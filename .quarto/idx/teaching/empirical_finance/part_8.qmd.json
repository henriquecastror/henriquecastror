{"title":"Empirical Methods in Finance","markdown":{"yaml":{"title":"Empirical Methods in Finance","subtitle":"Part 8","author":"Henrique C. Martins","format":{"revealjs":{"slide-number":true,"theme":"simple","chalkboard":true,"preview-links":"auto","logo":"figs/background8.png","css":"logo.css","footer":"**[**Henrique C. Martins**] [[henrique.martins@fgv.br](mailto:henrique.martins@fgv.br)][Do not use without permission]**  ","multiplex":true,"scrollable":true}},"title-slide-attributes":{"data-background-color":"#b1cafa"},"include-after":"<script type=\"text/javascript\">\n  Reveal.on('ready', event => {\n    if (event.indexh === 0) {\n      document.querySelector(\"div.has-logo > img.slide-logo\").style.display = \"none\";\n    }\n  });\n  Reveal.addEventListener('slidechanged', (event) => {\n    if (event.indexh === 0) {\n      Reveal.configure({ slideNumber: null });\n      document.querySelector(\"div.has-logo > img.slide-logo\").style.display = \"none\";\n    }\n    if (event.indexh === 1) {\n      Reveal.configure({ slideNumber: 'c' });\n      document.querySelector(\"div.has-logo > img.slide-logo\").style.display = null;\n    }\n  });\n</script>\n"},"headingText":"library(reticulate)","containsRefs":false,"markdown":"\n\n```{r setup}\n#| include: false\n#| warning: false\n\n# use_python(\"C:/Users/hcmrt/AppData/Local/Programs/Python/Python310/python.exe\")\nlibrary(reticulate)\nlibrary(Statamarkdown)\n#reticulate::py_install(\"matplotlib\")\n#reticulate::py_install(\"seaborn\")\n#reticulate::py_install(\"pyfinance\")\n#reticulate::py_install(\"xlrd\")\n#reticulate::py_install(\"quandl\")\n#reticulate::py_install(\"linearmodels\")\n#reticulate::py_install(\"causalml\")\n\n```\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n# Regression Discontinuity Design (RDD) {.smaller background=\"#e3e2b8\"}\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\n**The regression-discontinuity (RD) research design is a quasi experimental method.**\n\nHere the *treatment* is not a binary as before. \n\n**Treated units are assigned based on a cutoff score of a continuous variable.**\n\n. . .\n\nIn a RDD the treatment assignment is not random...\n\n... but it is based in the value of an observed covariate, in which the units lie on either side of the threshold.\n\n\n\n\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\n**[Example Mastering Metrics](https://www.masteringmetrics.com/):**\n\n- Age for drinking is 18 in Brazil. \n\nWhy prohibiting younger than 18?\n\nThe theory behind this effort is that legal drinking at age 18 discourages binge drinking and promotes a culture of mature alcohol consumption. \n\nThe cutoff splits who can drink and who can't.\n\n\n\n\n\n\n\n\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\nThe name RDD comes from a *jump*, a discontinuity that occurs in a continuous variable.\n\nIn its simplest form, the design has a:\n\n- The assignment variable (e.g., age), \n\n- Two groups (above and below the cutoff),\n\n- The outcome variable.\n\n- You may include nonlinearities and control variables. \n\n\n\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\nRDD is:\n\n$$D_i = 1(x_i>c) \\;$$\n\nwhere:\n\n- $$\\;D = 1 \\; if \\;X \\;_i>c $$ \n\n- $$\\;D = 0 \\; if \\;X \\;_i<c $$\n\n\n$X$ is called the forcing variable because it \"forces\" units into treatment or control groups.\n\n$X$ may be correlated with $Y_1$ or $Y_0$, so simply comparing treated and control units would not provide causal effects\n\nHowever, if the units are randomly assigned into treatment around the cutoff, we would have causal effects.\n\n\n\n\n\n\n\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\nThe main assumption that allows using RDD as a causal method is that\n\n**Next to the cut, the participants are similar. The only difference is that one individual is in each of the \"sides\".** [Source](http://dx.doi.org/10.1016/B978-0-08-097086-8.44049-3)\n\n![](figs/rdd0.png){width=60%  height=60%}\n\n\n\n\n\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\n- The cutoff value **occurs at 50**\n\n- What are the differences between someone that scores 49.99 and 50.01 in the X variable?\n\n- The intuition is that these individuals are similar and comparable.\n\nIn the absence of **treatment**, the assumption is that the solid line would \"continue\" with the same inclination and values. \n\nThere is a discontinuity, however. This implies that the pretreatment  in the absence of the treatment should be the dashed line.\n\nThe discontinuity is the causal effect of X (at the cutoff) to Y.\n\n\n\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\n*Unlike the matching and regression strategies based on treatment-control comparisons conditional on covariates, the validity of RDD is based on our willingness to extrapolate across values of the running variable, at least for values in the neighborhood of the cutoff at which treatment switches on.* [MM](https://www.masteringmetrics.com/)\n\n\n\n\n\n\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\n**Again the drinking example:**\n\n\n**In the US it is 21 years (age & alcohol).** **[Example Mastering Metrics](https://www.masteringmetrics.com/):**\n\n*Notice the x-axis.*\n\n![](figs/rdd1.png)\n\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\n**In the US it is 21 years.** **[Example Mastering Metrics](https://www.masteringmetrics.com/):**\n\n*Notice the x-axis.*\n\n![](figs/rdd2.png)\n\n\n\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\nExamples [Almeida et al 2016](https://doi.org/10.1016/j.jfineco.2015.08.008)\n\n\n![](figs/almeida.png)\n\n\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\nExamples [Flammer 2015](https://doi.org/10.1287/mnsc.2014.2038)\n\n\n![](figs/flammer.png)\n\n\n\n\n\n\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\nThis is (legally, it should be) an example of a **Sharp RDD**\n\nA **Sharp RDD** occurs when the cutoff is mandatory. There are no exceptions. In this case, there are no 17 years old drinking and driving. \n\nThe treatment is\n\n$$D_a= 1, \\;if \\;a \\;>=\\; 18, \\;0 \\;if \\;a\\; <\\; 18$$ \n\n\n. . . \n\nThe alternative is a **fuzzy RDD**, which occurs when there is some misassignment.\n\n- People from under the cut also receiving the treatment.\n- Ex. students that receive 5,96 usually are *approved* in a course (this is a misassignment).\n- To estimate a Fuzzy RDD, you can use the treatment as an instrumental variable (Angrist & Pischke, 2009).  \n\n\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\n**fuzzy RDD** ([The effect](https://theeffectbook.net/ch-DifferenceinDifference.html) )\n\n\n![](figs/fuzzy.png)\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\n**fuzzy RDD** \n\n*Compliers*: Takes treatment if above threshold but not if below threshold.\n\n*Always-Takers*: Always takes the treatment, ignores the cut.\n\n*Never-Takers*: Never takes the treatment, ignores the cut.\n\n*Defiers*: Takes treatment if below the threshold, does not take the treatment if above the threshold.\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\nThings that are \"good\" to a RDD.\n\n- Age \n- Dates (you need 6 years to start school, 5,99 years is not allowed)\n  - Great example: Most of NHL players are those with anniversaries just after the enrollment date\n- Ranking systems\n- Location (when people cannot \"move\" easily)\n\n\n\n\n\n\n# Estimation {.smaller background=\"#d4d3bc\"}\n\n\n## Estimation   {.smaller background=\"#d4d3bc\"}\n\nA **Sharp RDD** can take the form of:\n\n$$Y_i = \\alpha + \\beta_1 D_a + \\beta_2 \\tilde{x}_1 + \\epsilon$$\n\nWhere $D_a$ is the treatment based on the cutoff.\n\n$x$ is the running variable (the difference between the actual $X$ and the cutoff in $X_0$).\n\n- For instance, months until the 18 years birthday.\n\n- We can also use the notation: $\\tilde{X}=x-x_0$ regarding the difference. \n\n\n\n\n\n\n\n## Estimation   {.smaller background=\"#d4d3bc\"}\n\nYou also should trim the sample to a reasonable window around the cutoff $c$ \n\n- Something like: $c-h<X_i<c+h$, where $h$ is a positive value that determines the window\n\n- There is no theoretical solution to how big should $h$ be. It invites robustness tests.\n\n\n\n## Estimation   {.smaller background=\"#d4d3bc\"}\n\n**Final Step:**\n\nDecide on the model of E[Y|X]:\n\n- linear in both \"sides\" with same slope\n\n- linear with different slopes\n\n- non-linear\n\n\n\n**Tip**: always execute a visual inspection to check which model os appropriate.\n\nAlso, always estimate different models and discuss the results.\n\n\n\n\n\n\n## Estimation   {.smaller background=\"#d4d3bc\"}\n\n**fuzzy RDD** \n\n\n$$Y_i = \\alpha + \\beta_1 D_a + \\beta_2 \\tilde{x}_1 + \\beta_3(Z \\times \\tilde{x}_1) \\epsilon$$\n\nWhere Z is 1 if unit is above the cut or 0 if unit is below the cut.\n\nNotice that D is not equal to Z, in these cases.\n\n\n\n\n\n\n\n\n\n# RDD Nonlinearities  {.smaller background=\"#f2f1d5\"}\n\n## RDD Nonlinearities   {.smaller background=\"#f2f1d5\"}\n\n\n**[Example Mastering Metrics](https://www.masteringmetrics.com/):**\n\nThis is a linear relationship, with the same slopes.\n\n![](figs/rdd3.png)\n\n$$E[Y|X,D] = \\alpha + \\beta_1 \\times D + \\beta_2 \\times \\tilde{X}$$\n\n\n\n## RDD Nonlinearities   {.smaller background=\"#f2f1d5\"}\n\n\n[The effect](https://theeffectbook.net/ch-DifferenceinDifference.html) This is a linear relationship, with different  slopes.\n\n![](figs/rdd_diff_slope.png)\n\n\n\n\n\n\n\n\n\n\n## RDD Nonlinearities   {.smaller background=\"#f2f1d5\"}\n\n**[Example Mastering Metrics](https://www.masteringmetrics.com/):**\n\nThis is a nonlinear relationship.\n\n![](figs/rdd4.png)\n\n\n\n\n\n\n\n\n\n\n## RDD Nonlinearities   {.smaller background=\"#f2f1d5\"}\n\n**[Example Mastering Metrics](https://www.masteringmetrics.com/):**\n\n Is the relationship linear or nonlinear here? If you misjudge the relationship, it will be hard to tell a story credibly.\n\n![](figs/rdd5.png)\n\n\n\n\n\n\n\n\n\n## RDD Nonlinearities   {.smaller background=\"#f2f1d5\"}\n\n**The takeaway:** **RDD is a graphical method. You need to show the graphs**.\n\n**Nobody will believe your story without the correct specification of the model**.\n\n. . .\n\nIn the first case:\n\n\n$$Y_i = \\alpha + \\beta_1 D_a + \\beta_2 x_1 + \\epsilon$$\n\nIn the second case:\n\n$$Y_i = \\alpha + \\beta_1 D_a + \\beta_2 x_1 + \\beta_3 x_1^2 + \\epsilon$$\n\n\n\n\n\n\n\n## RDD Nonlinearities   {.smaller background=\"#f2f1d5\"}\n\nWe can also add an interaction term (notice that I am changing the notation now to make it similar to MM)\n\n$$Y_i = \\alpha + \\beta_1 D_a + \\beta_2 (x - x_0) + \\beta_3 (x - x_0) D_a + \\epsilon$$\n\nThis allows for different inclinations before and after the cut.\n\n\n\n## RDD Nonlinearities   {.smaller background=\"#f2f1d5\"}\n\nOr even different nonlinearities before and after the cut:\n\n\n$$Y_i = \\alpha + \\beta_1 D_a + \\beta_2 (x - x_0) + \\beta_3 (x - x_0)^2 + \\beta_4 (x - x_0) D_a  + \\beta_5 (x - x_0)^2 D_a + \\epsilon$$\n\n\n![](figs/rdd6.png)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n# Example RDD  {.smaller background=\"#edecc0\"}\n\n## Example RDD **Clearly, this is not linear.** {.smaller background=\"#edecc0\"}\n\n\n::: panel-tabset\n### R\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: true\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nlibrary(readxl)\nlibrary(ggplot2)\ndata  <- read_excel(\"files/RDD.xlsx\")\nggplot(data, aes(x, y))  + \n  geom_point(size=1.2) + \n  labs(y = \"\", x=\"\", title = \"Evolution of Y\") +\n  theme(plot.title = element_text(color=\"black\", size=20, face=\"bold\"),\n        panel.background = element_rect(fill = \"grey95\", colour = \"grey95\"),\n        axis.text.y = element_text(face=\"bold\", color=\"black\", size = 12),\n        axis.text.x = element_text(face=\"bold\", color=\"black\", size = 12),\n        legend.title = element_blank(),\n        legend.key.size = unit(1, \"cm\")) +\n    geom_smooth(method = \"lm\", fill = NA)\n```\n\n### Python\n\n```{python}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output: true\n#| output-location: default\n#| code-fold: true\n#| code-line-numbers: true\n#| eval: true\n#| code-summary: \"Python\"\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns\n# Read Excel file\ndata = pd.read_excel(\"files/RDD.xlsx\")\n# Generate line graph - Including all observations together\nsns.set(style=\"whitegrid\")\nplt.figure(figsize=(10, 5))\nscatter_plot = sns.scatterplot(x='x', y='y', data=data, s=50)\nscatter_plot.set_title(\"Evolution of Y\", fontsize=20, fontweight='bold')\nscatter_plot.set_xlabel(\"\", fontsize=12, fontweight='bold')\nscatter_plot.set_ylabel(\"\", fontsize=12, fontweight='bold')\n# Add regression line\nsns.regplot(x='x', y='y', data=data, scatter=False, line_kws={'color': 'blue'})\nplt.show()\n```\n\n### Stata\n\n```{stata}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: false\n#| output: false\n#| output-location: default\n#| code-fold: true\n#| code-line-numbers: true\n#| eval: true\n#| code-summary: \"Stata\"\nimport excel \"files/RDD.xlsx\", firstrow\ntwoway (scatter y x) (lfit y x)\nquietly graph export figs/graph1.svg, replace\n```  \n\n![](figs/graph1.svg)\n\n:::\n\n\n\n\n\n\n\n\n\n\n\n\n\n## Example RDD  {.smaller background=\"#edecc0\"}\n\n::: panel-tabset\n### R\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: true\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nlibrary(readxl)\nlibrary(ggplot2)\ndata  <- read_excel(\"files/RDD.xlsx\")\n# Creating  groups\ndata$treated <- 0\ndata$treated[data$x >= 101] <- 1  \n# Generate a line graph - two groups\nggplot(data, aes(x, y, group=treated, color = factor(treated)))  + \n    geom_point( size=1.25) + \n    labs(y = \"\", x=\"\", title = \"RDD exemplo\")+\n    theme(plot.title = element_text(color=\"black\", size=25, face=\"bold\"),\n          panel.background = element_rect(fill = \"grey95\", colour = \"grey95\"),\n          axis.text.y = element_text(face=\"bold\", color=\"black\", size = 16),\n          axis.text.x = element_text(face=\"bold\", color=\"black\", size = 16),\n          legend.title = element_blank(),\n          legend.key.size = unit(2, \"cm\")) +\n    geom_smooth(method = \"lm\", fill = NA)\n```\n\n### Python\n\n```{python}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output: true\n#| output-location: default\n#| code-fold: true\n#| code-line-numbers: true\n#| eval: true\n#| code-summary: \"Python\"\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns\n# Read Excel file\ndata = pd.read_excel(\"files/RDD.xlsx\")\n# Create treated variable\ndata['treated'] = 0\ndata.loc[data['x'] >= 101, 'treated'] = 1\n# Generate line graph with two groups\nsns.set(style=\"whitegrid\")\nplt.figure(figsize=(10, 5))\nscatter_plot = sns.scatterplot(x='x', y='y', hue='treated', style='treated', data=data, s=50)\nscatter_plot.set_title(\"RDD exemplo\", fontsize=25, fontweight='bold')\nscatter_plot.set_xlabel(\"\", fontsize=16, fontweight='bold')\nscatter_plot.set_ylabel(\"\", fontsize=16, fontweight='bold')\nscatter_plot.legend().set_title('')\nscatter_plot.legend(title='', loc='upper left', fontsize='small')\n# Add regression lines\nsns.regplot(x='x', y='y', data=data[data['treated'] == 0], scatter=False, line_kws={'color': 'blue'})\nsns.regplot(x='x', y='y', data=data[data['treated'] == 1], scatter=False, line_kws={'color': 'orange'})\nplt.show()\n```\n\n### Stata\n\n```{stata}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: false\n#| output: false\n#| output-location: default\n#| code-fold: true\n#| code-line-numbers: true\n#| eval: true\n#| code-summary: \"Stata\"\nimport excel \"files/RDD.xlsx\", firstrow\ngen treated = 0\nreplace treated = 1 if x >= 101\ntwoway (scatter y x) (lfit y x if treated == 0) (lfit y x if treated == 1)\nquietly graph export figs/graph2.svg, replace\n```  \n\n![](figs/graph2.svg) \n\n:::\n\n\n\n\n\n\n\n\n\n## Example RDD  {.smaller background=\"#edecc0\"}\n\n::: panel-tabset\n### R\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: true\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nlibrary(readxl)\nlibrary(ggplot2)\ndata  <- read_excel(\"files/RDD.xlsx\")\n# Creating  groups\ndata$treated <- 0\ndata$treated[data$x >= 101] <- 1  \n# define cut\ncut <- 100\nband <- 50\nxlow = cut - band\nxhigh = cut + band\n# subset the data for the bandwidth\ndata <- subset(data, x > xlow & x <= xhigh, select=c(x, y,  treated))\n# Generate a line graph - two groups\nggplot(data, aes(x, y, group=treated, color = factor(treated)))  + \n  geom_point( size=1.25) + \n  labs(y = \"\", x=\"\", title = \"RDD example\")+\n  theme(plot.title = element_text(color=\"black\", size=25, face=\"bold\"),\n        panel.background = element_rect(fill = \"grey95\", colour = \"grey95\"),\n        axis.text.y = element_text(face=\"bold\", color=\"black\", size = 16),\n        axis.text.x = element_text(face=\"bold\", color=\"black\", size = 16),\n        legend.title = element_blank(),\n        legend.key.size = unit(2, \"cm\")) +\n  geom_smooth(method = \"lm\", fill = NA)\n```\n\n\n### Python\n\n```{python}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output: true\n#| output-location: default\n#| code-fold: true\n#| code-line-numbers: true\n#| eval: true\n#| code-summary: \"Python\"\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns\n# Read Excel file\ndata = pd.read_excel(\"files/RDD.xlsx\")\n# Create treated variable\ndata['treated'] = 0\ndata.loc[data['x'] >= 101, 'treated'] = 1\n# Define cut, band, and subset data\ncut = 100\nband = 50\nxlow = cut - band\nxhigh = cut + band\ndata = data[(data['x'] > xlow) & (data['x'] <= xhigh)][['x', 'y', 'treated']]\n# Generate line graph with two groups\nsns.set(style=\"whitegrid\")\nplt.figure(figsize=(10, 5))\nscatter_plot = sns.scatterplot(x='x', y='y', hue='treated', style='treated', data=data, s=50)\nscatter_plot.set_title(\"RDD example\", fontsize=25, fontweight='bold')\nscatter_plot.set_xlabel(\"\", fontsize=16, fontweight='bold')\nscatter_plot.set_ylabel(\"\", fontsize=16, fontweight='bold')\nscatter_plot.legend().set_title('')\nscatter_plot.legend(title='', loc='upper left', fontsize='small')\n# Add regression lines\nsns.regplot(x='x', y='y', data=data[data['treated'] == 0], scatter=False, line_kws={'color': 'blue'})\nsns.regplot(x='x', y='y', data=data[data['treated'] == 1], scatter=False, line_kws={'color': 'orange'})\nplt.show()\n```\n\n### Stata\n\n```{stata}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: false\n#| output: false\n#| output-location: default\n#| code-fold: true\n#| code-line-numbers: true\n#| eval: true\n#| code-summary: \"Stata\"\nimport excel \"files/RDD.xlsx\", firstrow\ngen treated = 0\nreplace treated = 1 if x >= 101\ngen cut = 100\ngen band = 50\ngen xlow = cut - band\ngen xhigh = cut + band\nkeep if x > xlow & x <= xhigh\ntwoway (scatter y x) (lfit y x if treated == 0) (lfit y x if treated == 1)\nquietly graph export figs/graph3.svg, replace\n```  \n\n![](figs/graph3.svg)\n\n:::\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n## Example RDD  {.smaller background=\"#edecc0\"}\n\n::: panel-tabset\n### R\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: true\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nlibrary(readxl)\nlibrary(ggplot2)\ndata  <- read_excel(\"files/RDD.xlsx\")\ndata$treated <- 0\ndata$treated[data$x >= 101] <- 1  \ncut <- 100\nband <- 50\nxlow = cut - band\nxhigh = cut + band\ndata <- subset(data, x > xlow & x <= xhigh, select=c(x, y,  treated))\n# Generating xhat - Now we are going to the RDD\ndata$xhat <- data$x - cut\n# Generating xhat * treated to allow different inclinations (we will use the findings of the last graph, i.e. that each group has a different trend.)\ndata$xhat_treated <- data$xhat * data$treated\n# RDD Assuming different trends\nrdd <- lm(y  ~ xhat + treated  + xhat_treated, data = data)\nsummary(rdd)\n```\n\n### Python\n\n```{python}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output: true\n#| output-location: default\n#| code-fold: true\n#| code-line-numbers: true\n#| eval: true\n#| code-summary: \"Python\"\nimport pandas as pd\nimport statsmodels.api as sm\ndata = pd.read_excel(\"files/RDD.xlsx\")\n# Generate treated variable\ndata['treated'] = 0\ndata.loc[data['x'] >= 101, 'treated'] = 1\n# Define cut and band\ncut = 100\nband = 50\nxlow = cut - band\nxhigh = cut + band\n# Subset data\ndata = data[(data['x'] > xlow) & (data['x'] <= xhigh)]\n# Generate xhat and xhat_treated\ndata['xhat'] = data['x'] - cut\ndata['xhat_treated'] = data['xhat'] * data['treated']\n# Regression\nX = data[['xhat', 'treated', 'xhat_treated']]\nX = sm.add_constant(X)  # Add a constant term\ny = data['y']\nmodel = sm.OLS(y, X).fit()\nprint(model.summary())\n```\n\n### Stata\n\n```{stata}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output: true\n#| output-location: default\n#| code-fold: true\n#| code-line-numbers: true\n#| eval: true\n#| code-summary: \"Stata\"\nimport excel \"files/RDD.xlsx\", firstrow clear\ngen treated = 0\nreplace treated = 1 if x >= 101\ngen cut = 100\ngen band = 50\ngen xlow = cut - band\ngen xhigh = cut + band\nkeep if x > xlow & x <= xhigh\ngen xhat = x - cut\ngen xhat_treated = xhat * treated\nregress y xhat treated xhat_treated\n```  \n\n:::\n\n\n\n\n## Example RDD  {.smaller background=\"#edecc0\"}\n\nThe coefficient of x before the cut is 0.29 (t-stat 5.45), and after the cut, it is -0.51 (t-stat -6.75). \n\nWe also have the coefficient of the treatment, which is measured by the \"jump\" that occurs near the cut: **an estimated coefficient of 28.9 (t-stat 13.11). **\n\nIf this were a real example, this would be the causal effect of receiving the treatment (i.e., being beyond the cut).\n\n\n\n\n\n\n\n\n\n\n# Final comments RDD {.smaller background=\"#f0eeb4\"}\n\n## Final comments RDD {.smaller background=\"#f0eeb4\"}\n\n\n**Sensitivity to specification**\n\nMisspecification can lead to a \"spurious jump\". **Do not mix nonlinearity with a discontinuity**.\n\n. . . \n\n**Sensitivity to window**\n\nAlso, need to check many alternative $h$. \n\n. . . \n\n**Smoothness of the running around the cut**\n\nThe distribution of X should be smooth around the cut. If it is not, it might indicate that the treatment assignment was not random. \n\n. . . \n\n**Test comparability of units around the cut**\n\nCovariates balance. You can check whether there are jumps in control variables as an additional robustness.\n\n. . . \n\n**Placebo tests**\n\nTest whether the treatment is zero when it should be zero.\n\n\n\n\n\n\n\n\n## 🙋‍♂️ **Any Questions?**{ .smaller  background=\"#fdf6e3\"}\n\n::: columns\n::: {.column width=\"50%\"}\n### Thank You!\n\n![](figs/qa2.png){width=\"110%\" style=\"box-shadow: none;\"}\n\n:::\n\n::: {.column width=\"50%\"}\n<div style=\"text-align:right;\">\n  <img src=\"figs/avatar.jpg\" width=\"120px\" style=\"border-radius:50%; box-shadow:0 4px 12px rgba(0,0,0,.25);\" />\n</div>\n\n### **Henrique C. Martins**\n\n- 🌐 [FGV/EAESP](https://eaesp.fgv.br/en/people/henrique-castro-martins)  \n- 💼 [LinkedIn](https://www.linkedin.com/in/henriquecastror/)  \n- 🧠 [Google Scholar](https://scholar.google.com.br/citations?user=7gIfkRMAAAAJ&hl=pt-BR&oi=ao)  \n- 📄 [Lattes CV](http://lattes.cnpq.br/6076997472159785)  \n- 🏠 [Personal Website](https://henriquemartins.net/)  \n:::\n:::\n\n","srcMarkdownNoYaml":"\n\n```{r setup}\n#| include: false\n#| warning: false\n\n# library(reticulate)\n# use_python(\"C:/Users/hcmrt/AppData/Local/Programs/Python/Python310/python.exe\")\nlibrary(reticulate)\nlibrary(Statamarkdown)\n#reticulate::py_install(\"matplotlib\")\n#reticulate::py_install(\"seaborn\")\n#reticulate::py_install(\"pyfinance\")\n#reticulate::py_install(\"xlrd\")\n#reticulate::py_install(\"quandl\")\n#reticulate::py_install(\"linearmodels\")\n#reticulate::py_install(\"causalml\")\n\n```\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n# Regression Discontinuity Design (RDD) {.smaller background=\"#e3e2b8\"}\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\n**The regression-discontinuity (RD) research design is a quasi experimental method.**\n\nHere the *treatment* is not a binary as before. \n\n**Treated units are assigned based on a cutoff score of a continuous variable.**\n\n. . .\n\nIn a RDD the treatment assignment is not random...\n\n... but it is based in the value of an observed covariate, in which the units lie on either side of the threshold.\n\n\n\n\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\n**[Example Mastering Metrics](https://www.masteringmetrics.com/):**\n\n- Age for drinking is 18 in Brazil. \n\nWhy prohibiting younger than 18?\n\nThe theory behind this effort is that legal drinking at age 18 discourages binge drinking and promotes a culture of mature alcohol consumption. \n\nThe cutoff splits who can drink and who can't.\n\n\n\n\n\n\n\n\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\nThe name RDD comes from a *jump*, a discontinuity that occurs in a continuous variable.\n\nIn its simplest form, the design has a:\n\n- The assignment variable (e.g., age), \n\n- Two groups (above and below the cutoff),\n\n- The outcome variable.\n\n- You may include nonlinearities and control variables. \n\n\n\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\nRDD is:\n\n$$D_i = 1(x_i>c) \\;$$\n\nwhere:\n\n- $$\\;D = 1 \\; if \\;X \\;_i>c $$ \n\n- $$\\;D = 0 \\; if \\;X \\;_i<c $$\n\n\n$X$ is called the forcing variable because it \"forces\" units into treatment or control groups.\n\n$X$ may be correlated with $Y_1$ or $Y_0$, so simply comparing treated and control units would not provide causal effects\n\nHowever, if the units are randomly assigned into treatment around the cutoff, we would have causal effects.\n\n\n\n\n\n\n\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\nThe main assumption that allows using RDD as a causal method is that\n\n**Next to the cut, the participants are similar. The only difference is that one individual is in each of the \"sides\".** [Source](http://dx.doi.org/10.1016/B978-0-08-097086-8.44049-3)\n\n![](figs/rdd0.png){width=60%  height=60%}\n\n\n\n\n\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\n- The cutoff value **occurs at 50**\n\n- What are the differences between someone that scores 49.99 and 50.01 in the X variable?\n\n- The intuition is that these individuals are similar and comparable.\n\nIn the absence of **treatment**, the assumption is that the solid line would \"continue\" with the same inclination and values. \n\nThere is a discontinuity, however. This implies that the pretreatment  in the absence of the treatment should be the dashed line.\n\nThe discontinuity is the causal effect of X (at the cutoff) to Y.\n\n\n\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\n*Unlike the matching and regression strategies based on treatment-control comparisons conditional on covariates, the validity of RDD is based on our willingness to extrapolate across values of the running variable, at least for values in the neighborhood of the cutoff at which treatment switches on.* [MM](https://www.masteringmetrics.com/)\n\n\n\n\n\n\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\n**Again the drinking example:**\n\n\n**In the US it is 21 years (age & alcohol).** **[Example Mastering Metrics](https://www.masteringmetrics.com/):**\n\n*Notice the x-axis.*\n\n![](figs/rdd1.png)\n\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\n**In the US it is 21 years.** **[Example Mastering Metrics](https://www.masteringmetrics.com/):**\n\n*Notice the x-axis.*\n\n![](figs/rdd2.png)\n\n\n\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\nExamples [Almeida et al 2016](https://doi.org/10.1016/j.jfineco.2015.08.008)\n\n\n![](figs/almeida.png)\n\n\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\nExamples [Flammer 2015](https://doi.org/10.1287/mnsc.2014.2038)\n\n\n![](figs/flammer.png)\n\n\n\n\n\n\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\nThis is (legally, it should be) an example of a **Sharp RDD**\n\nA **Sharp RDD** occurs when the cutoff is mandatory. There are no exceptions. In this case, there are no 17 years old drinking and driving. \n\nThe treatment is\n\n$$D_a= 1, \\;if \\;a \\;>=\\; 18, \\;0 \\;if \\;a\\; <\\; 18$$ \n\n\n. . . \n\nThe alternative is a **fuzzy RDD**, which occurs when there is some misassignment.\n\n- People from under the cut also receiving the treatment.\n- Ex. students that receive 5,96 usually are *approved* in a course (this is a misassignment).\n- To estimate a Fuzzy RDD, you can use the treatment as an instrumental variable (Angrist & Pischke, 2009).  \n\n\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\n**fuzzy RDD** ([The effect](https://theeffectbook.net/ch-DifferenceinDifference.html) )\n\n\n![](figs/fuzzy.png)\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\n**fuzzy RDD** \n\n*Compliers*: Takes treatment if above threshold but not if below threshold.\n\n*Always-Takers*: Always takes the treatment, ignores the cut.\n\n*Never-Takers*: Never takes the treatment, ignores the cut.\n\n*Defiers*: Takes treatment if below the threshold, does not take the treatment if above the threshold.\n\n\n\n\n## Regression Discontinuity Design (RDD)   {.smaller background=\"#e3e2b8\"}\n\nThings that are \"good\" to a RDD.\n\n- Age \n- Dates (you need 6 years to start school, 5,99 years is not allowed)\n  - Great example: Most of NHL players are those with anniversaries just after the enrollment date\n- Ranking systems\n- Location (when people cannot \"move\" easily)\n\n\n\n\n\n\n# Estimation {.smaller background=\"#d4d3bc\"}\n\n\n## Estimation   {.smaller background=\"#d4d3bc\"}\n\nA **Sharp RDD** can take the form of:\n\n$$Y_i = \\alpha + \\beta_1 D_a + \\beta_2 \\tilde{x}_1 + \\epsilon$$\n\nWhere $D_a$ is the treatment based on the cutoff.\n\n$x$ is the running variable (the difference between the actual $X$ and the cutoff in $X_0$).\n\n- For instance, months until the 18 years birthday.\n\n- We can also use the notation: $\\tilde{X}=x-x_0$ regarding the difference. \n\n\n\n\n\n\n\n## Estimation   {.smaller background=\"#d4d3bc\"}\n\nYou also should trim the sample to a reasonable window around the cutoff $c$ \n\n- Something like: $c-h<X_i<c+h$, where $h$ is a positive value that determines the window\n\n- There is no theoretical solution to how big should $h$ be. It invites robustness tests.\n\n\n\n## Estimation   {.smaller background=\"#d4d3bc\"}\n\n**Final Step:**\n\nDecide on the model of E[Y|X]:\n\n- linear in both \"sides\" with same slope\n\n- linear with different slopes\n\n- non-linear\n\n\n\n**Tip**: always execute a visual inspection to check which model os appropriate.\n\nAlso, always estimate different models and discuss the results.\n\n\n\n\n\n\n## Estimation   {.smaller background=\"#d4d3bc\"}\n\n**fuzzy RDD** \n\n\n$$Y_i = \\alpha + \\beta_1 D_a + \\beta_2 \\tilde{x}_1 + \\beta_3(Z \\times \\tilde{x}_1) \\epsilon$$\n\nWhere Z is 1 if unit is above the cut or 0 if unit is below the cut.\n\nNotice that D is not equal to Z, in these cases.\n\n\n\n\n\n\n\n\n\n# RDD Nonlinearities  {.smaller background=\"#f2f1d5\"}\n\n## RDD Nonlinearities   {.smaller background=\"#f2f1d5\"}\n\n\n**[Example Mastering Metrics](https://www.masteringmetrics.com/):**\n\nThis is a linear relationship, with the same slopes.\n\n![](figs/rdd3.png)\n\n$$E[Y|X,D] = \\alpha + \\beta_1 \\times D + \\beta_2 \\times \\tilde{X}$$\n\n\n\n## RDD Nonlinearities   {.smaller background=\"#f2f1d5\"}\n\n\n[The effect](https://theeffectbook.net/ch-DifferenceinDifference.html) This is a linear relationship, with different  slopes.\n\n![](figs/rdd_diff_slope.png)\n\n\n\n\n\n\n\n\n\n\n## RDD Nonlinearities   {.smaller background=\"#f2f1d5\"}\n\n**[Example Mastering Metrics](https://www.masteringmetrics.com/):**\n\nThis is a nonlinear relationship.\n\n![](figs/rdd4.png)\n\n\n\n\n\n\n\n\n\n\n## RDD Nonlinearities   {.smaller background=\"#f2f1d5\"}\n\n**[Example Mastering Metrics](https://www.masteringmetrics.com/):**\n\n Is the relationship linear or nonlinear here? If you misjudge the relationship, it will be hard to tell a story credibly.\n\n![](figs/rdd5.png)\n\n\n\n\n\n\n\n\n\n## RDD Nonlinearities   {.smaller background=\"#f2f1d5\"}\n\n**The takeaway:** **RDD is a graphical method. You need to show the graphs**.\n\n**Nobody will believe your story without the correct specification of the model**.\n\n. . .\n\nIn the first case:\n\n\n$$Y_i = \\alpha + \\beta_1 D_a + \\beta_2 x_1 + \\epsilon$$\n\nIn the second case:\n\n$$Y_i = \\alpha + \\beta_1 D_a + \\beta_2 x_1 + \\beta_3 x_1^2 + \\epsilon$$\n\n\n\n\n\n\n\n## RDD Nonlinearities   {.smaller background=\"#f2f1d5\"}\n\nWe can also add an interaction term (notice that I am changing the notation now to make it similar to MM)\n\n$$Y_i = \\alpha + \\beta_1 D_a + \\beta_2 (x - x_0) + \\beta_3 (x - x_0) D_a + \\epsilon$$\n\nThis allows for different inclinations before and after the cut.\n\n\n\n## RDD Nonlinearities   {.smaller background=\"#f2f1d5\"}\n\nOr even different nonlinearities before and after the cut:\n\n\n$$Y_i = \\alpha + \\beta_1 D_a + \\beta_2 (x - x_0) + \\beta_3 (x - x_0)^2 + \\beta_4 (x - x_0) D_a  + \\beta_5 (x - x_0)^2 D_a + \\epsilon$$\n\n\n![](figs/rdd6.png)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n# Example RDD  {.smaller background=\"#edecc0\"}\n\n## Example RDD **Clearly, this is not linear.** {.smaller background=\"#edecc0\"}\n\n\n::: panel-tabset\n### R\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: true\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nlibrary(readxl)\nlibrary(ggplot2)\ndata  <- read_excel(\"files/RDD.xlsx\")\nggplot(data, aes(x, y))  + \n  geom_point(size=1.2) + \n  labs(y = \"\", x=\"\", title = \"Evolution of Y\") +\n  theme(plot.title = element_text(color=\"black\", size=20, face=\"bold\"),\n        panel.background = element_rect(fill = \"grey95\", colour = \"grey95\"),\n        axis.text.y = element_text(face=\"bold\", color=\"black\", size = 12),\n        axis.text.x = element_text(face=\"bold\", color=\"black\", size = 12),\n        legend.title = element_blank(),\n        legend.key.size = unit(1, \"cm\")) +\n    geom_smooth(method = \"lm\", fill = NA)\n```\n\n### Python\n\n```{python}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output: true\n#| output-location: default\n#| code-fold: true\n#| code-line-numbers: true\n#| eval: true\n#| code-summary: \"Python\"\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns\n# Read Excel file\ndata = pd.read_excel(\"files/RDD.xlsx\")\n# Generate line graph - Including all observations together\nsns.set(style=\"whitegrid\")\nplt.figure(figsize=(10, 5))\nscatter_plot = sns.scatterplot(x='x', y='y', data=data, s=50)\nscatter_plot.set_title(\"Evolution of Y\", fontsize=20, fontweight='bold')\nscatter_plot.set_xlabel(\"\", fontsize=12, fontweight='bold')\nscatter_plot.set_ylabel(\"\", fontsize=12, fontweight='bold')\n# Add regression line\nsns.regplot(x='x', y='y', data=data, scatter=False, line_kws={'color': 'blue'})\nplt.show()\n```\n\n### Stata\n\n```{stata}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: false\n#| output: false\n#| output-location: default\n#| code-fold: true\n#| code-line-numbers: true\n#| eval: true\n#| code-summary: \"Stata\"\nimport excel \"files/RDD.xlsx\", firstrow\ntwoway (scatter y x) (lfit y x)\nquietly graph export figs/graph1.svg, replace\n```  \n\n![](figs/graph1.svg)\n\n:::\n\n\n\n\n\n\n\n\n\n\n\n\n\n## Example RDD  {.smaller background=\"#edecc0\"}\n\n::: panel-tabset\n### R\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: true\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nlibrary(readxl)\nlibrary(ggplot2)\ndata  <- read_excel(\"files/RDD.xlsx\")\n# Creating  groups\ndata$treated <- 0\ndata$treated[data$x >= 101] <- 1  \n# Generate a line graph - two groups\nggplot(data, aes(x, y, group=treated, color = factor(treated)))  + \n    geom_point( size=1.25) + \n    labs(y = \"\", x=\"\", title = \"RDD exemplo\")+\n    theme(plot.title = element_text(color=\"black\", size=25, face=\"bold\"),\n          panel.background = element_rect(fill = \"grey95\", colour = \"grey95\"),\n          axis.text.y = element_text(face=\"bold\", color=\"black\", size = 16),\n          axis.text.x = element_text(face=\"bold\", color=\"black\", size = 16),\n          legend.title = element_blank(),\n          legend.key.size = unit(2, \"cm\")) +\n    geom_smooth(method = \"lm\", fill = NA)\n```\n\n### Python\n\n```{python}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output: true\n#| output-location: default\n#| code-fold: true\n#| code-line-numbers: true\n#| eval: true\n#| code-summary: \"Python\"\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns\n# Read Excel file\ndata = pd.read_excel(\"files/RDD.xlsx\")\n# Create treated variable\ndata['treated'] = 0\ndata.loc[data['x'] >= 101, 'treated'] = 1\n# Generate line graph with two groups\nsns.set(style=\"whitegrid\")\nplt.figure(figsize=(10, 5))\nscatter_plot = sns.scatterplot(x='x', y='y', hue='treated', style='treated', data=data, s=50)\nscatter_plot.set_title(\"RDD exemplo\", fontsize=25, fontweight='bold')\nscatter_plot.set_xlabel(\"\", fontsize=16, fontweight='bold')\nscatter_plot.set_ylabel(\"\", fontsize=16, fontweight='bold')\nscatter_plot.legend().set_title('')\nscatter_plot.legend(title='', loc='upper left', fontsize='small')\n# Add regression lines\nsns.regplot(x='x', y='y', data=data[data['treated'] == 0], scatter=False, line_kws={'color': 'blue'})\nsns.regplot(x='x', y='y', data=data[data['treated'] == 1], scatter=False, line_kws={'color': 'orange'})\nplt.show()\n```\n\n### Stata\n\n```{stata}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: false\n#| output: false\n#| output-location: default\n#| code-fold: true\n#| code-line-numbers: true\n#| eval: true\n#| code-summary: \"Stata\"\nimport excel \"files/RDD.xlsx\", firstrow\ngen treated = 0\nreplace treated = 1 if x >= 101\ntwoway (scatter y x) (lfit y x if treated == 0) (lfit y x if treated == 1)\nquietly graph export figs/graph2.svg, replace\n```  \n\n![](figs/graph2.svg) \n\n:::\n\n\n\n\n\n\n\n\n\n## Example RDD  {.smaller background=\"#edecc0\"}\n\n::: panel-tabset\n### R\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: true\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nlibrary(readxl)\nlibrary(ggplot2)\ndata  <- read_excel(\"files/RDD.xlsx\")\n# Creating  groups\ndata$treated <- 0\ndata$treated[data$x >= 101] <- 1  \n# define cut\ncut <- 100\nband <- 50\nxlow = cut - band\nxhigh = cut + band\n# subset the data for the bandwidth\ndata <- subset(data, x > xlow & x <= xhigh, select=c(x, y,  treated))\n# Generate a line graph - two groups\nggplot(data, aes(x, y, group=treated, color = factor(treated)))  + \n  geom_point( size=1.25) + \n  labs(y = \"\", x=\"\", title = \"RDD example\")+\n  theme(plot.title = element_text(color=\"black\", size=25, face=\"bold\"),\n        panel.background = element_rect(fill = \"grey95\", colour = \"grey95\"),\n        axis.text.y = element_text(face=\"bold\", color=\"black\", size = 16),\n        axis.text.x = element_text(face=\"bold\", color=\"black\", size = 16),\n        legend.title = element_blank(),\n        legend.key.size = unit(2, \"cm\")) +\n  geom_smooth(method = \"lm\", fill = NA)\n```\n\n\n### Python\n\n```{python}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output: true\n#| output-location: default\n#| code-fold: true\n#| code-line-numbers: true\n#| eval: true\n#| code-summary: \"Python\"\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns\n# Read Excel file\ndata = pd.read_excel(\"files/RDD.xlsx\")\n# Create treated variable\ndata['treated'] = 0\ndata.loc[data['x'] >= 101, 'treated'] = 1\n# Define cut, band, and subset data\ncut = 100\nband = 50\nxlow = cut - band\nxhigh = cut + band\ndata = data[(data['x'] > xlow) & (data['x'] <= xhigh)][['x', 'y', 'treated']]\n# Generate line graph with two groups\nsns.set(style=\"whitegrid\")\nplt.figure(figsize=(10, 5))\nscatter_plot = sns.scatterplot(x='x', y='y', hue='treated', style='treated', data=data, s=50)\nscatter_plot.set_title(\"RDD example\", fontsize=25, fontweight='bold')\nscatter_plot.set_xlabel(\"\", fontsize=16, fontweight='bold')\nscatter_plot.set_ylabel(\"\", fontsize=16, fontweight='bold')\nscatter_plot.legend().set_title('')\nscatter_plot.legend(title='', loc='upper left', fontsize='small')\n# Add regression lines\nsns.regplot(x='x', y='y', data=data[data['treated'] == 0], scatter=False, line_kws={'color': 'blue'})\nsns.regplot(x='x', y='y', data=data[data['treated'] == 1], scatter=False, line_kws={'color': 'orange'})\nplt.show()\n```\n\n### Stata\n\n```{stata}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: false\n#| output: false\n#| output-location: default\n#| code-fold: true\n#| code-line-numbers: true\n#| eval: true\n#| code-summary: \"Stata\"\nimport excel \"files/RDD.xlsx\", firstrow\ngen treated = 0\nreplace treated = 1 if x >= 101\ngen cut = 100\ngen band = 50\ngen xlow = cut - band\ngen xhigh = cut + band\nkeep if x > xlow & x <= xhigh\ntwoway (scatter y x) (lfit y x if treated == 0) (lfit y x if treated == 1)\nquietly graph export figs/graph3.svg, replace\n```  \n\n![](figs/graph3.svg)\n\n:::\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n## Example RDD  {.smaller background=\"#edecc0\"}\n\n::: panel-tabset\n### R\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: true\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nlibrary(readxl)\nlibrary(ggplot2)\ndata  <- read_excel(\"files/RDD.xlsx\")\ndata$treated <- 0\ndata$treated[data$x >= 101] <- 1  \ncut <- 100\nband <- 50\nxlow = cut - band\nxhigh = cut + band\ndata <- subset(data, x > xlow & x <= xhigh, select=c(x, y,  treated))\n# Generating xhat - Now we are going to the RDD\ndata$xhat <- data$x - cut\n# Generating xhat * treated to allow different inclinations (we will use the findings of the last graph, i.e. that each group has a different trend.)\ndata$xhat_treated <- data$xhat * data$treated\n# RDD Assuming different trends\nrdd <- lm(y  ~ xhat + treated  + xhat_treated, data = data)\nsummary(rdd)\n```\n\n### Python\n\n```{python}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output: true\n#| output-location: default\n#| code-fold: true\n#| code-line-numbers: true\n#| eval: true\n#| code-summary: \"Python\"\nimport pandas as pd\nimport statsmodels.api as sm\ndata = pd.read_excel(\"files/RDD.xlsx\")\n# Generate treated variable\ndata['treated'] = 0\ndata.loc[data['x'] >= 101, 'treated'] = 1\n# Define cut and band\ncut = 100\nband = 50\nxlow = cut - band\nxhigh = cut + band\n# Subset data\ndata = data[(data['x'] > xlow) & (data['x'] <= xhigh)]\n# Generate xhat and xhat_treated\ndata['xhat'] = data['x'] - cut\ndata['xhat_treated'] = data['xhat'] * data['treated']\n# Regression\nX = data[['xhat', 'treated', 'xhat_treated']]\nX = sm.add_constant(X)  # Add a constant term\ny = data['y']\nmodel = sm.OLS(y, X).fit()\nprint(model.summary())\n```\n\n### Stata\n\n```{stata}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output: true\n#| output-location: default\n#| code-fold: true\n#| code-line-numbers: true\n#| eval: true\n#| code-summary: \"Stata\"\nimport excel \"files/RDD.xlsx\", firstrow clear\ngen treated = 0\nreplace treated = 1 if x >= 101\ngen cut = 100\ngen band = 50\ngen xlow = cut - band\ngen xhigh = cut + band\nkeep if x > xlow & x <= xhigh\ngen xhat = x - cut\ngen xhat_treated = xhat * treated\nregress y xhat treated xhat_treated\n```  \n\n:::\n\n\n\n\n## Example RDD  {.smaller background=\"#edecc0\"}\n\nThe coefficient of x before the cut is 0.29 (t-stat 5.45), and after the cut, it is -0.51 (t-stat -6.75). \n\nWe also have the coefficient of the treatment, which is measured by the \"jump\" that occurs near the cut: **an estimated coefficient of 28.9 (t-stat 13.11). **\n\nIf this were a real example, this would be the causal effect of receiving the treatment (i.e., being beyond the cut).\n\n\n\n\n\n\n\n\n\n\n# Final comments RDD {.smaller background=\"#f0eeb4\"}\n\n## Final comments RDD {.smaller background=\"#f0eeb4\"}\n\n\n**Sensitivity to specification**\n\nMisspecification can lead to a \"spurious jump\". **Do not mix nonlinearity with a discontinuity**.\n\n. . . \n\n**Sensitivity to window**\n\nAlso, need to check many alternative $h$. \n\n. . . \n\n**Smoothness of the running around the cut**\n\nThe distribution of X should be smooth around the cut. If it is not, it might indicate that the treatment assignment was not random. \n\n. . . \n\n**Test comparability of units around the cut**\n\nCovariates balance. You can check whether there are jumps in control variables as an additional robustness.\n\n. . . \n\n**Placebo tests**\n\nTest whether the treatment is zero when it should be zero.\n\n\n\n\n\n\n\n\n## 🙋‍♂️ **Any Questions?**{ .smaller  background=\"#fdf6e3\"}\n\n::: columns\n::: {.column width=\"50%\"}\n### Thank You!\n\n![](figs/qa2.png){width=\"110%\" style=\"box-shadow: none;\"}\n\n:::\n\n::: {.column width=\"50%\"}\n<div style=\"text-align:right;\">\n  <img src=\"figs/avatar.jpg\" width=\"120px\" style=\"border-radius:50%; box-shadow:0 4px 12px rgba(0,0,0,.25);\" />\n</div>\n\n### **Henrique C. Martins**\n\n- 🌐 [FGV/EAESP](https://eaesp.fgv.br/en/people/henrique-castro-martins)  \n- 💼 [LinkedIn](https://www.linkedin.com/in/henriquecastror/)  \n- 🧠 [Google Scholar](https://scholar.google.com.br/citations?user=7gIfkRMAAAAJ&hl=pt-BR&oi=ao)  \n- 📄 [Lattes CV](http://lattes.cnpq.br/6076997472159785)  \n- 🏠 [Personal Website](https://henriquemartins.net/)  \n:::\n:::\n\n"},"formats":{"revealjs":{"identifier":{"display-name":"RevealJS","target-format":"revealjs","base-format":"revealjs"},"execute":{"fig-width":10,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":false,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":true,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","html-math-method":{"method":"mathjax","url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML-full"},"slide-level":2,"to":"revealjs","css":["logo.css"],"output-file":"part_8.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"lang":"en","fig-responsive":false,"quarto-version":"1.4.549","auto-stretch":true,"html":{"css":"webex.css","include-after-body":"webex.js"},"editor":"visual","title":"Empirical Methods in Finance","subtitle":"Part 8","author":"Henrique C. Martins","title-slide-attributes":{"data-background-color":"#b1cafa"},"include-after":["<script type=\"text/javascript\">\n  Reveal.on('ready', event => {\n    if (event.indexh === 0) {\n      document.querySelector(\"div.has-logo > img.slide-logo\").style.display = \"none\";\n    }\n  });\n  Reveal.addEventListener('slidechanged', (event) => {\n    if (event.indexh === 0) {\n      Reveal.configure({ slideNumber: null });\n      document.querySelector(\"div.has-logo > img.slide-logo\").style.display = \"none\";\n    }\n    if (event.indexh === 1) {\n      Reveal.configure({ slideNumber: 'c' });\n      document.querySelector(\"div.has-logo > img.slide-logo\").style.display = null;\n    }\n  });\n</script>\n"],"slideNumber":true,"theme":"simple","chalkboard":true,"previewLinks":"auto","logo":"figs/background8.png","footer":"**[**Henrique C. Martins**] [[henrique.martins@fgv.br](mailto:henrique.martins@fgv.br)][Do not use without permission]**  ","multiplex":true,"scrollable":true}}},"projectFormats":["html"]}