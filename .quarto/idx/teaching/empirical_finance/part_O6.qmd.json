{"title":"Empirical Methods in Finance","markdown":{"yaml":{"title":"Empirical Methods in Finance","subtitle":"Practicing 6","author":"Henrique C. Martins","format":{"revealjs":{"slide-number":true,"theme":"simple","chalkboard":true,"preview-links":"auto","logo":"figs/background8.png","css":"logo.css","footer":"**[**Henrique C. Martins**] [[henrique.martins@fgv.br](mailto:henrique.martins@fgv.br)][Do not use without permission]**  ","multiplex":true,"scrollable":true}},"title-slide-attributes":{"data-background-color":"#b1cafa"},"include-after":"<script type=\"text/javascript\">\n  Reveal.on('ready', event => {\n    if (event.indexh === 0) {\n      document.querySelector(\"div.has-logo > img.slide-logo\").style.display = \"none\";\n    }\n  });\n  Reveal.addEventListener('slidechanged', (event) => {\n    if (event.indexh === 0) {\n      Reveal.configure({ slideNumber: null });\n      document.querySelector(\"div.has-logo > img.slide-logo\").style.display = \"none\";\n    }\n    if (event.indexh === 1) {\n      Reveal.configure({ slideNumber: 'c' });\n      document.querySelector(\"div.has-logo > img.slide-logo\").style.display = null;\n    }\n  });\n</script>\n"},"headingText":"library(reticulate)","containsRefs":false,"markdown":"\n\n```{r setup}\n#| include: false\n#| warning: false\n\n# use_python(\"C:/Users/hcmrt/AppData/Local/Programs/Python/Python310/python.exe\")\nlibrary(reticulate)\nlibrary(Statamarkdown)\nlibrary(ggplot2)\nlibrary(dplyr)\nlibrary(ggthemes)\n#reticulate::py_install(\"matplotlib\")\n#reticulate::py_install(\"seaborn\")\n#reticulate::py_install(\"pyfinance\")\n#reticulate::py_install(\"xlrd\")\n#reticulate::py_install(\"quandl\")\n#reticulate::py_install(\"linearmodels\")\n#reticulate::py_install(\"causalml\")\n\n```\n\n\n\n# Panel Data {.smaller}\n\n\n\n## Panel Data {.smaller}\n\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nlibrary(ggplot2)\nlibrary(ggthemes)\nlibrary(readxl) \nlibrary(jtools) # for nice tables of models - https://cran.r-project.org/web/packages/jtools/vignettes/summ.html#summ\ndata <- read_excel(\"files/data.xls\")\n```\n\n\nAfter uploading the data, tell R the data is panel. You need two identifiers: one for the cross-sectional part (usually, firms in accounting & finance research), and other for the time-series part (usually, year but sometimes can be quarter). The following example uses a panel wit quarterly data. \n\nI am also creating an identifier for industries, which might be useful.\n\n\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nlibrary(dplyr)\ndata <- data %>% group_by(id )                %>% dplyr::mutate(id_firm = cur_group_id())\ndata <- data %>% group_by(setor_economatica)  %>% dplyr::mutate(id_ind = cur_group_id())\n```\n\n\n\nNow, I am stating to r that I have a dataset in a panel structure.\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nlibrary(plm)\ndata <- pdata.frame(data, index=c(\"id_firm\",\"year\"))\n```\n\n\n\n\n\n## OLS, Panel, Fixed effects, and Random Effects {.smaller}\n\nLet's attach the dataset to make things easier.\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nattach(data)\n```\n\n\n## {.smaller}\n\n\nLet's inspect the dataset. First, let's see how many observations we have by country:\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nlibrary('plyr')\ncount(country)\n```\n\n## {.smaller}\n\nNow, by year.\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\ncount(year)\n```\n\n\n\n## OLS, Panel, Fixed effects, and Random Effects {.smaller}\n\nNow, by industry.\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\ncount(setor_economatica)\n```\n\n\n\n\n\n\n## Generating variables {.smaller}\n\nLet's generate some variables to use later. \n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\ndata$lev1 <- Debt / (Debt + Equity.market.value)\ndata$lev2 <- Debt / Total.Assets\ndata$wc_ta <- wc  / Total.Assets \ndata$cash_ta <- cash / Total.Assets\ndata$div_ta <- Dividends / Total.Assets\ndata$fcf_ta <- Free.cash.flow / Total.Assets\ndata$tang_ta <- tangible / Total.Assets\ndata$roa2 <- roa / 100\nlibrary(SciViews)\ndata$size1  <- ln(Total.Assets)\n```\n\n\n\n\n## Generating variables {.smaller}\n\n\nNotice that most variables are ratios and thus are expected to fall in the 0-100% range. \n\nThere is one important exception: Size. Size in this example is the **natural logarithm of Total Assets** (sometimes, studies use the natural logarithm of Total Sales). Taking the natural logarithm is a traditional decision in this type of research.\n\nSo, why did I do that in Size but not in the others?\n\n\n## Generating variables {.smaller}\n\n\nIn many cases, you want to use **relative differences or percentages change**. For instance, GDP growth is usually measured as the growth of each year over the previous year. The same is true for stock prices. \n\n$$GDP\\; growth = \\frac{GDP_t - GDP_{t-1}}{GDP`{t-1}}$$\n\nThis is possible because you always have a previous value to use as base for comparison.\n\n\n\n\n## Generating variables {.smaller}\n\n\nIn many cases, you do not have such base for comparison. This is the case of a firm's Total Assets. What is the natural base for Total Assets? No answer.\n\nTherefore, you take the natural logarithm so that you minimize this concern. \n\nAdditionally, keep in mind that the empirical values of Total Assets are often very dissimilar and with huge magnitude. Consider two firms, one with 1 million of total assets, the other with 1 billion. Assume that both firms increased throughout one year their total assets by 1 million. The first firm is twice the size of before, but 1 million make little difference for a billion dollar firm. Taking the logarithm helps you to have a similar base and mitigate the magnitude effect of these changes.\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n## Summary statistics {.smaller}\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nlibrary(vtable)\nsumtable(data, vars = c('lev1' , 'lev2' , 'wc_ta', 'cash_ta',  'size1'  , 'fcf_ta' , 'div_ta', 'roa' , 'tang_ta'))\n```\n\n\n\n\n## Winsorization {.smaller}\n\nSome of the variables have weird values. For instance, the variable $\\frac{Free cash flow}{Total Assets}$ has a maximum value of 817. It means that there is one firm-year observation in which the cash flow of that firm in that year is 817 times the firm's total assets. This is very odd to say the least. \n\nTo avoid this type of problem, we can winsorize our variables.\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nlibrary(DescTools)\ndata$w_lev1     <- Winsorize(data$lev1   , probs = c(0.01, 0.99) , na.rm = TRUE) \ndata$w_lev2     <- Winsorize(data$lev2   , probs = c(0.01, 0.99) , na.rm = TRUE) \ndata$w_wc_ta    <- Winsorize(data$wc_ta  , probs = c(0.01, 0.99) , na.rm = TRUE) \ndata$w_cash_ta  <- Winsorize(data$cash_ta, probs = c(0.01, 0.99) , na.rm = TRUE) \ndata$w_size1    <- Winsorize(data$size1  , probs = c(0.01, 0.99) , na.rm = TRUE) \ndata$w_fcf_ta   <- Winsorize(data$fcf_ta , probs = c(0.01, 0.99) , na.rm = TRUE) \ndata$w_div_ta   <- Winsorize(data$div_ta , probs = c(0.01, 0.99) , na.rm = TRUE) \ndata$w_roa      <- Winsorize(data$roa    , probs = c(0.01, 0.99) , na.rm = TRUE) \ndata$w_tang_ta  <- Winsorize(data$tang_ta, probs = c(0.01, 0.99) , na.rm = TRUE) \n```\n\n\n\n## Panel data {.smaller}\n\nMultiple times are always helpful. That is, in a panel dataset, you have many observations of the same unit in different time periods. This is helpful because you observe the evolution of that unit. Also, this allows to control for **time-invariant unobserved heterogeneity at the unit level**.\n\nA general representation of a regression using panel data is:\n\n$$Y_{t,i} = \\alpha + \\beta \\times X_{t,i} + \\epsilon_{t,i}$$\n\nNotice that each variable has two subscripts, t represents the year = t, and i represents the unit = i. This type of notation is common in empirical research.\n\n\n\n\n\n\n\n## Functional form of relationships {.smaller}\n\nAs mentioned before, in many cases, you want to use the logarithm of a variable. This changes the interpretation of the coefficients you estimate.\n\nWe have three possible scenarios for regression's functional forms.\n\n- **log-log regression**: both Y and X are in log values $ln(Y) = \\alpha + \\beta \\times ln(X) + \\epsilon$. The interpretation of $\\beta$ in this case is: **$y$ is $\\beta$ percent higher** on average for observations with **one percent higher $x$**.   \n\n\n- **log-level regression**: both Y and X are in log values $ln(Y) = \\alpha + \\beta \\times X + \\epsilon$. The interpretation of $\\beta$ in this case is: **$y$ is $\\beta$ percent higher** on average for observations with **one unit higher $x$**.   \n\n- **level-log regression**: both Y and X are in log values $Y = \\alpha + \\beta \\times ln(X) + \\epsilon$. The interpretation of $\\beta$ in this case is: **$y$ is $\\frac{\\beta}{100}$ units higher** on average for observations with **one percent higher $x$**.   \n\n\n**Important note:** the misspecification of x’s is similar to the omitted variable bias (OVB).\n\n\n\n\n\n\n## OLS {.smaller}\n\nThis is a plain OLS model using the original data (i.e., not winsorized yet).\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nols <- lm(lev1 ~ size1 + fcf_ta + roa + tang_ta + cash_ta + div_ta, data = data)\nsummary(ols)\n```\n\n## OLS {.smaller}\n\n\nA nicer looking table.\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\n\nlibrary(jtools)\nexport_summs(ols, digits = 3 , model.names = c(\"OLS\") )\n```\n\n\n## OLS {.smaller}\n\n\nNow, we are using the winsorized data.\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nw_ols <- lm(w_lev1 ~ w_size1 + w_fcf_ta + w_roa + w_tang_ta + w_cash_ta + w_div_ta, data = data)\n#summary(w_ols)\nexport_summs(ols,w_ols ,model.names = c(\"OLS\",\"OLS (winsorized)\"))\n```\n\n\n\n\n\n\n\n## Heterogeneity across countries  {.smaller}\n\n\nThere is a huge literature on capital structure decisions. Let's see the heterogeneity of leverage across countries. Thus, it makes sense to control for this type of heterogeneity somehow. \n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nlibrary(gplots)\nplotmeans(lev1 ~ country, data = data)\n```\n\n\n\n\n\n\n\n\n\n \n## FE Country  {.smaller}\n\nThe following example uses fixed effects for countries. Notice that one country is missing.\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nfe_c <- lm(lev1 ~ size1 + fcf_ta + roa + tang_ta + cash_ta + div_ta  + factor(country) , data = data)\nexport_summs(fe_c)\n```\n\n\n## FE Country  {.smaller}\n\nNow, we are using fixed effects for countries and years.\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nfe_cy <- lm(lev1 ~ size1 + fcf_ta + roa + tang_ta + cash_ta + div_ta  + factor(country) + factor(year), data = data)\nexport_summs(fe_c, fe_cy)\n```\n\n\n\n## FE Firms  {.smaller}\n\nThe most usual regression we estimate in Accounting & Finance is a panel using firms as units. Imagine that you are including one dummy for each firm, just as we included a dummy for each country in the previous example. This is the way to do it.\n\nThe strength of a firm fixed effect model is that it controls for **time-invariant unobserved heterogeneity at the firm level**. \n\nThat is, if there is an omitted variable in your model (something that is constant over time that you cannot measure because you do not observe, for instance, the quality of the managerial team), you should use firm fixed effects.\n\nFE is a very traditional and accepted solution in this type of research because our models are always a representation of reality, we can never be sure we are controlling for everything that is important. By including a firm FE you are, at least, safe that you are controlling of omitted variables that do not change over time at the firm level. **That is, Firm FE mitigates concerns of omitted variable bias of time-invariant at the firm level**.\n\n\n##   {.smaller}\n\n\nOn top of the firm FE, it is always a good idea to include year FE at the same time, as follows. You do not need to present them in your final paper, but you need to mention them.\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nfe <- plm(w_lev1 ~ w_size1 + w_fcf_ta + w_roa + w_tang_ta + w_cash_ta + w_div_ta + factor(year) , data = data, model=\"within\")\nexport_summs(fe, coefs = c(\"w_size1\",\"w_div_ta\",\"w_fcf_ta\",\"w_roa\",\"w_tang_ta\",\"w_cash_ta\"),  digits = 3 , model.names = c(\"FE\") )\n```\n\n\n##   {.smaller}\n\n\nMore technically (but really not that much), a firm FE model can be represented as follows. That is, you include one fixed term for each firm (again, except for the first firm). Also, I am adding the year FE in the equation below. \n\n$$Y_{t,i} = \\beta \\times X_{t-1,i} + \\alpha_i + \\alpha_t+  \\epsilon_{t,i}$$\n\n\nTechnically, the inclusion of the FE acts as a transformation of Y and X into differences such as $y_{t,i} - \\bar{y_i}$ and $x_{t,i} - \\bar{x_i}$, where $\\bar{y_i}$ is the mean value of y across all time periods for unit i. As a result, in FE regressions, $\\beta$ shows how much larger y is compared to its mean within the cross-sectional unit. That is, compare two observations of x that are different in terms of their value x compared to the i-specific mean. On average, x is larger that average x by $\\beta$.\n\n##   {.smaller}\n\nThus, **a FE model is a within-unit comparison model** and the model is not affected by whether the unit has larger average of X or Y. That is, the estimates are not affected by **unobserved confounders that affect either x or y in the same way in all time periods**.\n\n\n\n##   {.smaller}\n\n**Important question**: Can you include firm FE and country FE at the same time in a regression? **The answer is no**. If you try, all the country FE will be dropped due to colinearity with firm FE.\n\n. . . \n\nFinal notes on FE models:\n\n1) Notice there is no intercept in the table above. The reason is that the model includes $i$ intercepts, one for each firm. In some cases, some  softwares report an intercept value that is the average of all intercepts. But that is of little value to us.\n\n2) There are two possible r-squares in FE models: **within R-squared** and the **R-squared** (the traditional one). The first is more adequate, because the second uses all intercepts as explanatory variables of y and thus overstates the magnitude of the model's explanatory power.\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n## OLS vs FE   {.smaller}\n\nAt the end of the day, you never can be sure that the FE model is better. So, we can test if it is an improvement over OLS, as follows.\n\nIf the p-value low enough then the fixed effects model is the path to go. \n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\npFtest(fe, ols)\n```\n\n\n\n \n\n\n## Random Effects  {.smaller}\n\nAn alternative to FE models is the RE (random effects) models. In FE models, we assume $\\alpha_i$ is correlated with the other X variables. This makes sense since the unobserved time-invariant characteristics of a firm is expected to be correlated with the observed characteristics of that firm.\n\nIf we believe that $\\alpha_i$ is not correlated with X, we should use a RE model. You can estimate as follows.\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nre <- plm(w_lev1 ~ w_size1 + w_fcf_ta + w_roa + w_tang_ta + w_cash_ta + w_div_ta  , data = data, model=\"random\") \nexport_summs(fe, re, coefs = c(\"w_size1\",\"w_div_ta\",\"w_fcf_ta\",\"w_roa\",\"w_tang_ta\",\"w_cash_ta\"),  digits = 3 , model.names = c(\"FE\", \"RE\") )\n```\n\n\n\n## RE vs FE   {.smaller}\n\nIf you want to test which model is best suited to your dataset, you can test as follows. If the p-value is significant then use FE, if not use RE. \n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nphtest(fe, re)\n```\n\n\n\n\n\n\n\n\n\n\n\n## 🙋‍♂️ **Any Questions?**{ .smaller  background=\"#fdf6e3\"}\n\n::: columns\n::: {.column width=\"50%\"}\n### Thank You!\n\n![](figs/qa2.png){width=\"110%\" style=\"box-shadow: none;\"}\n\n:::\n\n::: {.column width=\"50%\"}\n<div style=\"text-align:right;\">\n  <img src=\"figs/avatar.jpg\" width=\"120px\" style=\"border-radius:50%; box-shadow:0 4px 12px rgba(0,0,0,.25);\" />\n</div>\n\n### **Henrique C. Martins**\n\n- 🌐 [FGV/EAESP](https://eaesp.fgv.br/en/people/henrique-castro-martins)  \n- 💼 [LinkedIn](https://www.linkedin.com/in/henriquecastror/)  \n- 🧠 [Google Scholar](https://scholar.google.com.br/citations?user=7gIfkRMAAAAJ&hl=pt-BR&oi=ao)  \n- 📄 [Lattes CV](http://lattes.cnpq.br/6076997472159785)  \n- 🏠 [Personal Website](https://henriquemartins.net/)  \n:::\n:::\n\n","srcMarkdownNoYaml":"\n\n```{r setup}\n#| include: false\n#| warning: false\n\n# library(reticulate)\n# use_python(\"C:/Users/hcmrt/AppData/Local/Programs/Python/Python310/python.exe\")\nlibrary(reticulate)\nlibrary(Statamarkdown)\nlibrary(ggplot2)\nlibrary(dplyr)\nlibrary(ggthemes)\n#reticulate::py_install(\"matplotlib\")\n#reticulate::py_install(\"seaborn\")\n#reticulate::py_install(\"pyfinance\")\n#reticulate::py_install(\"xlrd\")\n#reticulate::py_install(\"quandl\")\n#reticulate::py_install(\"linearmodels\")\n#reticulate::py_install(\"causalml\")\n\n```\n\n\n\n# Panel Data {.smaller}\n\n\n\n## Panel Data {.smaller}\n\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nlibrary(ggplot2)\nlibrary(ggthemes)\nlibrary(readxl) \nlibrary(jtools) # for nice tables of models - https://cran.r-project.org/web/packages/jtools/vignettes/summ.html#summ\ndata <- read_excel(\"files/data.xls\")\n```\n\n\nAfter uploading the data, tell R the data is panel. You need two identifiers: one for the cross-sectional part (usually, firms in accounting & finance research), and other for the time-series part (usually, year but sometimes can be quarter). The following example uses a panel wit quarterly data. \n\nI am also creating an identifier for industries, which might be useful.\n\n\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nlibrary(dplyr)\ndata <- data %>% group_by(id )                %>% dplyr::mutate(id_firm = cur_group_id())\ndata <- data %>% group_by(setor_economatica)  %>% dplyr::mutate(id_ind = cur_group_id())\n```\n\n\n\nNow, I am stating to r that I have a dataset in a panel structure.\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nlibrary(plm)\ndata <- pdata.frame(data, index=c(\"id_firm\",\"year\"))\n```\n\n\n\n\n\n## OLS, Panel, Fixed effects, and Random Effects {.smaller}\n\nLet's attach the dataset to make things easier.\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nattach(data)\n```\n\n\n## {.smaller}\n\n\nLet's inspect the dataset. First, let's see how many observations we have by country:\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nlibrary('plyr')\ncount(country)\n```\n\n## {.smaller}\n\nNow, by year.\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\ncount(year)\n```\n\n\n\n## OLS, Panel, Fixed effects, and Random Effects {.smaller}\n\nNow, by industry.\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\ncount(setor_economatica)\n```\n\n\n\n\n\n\n## Generating variables {.smaller}\n\nLet's generate some variables to use later. \n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\ndata$lev1 <- Debt / (Debt + Equity.market.value)\ndata$lev2 <- Debt / Total.Assets\ndata$wc_ta <- wc  / Total.Assets \ndata$cash_ta <- cash / Total.Assets\ndata$div_ta <- Dividends / Total.Assets\ndata$fcf_ta <- Free.cash.flow / Total.Assets\ndata$tang_ta <- tangible / Total.Assets\ndata$roa2 <- roa / 100\nlibrary(SciViews)\ndata$size1  <- ln(Total.Assets)\n```\n\n\n\n\n## Generating variables {.smaller}\n\n\nNotice that most variables are ratios and thus are expected to fall in the 0-100% range. \n\nThere is one important exception: Size. Size in this example is the **natural logarithm of Total Assets** (sometimes, studies use the natural logarithm of Total Sales). Taking the natural logarithm is a traditional decision in this type of research.\n\nSo, why did I do that in Size but not in the others?\n\n\n## Generating variables {.smaller}\n\n\nIn many cases, you want to use **relative differences or percentages change**. For instance, GDP growth is usually measured as the growth of each year over the previous year. The same is true for stock prices. \n\n$$GDP\\; growth = \\frac{GDP_t - GDP_{t-1}}{GDP`{t-1}}$$\n\nThis is possible because you always have a previous value to use as base for comparison.\n\n\n\n\n## Generating variables {.smaller}\n\n\nIn many cases, you do not have such base for comparison. This is the case of a firm's Total Assets. What is the natural base for Total Assets? No answer.\n\nTherefore, you take the natural logarithm so that you minimize this concern. \n\nAdditionally, keep in mind that the empirical values of Total Assets are often very dissimilar and with huge magnitude. Consider two firms, one with 1 million of total assets, the other with 1 billion. Assume that both firms increased throughout one year their total assets by 1 million. The first firm is twice the size of before, but 1 million make little difference for a billion dollar firm. Taking the logarithm helps you to have a similar base and mitigate the magnitude effect of these changes.\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n## Summary statistics {.smaller}\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nlibrary(vtable)\nsumtable(data, vars = c('lev1' , 'lev2' , 'wc_ta', 'cash_ta',  'size1'  , 'fcf_ta' , 'div_ta', 'roa' , 'tang_ta'))\n```\n\n\n\n\n## Winsorization {.smaller}\n\nSome of the variables have weird values. For instance, the variable $\\frac{Free cash flow}{Total Assets}$ has a maximum value of 817. It means that there is one firm-year observation in which the cash flow of that firm in that year is 817 times the firm's total assets. This is very odd to say the least. \n\nTo avoid this type of problem, we can winsorize our variables.\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nlibrary(DescTools)\ndata$w_lev1     <- Winsorize(data$lev1   , probs = c(0.01, 0.99) , na.rm = TRUE) \ndata$w_lev2     <- Winsorize(data$lev2   , probs = c(0.01, 0.99) , na.rm = TRUE) \ndata$w_wc_ta    <- Winsorize(data$wc_ta  , probs = c(0.01, 0.99) , na.rm = TRUE) \ndata$w_cash_ta  <- Winsorize(data$cash_ta, probs = c(0.01, 0.99) , na.rm = TRUE) \ndata$w_size1    <- Winsorize(data$size1  , probs = c(0.01, 0.99) , na.rm = TRUE) \ndata$w_fcf_ta   <- Winsorize(data$fcf_ta , probs = c(0.01, 0.99) , na.rm = TRUE) \ndata$w_div_ta   <- Winsorize(data$div_ta , probs = c(0.01, 0.99) , na.rm = TRUE) \ndata$w_roa      <- Winsorize(data$roa    , probs = c(0.01, 0.99) , na.rm = TRUE) \ndata$w_tang_ta  <- Winsorize(data$tang_ta, probs = c(0.01, 0.99) , na.rm = TRUE) \n```\n\n\n\n## Panel data {.smaller}\n\nMultiple times are always helpful. That is, in a panel dataset, you have many observations of the same unit in different time periods. This is helpful because you observe the evolution of that unit. Also, this allows to control for **time-invariant unobserved heterogeneity at the unit level**.\n\nA general representation of a regression using panel data is:\n\n$$Y_{t,i} = \\alpha + \\beta \\times X_{t,i} + \\epsilon_{t,i}$$\n\nNotice that each variable has two subscripts, t represents the year = t, and i represents the unit = i. This type of notation is common in empirical research.\n\n\n\n\n\n\n\n## Functional form of relationships {.smaller}\n\nAs mentioned before, in many cases, you want to use the logarithm of a variable. This changes the interpretation of the coefficients you estimate.\n\nWe have three possible scenarios for regression's functional forms.\n\n- **log-log regression**: both Y and X are in log values $ln(Y) = \\alpha + \\beta \\times ln(X) + \\epsilon$. The interpretation of $\\beta$ in this case is: **$y$ is $\\beta$ percent higher** on average for observations with **one percent higher $x$**.   \n\n\n- **log-level regression**: both Y and X are in log values $ln(Y) = \\alpha + \\beta \\times X + \\epsilon$. The interpretation of $\\beta$ in this case is: **$y$ is $\\beta$ percent higher** on average for observations with **one unit higher $x$**.   \n\n- **level-log regression**: both Y and X are in log values $Y = \\alpha + \\beta \\times ln(X) + \\epsilon$. The interpretation of $\\beta$ in this case is: **$y$ is $\\frac{\\beta}{100}$ units higher** on average for observations with **one percent higher $x$**.   \n\n\n**Important note:** the misspecification of x’s is similar to the omitted variable bias (OVB).\n\n\n\n\n\n\n## OLS {.smaller}\n\nThis is a plain OLS model using the original data (i.e., not winsorized yet).\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nols <- lm(lev1 ~ size1 + fcf_ta + roa + tang_ta + cash_ta + div_ta, data = data)\nsummary(ols)\n```\n\n## OLS {.smaller}\n\n\nA nicer looking table.\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\n\nlibrary(jtools)\nexport_summs(ols, digits = 3 , model.names = c(\"OLS\") )\n```\n\n\n## OLS {.smaller}\n\n\nNow, we are using the winsorized data.\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nw_ols <- lm(w_lev1 ~ w_size1 + w_fcf_ta + w_roa + w_tang_ta + w_cash_ta + w_div_ta, data = data)\n#summary(w_ols)\nexport_summs(ols,w_ols ,model.names = c(\"OLS\",\"OLS (winsorized)\"))\n```\n\n\n\n\n\n\n\n## Heterogeneity across countries  {.smaller}\n\n\nThere is a huge literature on capital structure decisions. Let's see the heterogeneity of leverage across countries. Thus, it makes sense to control for this type of heterogeneity somehow. \n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nlibrary(gplots)\nplotmeans(lev1 ~ country, data = data)\n```\n\n\n\n\n\n\n\n\n\n \n## FE Country  {.smaller}\n\nThe following example uses fixed effects for countries. Notice that one country is missing.\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nfe_c <- lm(lev1 ~ size1 + fcf_ta + roa + tang_ta + cash_ta + div_ta  + factor(country) , data = data)\nexport_summs(fe_c)\n```\n\n\n## FE Country  {.smaller}\n\nNow, we are using fixed effects for countries and years.\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nfe_cy <- lm(lev1 ~ size1 + fcf_ta + roa + tang_ta + cash_ta + div_ta  + factor(country) + factor(year), data = data)\nexport_summs(fe_c, fe_cy)\n```\n\n\n\n## FE Firms  {.smaller}\n\nThe most usual regression we estimate in Accounting & Finance is a panel using firms as units. Imagine that you are including one dummy for each firm, just as we included a dummy for each country in the previous example. This is the way to do it.\n\nThe strength of a firm fixed effect model is that it controls for **time-invariant unobserved heterogeneity at the firm level**. \n\nThat is, if there is an omitted variable in your model (something that is constant over time that you cannot measure because you do not observe, for instance, the quality of the managerial team), you should use firm fixed effects.\n\nFE is a very traditional and accepted solution in this type of research because our models are always a representation of reality, we can never be sure we are controlling for everything that is important. By including a firm FE you are, at least, safe that you are controlling of omitted variables that do not change over time at the firm level. **That is, Firm FE mitigates concerns of omitted variable bias of time-invariant at the firm level**.\n\n\n##   {.smaller}\n\n\nOn top of the firm FE, it is always a good idea to include year FE at the same time, as follows. You do not need to present them in your final paper, but you need to mention them.\n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nfe <- plm(w_lev1 ~ w_size1 + w_fcf_ta + w_roa + w_tang_ta + w_cash_ta + w_div_ta + factor(year) , data = data, model=\"within\")\nexport_summs(fe, coefs = c(\"w_size1\",\"w_div_ta\",\"w_fcf_ta\",\"w_roa\",\"w_tang_ta\",\"w_cash_ta\"),  digits = 3 , model.names = c(\"FE\") )\n```\n\n\n##   {.smaller}\n\n\nMore technically (but really not that much), a firm FE model can be represented as follows. That is, you include one fixed term for each firm (again, except for the first firm). Also, I am adding the year FE in the equation below. \n\n$$Y_{t,i} = \\beta \\times X_{t-1,i} + \\alpha_i + \\alpha_t+  \\epsilon_{t,i}$$\n\n\nTechnically, the inclusion of the FE acts as a transformation of Y and X into differences such as $y_{t,i} - \\bar{y_i}$ and $x_{t,i} - \\bar{x_i}$, where $\\bar{y_i}$ is the mean value of y across all time periods for unit i. As a result, in FE regressions, $\\beta$ shows how much larger y is compared to its mean within the cross-sectional unit. That is, compare two observations of x that are different in terms of their value x compared to the i-specific mean. On average, x is larger that average x by $\\beta$.\n\n##   {.smaller}\n\nThus, **a FE model is a within-unit comparison model** and the model is not affected by whether the unit has larger average of X or Y. That is, the estimates are not affected by **unobserved confounders that affect either x or y in the same way in all time periods**.\n\n\n\n##   {.smaller}\n\n**Important question**: Can you include firm FE and country FE at the same time in a regression? **The answer is no**. If you try, all the country FE will be dropped due to colinearity with firm FE.\n\n. . . \n\nFinal notes on FE models:\n\n1) Notice there is no intercept in the table above. The reason is that the model includes $i$ intercepts, one for each firm. In some cases, some  softwares report an intercept value that is the average of all intercepts. But that is of little value to us.\n\n2) There are two possible r-squares in FE models: **within R-squared** and the **R-squared** (the traditional one). The first is more adequate, because the second uses all intercepts as explanatory variables of y and thus overstates the magnitude of the model's explanatory power.\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n## OLS vs FE   {.smaller}\n\nAt the end of the day, you never can be sure that the FE model is better. So, we can test if it is an improvement over OLS, as follows.\n\nIf the p-value low enough then the fixed effects model is the path to go. \n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\npFtest(fe, ols)\n```\n\n\n\n \n\n\n## Random Effects  {.smaller}\n\nAn alternative to FE models is the RE (random effects) models. In FE models, we assume $\\alpha_i$ is correlated with the other X variables. This makes sense since the unobserved time-invariant characteristics of a firm is expected to be correlated with the observed characteristics of that firm.\n\nIf we believe that $\\alpha_i$ is not correlated with X, we should use a RE model. You can estimate as follows.\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nre <- plm(w_lev1 ~ w_size1 + w_fcf_ta + w_roa + w_tang_ta + w_cash_ta + w_div_ta  , data = data, model=\"random\") \nexport_summs(fe, re, coefs = c(\"w_size1\",\"w_div_ta\",\"w_fcf_ta\",\"w_roa\",\"w_tang_ta\",\"w_cash_ta\"),  digits = 3 , model.names = c(\"FE\", \"RE\") )\n```\n\n\n\n## RE vs FE   {.smaller}\n\nIf you want to test which model is best suited to your dataset, you can test as follows. If the p-value is significant then use FE, if not use RE. \n\n\n```{r}\n#| warning: false\n#| message: false\n#| fig-align: center\n#| echo: true\n#| output-location: default\n#| code-fold: false\n#| code-summary: \"R\"\n#| code-line-numbers: true\n#| eval: true\nphtest(fe, re)\n```\n\n\n\n\n\n\n\n\n\n\n\n## 🙋‍♂️ **Any Questions?**{ .smaller  background=\"#fdf6e3\"}\n\n::: columns\n::: {.column width=\"50%\"}\n### Thank You!\n\n![](figs/qa2.png){width=\"110%\" style=\"box-shadow: none;\"}\n\n:::\n\n::: {.column width=\"50%\"}\n<div style=\"text-align:right;\">\n  <img src=\"figs/avatar.jpg\" width=\"120px\" style=\"border-radius:50%; box-shadow:0 4px 12px rgba(0,0,0,.25);\" />\n</div>\n\n### **Henrique C. Martins**\n\n- 🌐 [FGV/EAESP](https://eaesp.fgv.br/en/people/henrique-castro-martins)  \n- 💼 [LinkedIn](https://www.linkedin.com/in/henriquecastror/)  \n- 🧠 [Google Scholar](https://scholar.google.com.br/citations?user=7gIfkRMAAAAJ&hl=pt-BR&oi=ao)  \n- 📄 [Lattes CV](http://lattes.cnpq.br/6076997472159785)  \n- 🏠 [Personal Website](https://henriquemartins.net/)  \n:::\n:::\n\n"},"formats":{"revealjs":{"identifier":{"display-name":"RevealJS","target-format":"revealjs","base-format":"revealjs"},"execute":{"fig-width":10,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":false,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":true,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","html-math-method":{"method":"mathjax","url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML-full"},"slide-level":2,"to":"revealjs","css":["logo.css"],"output-file":"part_O6.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"lang":"en","fig-responsive":false,"quarto-version":"1.4.549","auto-stretch":true,"html":{"css":"webex.css","include-after-body":"webex.js"},"editor":"visual","title":"Empirical Methods in Finance","subtitle":"Practicing 6","author":"Henrique C. Martins","title-slide-attributes":{"data-background-color":"#b1cafa"},"include-after":["<script type=\"text/javascript\">\n  Reveal.on('ready', event => {\n    if (event.indexh === 0) {\n      document.querySelector(\"div.has-logo > img.slide-logo\").style.display = \"none\";\n    }\n  });\n  Reveal.addEventListener('slidechanged', (event) => {\n    if (event.indexh === 0) {\n      Reveal.configure({ slideNumber: null });\n      document.querySelector(\"div.has-logo > img.slide-logo\").style.display = \"none\";\n    }\n    if (event.indexh === 1) {\n      Reveal.configure({ slideNumber: 'c' });\n      document.querySelector(\"div.has-logo > img.slide-logo\").style.display = null;\n    }\n  });\n</script>\n"],"slideNumber":true,"theme":"simple","chalkboard":true,"previewLinks":"auto","logo":"figs/background8.png","footer":"**[**Henrique C. Martins**] [[henrique.martins@fgv.br](mailto:henrique.martins@fgv.br)][Do not use without permission]**  ","multiplex":true,"scrollable":true}}},"projectFormats":["html"]}