---
title: "Exerc√≠cio com Login"
format: html
runtime: shiny
---

```{r}
#| eval: true
#| results: asis
#| echo: false
#| warning: false
# Instale os pacotes antes se necessC!rio
# install.packages(c("shiny", "shinyauthr", "openxlsx"))
# install.packages("googledrive")

library(shiny)
library(shinyauthr)
library(openxlsx)

# Dados de autenticaC'C#o
user_base <- data.frame(
  user = c("aluno1", "aluno2"),
  password = c("senha1", "senha2"),
  stringsAsFactors = FALSE
)

ui <- fluidPage(
  titlePanel("ExercC-cio de FinanC'as"),
  
  shinyauthr::loginUI("login"),
  
  uiOutput("exercicio_ui"),
  
  verbatimTextOutput("resposta")
)

server <- function(input, output, session) {
  # MC3dulo de login
  credentials <- shinyauthr::loginServer(
    id = "login",
    data = user_base,
    user_col = user,
    pwd_col = password,
    log_out = reactive(logout_init())
  )
  
  logout_init <- reactiveVal(FALSE)
  
  output$exercicio_ui <- renderUI({
    req(credentials()$user_auth)
    
    tagList(
      h3("ExercC-cio: Valor Esperado"),
      p("Uma empresa tem duas possibilidades de resultado daqui a um ano:"),
      tags$ul(
        tags$li("Lucro de R$ 1.000 mil com 60% de chance."),
        tags$li("Lucro de R$ 500 mil com 40% de chance.")
      ),
      p("Qual C) o valor esperado do lucro?"),
      numericInput("resposta", "Sua resposta (em R$ mil):", value = NA),
      actionButton("enviar", "Enviar Resposta"),
      actionButton("logout", "Logout")
    )
  })
  
  observeEvent(input$enviar, {
    req(credentials()$user_auth)
    resposta <- input$resposta
    usuario <- credentials()$info$user
    
    df <- data.frame(
      usuario = usuario,
      resposta = resposta,
      data_hora = Sys.time(),
      stringsAsFactors = FALSE
    )
    
    # Se o arquivo jC! existir, adiciona; senC#o, cria
    arquivo <- "respostas_alunos.xlsx"
    if (file.exists(arquivo)) {
      wb <- loadWorkbook(arquivo)
      addWorksheet(wb, sheetName = usuario)
      writeData(wb, usuario, df)
      saveWorkbook(wb, arquivo, overwrite = TRUE)
    } else {
      wb <- createWorkbook()
      addWorksheet(wb, sheetName = usuario)
      writeData(wb, usuario, df)
      saveWorkbook(wb, arquivo)
    }
    
    showModal(modalDialog(
      title = "Resposta Enviada",
      "Sua resposta foi salva com sucesso!",
      easyClose = TRUE
    ))
  })
  
  observeEvent(input$logout, {
    logout_init(TRUE)
  })
  
  output$resposta <- renderPrint({
    req(credentials()$user_auth)
    paste("UsuC!rio:", credentials()$info$user)
  })
}

shinyApp(ui, server)
```

