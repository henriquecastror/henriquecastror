<!-- checkout2.html — Check-out → Cloudflare Worker (JSON, CORS-safe) -->
<style>
  /* ====== Tokens (light) — exit-checkout colors ====== */
  :root{
    --card-bg: #ffffff;
    --card-border: rgba(15,23,42,.06);
    --card-shadow: 0 12px 30px rgba(17,24,39,.12);

    --ink: #0b1220;
    --muted: #3a4a5c;
    --muted-2: #2b3a4a;
    --line: #e9eef5;
    --pill-bg: #f5f9ff;

    --focus: rgba(59,130,246,.22);

    --btn-bg-1: #4f46e5;
    --btn-bg-2: #60a5fa;
    --btn-ink: #ffffff;

    --textarea-bg: #ffffff;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --card-bg: rgba(15,23,42,.92);
      --card-border: rgba(148,163,184,.20);
      --card-shadow: 0 16px 44px rgba(0,0,0,.55);
      --line: rgba(148,163,184,.28);
      --pill-bg: rgba(148,163,184,.18);

      --ink: #f8fafc;
      --muted: #e5edf6;
      --muted-2: #f1f5f9;

      --btn-bg-1: #5b7fff;
      --btn-bg-2: #7cc5ff;
      --btn-ink: #0b1220;

      --textarea-bg: rgba(2,6,23,.55);
    }
  }

  /* ====== Card ====== */
  [data-ticket] .tw-card{
    position: relative;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 16px;
    padding: 16px;
    box-shadow: var(--card-shadow);
    backdrop-filter: saturate(120%) blur(6px);
    -webkit-backdrop-filter: saturate(120%) blur(6px);
    color: var(--ink);
    overflow: hidden;
    box-sizing: border-box;
  }
  [data-ticket] .tw-card::before{
    content:"";
    position:absolute; inset:0 0 auto 0; height:56px;
    background: linear-gradient(135deg, rgba(99,102,241,.14), rgba(96,165,250,.14));
    pointer-events:none;
  }

  /* ====== Header ====== */
  [data-ticket] .tw-header{ display:flex; align-items:center; gap:12px; margin-bottom:10px; position:relative; z-index:1; }
  [data-ticket] .tw-icon{
    width:36px; height:36px; border-radius:12px; background:#1f2937;
    display:grid; place-items:center; flex:0 0 36px; box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
    position: relative;
  }
  [data-ticket] .tw-icon::after{
    content:""; position:absolute; inset:-3px; border-radius:14px;
    background: conic-gradient(from 120deg, rgba(79,70,229,.35), rgba(6,182,212,.35), rgba(79,70,229,.35));
    z-index:-1; filter: blur(6px); opacity:.55;
  }
  [data-ticket] .tw-icon svg{ width:18px; height:18px; color:#fff; opacity:.96; }

  [data-ticket] .tw-titles{ display:flex; flex-direction:column; gap:2px; }
  [data-ticket] .tw-title{ font-weight:800; color:var(--ink); line-height:1.1; letter-spacing:.2px; }
  [data-ticket] .tw-sub{ color:var(--muted); font-size:.92rem; }

  /* ====== Meta / badges ====== */
  [data-ticket] .tw-meta{ margin-left:auto; display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  [data-ticket] .tw-badge{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border:1px solid var(--line); border-radius:999px;
    background: var(--pill-bg); color: var(--muted-2);
    font-size:.88rem; white-space:nowrap; box-shadow: 0 1px 0 rgba(17,24,39,.04) inset;
  }
  [data-ticket] .tw-badge svg, [data-ticket] .tw-badge svg *, [data-ticket] .tw-badge .tw-window-text{
    color: currentColor; stroke: currentColor !important; fill: none;
  }
  [data-ticket] .tw-window-text{ white-space: pre-line; }

  /* ====== Dots / status ====== */
  [data-ticket] .tw-dot{ width:8px; height:8px; border-radius:50%; background:#94a3b8; }
  [data-ticket].open  .tw-dot{ background:#16a34a; }
  [data-ticket].soon  .tw-dot{ background:#f59e0b; }
  [data-ticket].closed .tw-dot{ background:#ff4d4f; }

  /* ====== Textarea ====== */
  [data-ticket] .tw-body{ position:relative; z-index:1; box-sizing:border-box; }
  [data-ticket] textarea.tw-text{
    width:100%; border:1px solid var(--line); background:var(--textarea-bg);
    border-radius:14px; padding:12px 14px; font-size:1rem; line-height:1.5; outline:none;
    transition:border-color .15s, box-shadow .15s, transform .06s;
    min-height:120px; resize:vertical; color: var(--ink);
    box-sizing:border-box;
  }
  [data-ticket] textarea.tw-text:focus{ border-color:#60a5fa; box-shadow:0 0 0 4px var(--focus); transform:translateY(-1px); }
  [data-ticket] textarea.tw-text::placeholder{ color:#60758a; opacity:.9; }

  /* ====== Footer ====== */
  [data-ticket] .tw-footer{ display:flex; align-items:center; gap:12px; margin-top:12px; }
  [data-ticket] .tw-count{ margin-left:auto; color:#60758a; font-size:.86rem; }

  /* ====== Messages ====== */
  [data-ticket] .tw-msg{
    margin-top:8px; font-size:.93rem; min-height:1.2em;
    font-weight:700; letter-spacing:.2px;
  }
  [data-ticket] .tw-msg.error,
  [data-ticket] .tw-msg[style*="b91c1c"],
  [data-ticket] .tw-msg[style*="rgb(185, 28, 28)"]{
    color:#ff4d4f !important;
    text-shadow:0 0 3px rgba(255,77,79,.40);
  }
  [data-ticket] .tw-msg.warning{ color:#f59e0b !important; text-shadow:0 0 3px rgba(245,158,11,.40); }
  [data-ticket] .tw-msg.success,
  [data-ticket] .tw-msg[style*="065f46"]{
    color:#059669 !important;
    text-shadow:0 0 1px rgba(255,255,255,.18);
  }

  /* ====== Button ====== */
  [data-ticket] .tw-btn{
    padding:10px 16px; border-radius:12px; border:1px solid rgba(15,23,42,.12);
    background: linear-gradient(135deg, var(--btn-bg-1), var(--btn-bg-2));
    color: var(--btn-ink); font-weight:800; cursor:pointer;
    box-shadow: 0 4px 14px rgba(59,130,246,.25);
    transition: transform .08s ease, box-shadow .15s ease, filter .15s ease;
    letter-spacing:.2px;
  }
  [data-ticket] .tw-btn:hover{ transform:translateY(-1px); box-shadow:0 8px 22px rgba(59,130,246,.35); filter:saturate(108%); }
  [data-ticket] .tw-btn:focus-visible{ outline:none; box-shadow:0 0 0 4px var(--focus); }
  [data-ticket] .tw-btn:disabled{
    opacity:.85; cursor:not-allowed; transform:none;
    background:#e5f0ff; color:#6b7280; border-color:#dbeafe; box-shadow:none;
  }
  [data-ticket] .tw-btn.sent{ opacity:.92; cursor:default; }

  /* Spinner */
  [data-ticket] .spin:after{
    content:""; display:inline-block; width:14px; height:14px; margin-left:8px;
    border:2px solid rgba(255,255,255,.65); border-top-color:transparent;
    border-radius:50%; animation:twspin .8s linear infinite; vertical-align:-2px;
  }
  @keyframes twspin{ to{ transform:rotate(360deg) } }

  /* ====== Responsive ====== */
  @media (max-width:640px){
    [data-ticket] .tw-card{ border-radius:14px; padding:14px; }
    [data-ticket] .tw-header{ gap:10px; }
    [data-ticket] .tw-icon{ width:34px; height:34px; border-radius:11px; }
    [data-ticket] .tw-meta{ gap:6px; }
    [data-ticket] .tw-badge{ padding:5px 9px; font-size:.82rem; }
  }

  /* === Message color matches the status dot exactly === */
  [data-ticket].open  .tw-msg  { color: #16a34a !important; }
  [data-ticket].soon  .tw-msg  { color: #f59e0b !important; }
  [data-ticket].closed .tw-msg { color: #ff4d4f !important; }
</style>

<script>
(() => {
  function mountAll(){
    const hosts = document.querySelectorAll('[data-ticket]:not([data-tw-mounted])');
    if (!hosts.length) return;
    hosts.forEach(initOne);
  }

  function initOne(host){
    host.setAttribute('data-tw-mounted','1');

    // ===== ENDPOINT DO WORKER =====
    // 1) data-bridge="https://seu-worker/checkouts" (prioridade)
    // 2) window.BRIDGE_URL (fallback global)
    const bridge = (host.getAttribute('data-bridge') || window.BRIDGE_URL || '').trim();

    // Somente CHECK-OUT
    const sessionTag  = (host.getAttribute('data-session') || '').trim();
    const pageAttr    = (host.getAttribute('data-page') || '').trim(); // recomendado p/ diferenciar múltiplos
    const winStartStr = (host.getAttribute('data-open') || '').trim();
    const winEndStr   = (host.getAttribute('data-close') || '').trim();
    const requireLogin= String(host.getAttribute('data-require-login') || 'true').toLowerCase() !== 'false';

    // Helpers de tempo (janela local)
    function parseLocal(ts){ return ts ? new Date(ts.replace(' ','T')) : null; }
    const winStart = parseLocal(winStartStr);
    const winEnd   = parseLocal(winEndStr);

    function fmtDur(s){
      const m = Math.floor(s/60), r = s%60;
      if (m >= 60){ const h = Math.floor(m/60), mm = m%60; return h+'h '+mm+'m'; }
      if (m > 0) return m+'m '+r+'s';
      return r+'s';
    }
    function statusNow(){
      const now = new Date();
      if (!winStart || !winEnd) return {state:'open', label:'Always available'};
      if (now < winStart){ const s1 = Math.max(0, Math.floor((winStart - now)/1000)); return {state:'soon', label:'Opens in '+fmtDur(s1)}; }
      if (now > winEnd)  return {state:'closed', label:'Closed'};
      const s2 = Math.max(0, Math.floor((winEnd - now)/1000)); return {state:'open', label:'Closes in '+fmtDur(s2)};
    }

    // Identidade do aluno e página
    function getStudentId(){
      const a = window.studentId || localStorage.getItem('studentId') || localStorage.getItem('fs_user') || '';
      return String(a||'').trim();
    }
    function getPageId(){
      return pageAttr || window.pageId || (location.pathname + location.hash);
    }

    function setMsg(el, t){ el.textContent = t || ''; }

    // Chave local p/ impedir reenvio
    function doneKey(){
      const sid = getStudentId() || 'anon';
      const scope = (sessionTag || getPageId() || 'page');
      return 'ticket_done:exit:' + scope + ':' + sid;
    }
    function isDone(){
      try { return localStorage.getItem(doneKey()) === '1'; } catch(_) { return false; }
    }
    function markDone(btn){
      try{ localStorage.setItem(doneKey(), '1'); }catch(_){}
      btn.classList.remove('spin');
      btn.disabled = true;
      btn.classList.add('sent');
      btn.textContent = 'Sent ✓';
    }

    // ===== UI =====
    host.innerHTML = '';
    const card = document.createElement('div'); card.className = 'tw-card';
    const windowLabel = (winStartStr && winEndStr) ? (winStartStr + '\n→ ' + winEndStr) : 'No window set';
    card.innerHTML =
      '<div class="tw-header">'+
        '<div class="tw-icon" aria-hidden="true">'+
          '<svg viewBox="0 0 24 24" fill="none"><path d="M12 8v5l3 3M6 3h12a1 1 0 0 1 1 1v16l-7-3-7 3V4a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>'+
        '</div>'+
        '<div class="tw-titles">'+
          '<div class="tw-title">Check-out</div>'+
          '<div class="tw-sub"></div>'+
        '</div>'+
        '<div class="tw-meta">'+
          '<div class="tw-badge"><span class="tw-dot"></span><span class="tw-badge-text">—</span></div>'+
          '<div class="tw-badge" title="São Paulo time">'+
            '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" style="opacity:.8"><path d="M12 7v5l4 2" stroke="#334155" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="9" stroke="#334155" stroke-width="1.5" fill="none"/></svg>'+
            '<span class="tw-window-text">'+windowLabel+'</span>'+
          '</div>'+
        '</div>'+
      '</div>'+
      '<div class="tw-body"></div>'+
      '<div class="tw-footer">'+
        '<button class="tw-btn tw-send">Send (click only 1x)</button>'+
        '<div class="tw-count">0/500</div>'+
      '</div>'+
      '<div class="tw-msg"></div>';
    host.appendChild(card);

    const body   = host.querySelector('.tw-body');
    const btn    = host.querySelector('.tw-send');
    const msg    = host.querySelector('.tw-msg');
    const badgeText = host.querySelector('.tw-badge-text');
    const count  = host.querySelector('.tw-count');

    const successMsg = 'Check-out recorded. Thank you!';
    const dupMsg     = 'You have already completed the check-out for this session. Thanks!';

    // Único campo: textarea (check-out)
    const ta = document.createElement('textarea');
    ta.className = 'tw-text'; ta.maxLength = 500;
    ta.placeholder = 'Your check-out (max 500): one thing you learned + one question…';
    body.appendChild(ta);
    ta.addEventListener('input', function(){
      if (count) count.textContent = ta.value.length + '/500';
      syncEnabled();
    });

    function paintBadge(){
      const st = statusNow();
      host.classList.remove('open','soon','closed');
      host.classList.add(st.state);
      badgeText.textContent = st.label;
    }

    function syncEnabled(){
      const logged = !requireLogin || !!getStudentId();
      const st = statusNow().state;
      const filled = ta && ta.value.trim().length>0;
      const enabled = logged && (st==='open') && filled && !isDone();

      btn.disabled = !enabled;

      if (isDone()){
        setMsg(msg, dupMsg);
        btn.textContent = 'Sent ✓';
        btn.classList.add('sent');
        btn.disabled = true;
        return;
      }

      if (!logged) setMsg(msg,'Please log in to submit.');
      else if (st==='soon') setMsg(msg,'Not open yet.');
      else if (st==='closed') setMsg(msg,'This activity is closed.');
      else if (!filled) setMsg(msg,'Write something to submit.');
      else setMsg(msg,'');
    }

    paintBadge();
    syncEnabled();

    // Atualiza contador/estado da janela
    const ticker = setInterval(function(){ paintBadge(); syncEnabled(); }, 1000);
    const obs = new MutationObserver(function(){ if(!document.body.contains(host)){ clearInterval(ticker); obs.disconnect(); } });
    obs.observe(document.body, {childList:true, subtree:true});

    document.addEventListener('auth:login', syncEnabled);

    // ===== Envio JSON → Worker =====
    btn.addEventListener('click', async function(){
      const sid = getStudentId();
      if (requireLogin && !sid){ setMsg(msg,'Please log in to submit.'); return; }
      const text = (ta.value || '').trim().slice(0,500);
      if (!text){ setMsg(msg,'Write something to submit.'); return; }
      if (!bridge){ setMsg(msg,'Missing BRIDGE URL.'); return; }

      btn.classList.add('spin'); btn.disabled = true; setMsg(msg,'');

      // Corpo que o Worker espera em POST /checkouts
      const payload = {
        student:   sid,                                 // Worker aceita student OU student_id
        slide_id:  (sessionTag || getPageId()),         // chave de unicidade com student
        ticket:    text,                                // conteúdo do check-out
        tsClient:  new Date().toISOString(),            // opcional
        open:      winStartStr,                         // p/ validação de janela no servidor
        close:     winEndStr,
        // userAgent é lido do header server-side; mandar também não atrapalha
        user_agent: navigator.userAgent
      };

      try{
        const res  = await fetch(bridge, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          keepalive: true
        });

        const textResp = await res.text();
        let data = null; try{ data = JSON.parse(textResp); }catch(_){}

        if (!res.ok){
          // casos especiais: janela fechada (403)
          if (data && data.status === 'closed_window'){
            setMsg(msg, 'This activity is closed now.');
          } else {
            setMsg(msg, 'Failed to submit. Please try again.');
          }
          console.error('[checkout] HTTP error:', res.status, textResp);
          btn.classList.remove('spin'); btn.disabled = false; btn.textContent = 'Send (click only 1x)';
          return;
        }

        // Tratamento de respostas do Worker
        if (data && data.status === 'success'){
          setMsg(msg, successMsg);
          ta.value=''; if (count) count.textContent='0/500';
          markDone(btn);
          return;
        }
        if (data && data.status === 'duplicate'){
          setMsg(msg, dupMsg);
          markDone(btn);
          return;
        }
        if (data && data.status === 'closed_window'){
          setMsg(msg, 'This activity is closed now.');
          btn.classList.remove('spin'); btn.disabled = false; btn.textContent = 'Send (click only 1x)';
          return;
        }

        // Genérico
        setMsg(msg, 'Failed to submit. Please try again.');
        console.error('[checkout] unexpected response:', textResp);
        btn.classList.remove('spin'); btn.disabled = false; btn.textContent = 'Send (click only 1x)';

      }catch(e){
        console.error('[checkout] submit error:', e);
        setMsg(msg,'Network error. Please try again.');
        btn.classList.remove('spin'); btn.disabled = false; btn.textContent = 'Send (click only 1x)';
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', mountAll, { once:true });
  } else {
    mountAll();
  }
})();
</script>
