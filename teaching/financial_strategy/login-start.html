<!-- === login-start.html (com prote√ß√£o para p√°ginas e slides + turbo) === -->

<style>
  /* Card padr√£o (p√°ginas normais) */
  #login-form {
    max-width: 300px;
    margin: 100px auto 40px auto;
    padding: 20px;
    border: 1px solid #ccc;
    border-radius: 10px;
    font-family: sans-serif;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    background: #fff;
    box-sizing: border-box;
  }
  #login-form input {
    width: 100%; padding: 10px; margin: 6px 0;
    border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;
  }
  #login-form button {
    width: 100%; padding: 10px; margin-top: 10px;
    background-color: #0066cc; color: #fff; border: 0; border-radius: 5px; cursor: pointer;
  }
  #login-error { color: red; text-align: center; margin-top: 10px; }
  #loading-msg{ display:none; text-align:center; margin-top:10px; color:gray; }

  /* Desabilitado durante autentica√ß√£o */
  #login-form button:disabled { opacity:.6; cursor:not-allowed; }
  #login-form input:disabled  { opacity:.7; }

  /* Conte√∫do de p√°ginas normais (fica atr√°s do login at√© destravar) */
  html.locked #after-login-content,
  body.locked #after-login-content { display: none !important; }

  /* Slides (Reveal.js): desfoca deck e bloqueia intera√ß√£o */
  html.locked.reveal-page .reveal,
  body.locked.reveal-page .reveal { filter: blur(4px); pointer-events: none; user-select: none; }

  #login-scrim { display:none; }
  html.locked.reveal-page #login-scrim,
  body.locked.reveal-page #login-scrim{
    display:block; position:fixed; inset:0; background:rgba(255,255,255,.92); z-index:9998;
  }
  html.locked.reveal-page #login-form,
  body.locked.reveal-page #login-form{
    position: fixed; top:50%; left:50%; transform: translate(-50%,-50%);
    margin:0; max-width:340px; width:min(340px,92vw); z-index:9999;
  }

  /* (Opcional) Para ocultar totalmente os slides em vez de s√≥ blur, descomente: */
  /* html.locked.reveal-page .reveal .slides,
     body.locked.reveal-page .reveal .slides { visibility: hidden; } */

  /* Oculta o "Welcome" nos slides */
  .reveal-page #welcome-message { display: none !important; }

  /* Remember me */
  .remember-row{
    display:flex; align-items:center; gap:8px; margin-top:6px; font-size:.95rem; color:#444; white-space:nowrap;
  }
  .remember-row label{ display:flex; align-items:center; gap:6px; cursor:pointer; }
</style>
<style>
  /* Fallback duro para p√°ginas comuns: esconde TUDO (qualquer descendente) menos o form/scrim
     enquanto locked. Evita vazamentos quando o Quarto cria cont√™ineres intermedi√°rios. */
  html.locked body:not(.reveal-page) :not(#login-form):not(#login-form *):not(#login-scrim):not(script):not(style):not(link) {
    display: none !important;
  }

  /* Garante que o form fique acima de qualquer layout do tema */
  #login-form { position: relative; z-index: 10000; }
  #login-scrim { z-index: 9998; }
</style>

<style>
  /* Scrim e formul√°rio fixos tamb√©m em p√°ginas N√ÉO-reveal enquanto locked */
  html.locked #login-scrim,
  body.locked #login-scrim {
    display: block !important;
    position: fixed !important;
    inset: 0 !important;
    background: #ffffff !important;   /* pode usar rgba(255,255,255,.96) se quiser s√≥ "lavar" */
    z-index: 2147483646 !important;    /* bem acima de qualquer layout do tema */
  }

  html.locked #login-form,
  body.locked #login-form {
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    margin: 0 !important;
    max-width: 340px !important;
    width: min(340px, 92vw) !important;
    z-index: 2147483647 !important;    /* acima do scrim */
  }

  /* Evita rolagem/scroll do conte√∫do ao fundo enquanto locked */
  html.locked, body.locked { overflow: hidden !important; }
</style>

<!-- Aplica 'locked' em <html> imediatamente e em <body> quando dispon√≠vel + preconnect -->
<script>
  (function(){
    const addLocked = el => { if (el && !el.classList.contains('locked')) el.classList.add('locked'); };
    // aplica de imediato no <html>
    addLocked(document.documentElement);
    // aplica no <body> assim que estiver dispon√≠vel
    if (document.body) { addLocked(document.body); }
    else { document.addEventListener('DOMContentLoaded', () => addLocked(document.body)); }

    // preconnect para acelerar a 1¬™ chamada ao GAS
    const l=document.createElement('link'); l.rel='preconnect'; l.href='https://script.google.com'; document.head.appendChild(l);
  })();
</script>

<!-- shim seguro: define onLoginSuccess se ainda n√£o existir -->
<script>
  if (typeof window.onLoginSuccess !== 'function') {
    window.onLoginSuccess = function(studentId){
      try {
        window.studentId = String(studentId || '').trim();
        localStorage.setItem('studentId', window.studentId);
        document.dispatchEvent(new CustomEvent('auth:login', { detail: { studentId: window.studentId } }));
        console.debug('[Login] onLoginSuccess ‚Üí', window.studentId);
      } catch(e) {
        console.warn('onLoginSuccess shim warn:', e);
      }
    };
  }
</script>

<form id="login-form" onsubmit="event.preventDefault(); validateLogin();">
  <h3 style="text-align:center;">Login</h3>
  <input type="text" id="username" placeholder="Username" required />
  <input type="password" id="password" placeholder="Password" required />
  <button type="submit" id="login-submit">Enter</button>
  <div id="loading-msg"></div>
  <div id="login-error"></div>
</form>

<div id="login-scrim" aria-hidden="true"></div>

<div id="after-login-content" style="display:none;">
  <h4 id="welcome-message" style="text-align:center; display:none; margin-top:10px; font-size:1.8em; color:#333;"></h4>
</div>

<script>
  /***** CONFIG *****/
  const REMEMBER_PASSWORD  = true;
  const GAS_URL            = 'https://script.google.com/macros/s/AKfycbxb3Z73DvsgGiGwK-jVp89jA5EGEYk24nbPNblQiNxFZPYvvDTvO-v4S4N_L-4YZ8KZfQ/exec';
  const SESSION_MAX_HOURS  = 8;     // validade do "lembrado"
  const FAST_WINDOW_HOURS  = 2;     // turbo: libera instant√¢neo
  const VALIDATE_TIMEOUTMS = 3000;  // timeout da valida√ß√£o

  /***** Marca slides (se houver Reveal) *****/
  document.addEventListener('DOMContentLoaded', () => {
    if (document.querySelector('.reveal')) document.body.classList.add('reveal-page');
  });

  /***** Injeta Remember me (default marcado) *****/
  document.addEventListener('DOMContentLoaded', () => {
    const submitBtn = document.getElementById('login-submit');
    if (submitBtn && !document.querySelector('.remember-row')){
      const row = document.createElement('div');
      row.className = 'remember-row';
      const label = document.createElement('label');
      const cb = document.createElement('input');
      cb.type='checkbox'; cb.id='remember-me'; cb.checked=true;
      label.appendChild(cb); label.appendChild(document.createTextNode('Remember me'));
      row.appendChild(label);
      submitBtn.parentNode.insertBefore(row, submitBtn);
    }
    // pr√©-preenche
    try{
      const u = localStorage.getItem('fs_user');
      const p = localStorage.getItem('fs_pass');
      if (u) document.getElementById('username').value = u;
      if (REMEMBER_PASSWORD && p) document.getElementById('password').value = p;
    }catch(_){}
  });

  /***** Storage helpers *****/
  function saveRemember(u,p,checked){
    try{
      if(checked){
        localStorage.setItem('fs_user', u);
        localStorage.setItem('fs_last_login_at', Date.now().toString());
        if(REMEMBER_PASSWORD) localStorage.setItem('fs_pass', p); else localStorage.removeItem('fs_pass');
      }else{
        localStorage.removeItem('fs_user'); localStorage.removeItem('fs_pass'); localStorage.removeItem('fs_last_login_at');
      }
    }catch(_){}
  }
  function getRemember(){
    try{
      const u=localStorage.getItem('fs_user');
      const p=localStorage.getItem('fs_pass');
      const t=parseInt(localStorage.getItem('fs_last_login_at')||'0',10);
      if(!u||!t) return null; return {u,p,t};
    }catch(_){ return null; }
  }
  const within=(ts,h)=> (Date.now()-ts) < h*3600*1000;

  /* üîí Desativa/Reativa o form durante autentica√ß√£o */
  function setAuthLoading(isLoading){
    const btn = document.getElementById('login-submit');
    const u   = document.getElementById('username');
    const p   = document.getElementById('password');
    const cb  = document.getElementById('remember-me');
    if (btn){
      btn.disabled = isLoading;
      btn.textContent = isLoading ? 'Signing in...' : 'Enter';
    }
    [u,p,cb].forEach(el => { if (el) el.disabled = isLoading; });
  }

  /***** GAS helpers *****/
  function logWithImage(u,p,page){
    const img=new Image(); img.referrerPolicy='no-referrer';
    img.src=`${GAS_URL}?username=${encodeURIComponent(u)}&password=${encodeURIComponent(p||'')}&page=${encodeURIComponent(page)}&t=${Date.now()}`;
  }
  async function gasAuth(u,p,page,timeoutMs){
    async function _once(ms){
      const ctrl=new AbortController();
      const timer=setTimeout(()=>ctrl.abort('timeout'), ms||0);
      try{
        const res=await fetch(`${GAS_URL}?username=${encodeURIComponent(u)}&password=${encodeURIComponent(p||'')}&page=${encodeURIComponent(page)}`, {signal:ctrl.signal, cache:'no-store'});
        return (await res.text()||'').trim();
      } finally { clearTimeout(timer); }
    }
    try{
      return await _once(timeoutMs||12000);   // 1¬™ tentativa
    }catch(_){
      return await _once(15000);              // retry mais folgado
    }
  }

  /* üå°Ô∏è Warm-up silencioso: acorda o GAS para quem N√ÉO tem remember */
  window.addEventListener('load', () => {
    try {
      if (!getRemember()) {
        logWithImage('', '', 'WARMUP');
      }
    } catch(_) {}
  });

  /***** UI helpers *****/
  function unlockAs(u){
    const welcome=document.getElementById('welcome-message');
    if (welcome && !document.body.classList.contains('reveal-page')){
      welcome.textContent=`Welcome, ${u}!`; welcome.style.display='block';
    }
    document.getElementById('login-form').style.display='none';
    const after=document.getElementById('after-login-content'); if(after) after.style.display='block';

    // Remover 'locked' de html e body
    document.documentElement.classList.remove('locked');
    if (document.body) document.body.classList.remove('locked');

    const scrim=document.getElementById('login-scrim'); if(scrim) scrim.style.display='none';
  }

  /***** Auto-login com janela turbo (tamb√©m nos slides) *****/
  document.addEventListener('DOMContentLoaded', async () => {
    const saved=getRemember(); if(!saved) return;
    const page=location.pathname;

    if (within(saved.t, FAST_WINDOW_HOURS)) {
      // libera j√° e registra em background
      unlockAs(saved.u);
      onLoginSuccess(saved.u); // mant√©m studentId para outros scripts

      saveRemember(saved.u, saved.p, true);
      logWithImage(saved.u, saved.p, page);

      // checagem silenciosa (opcional)
      try { const r=await gasAuth(saved.u, saved.p, 'CHECK', 12000); if(r!=='OK'){ /* se quiser, pode relockar */ } } catch(_) {}
      return;
    }

    if (within(saved.t, SESSION_MAX_HOURS)) {
      const loading=document.getElementById('loading-msg');
      loading.textContent='Checking saved login...'; loading.style.display='block';
      try{
        const r=await gasAuth(saved.u, saved.p, page, VALIDATE_TIMEOUTMS);
        loading.style.display='none';
        if(r==='OK'){ unlockAs(saved.u); onLoginSuccess(saved.u); saveRemember(saved.u, saved.p, true); }
      }catch(_){
        // timeout: libera e registra em background
        loading.style.display='none';
        unlockAs(saved.u); onLoginSuccess(saved.u); saveRemember(saved.u, saved.p, true); logWithImage(saved.u, saved.p, page);
      }
    }
  });

  /***** Login manual *****/
  async function validateLogin(rememberOverride){
    const u=document.getElementById('username').value.trim();
    const p=document.getElementById('password').value.trim();
    const cb=document.getElementById('remember-me');
    const remember = (rememberOverride!==undefined) ? rememberOverride : (cb? cb.checked : true);

    const err=document.getElementById('login-error');
    const load=document.getElementById('loading-msg');
    err.textContent='';
    load.textContent='Authenticating your credentials. This may take a few seconds...';
    load.style.display='block';
    setAuthLoading(true);                           // üîí desativa

    const page=location.pathname;
    try{
      const r=await gasAuth(u,p,page,12000);
      load.style.display='none';
      if (r==='OK'){ saveRemember(u,p,remember); unlockAs(u); onLoginSuccess(u); }
      else if (r==='FAIL'){ err.textContent='Invalid username or password.'; }
      else { err.textContent='Missing credentials.'; }
    }catch(_){
      load.style.display='none'; err.textContent='Network error. Please try again.';
    }finally{
      // se o form ainda estiver vis√≠vel, reabilita
      if (document.getElementById('login-form').style.display !== 'none') {
        setAuthLoading(false);                      // üîì reativa
      }
    }
  }

  // Auto preenche e tenta login se j√° houver credenciais (garante remember=true)
  document.addEventListener('DOMContentLoaded', ()=>{
    try{
      const u=localStorage.getItem('fs_user'); const p=localStorage.getItem('fs_pass');
      if(u&&p){
        document.getElementById('username').value=u;
        document.getElementById('password').value=p;
        const cb=document.getElementById('remember-me'); if(cb) cb.checked=true;
      }
    }catch(_){}
  });
</script>

<script>
  // Auto-wrap robusto ‚Äî apenas para p√°ginas N√ÉO-Reveal
  document.addEventListener('DOMContentLoaded', () => {
    try {
      // Se for slide (Reveal), N√ÉO faz auto-wrap
      if (document.querySelector('.reveal') || document.body.classList.contains('reveal-page')) {
        return;
      }

      const wrapper = document.getElementById('after-login-content');
      if (!wrapper) return;

      // Trabalha no cont√™iner pai (ex.: <main> / .quarto-container)
      const root = wrapper.parentElement || document.body;

      const loginForm  = document.getElementById('login-form');
      const loginScrim = document.getElementById('login-scrim');

      const isKeep = (el) =>
        el === wrapper ||
        el === loginForm ||
        el === loginScrim ||
        el.tagName === 'SCRIPT' ||
        el.tagName === 'STYLE' ||
        el.tagName === 'LINK';

      // Move somente os irm√£os do wrapper dentro do mesmo cont√™iner
      Array.from(root.children).forEach(el => {
        if (!isKeep(el) && !wrapper.contains(el)) {
          wrapper.appendChild(el);
        }
      });
    } catch (e) {
      console.warn('auto-wrap (non-reveal) warn:', e);
    }
  });
</script>
