<!-- Fun√ß√£o global para registrar login do aluno -->
<script>
/**
 * Chame esta fun√ß√£o logo ap√≥s validar o login no seu fluxo.
 * @param {string} studentId - login/ID do aluno
 */
function onLoginSuccess(studentId) {
  // Salva globalmente
  window.studentId = String(studentId || '').trim();
  // Persiste para outras abas/janelas
  localStorage.setItem('studentId', window.studentId);
  // Dispara evento para widgets ouvirem
  document.dispatchEvent(new CustomEvent('auth:login', { 
    detail: { studentId: window.studentId }
  }));
  console.debug('[Login] onLoginSuccess ‚Üí', window.studentId);
}
</script>

<!-- COMMENTS WIDGET ‚Äî chat layout com avatars, delete pr√≥prio e login autom√°tico -->
<div id="cmt-root">
  <!-- Bubble -->
  <button id="cmt-bubble" aria-label="Open comments">
    <span class="cmt-icon">üí¨</span>
    <span class="cmt-badge" id="cmt-count">0</span>
  </button>

  <!-- Floating Panel -->
  <aside id="cmt-panel" aria-hidden="true" aria-label="Comments panel">
    <header class="cmt-header">
      <div class="cmt-title"><span class="cmt-dot"></span><span>Comments</span></div>
      <div class="cmt-actions">
        <span id="cmt-last" class="cmt-last" aria-live="polite" title="Last refresh">‚Äî</span>
        <button id="cmt-refresh" class="cmt-ghost" title="Refresh" aria-label="Refresh">‚Üª</button>
        <button id="cmt-close" class="cmt-ghost" title="Close" aria-label="Close">‚úï</button>
      </div>
    </header>

    <div id="cmt-list" class="cmt-body" role="list"></div>

    <footer class="cmt-input">
      <!-- escondido: sempre usamos o login do aluno -->
      <div class="cmt-row" id="cmt-name-row" style="display:none;">
        <input id="cmt-name" type="text" placeholder="Your name" autocomplete="name" />
      </div>
      <textarea id="cmt-text" placeholder="Write a thoughtful comment‚Ä¶"></textarea>
      <div class="cmt-row cmt-end">
        <button id="cmt-send" class="cmt-primary" aria-label="Send">Send</button>
      </div>
    </footer>
  </aside>
</div>

<style>
/* ---- Scoped styles (layout original) ---- */
#cmt-root { all: initial; }
#cmt-root * { all: unset; box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }
#cmt-root { position: relative; }

/* Bubble ‚Äî bottom-left, gradient like chatbot */
#cmt-root #cmt-bubble{
  position: fixed;
  left: max(20px, env(safe-area-inset-left));
  bottom: max(20px, env(safe-area-inset-bottom));
  display: inline-flex; align-items: center; gap: 8px;
  background: linear-gradient(135deg, #7c3aed 0%, #06b6d4 100%);
  color: #fff;
  border: 1px solid rgba(255,255,255,0.18);
  border-radius: 16px; padding: 10px 12px;
  box-shadow: 0 18px 40px rgba(0,0,0,0.28);
  cursor: pointer; z-index: 11000;
  transition: transform .18s ease, box-shadow .18s ease, opacity .18s ease;
}
#cmt-root #cmt-bubble:hover{ transform: translateY(-2px) }
#cmt-root .cmt-icon{ font-size: 18px; line-height: 1; }
#cmt-root .cmt-badge{
  min-width: 20px; height: 20px; padding: 0 6px;
  display: inline-flex; align-items: center; justify-content: center;
  background: rgba(255,255,255,0.95); color:#1f2937; font-size:12px; font-weight:800; border-radius: 999px;
  box-shadow: 0 2px 6px rgba(0,0,0,.18);
  transition: background .25s ease, color .25s ease;
}
/* ALERTA: quando houver coment√°rio novo de outra pessoa */
#cmt-root .cmt-badge.alert{
  background: #dc2626 !important;  /* vermelho */
  color: #fff !important;
}

/* Floating panel ‚Äî mesmo padr√£o do chatbot */
#cmt-root #cmt-panel{
  position: fixed;
  left: max(20px, env(safe-area-inset-left));
  bottom: calc(max(20px, env(safe-area-inset-bottom)) + 56px);
  width: 325px; height: 600px;
  min-width: 280px; min-height: 360px;
  max-width: 94vw; max-height: 84vh;

  display: grid; grid-template-rows: auto 1fr auto;
  background: rgba(248,250,252,0.85); color: #0f172a;
  -webkit-backdrop-filter: saturate(140%) blur(10px); backdrop-filter: saturate(140%) blur(10px);
  border: 1px solid rgba(30,41,59,0.12);
  box-shadow: 0 16px 50px rgba(0,0,0,0.35);
  border-radius: 18px; overflow: hidden;
  z-index: 12000;
  opacity: 0; transform: translateY(8px) scale(.98);
  pointer-events: none;
  transition: opacity .22s ease, transform .22s ease;

  resize: both;
}
#cmt-root #cmt-panel.open{ opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }

#cmt-root .cmt-header{
  display:flex; align-items:center; gap:10px; padding:12px 14px;
  background: linear-gradient(180deg, #334155 0%, #475569 100%);
  color:#fff;
}
#cmt-root .cmt-title{ display:flex; align-items:center; gap:8px; font-weight:700; letter-spacing:.2px;}
#cmt-root .cmt-dot{ width:10px; height:10px; border-radius:50%; background:#22c55e; box-shadow:0 0 0 3px rgba(34,197,94,.22); }
#cmt-root .cmt-actions{ margin-left:auto; display:flex; gap:8px; align-items:center; }
#cmt-root .cmt-last{ font-size:12px; opacity:.85; color:#fff; }
#cmt-root .cmt-ghost{ padding:6px 10px; border-radius:10px; cursor:pointer; background: rgba(255,255,255,.18); border: 1px solid rgba(255,255,255,.25); }
#cmt-root .cmt-ghost:hover{ background: rgba(255,255,255,.28); }

/* Body */
#cmt-root .cmt-body{
  padding:12px 10px 16px 10px;
  overflow:auto;
}

/* === Chat message === */
#cmt-root .cmt-msg{
  display: flex; align-items: flex-end; gap: 8px;
  margin: 12px 6px;
}
#cmt-root .cmt-msg.other{ flex-direction: row; }
#cmt-root .cmt-msg.me{ flex-direction: row-reverse; }

/* Avatar bolinha */
#cmt-root .cmt-avatar{
  width: 28px; height: 28px; min-width:28px; min-height:28px;
  border-radius: 50%;
  color: #fff; font-weight: 700; font-size: 12px;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 4px 12px rgba(0,0,0,.12);
}

/* Meta (data ‚Ä¢ autor) ‚Äî acima do bal√£o */
#cmt-root .cmt-meta{
  display:flex; align-items:center; gap:8px;
  font-size: 11px; color: #64748b; margin: 0 4px 6px 4px; line-height: 1.2;
  word-break: break-word; overflow-wrap: anywhere;
}
#cmt-root .cmt-meta-wrap{ display:flex; flex-direction:column; align-items:flex-start; }
#cmt-root .cmt-msg.me .cmt-meta-wrap{ align-items:flex-end; }

/* Bal√£o do coment√°rio */
#cmt-root .cmt-bubble{
  display:inline-block; max-width: 78%;
  padding: 10px 12px; border-radius: 14px;
  border: 1px solid rgba(30,41,59,0.12);
  background: rgba(255,255,255,0.92);
  box-shadow: 0 6px 14px rgba(0,0,0,.06);
  line-height: 1.45;
  white-space: pre-wrap; word-break: break-word; overflow-wrap: anywhere;
  font-size: 12px;
}
#cmt-root .cmt-msg.me .cmt-bubble{
  background: #eef2ff;           /* leve indigo p/ o pr√≥prio usu√°rio */
  border-color: rgba(79,70,229,.20);
}

/* Input */
#cmt-root .cmt-input{
  border-top: 1px solid rgba(30,41,59,0.12); padding:12px; display:grid; gap:8px;
  background: rgba(255,255,255,0.6);
}
#cmt-root .cmt-row{ display:flex; gap:8px; }
#cmt-root .cmt-end{ justify-content:flex-end; }
#cmt-root .cmt-input input, #cmt-root .cmt-input textarea{
  width:100%; font-size:14px; padding:10px 12px; border-radius:12px;
  border:1px solid rgba(30,41,59,0.15); color:#0f172a; background: rgba(255,255,255,0.9); outline: none;
}
#cmt-root .cmt-input textarea{ min-height:88px; max-height:140px; resize: vertical; }
#cmt-root .cmt-primary{
  background:#6366f1; color:#fff; border:none; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600;
  box-shadow: 0 6px 18px rgba(99,102,241,.35); transition: transform .15s ease, box-shadow .2s ease, opacity .2s ease;
}
#cmt-root .cmt-primary:hover{ transform: translateY(-1px); box-shadow: 0 10px 24px rgba(99,102,241,.42); }
</style>

<script>
/* slide/presentation id helpers */
window.__getSlideId = window.__getSlideId || function() {
  if (window.Reveal && Reveal.getCurrentSlide) {
    const s = Reveal.getCurrentSlide();
    if (s && s.getAttribute('id')) return s.getAttribute('id');
    if (Reveal.getIndices) { const idx = Reveal.getIndices(); return `h${idx.h}_v${idx.v||0}`; }
  }
  const hash = (location.hash||'').replace(/^#\/?/, '');
  return hash || 'slide-unknown';
};
</script>

<script>
(function(){
  const COMMENTS_SCOPE = 'presentation'; // 'presentation' | 'slide'
  const scriptURL = "https://script.google.com/macros/s/AKfycbxfBAS6Bhm9CwTH8OKjSwPuffvcm7DkdfAc0EeatJBHSSzStLWv-6U7-W4ZgvGdmusoeA/exec";
  const CMT_SIZE = "cmt_panel_size";

  const BASE_POLL_MS  = 3000;   // polling normal
  const TURBO_POLL_MS = 1000;   // logo ap√≥s um post
  const TURBO_DURATION_MS = 10000;

  const scopeId = () => COMMENTS_SCOPE === 'slide'
    ? window.__getSlideId()
    : (location.origin + location.pathname + location.search);

  const root     = document.getElementById("cmt-root");
  const bubble   = root.querySelector("#cmt-bubble");
  const bubbleCt = root.querySelector("#cmt-count");
  const panel    = root.querySelector("#cmt-panel");
  const closeBtn = root.querySelector("#cmt-close");
  const refresh  = root.querySelector("#cmt-refresh");
  const lastEl   = root.querySelector("#cmt-last");
  const listEl   = root.querySelector("#cmt-list");
  const textIn   = root.querySelector("#cmt-text");
  const sendBtn  = root.querySelector("#cmt-send");

  let __lastTsMs = 0;
  let __haveInitial = false;
  let __posting = false;
  let __lastSent = { sig:"", at:0 };
  let pollTimer = null;
  let turboUntil = 0;

  // hidrata a vari√°vel global a partir do storage, se necess√°rio
  if (!window.studentId) {
    const sid = (localStorage.getItem('studentId') || '').trim();
    if (sid) window.studentId = sid;
  }
  // escuta evento de login do seu fluxo
  document.addEventListener('auth:login', (ev) => {
    if (ev?.detail?.studentId) {
      window.studentId = String(ev.detail.studentId).trim();
      localStorage.setItem('studentId', window.studentId);
    }
  });

  const loggedLogin = () => {
    const tryVals = [
      () => (window.studentId || '').toString().trim(),
      () => (localStorage.getItem('studentId') || '').toString().trim(),
      () => (window.__auth && window.__auth.student && window.__auth.student.login || '').toString().trim(),
      () => (document.getElementById('student-id')?.value || '').toString().trim(),
      () => (localStorage.getItem('login') || '').toString().trim(),
    ];
    for (const f of tryVals){
      const v = f();
      if (v) return v;
    }
    return '';
  };

  const hashColor = (s)=>{ let h=0; for(let i=0;i<s.length;i++) h=((h<<5)-h)+s.charCodeAt(i)|0; return `hsl(${Math.abs(h)%360},70%,50%)`; };

  // restore/save panel size
  try{ const saved = JSON.parse(localStorage.getItem(CMT_SIZE)||'null'); if(saved?.w&&saved?.h){ panel.style.width=saved.w; panel.style.height=saved.h; } }catch(_){}
  if ('ResizeObserver' in window){
    const ro = new ResizeObserver(es=>{
      for (const e of es){ const {width,height}=e.contentRect||{}; if(width&&height) localStorage.setItem(CMT_SIZE, JSON.stringify({w:Math.round(width)+'px', h:Math.round(height)+'px'})); }
    }); ro.observe(panel);
  }

  function itemKey(c){
    const id = (c.id||'').trim();
    if (id) return id;
    const who = (c.student||'').trim();
    const ts  = (c.timestamp||'').trim();
    const txt = (c.comment||'').slice(0,24);
    return `k_${who}__${ts}__${txt}`;
  }

  function buildMsgHTML(c, meLower){
    const who  = String(c.student||"").trim();
    const when = new Date(c.timestamp).toLocaleString();
    const meta = who ? `${when} ‚Ä¢ ${who}` : when;
    const safe = String(c.comment||"").replace(/</g,"&lt;");
    const isMe = meLower && who.toLowerCase()===meLower;
    const cls  = isMe ? "me" : "other";
    const init = (who||"Anonymous").slice(0,2).toUpperCase();
    const col  = hashColor(who||"Anonymous");
    const del  = isMe && c.id && !/^temp-/.test(c.id) ? `<button class="cmt-ghost" data-del="${c.id}" title="Delete">üóë</button>` : "";
    const key  = itemKey(c);
    return `
      <div class="cmt-msg ${cls}" role="listitem" data-id="${key}">
        <div class="cmt-avatar" style="background:${col}">${init}</div>
        <div class="cmt-meta-wrap">
          <div class="cmt-meta">
            <span>${meta}</span>
            ${del}
          </div>
          <div class="cmt-bubble">${safe}</div>
        </div>
      </div>`;
  }

  function bindDeletes(scopeEl){
    (scopeEl||listEl).querySelectorAll('[data-del]').forEach(btn=>{
      if (btn.__bound) return;
      btn.__bound = true;
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-del');
        deleteComment(id);
      });
    });
  }

  function recomputeCount(){
    const n = listEl.querySelectorAll('.cmt-msg').length;
    bubbleCt.textContent = n;
  }

  const pad2 = n => String(n).padStart(2,'0');
  function fmtTime(ms){
    const d = new Date(ms);
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }
  function setLastRef(ms){
    if (lastEl) lastEl.textContent = 'Last: ' + fmtTime(ms);
  }

  function render(items){
    const me = (loggedLogin()||"").toLowerCase();
    listEl.innerHTML = items.map(c=> buildMsgHTML(c, me)).join("");
    bindDeletes(listEl);
    recomputeCount();
  }

  const isNearBottom = ()=>{
    const gap = listEl.scrollHeight - (listEl.scrollTop + listEl.clientHeight);
    return gap < 120;
  };
  const scrollToBottom = ()=>{ listEl.scrollTop = listEl.scrollHeight; };

  function scheduleNextPoll(delay){
    if (pollTimer) clearTimeout(pollTimer);
    if (document.hidden) return;
    const now = Date.now();
    const base = (now < turboUntil) ? TURBO_POLL_MS : BASE_POLL_MS;
    pollTimer = setTimeout(()=> load({forceScroll:isNearBottom()}), delay ?? base);
  }

  function load({forceScroll=false}={}){
    const shouldStick = forceScroll || isNearBottom();
    const base = `${scriptURL}?comments=1&limit=1000&slide_id=${encodeURIComponent(scopeId())}`;
    const url  = (__haveInitial && __lastTsMs) ? `${base}&since_ms=${__lastTsMs}` : base;

    fetch(url)
      .then(r=>r.json())
      .then(d=>{
        const incoming = Array.isArray(d.items) ? d.items.slice() : [];
        incoming.sort((a,b)=> new Date(a.timestamp) - new Date(b.timestamp));

        for (const it of incoming){
          const ms = new Date(it.timestamp).getTime();
          if (ms > __lastTsMs) __lastTsMs = ms;
        }

        if (!__haveInitial){
          render(incoming);
          if (incoming.length){
            const last = new Date(incoming[incoming.length-1].timestamp).getTime();
            if (last > __lastTsMs) __lastTsMs = last;
          }
          __haveInitial = true;
          if (shouldStick) scrollToBottom();
        } else if (incoming.length){
          const me = (loggedLogin()||"").toLowerCase();
          const fresh = incoming.filter(c => !listEl.querySelector(`[data-id="${itemKey(c)}"]`));
          if (fresh.length){
            const frag = fresh.map(c=> buildMsgHTML(c, me)).join("");
            listEl.insertAdjacentHTML('beforeend', frag);
            bindDeletes(listEl);
            if (shouldStick) scrollToBottom();
            recomputeCount();

            // ALERTA VERMELHO NO BADGE SE CHEGAR DE OUTRA PESSOA
            const someoneElse = fresh.some(c => (String(c.student||'').trim().toLowerCase()) !== me);
            if (someoneElse) bubbleCt.classList.add('alert');
          }
        }
        setLastRef(Date.now());
      })
      .catch(()=>{})
      .finally(()=> scheduleNextPoll());
  }

  function post(){
    if (__posting) return;

    const s = loggedLogin();
    const t = (textIn.value||"").trim();
    if (!s){ alert("Fa√ßa login para comentar."); return; }
    if (!t){ alert("Please write a comment."); return; }

    const sig = `${s}__${scopeId()}__${t}`;
    const now = Date.now();
    if (__lastSent.sig === sig && (now - __lastSent.at) < 12000){
      textIn.focus();
      return;
    }
    __lastSent = { sig, at: now };
    __posting = true;
    sendBtn.disabled = true; sendBtn.setAttribute('aria-busy','true'); sendBtn.style.opacity = '0.7';

    const tempId = 'temp-' + now;
    const temp = { id: tempId, timestamp: new Date().toISOString(), student: s, slide_id: scopeId(), comment: t };

    if (panel.classList.contains("open")){
      const me = (s||'').toLowerCase();
      const html = buildMsgHTML(temp, me);
      const keepBottom = isNearBottom();
      listEl.insertAdjacentHTML('beforeend', html);
      bindDeletes(listEl);
      if (keepBottom) scrollToBottom();
      recomputeCount();
    }

    fetch(scriptURL, {
      method:"POST",
      body: JSON.stringify({ student:s, slide_id: scopeId(), comment:t, user_agent: navigator.userAgent })
    })
    .then(r=>r.json())
    .then(d=>{
      if (d.status==="success"){
        textIn.value="";
        if (panel.classList.contains("open")){
          const tempEl = listEl.querySelector(`[data-id="${tempId}"]`);
          if (tempEl){
            tempEl.setAttribute('data-id', d.id || tempId);
            const meta = tempEl.querySelector('.cmt-meta');
            if (meta && !meta.querySelector('[data-del]') && d.id){
              const btn = document.createElement('button');
              btn.className = 'cmt-ghost'; btn.title = 'Delete';
              btn.setAttribute('data-del', d.id); btn.textContent = 'üóë';
              meta.appendChild(btn); bindDeletes(meta);
            }
          }
        }
        // >>> LOGA PONTOS NO RANKING <<<
        if (typeof window.leaderboardLogEvent === 'function') {
          window.leaderboardLogEvent('comment_posted', { points: 2, details: 'source=comments_widget' });
        }
        turboUntil = Date.now() + TURBO_DURATION_MS;
        scheduleNextPoll(200);
      } else {
        const el = listEl.querySelector(`[data-id="${tempId}"]`);
        if (el) el.remove();
        recomputeCount();
        alert("Error: " + (d.message||"Unable to post"));
      }
    })
    .catch(()=>{
      const el = listEl.querySelector(`[data-id="${tempId}"]`);
      if (el) el.remove();
      recomputeCount();
      alert("Network error: failed to send");
    })
    .finally(()=>{
      __posting = false;
      sendBtn.disabled = false; sendBtn.removeAttribute('aria-busy'); sendBtn.style.opacity = '';
    });
  }

  function deleteComment(id){
    const s = loggedLogin();
    if (!s){ alert("Fa√ßa login para apagar seu coment√°rio."); return; }
    if (!id) return;
    if (/^temp-/.test(id)) {
      const el = listEl.querySelector(`[data-id="${id}"]`);
      if (el) el.remove();
      recomputeCount();
      return;
    }

    let placeholder = null;
    if (panel.classList.contains("open")){
      const el = listEl.querySelector(`[data-id="${id}"]`);
      if (el){ placeholder = el.outerHTML; el.remove(); recomputeCount(); }
    }

    fetch(scriptURL, {
      method:"POST",
      body: JSON.stringify({ action:"delete", comment_id:id, student:s, slide_id: scopeId() })
    })
    .then(r=>r.json())
    .then(d=>{
      if (d.status === "success"){
        // >>> LOGA PONTOS NO RANKING (NEGATIVO) <<<
        if (typeof window.leaderboardLogEvent === 'function') {
          window.leaderboardLogEvent('comment_deleted', { points: -2, details: 'source=comments_widget' });
        }
        scheduleNextPoll(200);
      } else {
        if (panel.classList.contains("open") && placeholder){
          listEl.insertAdjacentHTML('beforeend', placeholder);
          bindDeletes(listEl);
          recomputeCount();
        }
        alert("Erro ao apagar: " + (d.message||"Unknown"));
      }
    })
    .catch(()=>{
      if (panel.classList.contains("open") && placeholder){
        listEl.insertAdjacentHTML('beforeend', placeholder);
        bindDeletes(listEl);
        recomputeCount();
      }
      alert("Network error: failed to delete");
    });
  }

  function hardReload(){
    if (lastEl) lastEl.textContent = 'Last: ‚Ä¶';
    __haveInitial = false; __lastTsMs = 0;
    load({forceScroll:true});
  }

  // open/close
  const openPanel  = ()=>{
    panel.classList.add("open");
    panel.setAttribute('aria-hidden','false');
    bubbleCt.classList.remove('alert'); // limpamos o alerta ao abrir
    hardReload();
    setTimeout(scrollToBottom, 80);
  };
  const closePanel = ()=>{ panel.classList.remove("open"); panel.setAttribute('aria-hidden','true'); };

  bubble.addEventListener("click", ()=> panel.classList.contains("open") ? closePanel() : openPanel());
  closeBtn.addEventListener("click", closePanel);
  refresh.addEventListener("click", ()=>{ bubbleCt.classList.remove('alert'); hardReload(); });
  sendBtn.addEventListener("click", post);

  // Enter envia; Shift+Enter quebra linha
  textIn.addEventListener("keydown", (e)=>{
    if (e.key === "Enter" && !e.shiftKey){ e.preventDefault(); post(); }
  });

  // pause/resume quando a aba perde/ganha foco
  document.addEventListener('visibilitychange', ()=>{
    if (document.hidden){
      if (pollTimer) { clearTimeout(pollTimer); pollTimer=null; }
    } else {
      scheduleNextPoll(100);
    }
  });

  // initial + periodic scheduling
  load(); // o pr√≥prio load agenda o pr√≥ximo poll
})();
</script>
