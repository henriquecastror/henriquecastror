<div class="like-container">
  <button class="like-btn" title="Click if you got this">
    âœ… <span class="like-text">Got it</span>
    <span class="like-count">(0)</span>
  </button>
</div>

<script>
(function() {
  const root = document.currentScript && document.currentScript.previousElementSibling;
  if (!root || !root.matches('.like-container')) return;
  const btn = root.querySelector('.like-btn');
  const textSpan = btn && btn.querySelector('.like-text');
  const countSpan = btn && btn.querySelector('.like-count');
  if (!btn || !textSpan || !countSpan) return;

  // GAS de LIKES/COMMENTS (contagem + persistÃªncia do like)
  const scriptURL = "https://script.google.com/macros/s/AKfycbxfBAS6Bhm9CwTH8OKjSwPuffvcm7DkdfAc0EeatJBHSSzStLWv-6U7-W4ZgvGdmusoeA/exec";

  // (opcional) fallback direto para ranking se vocÃª NÃƒO tiver o ranking-widget na pÃ¡gina.
  // Se vocÃª usar o widget, deixe vazio que a gente usa window.leaderboardLogEvent.
  const RANKING_ENDPOINT = ""; // ex.: "https://script.google.com/macros/s/SEU_QUIZZ_RESPONSE_RANKING/exec"

  function getSlideHashForSection(sec) {
    if (sec && sec.id) return `#/${sec.id}`;
    if (window.Reveal && Reveal.getIndices) {
      const idx = Reveal.getIndices(sec || Reveal.getCurrentSlide());
      if (idx && typeof idx.h === 'number') {
        return typeof idx.v === 'number' && idx.v > 0 ? `#/${idx.h}/${idx.v}` : `#/${idx.h}`;
      }
    }
    return location.hash || '#';
  }

  function getSlideURLForThisButton() {
    const sec = root.closest('section');
    const hash = getSlideHashForSection(sec);
    return location.origin + location.pathname + location.search + hash;
  }

  function pageId() {
    return getSlideURLForThisButton();
  }

  function getStudentId() {
    return (window.studentId || localStorage.getItem("studentId") || localStorage.getItem("fs_user") || "");
  }

  function hasLogin() {
    return !!getStudentId();
  }

  function setGotItState() {
    textSpan.textContent = "Got it âœ”";
    btn.classList.add("liked");
    btn.title = "You have already confirmed";
  }

  // ðŸ”’ Desabilita se ainda nÃ£o hÃ¡ login
  function syncButtonLock() {
    if (!hasLogin()) {
      btn.setAttribute('disabled', 'disabled');
      btn.style.opacity = 0.6;
      btn.title = "Please log in to confirm";
    } else {
      btn.removeAttribute('disabled');
      btn.style.opacity = "";
      btn.title = "Click if you got this";
    }
  }
  syncButtonLock();

  // ðŸ”” Reabilita apÃ³s login
  document.addEventListener('auth:login', () => {
    syncButtonLock();
    updateCount();
  });

  if (localStorage.getItem(`liked_${pageId()}`)) setGotItState();

  // ðŸ‘‰ envia +1 ponto no ranking (sÃ³ quando o like foi aceito pelo GAS)
  async function awardLikePoint(student, pid){
    try {
      // 1) PreferÃªncia: usar o ranking-widget (jÃ¡ tem endpoint e fingerprint ok)
      if (typeof window.leaderboardLogEvent === 'function') {
        await window.leaderboardLogEvent('like', { details: 'source=like_button' });
        return;
      }
      // 2) Fallback direto ao endpoint (se vocÃª preencher RANKING_ENDPOINT)
      if (RANKING_ENDPOINT) {
        const payload = {
          action: 'leaderboard_log',
          studentId: student,
          event_type: 'like',
          module: (window.moduleId || 'module'),
          page: pid,
          details: 'source=like_button',
          // fingerprint para garantir 1 ponto por pÃ¡gina/slide:
          fingerprint: `${student}-like-${pid}`
        };
        await fetch(RANKING_ENDPOINT, { method: 'POST', body: JSON.stringify(payload) });
      } else {
        console.warn('[Like] Sem ranking-widget e sem RANKING_ENDPOINT â€” ponto nÃ£o enviado.');
      }
    } catch (e) {
      console.warn('[Like] Falha ao enviar ponto ao ranking:', e);
    }
  }

  btn.addEventListener("click", () => {
    const pid = pageId();

    if (!hasLogin()) {
      alert("Please log in first.");
      return;
    }
    if (localStorage.getItem(`liked_${pid}`)) return;

    localStorage.setItem(`liked_${pid}`, "true");
    setGotItState();
    btn.classList.add("pulse");
    setTimeout(() => btn.classList.remove("pulse"), 300);

    const currentCount = parseInt(countSpan.textContent.replace(/[^\d]/g, '')) || 0;
    countSpan.textContent = `(${currentCount + 1})`;

    const student = getStudentId();
    console.debug('[Like] pid=', pid, 'studentId=', student);

    fetch(`${scriptURL}?like=1&page=${encodeURIComponent(pid)}&student=${encodeURIComponent(student)}`)
      .then(res => res.json())
      .then(async data => {
        // SÃ³ pontua no ranking se o backend registrou este like como NOVO
        if (data && data.status === 'liked') {
          await awardLikePoint(student, pid);
        }
        updateCount();
      })
      .catch(err => console.error("Error marking got it:", err));
  });

  function updateCount() {
    const pid = pageId();
    fetch(`${scriptURL}?getLikes=1&page=${encodeURIComponent(pid)}`)
      .then(res => res.json())
      .then(data => {
        const count = data && typeof data.count === 'number' ? data.count : 0;
        countSpan.textContent = `(${count})`;
        if (localStorage.getItem(`liked_${pid}`)) setGotItState();
      })
      .catch(() => {});
  }

  updateCount();
  const interval = setInterval(updateCount, 3000);

  const obs = new MutationObserver(() => {
    if (!document.body.contains(root)) {
      clearInterval(interval);
      obs.disconnect();
    }
  });
  obs.observe(document.body, { childList: true, subtree: true });

  if (window.Reveal && Reveal.addEventListener) {
    Reveal.addEventListener('slidechanged', updateCount);
  }
})();
</script>

<style>
.like-container { position: relative; margin-top: 20px; text-align: right; }
.like-btn {
  background-color: #f0fdf4; border: 2px solid #86efac; color: #15803d;
  padding: 8px 16px; font-size: 16px; border-radius: 25px;
  display: inline-flex; align-items: center; gap: 8px; font-weight: 500;
  box-shadow: 1px 1px 4px rgba(0,0,0,0.08);
  transition: background-color 0.2s, color 0.2s, opacity 0.2s, transform 0.15s;
  cursor: pointer;
}
.like-btn:hover { background-color: #dcfce7; border-color: #4ade80; color: #166534; }
.like-btn.liked { background-color: #f0f0f0; color: #888; border-color: #ddd; opacity: 0.6; cursor: default; }
.like-btn .like-count {
  background-color: #86efac; color: #064e3b; padding: 2px 8px; border-radius: 12px;
  font-size: 14px; font-weight: bold;
}
@keyframes pulse { 0% {transform:scale(1)} 50% {transform:scale(1.08)} 100% {transform:scale(1)} }
.pulse { animation: pulse 0.3s ease; }
</style>
