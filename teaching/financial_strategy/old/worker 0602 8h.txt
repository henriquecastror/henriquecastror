
// ============================================================
// WORKER ‚Äî FULL FILE (single file)
// (Import box removed + /admin/poll fixed + admin-protected poll admin endpoints)
// ============================================================

const profile = {
  name: "Henrique Castro Martins",
  title: "Assistant Professor @ FGV/EAESP",
  bio: `I hold a Ph.D. in Finance, and I am currently an Assistant Professor at <a href="https://eaesp.fgv.br/" target="_blank">FGV/EAESP</a> (S√£o Paulo, Brazil).<br><br>
I teach corporate finance, corporate governance and financial analysis at the undergraduate, MBA, Master, and Ph.D. levels. I am currently working on several projects on these topics.<br><br>
If you have any questions about my research, or if you want to work with me, contact me at <a href="mailto:henrique.martins@fgv.br">henrique.martins@fgv.br</a>.`,
  links: [
    { text: "Email", icon: "bi-envelope", href: "mailto:henrique.martins@fgv.br" },
    { text: "Scholar", icon: "bi-mortarboard", href: "https://scholar.google.com.br/citations?user=7gIfkRMAAAAJ&hl=pt-BR&oi=ao" },
    { text: "Linkedin", icon: "bi-linkedin", href: "https://www.linkedin.com/in/henriquecastror/" },
    { text: "Lattes", icon: "bi-file-earmark-person", href: "http://lattes.cnpq.br/6076997472159785" },
    { text: "Orcid", icon: "bi-person-badge", href: "https://orcid.org/0000-0002-3186-4245" },
    { text: "Scopus", icon: "bi-journal-text", href: "https://www.scopus.com/authid/detail.uri?authorId=56179864100" },
    { text: "WoS", icon: "bi-globe", href: "https://www.webofscience.com/wos/author/record/AAA-9293-2019" },
    { text: "ResearchGate", icon: "bi-search", href: "https://www.researchgate.net/profile/Henrique_Castro_Martins" },
    { text: "Academia", icon: "bi-book", href: "https://fgvsp.academia.edu/HenriqueMartins" }
  ],
  education: [
    { degree: "PhD in Finance", year: "2016", school: "UFRGS" },
    { degree: "Master in Finance", year: "2012", school: "UFRGS" },
    { degree: "B.A. in Management", year: "2010", school: "PUCRS" }
  ],
  interests: ["Corporate Finance", "Corporate Governance", "Financial policies", "Empirical methods in finance"]
};

const researchPapers = [
  {
    title: "Symbolic or substantive? How shareholder heterogeneity shapes the purpose of the corporation",
    journal: "Long Range Planning, 102582, 2025",
    date: "2025-09-22",
    doi: "https://doi.org/10.1016/j.lrp.2025.102582",
    categories: ["Research", "Strategy", "ESG Decoupling"],
    description: "This study investigates how the heterogeneity of shareholders‚Äô financial and social interests creates tension around competing interpretations of the purpose of the corporation, particularly regarding their incompatibility and relative prevalence of initiatives that extend beyond profit maximization."
  },
  {
    title: "Competing Voices, Persistent Gaps: Shareholder Proposal Activism and ESG Decoupling",
    journal: "Business & Society, 2025",
    date: "2025-08-20",
    doi: "https://doi.org/10.1177/00076503251357372",
    categories: ["Shareholder Activism", "ESG", "Materiality"],
    description: "We investigate the occurrence and the persistence of environmental, social, and governance (ESG) decoupling when firms are exposed to heterogeneity in shareholder proposal activism, reflected by the different orientation of shareholder activists and the competing nature of their demands."
  },
  {
    title: "Intelig√™ncia Artificial: O que o Gestor deve saber",
    journal: "GV-executivo, v. 23, n. 3, 2024",
    date: "2024-11-20",
    doi: "https://doi.org/10.12660/gvexec.v23n3.2024.91213",
    categories: ["Management", "Artificial Intelligence"],
    description: "Um guia pr√°tico e conceitual sobre os impactos da IA na gest√£o, voltado para l√≠deres e tomadores de decis√£o."
  },
  {
    title: "Creativity governance: A conceptual framework for tailoring governance to the creativity and uncertainty in entrepreneurial projects",
    journal: "European Management Review, forthcoming, 2023",
    date: "2023-09-10",
    doi: "https://doi.org/10.1111/emre.12607",
    categories: ["Research", "Corporate Governance", "Creativity"],
    description: "In this article, we propose a typology of firms‚Äô projects drawing on parameters stemming from recent advancements in creativity theory: opacity and unlikelihood."
  },
  {
    title: "Financial materiality and corporate risk - evidence from an Instrumental Variables (IV) design",
    journal: "Finance Research Letters, forthcoming, 2023",
    date: "2023-09-07",
    doi: "https://doi.org/10.1016/j.frl.2023.104433",
    categories: ["Research", "Corporate Finance", "Materiality"],
    description: "This article investigates how the disclosure of financially material information relates to corporate risk using the SASB materiality framework."
  },
  {
    title: "Investment‚Äìcash flow sensitivity and investor protection",
    journal: "Journal of Business, Finance and Accounting, V50, Issue 7-8, 2023",
    date: "2023-08-16",
    doi: "https://doi.org/10.1111/jbfa.12645",
    categories: ["Research", "Corporate Governance", "Corporate Finance"],
    description: "We examine the role of country-level legal investor protection (i.e., shareholder and creditor protection) on firm investment‚Äìcash flow sensitivity."
  },
  {
    title: "Competition and ESG practices in emerging markets - Evidence from a difference-in-differences model",
    journal: "Finance Research Letters, 46*(A), 102371, 2022",
    date: "2022-05-01",
    doi: "https://doi.org/10.1016/j.frl.2021.102371",
    categories: ["Research", "Corporate Finance", "ESG"],
    description: "This paper investigates how competition affects firms' environmental, social, and governance (ESG) practices in 22 emerging markets."
  },
  {
    title: "Integrating uncertainty and governance into a capital structure puzzle: can risk-taking and rule-taking explain zero-leverage firms?",
    journal: "Review of Managerial Science, 16, 1979‚Äì2034, 2022",
    date: "2022-06-01",
    doi: "https://doi.org/10.1007/s11846-021-00500-w",
    categories: ["Research", "Corporate Governance"],
    description: "Can risk-taking and rule-taking explain zero-leverage firms?"
  },
  {
    title: "Blockholders and firm value: Evidence from Brazil",
    journal: "Brazilian Review of Finance, 20, 48‚Äì76, 2022",
    date: "2022-05-01",
    doi: "https://doi.org/10.12660/rbfin.v20n2.2022.83645",
    categories: ["Research", "Corporate Governance"],
    description: "This research analyzes the relationship between the presence of blockholders and the value of Brazilian firms."
  },
  {
    title: "Risk taking and Corporate Governance",
    journal: "Working Paper / Conceptual Framework",
    date: "2022-01-01",
    doi: "#",
    categories: ["Open Science"],
    description: "A framework of uncertainty taking and its implications for Agency Theory."
  },
  {
    title: "Does control concentration affect board busyness? International evidence",
    journal: "Journal of Management and Governance, 24, 821‚Äì850, 2020",
    date: "2020-09-01",
    doi: "https://doi.org/10.1007/s10997-019-09487-9",
    categories: ["Research", "Corporate Governance"],
    description: "We investigate specific characteristics of the board of directors: the number of directors' directorships and the number of committee positions."
  },
  {
    title: "Tutorial-Articles - The Importance of Data and Code Sharing",
    journal: "Journal of Contemporary Administration - RAC, 25*(1), 2021",
    date: "2020-09-09",
    doi: "https://doi.org/10.1590/1982-7849rac2021200212",
    categories: ["Research", "Corporate Finance"],
    description: "About Open Science mechanisms, data sharing, and the context for tutorial-articles."
  },
  {
    title: "The Brazilian bankruptcy law reform, corporate ownership concentration, and risk-taking",
    journal: "Managerial and Decision Economics, 41*(4), 562-573, 2020",
    date: "2020-06-01",
    doi: "https://doi.org/10.1002/mde.3120",
    categories: ["Research", "Corporate Finance"],
    description: "We investigate whether a bankruptcy reform, which increased creditors' protection, affected the risk taking of Brazilian firms."
  },
  {
    title: "Do shareholder protection and creditor rights have distinct effects on the association between debt maturity and ownership structure?",
    journal: "Journal of Business, Finance and Accounting, 47*(5-6), 708-729, 2020",
    date: "2020-06-01",
    doi: "https://doi.org/10.1111/jbfa.12430",
    categories: ["Research", "Corporate Governance", "Corporate Finance"],
    description: "This study examines the effects of the firm's ownership concentration and its institutional environment on corporate debt maturity choices."
  },
  {
    title: "Investor protection, managerial entrenchment, and cash holdings - Cross-country evidence",
    journal: "International Finance, 22*(3), 422-438, 2019",
    date: "2019-02-01",
    doi: "https://doi.org/10.1111/infi.12343",
    categories: ["Research", "Corporate Governance", "Corporate Finance"],
    description: "We investigate whether investor protection is associated with how entrenched managers set corporate cash holdings."
  },
  {
    title: "Country-level governance quality, ownership concentration, and debt maturity - A comparative study of Brazil and Chile",
    journal: "Corporate Governance: An International Review, 25(4) 236-254, 2017",
    date: "2017-06-01",
    doi: "https://doi.org/10.1111/corg.12192",
    categories: ["Research", "Corporate Governance"],
    description: "This study investigates the interplay between country-level governance quality and the capital structure choice at the firm level in Brazil and Chile."
  },
  {
    title: "Cross-National Governance Research - A Systematic Review and Assessment",
    journal: "Corporate Governance: An International Review, 24(3), 181-199, 2016",
    date: "2016-01-11",
    doi: "https://doi.org/10.1111/corg.12158",
    categories: ["Research", "Corporate Governance"],
    description: "A Systematic Review surveying 192 cross-national comparative studies to synthesize the interplay between country- and firm-level governance."
  }
];

// ============================================================
// APPs
// ============================================================
const PWA_MANIFEST = {
  "short_name": "HCM admin",
  "name": "Henrique Martins - Admin",
  "start_url": "/admin/",
  "display": "standalone",
  "scope": "/admin/",
  "theme_color": "#000000",
  "background_color": "#ffffff",
  "icons": [
    {
      "src": "https://henriquemartins.co/teaching/financial_strategy/figs/avatar.jpg", // Use um link real de imagem
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
};

const PWA_SW_CODE = `
self.addEventListener('install', (e) => { self.skipWaiting(); });
self.addEventListener('fetch', (e) => { e.respondWith(fetch(e.request)); });
`;

const COURSE_PWA_MANIFEST = {
  "short_name": "FinStrat",
  "name": "Estrat√©gia Financeira - HM",
  "start_url": "/teaching/financial_strategy/", // Aponte para o arquivo principal
  "display": "standalone",
  "scope": "/teaching/financial_strategy/", // Remova a barra final aqui
  "theme_color": "#0b1220",
  "background_color": "#ffffff",
  "icons": [
    {
      "src": "https://henriquemartins.co/teaching/financial_strategy/figs/avatar.jpg",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
};

const COURSE_PWA_SW_CODE = `
self.addEventListener('install', (e) => { self.skipWaiting(); });
self.addEventListener('fetch', (e) => { e.respondWith(fetch(e.request)); });
`;

// ============================================================
// REPORT SQL
// ============================================================
const REPORT_SQL = `
WITH params AS (SELECT LOWER(TRIM(?1)) AS sid)
SELECT json_object(
  'student_id', (SELECT sid FROM params),
  'generated_at', datetime('now', '-3 hours'),
  'ranking',
    ( SELECT json_object(
        'likes', likes_points,
        'checkouts', checkouts_points,
        'polls', poll_points,
        'total', points
      )
      FROM ranking_score_total
      WHERE student_id = (SELECT sid FROM params)
    ),
  'attendance',
    ( SELECT json_object(
        'attended', attended,
        'total', total_class,
        'absences', absences,
        'pct', pct
      )
      FROM attendance_resume
      WHERE student_id = (SELECT sid FROM params)
    ),
  'attendance_history',
    ( SELECT json_group_array(json_object('date', date_class, 'status', status))
      FROM attendance_dates
      WHERE student_id = (SELECT sid FROM params)
      ORDER BY date_class DESC
    ),
  'polls_history',
    ( SELECT json_group_array(json_object(
        'id', r.poll_id,
        'question', a.question,
        'options_json', a.options_json,
        'your_answer', r.chosen_option,
        'correct_answer', a.correct_option,
        'is_correct', r.is_correct,
        'when', r.ts_br
      ))
      FROM poll_responses r
      LEFT JOIN poll_active a ON r.poll_id = a.poll_id
      WHERE r.student_id = ?1
      ORDER BY r.ts_br DESC
      
    ),
    'checkouts',
    ( SELECT json_group_array(json_object(
        'slide_id', slide_id,
        'ticket', ticket,
        'when', timestamp_br,
        'likert_question', likert_question,
        'likert_value', likert_value
      ))
      FROM (
        SELECT slide_id, ticket, timestamp_br, likert_question, likert_value
        FROM t_checkouts
        WHERE student_id = (SELECT sid FROM params)
        ORDER BY timestamp_br DESC
      )
    ),
   
  'likes_count',
    (SELECT COUNT(*) FROM likes WHERE student_id = (SELECT sid FROM params)) ,

    'module_progress',
    ( 
      WITH RECURSIVE all_modules(n) AS (
        SELECT 1 UNION ALL SELECT n + 1 FROM all_modules WHERE n < 10
      )
      SELECT json_group_array(json_object(
        'module', 'module' || m.n,
        'pct', COALESCE(p.pct, 0)
      ))
      FROM all_modules m
      LEFT JOIN (
        SELECT 
          q.module, 
          ROUND(CAST(COUNT(DISTINCT p.exercise_id) AS FLOAT) / 
          NULLIF((SELECT COUNT(*) FROM questions_bank WHERE module = q.module AND type != 'long'), 0) * 100) as pct
        FROM questions_bank q
        INNER JOIN questions_bank_progress p ON q.exercise_id = p.exercise_id
        WHERE p.student_id = (SELECT sid FROM params) 
          AND p.is_correct = 1 
          AND q.type != 'long'
        GROUP BY q.module
      ) p ON ('module' || m.n) = p.module
      ORDER BY m.n ASC
    )

) AS report_json;
`;

// ============================================================
// login
// ============================================================
const COURSE_HOME = "/teaching/financial_strategy/";
const LOGIN_PATH  = "/teaching/financial_strategy/login";

function redirectToLogin(origin, next = COURSE_HOME) {
  const headers = new Headers(cors(origin));
  headers.set("Location", `${LOGIN_PATH}?next=${encodeURIComponent(next)}`);
  headers.set("Cache-Control", "no-store");
  return new Response(null, { status: 303, headers });
}

// ============================================================
// WORKER
// ============================================================
export default {
  async fetch(req, env, ctx) {
    const url = new URL(req.url);
    const origin = resolveOrigin(req, env); 
    const method = req.method;
    
    const rawPath = url.pathname;
    const path = rawPath.replace(/\/{2,}/g, "/").replace(/\/+$/, "") || "/";
    const is = (p) => path === p;

// Rota para o Manifest do Admin
if (url.pathname === "/admin/manifest.json") {
  return new Response(JSON.stringify(PWA_MANIFEST), {
    headers: { "content-type": "application/json;charset=UTF-8" },
  });
}
// Rota para o Service Worker do Admin
if (url.pathname === "/admin/sw.js") {
  return new Response(PWA_SW_CODE, {
    headers: { "content-type": "application/javascript;charset=UTF-8" },
  });
}
// Rota para o Manifest do Curso
if (url.pathname === "/teaching/financial_strategy/manifest.json") {
  return new Response(JSON.stringify(COURSE_PWA_MANIFEST), {
    headers: { "content-type": "application/json;charset=UTF-8" },
  });
}
// Rota para o Service Worker do Curso
if (url.pathname === "/teaching/financial_strategy/sw.js") {
  return new Response(COURSE_PWA_SW_CODE, {
    headers: { "content-type": "application/javascript;charset=UTF-8" },
  });
}

// ============================================================
if (is("/api/whoami") && method === "GET") {
  const sid = await getStudentIdFromSession(req);
  return json({ student_id: sid || null }, origin);
}
// ============================================================


// ============================================================
// COURSE LOGIN (single entry point)
// GET  /teaching/financial_strategy/login
// POST /teaching/financial_strategy/login
// Always redirects to /teaching/financial_strategy/ after success
// ============================================================
function courseLoginPage({ message = "" } = {}) {
  const msg = String(message || "").trim();

  return `<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Course Login</title>
  <style>
    :root{--ink:#0f172a;--muted:#64748b;--line:#e2e8f0;--brand:#1e3a8a}
    *{box-sizing:border-box}
    body{
      margin:0;background:#f8fafc;color:var(--ink);
      font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      display:flex;align-items:center;justify-content:center;min-height:100vh;
      padding:24px;
    }
    .card{
      width:100%;max-width:420px;background:#fff;border:1px solid var(--line);
      border-radius:14px;box-shadow:0 2px 12px rgba(15,23,42,.06);
      padding:22px;
    }
    h1{margin:0 0 8px;font-size:20px;font-weight:800;color:var(--brand)}
    .muted{color:var(--muted);font-size:13px;margin-bottom:12px}
    .err{color:#991b1b;background:#fee2e2;border:1px solid #fecaca;padding:10px;border-radius:10px;margin:6px 0 12px;font-weight:700;font-size:13px}
    label{font-size:11px;font-weight:800;color:var(--muted);text-transform:uppercase}
    input{
      width:100%;padding:10px 12px;border:1px solid var(--line);
      border-radius:10px;margin:8px 0 12px;font:inherit;outline-color:var(--brand);
    }
    button{
      width:100%;padding:12px;border-radius:10px;border:1px solid var(--brand);
      background:var(--brand);color:#fff;font-weight:800;cursor:pointer;
    }
    .small{font-size:12px;color:var(--muted);margin-top:12px;text-align:center}
  </style>
</head>
<body>
  <div class="card">
    <h1>üîê Course Login</h1>
    <div class="muted">Sign in once to unlock the whole course.</div>
    ${msg ? `<div class="err" role="alert">${escapeHtml(msg)}</div>` : ""}
    <form method="POST" action="/teaching/financial_strategy/login" autocomplete="off">
      <label>Student ID</label>
      <input type="text" name="username" placeholder="student_id" required autofocus />
      <label>Password</label>
      <input type="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
      <button type="submit">Enter</button>
    </form>
    <div class="small">After login, you won‚Äôt be asked again on this device.</div>
  </div>
</body>
</html>`;
}

if (path === "/teaching/financial_strategy/login" && method === "GET") {
  const sid = await getStudentIdFromSession(req);

  // Mesmo que venha ?next=..., voc√™ quer sempre HOME:
  const safeNext = COURSE_HOME;

  if (sid) {
    return new Response(null, {
      status: 303,
      headers: { ...cors(origin), "Location": safeNext, "Cache-Control": "no-store" }
    });
  }

  return new Response(courseLoginPage(), {
    status: 200,
    headers: { "Content-Type": "text/html; charset=utf-8", "Cache-Control": "no-store", ...cors(origin) }
  });
}

if (path === "/teaching/financial_strategy/login" && method === "POST") {
  const fd = await req.formData();
  const username = String(fd.get("username") || "").trim().toLowerCase();
  const password = String(fd.get("password") || "").trim();

  if (!username || !password) {
    return new Response(courseLoginPage({ message: "Missing credentials." }), {
      status: 200,
      headers: { "Content-Type": "text/html; charset=utf-8", "Cache-Control": "no-store", ...cors(origin) }
    });
  }

  const student = await env.DB.prepare(
    "SELECT student_id, password, active, prof, term_id FROM t_students_dim WHERE student_id = ? AND password = ?"
  ).bind(username, password).first();

  let status = "fail";
  if (student) status = student.active ? "success" : "denied";

  ctx.waitUntil(
    env.DB.prepare(
      "INSERT INTO t_logins (student_id, status, page, prof, term_id) VALUES (?, ?, ?, ?, ?)"
    ).bind(username, status, "course", student?.prof || "", student?.term_id || "").run()
  );

  if (status !== "success") {
    const msg = (status === "denied")
      ? "Account inactive. Contact the instructor."
      : "Invalid credentials.";

    return new Response(courseLoginPage({ message: msg }), {
      status: 200,
      headers: { "Content-Type": "text/html; charset=utf-8", "Cache-Control": "no-store", ...cors(origin) }
    });
  }

  // sucesso: cookie + redirect
  const safeNext = COURSE_HOME;
  const headers = new Headers(cors(origin));
  headers.set("Cache-Control", "no-store");
  headers.set(
    "Set-Cookie",
    `student_id=${encodeURIComponent(username)}; Path=/; Secure; HttpOnly; SameSite=Lax; Max-Age=2592000`
  );
  headers.set("Location", safeNext);

  return new Response(null, { status: 303, headers });
}



// --- SLIDES (protegido por login) ---
if (url.pathname.startsWith("/teaching/financial_strategy/slides/")) {
  const sid = await getStudentIdFromSession(req);
  if (!sid) return redirectToLogin(origin, COURSE_HOME);

  const slideKey = url.pathname.replace("/teaching/financial_strategy/slides/", "");
  const object = await env.SLIDES_BUCKET.get(slideKey);

  if (object === null) {
    return new Response("Slide ou imagem n√£o encontrados", { status: 404 });
  }

  const headers = new Headers();
  object.writeHttpMetadata(headers);
  headers.set("etag", object.httpEtag);

  // For√ßar Content-Type baseado na extens√£o
  const p = url.pathname.toLowerCase();
  if (p.endsWith(".html")) headers.set("Content-Type", "text/html; charset=utf-8");
  else if (p.endsWith(".css")) headers.set("Content-Type", "text/css; charset=utf-8");
  else if (p.endsWith(".js")) headers.set("Content-Type", "application/javascript; charset=utf-8");
  else if (p.endsWith(".png")) headers.set("Content-Type", "image/png");
  else if (p.endsWith(".jpg") || p.endsWith(".jpeg")) headers.set("Content-Type", "image/jpeg");
  else if (p.endsWith(".svg")) headers.set("Content-Type", "image/svg+xml; charset=utf-8");

  return new Response(object.body, { headers });
}




// 1) Preflight (CORS)
if (method === "OPTIONS") {
return new Response(null, { status: 204, headers: cors(origin) });
}

if (path === "/admin") {
const token = url.searchParams.get("t") || getCookie(req, "admin_token");
const master = String(env.ADMIN_SEMESTER || "").trim();
if (!token || token !== master) {
return new Response(renderAdminLoginPage(), { headers: { "Content-Type": "text/html; charset=utf-8" } });
}
return new Response(renderAdminDashboard(token), { 
headers: { 
"Content-Type": "text/html; charset=utf-8",
"Set-Cookie": `admin_token=${token}; Path=/; Secure; SameSite=Lax; Max-Age=86400` 
} 
});
}

// --- API: Verificar Mensagens (Fica no topo para ser r√°pido) ---
if (is("/api/dm/check") && method === "GET") {
const sid = String(url.searchParams.get("sid") || "").trim().toLowerCase();
if (!sid) return json({ error: "missing sid" }, origin, 400);
const row = await env.DB.prepare(`
 SELECT
   d.id,
   d.student_id,
   d.checkout_id,
   d.message_text,
   d.created_at,
   d.is_read,
  CASE
  WHEN d.context_type IS NOT NULL AND TRIM(d.context_type) <> '' THEN TRIM(d.context_type)
  WHEN d.checkout_id IS NOT NULL AND TRIM(d.checkout_id) <> '' THEN 'checkout'
  ELSE 'manual'
 END AS context_type,
    (
    SELECT c.ticket
    FROM t_checkouts c
    WHERE c.student_id = d.student_id
    AND c.slide_id = d.checkout_id
    ORDER BY c.timestamp_br DESC
    LIMIT 1
 ) AS original_ticket,
 (
      SELECT COALESCE(c.timestamp_br, c.created_at)
      FROM t_checkouts c
      WHERE c.student_id = d.student_id
        AND c.slide_id = d.checkout_id
      ORDER BY c.timestamp_br DESC
      LIMIT 1
    ) AS original_when
  FROM dm d
  WHERE d.student_id = ?
    AND COALESCE(d.is_read, 0) = 0
  ORDER BY d.created_at DESC
  LIMIT 1
`).bind(sid).first();
  return json({ message: row || null }, origin);
}

// --- API: Marcar como Lida ---
if (is("/api/dm/mark-read") && method === "POST") {
const body = await readJsonBody(req);
const { message_id, student_id } = body || {};
const ua = req.headers.get("user-agent") || "";
await env.DB.batch([
env.DB.prepare("UPDATE dm SET is_read = 1 WHERE id = ?").bind(message_id),
env.DB.prepare("INSERT INTO dm_seen (message_id, student_id, user_agent) VALUES (?, ?, ?)")
.bind(message_id, student_id, ua)
]);
return json({ status: "ok" }, origin);
}



// ============================================================
// 2) STATIC ASSETS (Inje√ß√£o de DM nos Slides)
// ============================================================
const urlPath = url.pathname;
if (
!urlPath.startsWith("/teaching/financial_strategy/") &&
      urlPath.match(/\.(html|css|js|mjs|map|json|png|jpg|jpeg|gif|webp|svg|ico|pdf|txt|xml|woff2?|ttf|eot|otf|wasm)$/i)
    ) {
      try {
        let assetRes = await env.ASSETS.fetch(req);
    
        if (assetRes.status !== 200 && !urlPath.startsWith("/teaching/financial_strategy/")) {
          const internalPath = "/teaching/financial_strategy" + (urlPath.startsWith("/") ? urlPath : "/" + urlPath);
          const fallbackUrl = new URL(internalPath, url.origin);
          fallbackUrl.search = url.search;
          const fallbackReq = new Request(fallbackUrl.toString(), req);
          assetRes = await env.ASSETS.fetch(fallbackReq);
        }
        return withCors(assetRes, origin);
      } catch (e) {
        console.error("Erro Assets:", e);
 }
}
    




// ============================================================
// 3) ADMIN GATE (Substituindo o bloco original)
// ============================================================
if (
  path.startsWith("/admin") ||
  path === "/poll/export" ||
  path === "/poll/admin" ||
  path === "/poll/list"
) {
  const clean = (s) => String(s ?? "").trim();
  
  const hdr = clean(req.headers.get("x-admin-token"));
  const bearer = clean((req.headers.get("authorization") || "").replace(/^Bearer\s+/i, ""));
  const qsTok = clean(url.searchParams.get("token") || url.searchParams.get("t") || url.searchParams.get("tkn"));
  const cookieTok = clean(getCookie(req, "admin_token")); 
  
  const sent = hdr || bearer || qsTok || cookieTok;
  const master = clean(env.ADMIN_SEMESTER || env.ADMIN_TOKEN || "");

  // Permitir acesso √† p√°gina de login se o token estiver ausente
  if ((path === "/admin" || path === "/admin/") && sent !== master) {
      // Deixa passar para o renderAdminLoginPage()
  } 
  // Bloquear todo o resto se o token estiver errado
  else if (sent !== master) {
    return new Response("Unauthorized: Admin access required", { 
      status: 401, 
      headers: cors(origin) 
    });
  }
}


    // Ensure schema (idempotent)
    try { await ensureSchema(env); } catch { /* ignore */ }

    const isAdmin = () => {
      const clean = (s) => String(s ?? "").trim();
      const sent = clean(req.headers.get("x-admin-token") || url.searchParams.get("token") || url.searchParams.get("t"));
      const master = clean(env.ADMIN_SEMESTER || env.ADMIN_TOKEN || "");
      return !!sent && sent === master;
    };

    // ===== helpers =====
    const int = (v, d = 0) => {
      const n = parseInt(String(v ?? ""), 10);
      return Number.isFinite(n) ? n : d;
    };
    const clamp = (n, lo, hi) => Math.max(lo, Math.min(hi, n));
    const nowMs = () => Date.now();

    // Rate limit (in-memory)
    const buckets = globalThis.__rl_buckets || (globalThis.__rl_buckets = new Map());
    const rateLimit = (key, limit, windowMs) => {
      const now = Date.now();
      const b = buckets.get(key) || [];
      const keep = b.filter((t) => now - t < windowMs);
      if (keep.length >= limit) {
        buckets.set(key, keep);
        return false;
      }
      keep.push(now);
      buckets.set(key, keep);
      return true;
    };
  

// ============================================================
// NOVO: Rota para renderizar Polls Ativas (P√°gina P√∫blica/Alunos)
// ============================================================
if (path === "/teaching/financial_strategy/polls" && method === "GET") {
  const sid = await getStudentIdFromSession(req);
  if (!sid) return redirectToLogin(origin, COURSE_HOME);
  const { results: activePolls } = await env.DB.prepare(
    "SELECT * FROM poll_active WHERE is_active = 1 ORDER BY poll_id DESC"
  ).all();
  if (!activePolls || activePolls.length === 0) {
    return new Response(renderNoPollsPage(), {
      status: 200,
      headers: { "Content-Type": "text/html; charset=utf-8", "Cache-Control": "no-store", ...cors(origin) }
    });
  }
  const html = renderPollsPage(activePolls, sid);
  return new Response(html, {
    status: 200,
    headers: { "Content-Type": "text/html; charset=utf-8", "Cache-Control": "no-store", ...cors(origin) }
  });
}



// ============================================================
// NOVO: Rota para o Ranking (P√°gina Completa)
// ============================================================
if (path === "/teaching/financial_strategy/ranking") {
  const sid = await getStudentIdFromSession(req);
  if (!sid) return redirectToLogin(origin, COURSE_HOME);

  // Busca o Top 5 Geral
  const { results: topRows } = await env.DB.prepare(`
    SELECT student_id, points
    FROM ranking_score_total
    ORDER BY points DESC, student_id COLLATE NOCASE ASC
    LIMIT 5
  `).all();

  // Busca os dados do aluno logado para a "faixa pessoal"
  const me = await env.DB.prepare(`
    WITH ranked AS (
      SELECT *, ROW_NUMBER() OVER (ORDER BY points DESC, student_id ASC) AS pos
      FROM ranking_score_total
    )
    SELECT * FROM ranked WHERE student_id = ?
  `).bind(sid).first();

  const html = renderRankingPage(topRows, me, sid);
  return new Response(html, {
    status: 200,
    headers: { "Content-Type": "text/html; charset=utf-8", ...cors(origin) }
  });
}


// ============================================================
// Checkout as page
// ============================================================
if (is("/checkout/active") && method === "GET") {
  const rows = await env.DB.prepare(`
    SELECT session_id, title, question, open_ts, close_ts, require_login
    FROM t_checkout_sessions
    WHERE is_active = 1
    ORDER BY open_ts ASC
  `).all();

  return json({ sessions: rows.results || [] }, origin);
}

if (is("/teaching/financial_strategy/checkout") && method === "GET") {
  const sid = await getStudentIdFromSession(req);
  if (!sid) return redirectToLogin(origin, COURSE_HOME);
const html = `<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Financial Strategy - Checkout</title>
  <style>
    /* FUNDO DA P√ÅGINA: Agora sempre claro por padr√£o */
    body{margin:0;font-family:system-ui,-apple-system,sans-serif;background:#ffffff;color:#0b1220}
    .wrap{max-width:980px;margin:0 auto;padding:22px 16px 40px}
    h1{margin:8px 0 6px;font-size:28px;color:#0b1220}
    .sub{color:#425466;margin:0 0 18px}
    .stack{display:flex;flex-direction:column;gap:14px}
    .empty{padding:14px 16px;border:1px dashed rgba(15,23,42,.20);border-radius:14px;background:#f8fafc;color:#425466}
  </style>

  <style>
    :root{
      /* CORES DO TICKET: For√ßamos o estilo escuro (Dark Mode) fixo para o Card, 
         independente da prefer√™ncia do sistema do aluno */
      --card-bg: rgba(15,23,42,1); 
      --card-border: rgba(148,163,184,.20); 
      --card-shadow: 0 16px 44px rgba(0,0,0,.15);
      --line: rgba(148,163,184,.28); 
      --pill-bg: rgba(148,163,184,.18);
      --ink: #f8fafc; 
      --muted: #e5edf6; 
      --muted-2: #f1f5f9;
      --btn-bg-1: #5b7fff; 
      --btn-bg-2: #7cc5ff; 
      --btn-ink: #0b1220;
      --textarea-bg: rgba(2,6,23,.55);

      --ribbon-open-1: rgba(34,197,94,.18);
      --ribbon-open-2: rgba(16,185,129,.16);
      --ribbon-soon-1: rgba(245,158,11,.18);
      --ribbon-soon-2: rgba(251,191,36,.16);
      --ribbon-closed-1: rgba(239,68,68,.20);
      --ribbon-closed-2: rgba(248,113,113,.16);
      --ribbon-default-1: rgba(99,102,241,.14);
      --ribbon-default-2: rgba(96,165,250,.14);

      --likert-bg: rgba(148,163,184,.18);
      --likert-border: rgba(148,163,184,.26);
      --likert-selected: rgba(124,197,255,.22);
      --likert-selected-border: rgba(124,197,255,.52);
    }

    /* Removido o @media (prefers-color-scheme: dark) que alterava o body, 
       pois queremos o fundo sempre branco. */

    [data-ticket] .tw-card{
      position:relative;background:var(--card-bg);border:1px solid var(--card-border);border-radius:16px;
      padding:16px;box-shadow:var(--card-shadow);backdrop-filter:saturate(120%) blur(6px);
      color:var(--ink);overflow:hidden;box-sizing:border-box;
    }
    
    /* Faixa de cor no topo do card (Ribbon) */
    [data-ticket] .tw-card::before{
      content:"";position:absolute;inset:0 0 auto 0;height:56px;
      background:linear-gradient(135deg,var(--ribbon-default-1),var(--ribbon-default-2));
      pointer-events:none;
    }
    [data-ticket].open   .tw-card::before{ background:linear-gradient(135deg,var(--ribbon-open-1),var(--ribbon-open-2)); }
    [data-ticket].soon   .tw-card::before{ background:linear-gradient(135deg,var(--ribbon-soon-1),var(--ribbon-soon-2)); }
    [data-ticket].closed .tw-card::before{ background:linear-gradient(135deg,var(--ribbon-closed-1),var(--ribbon-closed-2)); }

    [data-ticket] .tw-header{display:flex;align-items:center;gap:12px;margin-bottom:10px;position:relative;z-index:1;}
    [data-ticket] .tw-icon{
      width:36px;height:36px;border-radius:12px;background:#1f2937;display:grid;place-items:center;flex:0 0 36px;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.08);position:relative;
    }
    /* ... resto do CSS original mantido ... */
    [data-ticket] .tw-icon::after{
      content:"";position:absolute;inset:-3px;border-radius:14px;
      background:conic-gradient(from 120deg,rgba(79,70,229,.35),rgba(6,182,212,.35),rgba(79,70,229,.35));
      z-index:-1;filter:blur(6px);opacity:.55;
    }
    [data-ticket] .tw-icon svg{width:18px;height:18px;color:#fff;opacity:.96;}
    [data-ticket] .tw-titles{display:flex;flex-direction:column;gap:2px;}
    [data-ticket] .tw-title{font-weight:800;color:var(--ink);line-height:1.1;letter-spacing:.2px;}
    [data-ticket] .tw-sub{color:var(--muted);font-size:.92rem;}

    [data-ticket] .tw-meta{margin-left:auto;display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
    [data-ticket] .tw-badge{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;
      background:var(--pill-bg);color:var(--muted-2);font-size:.88rem;white-space:nowrap;box-shadow:0 1px 0 rgba(17,24,39,.04) inset;
    }
    [data-ticket] .tw-window-text{white-space:pre-line;}
    [data-ticket] .tw-dot{width:8px;height:8px;border-radius:50%;background:#94a3b8;}
    [data-ticket].open  .tw-dot{background:#16a34a;}
    [data-ticket].soon  .tw-dot{background:#f59e0b;}
    [data-ticket].closed .tw-dot{background:#ff4d4f;}

    [data-ticket] .tw-body{position:relative;z-index:1;box-sizing:border-box;}
    [data-ticket] textarea.tw-text{
      width:100%;border:1px solid var(--line);background:var(--textarea-bg);border-radius:14px;padding:12px 14px;
      font-size:1rem;line-height:1.5;outline:none;transition:border-color .15s,box-shadow .15s,transform .06s;min-height:120px;
      resize:vertical;color:var(--ink);box-sizing:border-box;
    }
    [data-ticket] textarea.tw-text:focus{border-color:#60a5fa;box-shadow:0 0 0 4px var(--focus);transform:translateY(-1px);}

    [data-ticket] .tw-footer{display:flex;align-items:center;gap:12px;margin-top:12px;flex-wrap:wrap;}
    [data-ticket] .tw-count{margin-left:auto;color:#60758a;font-size:.86rem;}
    [data-ticket] .tw-msg{margin-top:8px;font-size:.93rem;min-height:1.2em;font-weight:700;letter-spacing:.2px;}
    [data-ticket] .tw-msg.success{color:#059669!important;}
    [data-ticket] .tw-msg.error{color:#ff4d4f!important;}
    [data-ticket] .tw-msg.warning{color:#f59e0b!important;}

    [data-ticket] .tw-btn{
      padding:10px 16px;border-radius:12px;border:1px solid rgba(15,23,42,.12);
      background:linear-gradient(135deg,var(--btn-bg-1),var(--btn-bg-2));color:var(--btn-ink);font-weight:800;cursor:pointer;
      box-shadow:0 4px 14px rgba(59,130,246,.25);transition:transform .08s ease,box-shadow .15s ease,filter .15s ease;letter-spacing:.2px;
    }
    [data-ticket] .tw-btn:hover{transform:translateY(-1px);box-shadow:0 8px 22px rgba(59,130,246,.35);filter:saturate(108%);}
    [data-ticket] .tw-btn:disabled{opacity:.85;cursor:not-allowed;transform:none;background:#e5f0ff;color:#6b7280;border-color:#dbeafe;box-shadow:none;}
    [data-ticket] .tw-btn.sent{opacity:.92;cursor:default;}

    [data-ticket] .tw-likert{
      display:flex;align-items:center;gap:10px;
      padding:8px 10px;border-radius:12px;border:1px solid var(--line);
      background:var(--pill-bg);
    }
    [data-ticket] .tw-likert .tw-lab{font-size:.86rem;font-weight:800;color:var(--muted-2);white-space:nowrap;}
    [data-ticket] .tw-likert .tw-boxes{display:flex;gap:6px;}
    [data-ticket] .tw-likert button.tw-box{
      width:28px;height:28px;border-radius:9px;border:1px solid var(--likert-border);
      background:var(--likert-bg);color:var(--muted-2);font-weight:900;cursor:pointer;display:grid;place-items:center;
      transition:transform .06s, box-shadow .15s, border-color .15s, background .15s;user-select:none;
    }
    [data-ticket] .tw-likert button.tw-box.selected{background:var(--likert-selected);border-color:var(--likert-selected-border);}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Checkout</h1>
    <p class="sub">Submit your checkout for the current session.</p>

    <div id="checkout_stack" class="stack">
      <div class="empty">Loading‚Ä¶</div>
    </div>
  </div>

  <script>
    const BRIDGE_URL = ${JSON.stringify((new URL(req.url)).origin)}; // same worker origin
  </script>

  <!-- ======= checkout3.js (embedded) ======= -->
  <script>
  (() => {
    const stack = document.getElementById("checkout_stack");

    async function load_sessions(){
      try{
        const res = await fetch("/checkout/active", { method:"GET" });
        const data = await res.json();
        return (data && data.sessions) ? data.sessions : [];
      }catch(e){
        return [];
      }
    }

    function render_empty(){
      stack.innerHTML = '<div class="empty">No checkout session is active right now.</div>';
    }

    function mount_widget(host){
      const $ = (sel, el=document) => el.querySelector(sel);

      const bridge = (host.getAttribute('data-bridge') || '').trim();
      const sessionTag = (host.getAttribute('data-session') || '').trim();
      const pageAttr   = (host.getAttribute('data-page') || '').trim();
      const winStartStr= (host.getAttribute('data-open') || '').trim();
      const winEndStr  = (host.getAttribute('data-close') || '').trim();
      const requireLogin = String(host.getAttribute('data-require-login') || 'true').toLowerCase() !== 'false';
      const questionLabel = (host.getAttribute('data-question') || 'How did you like today?').trim();

      const MIN_CHARS = 100;
      const MAX_CHARS = 500;

      const parseLocal = (ts) => ts ? new Date(ts.replace(' ','T')) : null;
      const winStart = parseLocal(winStartStr);
      const winEnd   = parseLocal(winEndStr);

      const fmtDur = (s) => { const m=Math.floor(s/60),r=s%60; if(m>=60){const h=Math.floor(m/60),mm=m%60;return \`\${h}h \${mm}m\`;} if(m>0) return \`\${m}m \${r}s\`; return \`\${r}s\`; };
      function statusNow(){
        const now = new Date();
        if (!winStart || !winEnd) return {state:'open', label:'Always available'};
        if (now < winStart){ const s1=Math.max(0,Math.floor((winStart-now)/1000)); return {state:'soon', label:'Opens in '+fmtDur(s1)}; }
        if (now > winEnd)   return {state:'closed', label:'Closed'};
        const s2=Math.max(0,Math.floor((winEnd-now)/1000)); return {state:'open', label:'Closes in '+fmtDur(s2)};
      }

      const getStudentId = () => String(window.studentId || localStorage.getItem('studentId') || localStorage.getItem('fs_user') || '').trim();
      const getPageId = () => pageAttr || window.pageId || (location.pathname + location.hash);
      const setMsg = (el, text, cls) => { el.textContent = text || ''; el.className = 'tw-msg' + (cls ? ' ' + cls : ''); };

      // IMPORTANT: doneKey uses sessionTag, so sessionTag MUST be unique per checkout session
      const doneKey = () => \`ticket_done:exit:\${(sessionTag || getPageId() || 'page')}:\${(getStudentId() || 'anon')}\`;
      const isDone  = () => { try { return localStorage.getItem(doneKey()) === '1'; } catch(_) { return false; } };
      const markDone = (btn) => { try{ localStorage.setItem(doneKey(), '1'); }catch(_){}; btn.classList.remove('spin'); btn.disabled = true; btn.classList.add('sent'); btn.textContent = 'Sent ‚úì'; };

      // ---- UI
      host.innerHTML = '';
      const card = document.createElement('div'); card.className = 'tw-card';
      const windowLabel = (winStartStr && winEndStr) ? (winStartStr + '\\n‚Üí ' + winEndStr) : 'No window set';

      card.innerHTML = \`
        <div class="tw-header">
          <div class="tw-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none"><path d="M12 8v5l3 3M6 3h12a1 1 0 0 1 1 1v16l-7-3-7 3V4a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </div>
          <div class="tw-titles">
            <div class="tw-title">Check-out</div>
            <div class="tw-sub">\${sessionTag || ''}</div>
          </div>
          <div class="tw-meta">
            <div class="tw-badge"><span class="tw-dot"></span><span class="tw-badge-text">‚Äî</span></div>
            <div class="tw-badge" title="S√£o Paulo time">
              <span class="tw-window-text">\${windowLabel}</span>
            </div>
          </div>
        </div>

        <div class="tw-login" style="display:none">
          <input type="text" class="tw-login-input" placeholder="Your course ID / email"/>
          <button type="button" class="tw-btn tw-login-btn">Log in</button>
        </div>

        <div class="tw-body"></div>

        <div class="tw-footer">
          <div class="tw-likert" role="group" aria-label="Likert question">
            <span class="tw-lab"></span>
            <div class="tw-boxes">
              <button type="button" class="tw-box" data-val="1">1</button>
              <button type="button" class="tw-box" data-val="2">2</button>
              <button type="button" class="tw-box" data-val="3">3</button>
              <button type="button" class="tw-box" data-val="4">4</button>
              <button type="button" class="tw-box" data-val="5">5</button>
            </div>
          </div>

          <button type="button" class="tw-btn tw-send">Send</button>
          <div class="tw-count">0/\${MAX_CHARS}</div>
        </div>

        <div class="tw-msg"></div>\`;

      host.appendChild(card);

      const body = $('.tw-body', card);
      const btn  = $('.tw-send', card);
      const msg  = $('.tw-msg', card);
      const badgeText = $('.tw-badge-text', card);
      const count = $('.tw-count', card);
      const loginRow = $('.tw-login', card);
      const loginInp = $('.tw-login-input', card);
      const loginBtn = $('.tw-login-btn', card);
      const likertLabelEl = $('.tw-lab', card);
      const likertBoxes = Array.from(card.querySelectorAll('.tw-box'));

      likertLabelEl.textContent = questionLabel || 'Confidence';
      let likertValue = 0;

      const ta = document.createElement('textarea');
      ta.className = 'tw-text';
      ta.maxLength = MAX_CHARS;
      ta.placeholder = \`Your check-out (min \${MIN_CHARS}, max \${MAX_CHARS}): one thing you learned + one question‚Ä¶\`;
      body.appendChild(ta);

      function updateCount(){ count.textContent = \`\${ta.value.length}/\${MAX_CHARS}\`; }
      ta.addEventListener('input', () => { updateCount(); syncEnabled(); });
      updateCount();

      const successMsg = 'Check-out recorded. Thank you!';
      const dupMsg     = 'You have already completed this check-out. Thanks!';

      function paintBadge(){
        const st = statusNow();
        host.classList.remove('open','soon','closed'); host.classList.add(st.state);
        badgeText.textContent = st.label;
      }

      function showLoginIfNeeded(){
        const need = requireLogin && !getStudentId();
        loginRow.style.display = need ? 'flex' : 'none';
      }

      function setLikert(val){
        likertValue = val;
        likertBoxes.forEach(b => {
          const v = parseInt(b.getAttribute('data-val'), 10);
          b.classList.toggle('selected', v === likertValue);
        });
      }

      likertBoxes.forEach(b => {
        b.addEventListener('click', () => {
          const v = parseInt(b.getAttribute('data-val'), 10) || 0;
          setLikert(v);
          setMsg(msg, '');
          syncEnabled();
        });
      });

      function syncEnabled(){
        const logged = !requireLogin || !!getStudentId();
        const st     = statusNow().state;
        const len    = ta.value.trim().length;
        const filled = len >= MIN_CHARS;
        const rated  = likertValue >= 1 && likertValue <= 5;

        const enabled= logged && (st==='open') && filled && rated && !isDone();
        btn.disabled = !enabled;

        showLoginIfNeeded(); paintBadge();

        if (isDone()){
          setMsg(msg, dupMsg, 'success');
          btn.textContent = 'Sent ‚úì'; btn.classList.add('sent'); btn.disabled = true;
        } else if (!logged) setMsg(msg,'Please log in to submit.','warning');
        else if (st==='soon') setMsg(msg,'Not open yet.','warning');
        else if (st==='closed') setMsg(msg,'This activity is closed.','error');
        else if (!filled) setMsg(msg, \`Write at least \${MIN_CHARS} characters to submit.\`, 'warning');
        else if (!rated) setMsg(msg, \`Please answer: \${questionLabel} (1‚Äì5).\`, 'warning');
        else setMsg(msg,'');
      }

      loginBtn?.addEventListener('click', () => {
        const v = (loginInp.value || '').trim();
        if (!v) { setMsg(msg,'Enter your ID to continue.','warning'); return; }
        try { localStorage.setItem('studentId', v); } catch {}
        window.studentId = v;
        document.dispatchEvent(new Event('auth:login'));
        setMsg(msg,''); syncEnabled();
      });

      paintBadge(); syncEnabled();
      const ticker = setInterval(() => { paintBadge(); syncEnabled(); }, 1000);
      document.addEventListener('auth:login', syncEnabled);

      btn.addEventListener('click', async (e) => {
        e.preventDefault(); e.stopPropagation();

        const sid = getStudentId();
        if (requireLogin && !sid){ setMsg(msg,'Please log in to submit.','warning'); return; }

        const text = ta.value.trim().slice(0,MAX_CHARS);
        if (text.length < MIN_CHARS){ setMsg(msg, \`Write at least \${MIN_CHARS} characters to submit.\`, 'warning'); return; }
        if (!(likertValue >= 1 && likertValue <= 5)){ setMsg(msg, \`Please answer: \${questionLabel} (1‚Äì5).\`, 'warning'); return; }
        if (!bridge){ setMsg(msg,'Missing BRIDGE URL.','error'); return; }

        btn.classList.add('spin'); btn.disabled = true; setMsg(msg,'');

        const payload = {
          student_id: sid,
          slide_id: (sessionTag || getPageId()),
          ticket: text,
          likert_question: questionLabel,
          likert_value: likertValue,
          ts_client: new Date().toISOString(),
          open:  winStartStr,
          close: winEndStr,
          user_agent: navigator.userAgent
        };

        try{
          const res = await fetch(bridge, {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify(payload),
            keepalive:true
          });

          const raw = await res.text();
          let data = null; try{ data = JSON.parse(raw); }catch(_){}

          if (!res.ok){
            setMsg(msg,'Failed to submit. Please try again.','error');
            btn.classList.remove('spin'); btn.disabled = false; btn.textContent = 'Send (click only 1x)';
            return;
          }

          if (data && data.status === 'success'){
            setMsg(msg, successMsg, 'success');
            ta.value=''; updateCount(); setLikert(0);
            markDone(btn); clearInterval(ticker);
            return;
          }
          if (data && data.status === 'duplicate'){
            setMsg(msg, dupMsg, 'success'); markDone(btn); clearInterval(ticker); return;
          }
          if (data && data.status === 'closed_window'){
            setMsg(msg,'This activity is closed now.','error');
            btn.classList.remove('spin'); btn.disabled = false; btn.textContent = 'Send (click only 1x)';
            return;
          }

          setMsg(msg,'Failed to submit. Please try again.','error');
          btn.classList.remove('spin'); btn.disabled = false; btn.textContent = 'Send (click only 1x)';
        }catch(err){
          setMsg(msg,'Network error. Please try again.','error');
          btn.classList.remove('spin'); btn.disabled = false; btn.textContent = 'Send (click only 1x)';
        }
      });
    }

    (async () => {
      const sessions = await load_sessions();
      if (!sessions.length) return render_empty();

      stack.innerHTML = "";
      sessions.forEach(s => {
        const host = document.createElement("div");
        host.setAttribute("data-ticket", "");
        host.setAttribute("data-bridge", (location.origin.replace(/\\/$/, "") + "/checkouts"));
        host.setAttribute("data-session", s.session_id || s.title || "Checkout");
        host.setAttribute("data-page", s.title || s.session_id || "Checkout");
       host.setAttribute("data-require-login", "false");
        host.setAttribute("data-question", s.question || "How did you like today?");
        host.setAttribute("data-open", s.open_ts || "");
        host.setAttribute("data-close", s.close_ts || "");
        stack.appendChild(host);
        mount_widget(host);
      });
    })();
  })();
  </script>
</body>
</html>`;

  return new Response(html, {
    headers: {
      "content-type": "text/html; charset=utf-8",
      "cache-control": "no-store",
      ...cors(origin)
    }
  });
}



if (is("/admin/checkout") && method === "GET") {
  const activate = url.searchParams.get("set") === "1";
  const session_id = (url.searchParams.get("session_id") || "").trim();

  if (activate && session_id) {
    const title = url.searchParams.get("title") || session_id;
    const question = url.searchParams.get("question") || "How did you like today?";
    const open_ts = url.searchParams.get("open") || "";
    const close_ts = url.searchParams.get("close") || "";
    const require_login = (url.searchParams.get("require_login") || "1") === "1" ? 1 : 0;

    await env.DB.prepare(`
      INSERT INTO t_checkout_sessions (session_id, title, question, open_ts, close_ts, require_login, is_active)
      VALUES (?, ?, ?, ?, ?, ?, 1)
      ON CONFLICT(session_id) DO UPDATE SET
        title=excluded.title,
        question=excluded.question,
        open_ts=excluded.open_ts,
        close_ts=excluded.close_ts,
        require_login=excluded.require_login,
        is_active=1
    `).bind(session_id, title, question, open_ts, close_ts, require_login).run();

    return json({ status: "ok_activated" }, origin);
  }

  if (!activate && session_id) {
    await env.DB.prepare(`UPDATE t_checkout_sessions SET is_active=0 WHERE session_id=?`).bind(session_id).run();
    return json({ status: "ok_deactivated" }, origin);
  }
  return json({ status: "noop" }, origin);
}

// --- ADMIN: Listar sess√µes de checkout ---
if (is("/admin/checkout/sessions/list") && method === "GET") {
  const { results } = await env.DB.prepare(`
    SELECT * FROM t_checkout_sessions 
    ORDER BY open_ts DESC 
    LIMIT 50
  `).all();
  return json(results || [], origin);
}

// --- ADMIN: Salvar/Atualizar sess√£o ---
if (is("/admin/checkout/sessions/save") && method === "POST") {
  const body = await readJsonBody(req);
  const { session_id, title, question, open_ts, close_ts, require_login, is_active } = body;

  if (!session_id) return json({ error: "Missing session_id" }, origin, 400);

  await env.DB.prepare(`
    INSERT INTO t_checkout_sessions (session_id, title, question, open_ts, close_ts, require_login, is_active)
    VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7)
    ON CONFLICT(session_id) DO UPDATE SET
      title=excluded.title,
      question=excluded.question,
      open_ts=excluded.open_ts,
      close_ts=excluded.close_ts,
      require_login=excluded.require_login,
      is_active=excluded.is_active
  `).bind(
    session_id.trim(), 
    title || session_id, 
    question || "How did you like today?", 
    open_ts || "", 
    close_ts || "", 
    require_login ? 1 : 0, 
    is_active ? 1 : 0
  ).run();

  return json({ status: "success" }, origin);
}

// --- ADMIN: Deletar sess√£o ---
if (is("/admin/checkout/sessions/delete") && method === "DELETE") {
  const session_id = url.searchParams.get("session_id");
  await env.DB.prepare("DELETE FROM t_checkout_sessions WHERE session_id = ?").bind(session_id).run();
  return json({ status: "ok" }, origin);
}

if (is("/admin/checkout/manager") && method === "GET") {
  const adminKey = req.headers.get("x-admin-token") || url.searchParams.get("t") || url.searchParams.get("token") || "";
  
  const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>HCM Admin: Checkout Manager</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    :root{ --bg:#0b1220; --card:#111a2e; --muted:#93a4c7; --text:#e8eefc; --border:rgba(255,255,255,.10); --accent:#a78bfa; --ok:#34d399; --bad:#fb7185;}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,sans-serif;padding:20px; padding-bottom: 60px;}
    .wrap{max-width:900px;margin:0 auto;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:20px;}
    h1{font-size:1.5rem;margin:0 0 20px;}
    label{display:block;color:var(--muted);font-size:11px;text-transform:uppercase;margin:12px 0 4px;font-weight:800;}
    input, select, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0e1730;color:var(--text);font:inherit;box-sizing:border-box;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .row-actions{display:flex;gap:10px;margin-top:20px;}
    button{padding:12px 18px;border-radius:10px;border:none;font-weight:800;cursor:pointer;transition:0.2s;}
    .btn-save{background:var(--accent);color:#000;flex:2;}
    .btn-clear{background:transparent;color:var(--muted);border:1px solid var(--border);flex:1;}
    table{width:100%;border-collapse:collapse;margin-top:20px;font-size:13px;}
    th,td{padding:12px;text-align:left;border-bottom:1px solid var(--border);}
    th{color:var(--muted);text-transform:uppercase;font-size:10px;}
    .status-badge{padding:2px 8px;border-radius:999px;font-size:10px;font-weight:800;}
    .status-active{background:rgba(52,211,153,0.2);color:var(--ok);}
    .status-inactive{background:rgba(255,255,255,0.05);color:var(--muted);}
    .btn-action{padding:5px 10px;font-size:11px;background:rgba(255,255,255,0.05);color:var(--text);margin-right:5px;border:1px solid var(--border);}
    
    /* Bot√£o Back to Dashboard */
    .btn-back {
      display: flex; align-items: center; justify-content: center;
      margin-top: 25px; color: #64748b; text-decoration: none;
      font-size: 14px; font-weight: 500; transition: color 0.2s;
    }
    .btn-back:hover { color: #fff; }
    .btn-back i { margin-right: 8px; }

  </style>
</head>
<body>
  <div class="wrap">
    <h1>üöÄ Checkout Session Manager</h1>
    
    <div class="card">
      <div class="grid">
        <div>
          <label>Session ID (Unique)</label>
          <input id="session_id" placeholder="e.g. module1_class1">
        </div>
        <div>
          <label>Title (Display Name)</label>
          <input id="title" placeholder="e.g. Module 1 - Intro">
        </div>
      </div>

      <label>Likert Question</label>
      <input id="question" placeholder="e.g. How confident do you feel about today's topic?">

      <div class="grid">
        <div>
          <label>Open Time (SP Time)</label>
          <input type="datetime-local" id="open_ts">
        </div>
        <div>
          <label>Close Time (SP Time)</label>
          <input type="datetime-local" id="close_ts">
        </div>
      </div>

      <div class="grid" style="margin-top:10px;">
        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; text-transform:none;">
          <input type="checkbox" id="is_active" style="width:auto;" checked> Session is Active
        </label>
        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; text-transform:none;">
          <input type="checkbox" id="require_login" style="width:auto;" checked> Require Login
        </label>
      </div>

      <div class="row-actions">
        <button class="btn-save" onclick="saveSession()">Save Session</button>
        <button class="btn-clear" onclick="clearForm()">Clear</button>
      </div>
    </div>

    <div class="card">
      <label>Existing Sessions</label>
      <table id="sessionTable">
        <thead>
          <tr>
            <th>Status</th>
            <th>ID / Title</th>
            <th>Window</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <a href="/admin?t=${adminKey}" class="btn-back">
      <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
  </div>

  <script>
    const token = new URLSearchParams(window.location.search).get('t') || "${adminKey}";
    
    function toBR(iso) {
      if(!iso) return "";
      return iso.replace('T', ' ') + ":00";
    }

    function fromBR(br) {
      if(!br) return "";
      return br.substring(0, 16).replace(' ', 'T');
    }
    async function loadSessions() {
      const res = await fetch("/admin/checkout/sessions/list?t=" + token);
      const data = await res.json();
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = data.map(s => \`
        <tr>
          <td>
            <span class="status-badge \${s.is_active ? 'status-active' : 'status-inactive'}">
              \${s.is_active ? 'ACTIVE' : 'OFF'}
            </span>
          </td>
          <td>
            <strong>\${s.session_id}</strong><br>
            <small style="color:var(--muted)">\${s.title}</small>
          </td>
          <td style="font-size:11px; color:var(--muted)">
            \${s.open_ts || 'No start'}<br>‚Üí \${s.close_ts || 'No end'}
          </td>
          <td>
            <button class="btn-action" onclick='editSession(\${JSON.stringify(s)})'>Edit</button>
            <button class="btn-action" style="color:var(--bad)" onclick="deleteSession('\${s.session_id}')">Del</button>
          </td>
        </tr>
      \`).join('');
    }

    async function saveSession() {
      const body = {
        session_id: document.getElementById("session_id").value,
        title: document.getElementById("title").value,
        question: document.getElementById("question").value,
        open_ts: toBR(document.getElementById("open_ts").value),
        close_ts: toBR(document.getElementById("close_ts").value),
        is_active: document.getElementById("is_active").checked,
        require_login: document.getElementById("require_login").checked
      };

      const res = await fetch("/admin/checkout/sessions/save?t=" + token, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if(res.ok) {
        alert("Saved!");
        loadSessions();
      } else {
        alert("Error saving.");
      }
    }

    async function deleteSession(id) {
      if(!confirm("Delete session " + id + "?")) return;
      await fetch("/admin/checkout/sessions/delete?session_id=" + id + "&t=" + token, { method: 'DELETE' });
      loadSessions();
    }

    function editSession(s) {
      document.getElementById("session_id").value = s.session_id;
      document.getElementById("title").value = s.title;
      document.getElementById("question").value = s.question;
      document.getElementById("open_ts").value = fromBR(s.open_ts);
      document.getElementById("close_ts").value = fromBR(s.close_ts);
      document.getElementById("is_active").checked = !!s.is_active;
      document.getElementById("require_login").checked = !!s.require_login;
      window.scrollTo(0,0);
    }

    function clearForm() {
      document.getElementById("session_id").value = "";
      document.getElementById("title").value = "";
      document.getElementById("question").value = "";
      document.getElementById("open_ts").value = "";
      document.getElementById("close_ts").value = "";
    }

    loadSessions();
  </script>
</body>
</html>`;
  return new Response(html, { headers: { "Content-Type": "text/html; charset=utf-8" } });
}





// ============================================================
// NOVO: Rota do Dashboard dentro da disciplina
// ============================================================
if (path === "/teaching/financial_strategy/dashboard" && method === "GET") {
  const sid = await getStudentIdFromSession(req);
  if (!sid) return redirectToLogin(origin, COURSE_HOME);

  // 1) metadados do aluno (para log)
  const studentInfo = await env.DB.prepare(
    "SELECT prof, term_id FROM t_students_dim WHERE student_id = ? LIMIT 1"
  ).bind(sid).first();

  // 2) log de acesso (n√£o bloqueia resposta)
  ctx.waitUntil(
    env.DB.prepare(
      "INSERT INTO t_logins (student_id, status, page, prof, term_id) VALUES (?, ?, ?, ?, ?)"
    ).bind(
      sid,
      "success",
      "dashboard",
      studentInfo?.prof || "",
      studentInfo?.term_id || ""
    ).run()
  );

  // 3) report
  const r = await buildReport(env.DB, sid);
  const chat = await fetchChatInteractionsFromD1(env.CHAT_DB || env.DB, sid, 500);
  r.chat_interactions = chat;

  const html = reportToHTML(r, {
    logoUrl: String(env.FGV_LOGO_URL || "").trim(),
    courseName: "Financial Strategy (2026/01)",
    instructorName: "Henrique Castro Martins"
  });

  return new Response(html, {
    status: 200,
    headers: { "Content-Type": "text/html; charset=utf-8", "Cache-Control": "no-store", ...cors(origin) }
  });
}


// ============================================================
// PROXY SLIDES: serve /teaching/* from SLIDES worker
// (mas N√ÉO proxy o /practice, porque √© din√¢mico e roda aqui)
// ============================================================
const isPractice = (path === "/teaching/financial_strategy/practice");

if (path.startsWith("/teaching/financial_strategy/") && !isPractice) {
  const u = new URL(req.url);
  u.host = "slides.internal"; // dummy host

  const upstreamReq = new Request(u.toString(), req);
  const resp = await env.SLIDES.fetch(upstreamReq);

  const headers = new Headers(resp.headers);
  headers.set("X_Proxied_By", "course_chat");

  return new Response(resp.body, { status: resp.status, headers });
}






// ============================================================
// HOME "/"
// ============================================================
if (path === "/" ) {
const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>${profile.name}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    :root { --accent: #1e3a8a; --text-main: #1e293b; --text-muted: #64748b; --bg: #fdfdfd; }
    body { font-family: 'Inter', sans-serif; margin: 0; color: var(--text-main); background: var(--bg); line-height: 1.7; }
    header { padding: 1.2rem 8%; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(0,0,0,0.05); }
    .nav-brand { font-size: 1.1rem; font-weight: 600; color: var(--text-main); text-decoration: none; }
    nav { display: flex; gap: 25px; }
    nav a { text-decoration: none; color: var(--text-muted); font-size: 0.9rem; font-weight: 500; }
    .hero { max-width: 1100px; margin: 80px auto; display: grid; grid-template-columns: 1fr; gap: 60px; padding: 0 40px; }
    @media (min-width: 768px) { .hero { grid-template-columns: 320px 1fr; } }
    .avatar { width: 240px; height: 240px; border-radius: 50%; object-fit: cover; box-shadow: 0 15px 35px rgba(0,0,0,0.08); margin-bottom: 25px; border: 4px solid white; }
    .links-grid { display: flex; flex-wrap: wrap; gap: 8px; }
    .btn-link { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border: 1px solid #e2e8f0; border-radius: 6px; text-decoration: none; color: var(--text-main); font-size: 0.8rem; background: white; transition: 0.2s; }
    .btn-link:hover { border-color: var(--accent); color: var(--accent); transform: translateY(-2px); }
    .main-content h1 { font-size: 3.5rem; font-weight: 800; margin: 0; color: #0f172a; }
    .subtitle { font-size: 1.2rem; color: var(--accent); font-weight: 600; margin-bottom: 25px; display: block; }
    h2 { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px; color: var(--accent); margin-top: 50px; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
    .edu-card { padding: 8px 0; }
    .edu-card strong { display: block; color: var(--text-main); }
    .interest-tag { display: inline-block; background: #eff6ff; color: #1e40af; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 500; margin-right: 8px; margin-bottom: 8px; border: 1px solid #dbeafe; }
  </style>
</head>
<body>
<header>
  <a href="/" class="nav-brand">Henrique Castro Martins</a>
  <nav style="display:flex; gap:20px; align-items:center;">
    <a href="/teaching" style="text-decoration:none; color:#64748b;">Teaching</a>
    <a href="/research" style="text-decoration:none; color:#64748b;">Research</a>
    <a href="https://www.linkedin.com/in/henriquecastror/" target="_blank" style="text-decoration:none; color:#64748b;" title="Linkedin">
    <i class="bi bi-linkedin"></i>
  </a>  </nav>
</header>

  <div class="hero">
    <div class="sidebar">
      <img src="https://henriquemartins.net/avatar.jpg" class="avatar" alt="Henrique">
      <div class="links-grid">
        ${profile.links.map((l) => `<a href="${l.href}" class="btn-link" target="_blank" rel="noopener">
          <i class="bi ${l.icon}"></i> ${l.text}
        </a>`).join("")}
      </div>
    </div>

    <div class="main-content">
      <span class="subtitle">${profile.subtitle || profile.title}</span>
      <p>${profile.bio}</p>

      <h2>Education</h2>
      <div class="edu-grid">
        ${profile.education.map((e) => `<div class="edu-card">
          <strong>${e.degree}</strong>
          <span>${e.school} ‚Ä¢ ${e.year}</span>
        </div>`).join("")}
      </div>

      <h2>Research Interests</h2>
      <div class="interests-grid">
        ${profile.interests.map((topic) => `<span class="interest-tag">${topic}</span>`).join("")}
      </div>
    </div>
  </div>
</body>
</html>`;

      return new Response(html, {
        headers: {
          "Content-Type": "text/html;charset=UTF-8",
          ...cors(origin)
        }
  });
}

// ============================================================
// /teaching
// ============================================================
if (path === "/teaching" || path === "/teaching/") {
const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Teaching - ${profile.name}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    :root { --accent: #1e3a8a; --text-main: #1e293b; --text-muted: #64748b; --bg: #fdfdfd; }
    body { font-family: 'Inter', sans-serif; margin: 0; color: var(--text-main); background: var(--bg); line-height: 1.7; }
    header { padding: 1.2rem 8%; display: flex; justify-content: space-between; align-items: center;
      background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100;
      border-bottom: 1px solid rgba(0,0,0,0.05); }
    .nav-brand { font-size: 1.1rem; font-weight: 600; color: var(--text-main); text-decoration: none; }
    nav { display: flex; gap: 25px; }
    nav a { text-decoration: none; color: var(--text-muted); font-size: 0.9rem; font-weight: 500; }
    .container { max-width: 900px; margin: 60px auto; padding: 0 40px; }
    h1 { font-size: 2.5rem; font-weight: 800; color: #0f172a; margin-bottom: 10px; }
    h2 { font-size: 1.5rem; color: var(--accent); margin-top: 40px; display: flex; align-items: center; gap: 10px; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; border-radius: 8px; overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    th { background: #1e293b; color: white; padding: 12px; text-align: left; font-size: 0.9rem; }
    td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.95rem; }
    tr:hover { background: #f8fafc; }
    .course-link { text-decoration: none; color: var(--accent); font-weight: 600; }
    .tag { font-size: 0.7rem; padding: 2px 8px; border-radius: 12px; font-weight: 700; margin-left: 10px; text-transform: uppercase; }
    .tag-active { background: #dcfce7; color: #166534; }
    .tag-archived { background: rgba(220, 53, 69, 0.15); color: #dc3545; border: 1px solid #e2e8f0; }
    .course-disabled { color: var(--text-muted); font-weight: 500; cursor: default; }
  </style>
</head>
<body>
<header>
  <a href="/" class="nav-brand">Henrique Castro Martins</a>
  <nav style="display:flex; gap:20px; align-items:center;">
    <a href="/teaching" style="text-decoration:none; color:#64748b;">Teaching</a>
    <a href="/research" style="text-decoration:none; color:#64748b;">Research</a>
    <a href="https://www.linkedin.com/in/henriquecastror/" target="_blank" style="text-decoration:none; color:#64748b;" title="Linkedin">
    <i class="bi bi-linkedin"></i>
  </a>  </nav>
</header>

  <div class="container">
    <h1>üìö Teaching Resources</h1>
    <p style="color: var(--text-muted); margin-bottom: 40px;">
      Welcome! Below you will find the materials and resources for my current and past courses.
    </p>

    <h2><i class="bi bi-calendar3"></i> 2026</h2>
    <table>
      <thead><tr><th style="width: 120px;">Semester</th><th>Course</th></tr></thead>
      <tbody>
        <tr>
          <td>01</td>
          <td>
            <a href="/teaching/financial_strategy" class="course-link">üéØ Financial Strategy</a>
            <span class="tag tag-active">Active</span>
          </td>
        </tr>
      </tbody>
    </table>

    <h2><i class="bi bi-calendar3"></i> 2025</h2>
    <table>
      <thead><tr><th style="width: 120px;">Semester</th><th>Course</th></tr></thead>
      <tbody>
        <tr><td>02</td><td><a Financial Strategy >üéØ Financial Strategy</a><span class="tag tag-archived">Archived</span></td></tr>
        <tr><td>02</td><td><a Financial Strategy >üìâ Empirical Methods for Finance</a><span class="tag tag-archived">Archived</span></td></tr>
        <tr><td>01</td><td><a Financial Strategy >üéØ Financial Strategy</a><span class="tag tag-archived">Archived</span></td></tr>
        <tr><td>01</td><td><a Financial Strategy >üìä STAII </a><span class="tag tag-archived">Archived</span></td></tr>
      </tbody>
    </table>


    <h2><i class="bi bi-calendar3"></i> 2024</h2>
    <table>
      <thead><tr><th style="width: 120px;">Semester</th><th>Course</th></tr></thead>
      <tbody>
      <tr><td>02</td><td><a Financial Strategy >üßÆ Econometrics for Finance (DPA)</a><span class="tag tag-archived">Archived</span></td></tr>
      <tr><td>02</td><td><a Financial Strategy >üèõÔ∏è Causal Inference </a><span class="tag tag-archived">Archived</span></td></tr>
      <tr><td>02</td><td><a Financial Strategy >üéØ Financial Strategy</a><span class="tag tag-archived">Archived</span></td></tr>
        <tr><td>Winter</td><td><a Financial Strategy >üéØ Financial Strategy</a><span class="tag tag-archived">Archived</span></td></tr>
        <tr><td>01</td><td><a Financial Strategy >üå± ESG & Institutional Investment</a><span class="tag tag-archived">Archived</span></td></tr>
        <tr><td>01</td><td><a Financial Strategy >üéØ Financial Strategy</a><span class="tag tag-archived">Archived</span></td></tr>
        <tr><td>Summer</td><td><a Financial Strategy >üéØ Financial Strategy</a><span class="tag tag-archived">Archived</span></td></tr>
      </tbody>
    </table>
  </div>
</body>
</html>`;
return new Response(html, { headers: { "Content-Type": "text/html;charset=UTF-8", ...cors(origin) } });
}

// ============================================================
// /teaching/financial_strategy
// ============================================================
if (path === "/teaching/financial_strategy" || path === "/teaching/financial_strategy/") {
  const sid = await getStudentIdFromSession(req);
  if (!sid) return redirectToLogin(origin, COURSE_HOME);
const html = `<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="/teaching/financial_strategy/manifest.json">
<meta name="theme-color" content="#0b1220">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Financial Strategy - 2026/01</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    :root { --accent: #1e3a8a; --text-main: #1e293b; --bg: #fdfdfd; }
    body { font-family: 'Inter', sans-serif; margin: 0; color: var(--text-main); background: var(--bg); line-height: 1.6; }
    header { padding: 1.2rem 8%; display: flex; justify-content: space-between; align-items: center; background: white; border-bottom: 1px solid #eee; }
    .nav-brand { font-size: 1.1rem; font-weight: 600; text-decoration: none; color: var(--text-main); }
    .container { max-width: 900px; margin: 40px auto; padding: 0 20px; }
    table { width: 100%; border-collapse: collapse; font-size: 15px; margin: 1.5em 0; background: white; border-radius: 8px; overflow: hidden; }
    thead th { background: #1e293b; color: #ffffff; padding: 12px 8px; text-align: center; font-weight: 700; border-top: 2px solid #0f172a; }
    td { padding: 10px 8px; text-align: center; border-bottom: 1px solid #e2e8f0; }
    tbody tr:nth-child(even) { background: #f8fafc; }
    tbody tr:hover { background: #e0f2fe; }
    td a { font-size: 18px; text-decoration: none; }
    th:nth-child(1), td:nth-child(1) { width: 80px; }
    th:nth-child(2), td:nth-child(2) { width: 100px; }
    .callout { background: #fff5f5; border-left: 5px solid #ef4444; padding: 20px; margin: 25px 0; border-radius: 4px; }
    .callout h3 { margin-top: 0; color: #b91c1c; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
    .legend { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-top: 30px; }
    hr { border: 0; border-top: 1px solid #e2e8f0; margin: 30px 0; }
    /* Callout "For students" (azul claro) */
    .callout.callout-students{
      background: #eff6ff;            /* azul bem claro */
      border-left: 5px solid #3b82f6; /* azul */
      padding: 20px;
      border-radius: 4px;
      margin: 25px 0;
      font-size: 14px;
    }
    .callout.callout-students .callout-header{
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .callout.callout-students .callout-title{
      margin: 0;
      color: #1d4ed8;   /* azul forte */
      font-weight: 800;
      font-size: 1rem;
    }   
    .callout.callout-students .callout-icon{
      color: #1d4ed8;
      font-size: 1.1rem;
    }
.table-container {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  margin: 1.5em 0;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
}

table {
  margin: 0 !important; /* Reseta a margem que j√° existia na table */
  min-width: 600px;      /* Garante que a tabela n√£o fique espremida */
}
    </style>
</head>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/teaching/financial_strategy/sw.js", {
      scope: "/teaching/financial_strategy/"
    }).catch(console.error);
  }
</script>


<body>
<header>
  <a href="/" class="nav-brand">Henrique Castro Martins</a>
  <nav style="display:flex; gap:20px; align-items:center;">
    <a href="/teaching" style="text-decoration:none; color:#64748b;">Teaching</a>
    <a href="/research" style="text-decoration:none; color:#64748b;">Research</a>
    <a href="https://www.linkedin.com/in/henriquecastror/" target="_blank" style="text-decoration:none; color:#64748b;" title="Linkedin">
    <i class="bi bi-linkedin"></i>
  </a>  </nav>
</header>

  <div class="container">
    <h1>Financial Strategy - 2026/01</h1>

    <div class="callout callout-students">
    <div class="callout-header">
      <span class="callout-icon">‚ö†Ô∏è</span>
      <h3 class="callout-title">For students</h3>
    </div>
  
    <p>
      Below you find the persistent links to all lectures of the course. As they are continuously updated with fixes and new implementations,
      <strong>you might expect some changes from time to time in the contents of each file</strong>.
    </p>
  
  
    <p>The questions are based on or inspired by the following references:</p>
  
    <ul>
      <li>
        <a href="https://www.amazon.com.br/Corporate-Finance-Global-Jonathan-Berk/dp/1292304154"
           target="_blank" rel="noopener noreferrer">
          <strong>Berk &amp; DeMarzo, Corporate Finance, 5th ed. (2020)</strong>
        </a>
      </li>
      <li>
        <a href="https://www.amazon.com.br/Principles-Corporate-Finance-Richard-Brealey/dp/1260565556/ref=sr_1_3?refinements=p_27%3ABrealey+Myers&s=books&sr=1-3"
           target="_blank" rel="noopener noreferrer">
          <strong>Brealey &amp; Myers, Principles of Corporate Finance, 13th ed. (2020)</strong>
        </a>
      </li>
    </ul>
  

    <p class="callout-footnote">
      üí° <em>You can also type <code>e</code> then <code>Ctrl + P</code> (or <code>Cmd + P</code> on Mac) to print or save your responses as a <code>.pdf</code> file.</em>
    </p>
  </div>
  

<h3>üìó Part 0 (Introduction)</h3>
    <div class="table-container">
      <table>
        <thead><tr><th>Slides</th></tr></thead>
        <tbody><tr><td><a href="/teaching/financial_strategy/slides/p0.html">üéûÔ∏è</a></td></tr></tbody>
      </table>
    </div>

    <h3>üìò Part 1 (until Midterm)</h3>
    <div class="table-container">
      <table>
        <thead>
          <tr><th>Module</th><th>Ch.</th><th>Slides</th><th>T/F</th><th>MCQ</th><th>MultiA</th><th>Num.</th><th>Long</th></tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td>ch23</td>
            <td><a href="/teaching/financial_strategy/slides/p1.html">üéûÔ∏è</a></td>
            <td><a href="/teaching/financial_strategy/practice?module=module1&type=tf">‚úÖ</a></td>
            <td><a href="/teaching/financial_strategy/practice?module=module1&type=mcq">‚ùì</a></td>
            <td><a href="/teaching/financial_strategy/practice?module=module1&type=multia">üìë</a></td>
            <td><a href="/teaching/financial_strategy/practice?module=module1&type=num">üî¢</a></td>
            <td><a href="/teaching/financial_strategy/practice?module=module1&type=long">üìù</a></td>
          </tr>        
          <tr><td>2</td><td>ch10</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
          <tr><td>3</td><td>ch11</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
          <tr><td>4</td><td>ch12</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
          <tr><td>5</td><td>ch13</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        </tbody>
      </table>
    </div>

    <hr>

    <h3>üìô Part 2 (after Midterm)</h3>
    <div class="table-container">
      <table>
        <thead>
          <tr><th>Module</th><th>Ch.</th><th>Slides</th><th>T/F</th><th>MCQ</th><th>MultiA</th><th>Num.</th><th>Long</th></tr>
        </thead>
        <tbody>
          <tr><td>6</td><td>ch24</td><td></td><td></td><td></td><td></td><td></td><td></td></tr> 
          <tr><td>7</td><td>ch14</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
          <tr><td>8</td><td>ch15</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
          <tr><td>9</td><td>ch16</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
          <tr><td>10</td><td>ch17</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        </tbody>
      </table>
    </div>

<div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 24px; text-align: center; margin-bottom: 20px; 
            position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
  
  <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: #fbbf24; border-radius: 12px 12px 0 0;"></div>

  <h3 style="margin-top: 10px; color: #1e293b;">üèÜ Leaderboard</h3>
  <p style="color: #64748b;">Compare your performance and see who leads the Financial Strategy class.</p>
  
  <a href="/teaching/financial_strategy/ranking" style="background: #d97706; color: white;  padding: 10px 24px; border-radius: 8px; text-decoration: none; 
            font-weight: 600;
            display: inline-block;">
     View Full Ranking
  </a>
</div>

<div style="background: #f8fafc;border: 1px solid #e2e8f0;border-radius: 12px; padding: 24px; text-align: center; position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
<div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: #0ea5e9; border-radius: 12px 12px 0 0;"></div>
 <h3 style="margin-top: 10px; color: #1e293b;">üìä My Dashboard</h3>
  <p style="color: #64748b;">Check your overall progress, ranking points, and quiz results.</p>
  
  <a href="/teaching/financial_strategy/dashboard"  style="background: #0ea5e9; color: white; padding: 10px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-block;"> Open Dashboard</a>
</div>
    
    <!-- opcional: uma linha de separa√ß√£o antes da legenda -->
    <hr style="border:0; border-top:1px solid #e2e8f0; margin:28px 0;">


    <div class="legend-box" aria-label="Legend">
      <div class="legend-title">
        <span class="legend-emoji">üîë</span>
        <span>Legend</span>
        <a class="legend-link" href="#legend" aria-label="Link to legend">üîó</a>
      </div>
    
      <ul class="legend-list" id="legend">
        <li>üéûÔ∏è : Slides</li>
        <li>‚úÖ : True/False Questions</li>
        <li>‚ùì : Multiple Choice Questions</li>
        <li>üßæ : Multi-Affirmative Questions</li>
        <li>üî¢ : Numeric Questions</li>
        <li>üìù : Long Answer Questions</li>
      </ul>
    </div>
    <hr>
 </div>
</body>
</html>`;
return new Response(html, { headers: { "Content-Type": "text/html;charset=UTF-8", ...cors(origin) }});
}

          // --- NOVO MOTOR DE LOGIN (Substitui a depend√™ncia do GAS) ---
          if (is("/auth/login") && method === "GET") {
            const username = url.searchParams.get("username");
            const password = url.searchParams.get("password");
            const page     = url.searchParams.get("page") || "slide";
  
            // 1. Valida√ß√£o b√°sica
            if (!username || !password) return new Response("MISSING", { headers: cors(origin) });
  
            // 2. Consulta na sua nova tabela de 2026
            const student = await env.DB.prepare(
                "SELECT * FROM t_students_dim WHERE student_id = ? AND password = ?"
            ).bind(username.toLowerCase().trim(), password.trim()).first();
  
            let status = "fail";
            if (student) {
                status = student.active ? "success" : "denied";
            }
  
            // 3. Grava o Log na D1 (Substitui o log que o GAS fazia na planilha)
            // Usamos waitUntil para a resposta ser instant√¢nea para o aluno
            ctx.waitUntil(env.DB.prepare(
                "INSERT INTO t_logins (student_id, status, page, prof, term_id) VALUES (?, ?, ?, ?, ?)"
            ).bind(username, status, page, student?.prof || "", student?.term_id || "").run());
  
            // 4. Resposta para o seu HTML (mantendo o contrato "OK" ou "FAIL")
            const responseText = (status === "success") ? "OK" : "FAIL";
            return new Response(responseText, { 
              headers: { ...cors(origin), "Cache-Control": "no-store" } 
            });
          }


// --- API: Salvar Progresso nos Exerc√≠cios (Practice) ---
if (is("/api/practice/submit") && method === "POST") {
  const sid = await getStudentIdFromSession(req);
  if (!sid) return json({ error: "unauthorized" }, origin, 401);

  const body = await readJsonBody(req);
  const { exercise_id, module, is_correct, user_answer } = body || {};
  const tsNow = tsBRString(Date.now());

  try {
    // Corrigido: Removido o "1" fixo e ajustado para as colunas timestamp_br e attempts
    await env.DB.prepare(`
      INSERT INTO questions_bank_progress (student_id, exercise_id, module, is_correct, user_answer, timestamp_br, attempts)
      VALUES (?1, ?2, ?3, ?4, ?5, ?6, 1)
      ON CONFLICT(student_id, exercise_id) DO UPDATE SET
        is_correct = MAX(is_correct, excluded.is_correct),
        user_answer = excluded.user_answer,
        attempts = attempts + 1,
        timestamp_br = excluded.timestamp_br
    `).bind(
      sid, 
      exercise_id, 
      module, 
      is_correct ? 1 : 0, 
      String(user_answer || ""), 
      tsNow
    ).run();

    return json({ status: "success" }, origin);
  } catch (e) {
    return json({ error: "DB Error: " + e.message }, origin, 500);
  }
}



 // ============================================================
// REPORTS (D1-only, NO GAS)
// Endpoints:
//   GET  /reports         -> login page
//   POST /reports         -> validate in D1, set cookie, redirect to /reports/html
//   GET  /reports/html    -> render report HTML (requires cookie)
//   GET  /reports/me      -> JSON report (requires cookie) [optional]
//   GET  /reports/logout  -> clear cookie
// ============================================================

// normalize student_id (same style you already use elsewhere)
function normalizeSid(raw) {
  const s = String(raw || "").trim().toLowerCase();
  return s.replace(/[^a-z0-9._-]/g, "");
}

function getCookie(req, name) {
  const cookie = req.headers.get("Cookie") || "";
  const parts = cookie.split(";").map((p) => p.trim());
  for (const p of parts) {
    if (p.startsWith(name + "=")) return decodeURIComponent(p.slice(name.length + 1));
  }
  return "";
}

async function getStudentIdFromSession(req) {
  // priority: HttpOnly cookie set by /reports POST
  const sid = normalizeSid(getCookie(req, "student_id"));
  if (sid) return sid;
  // fallback: allow header if you ever need it
  const hdr = normalizeSid(req.headers.get("x-student-id"));
  if (hdr) return hdr;
  return "";
}

function practicesLoginPage({ message = "", next = "" } = {}) {
  const msg = String(message || "").trim();
  const baseUrl = "/teaching/financial_strategy/practice";
  
  // Se 'next' n√£o vier preenchido, mandamos para o pr√≥prio practice
  // Se vier (ex: redirecionado de um m√≥dulo), usamos a rota /reports para validar 
  // e o par√¢metro 'next' cuidar√° de levar o aluno de volta ao exerc√≠cio.
  const formAction = next 
    ? `/reports?next=${encodeURIComponent(next)}` 
    : `/reports?next=${encodeURIComponent(baseUrl)}`; 

  return `<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Practice ‚Äî login</title>
  <style>
    :root{--ink:#0f172a;--muted:#64748b;--line:#e2e8f0;--brand:#1e3a8a}
    *{box-sizing:border-box} 
    body{
      margin:0;background:#f8fafc;color:var(--ink);
      font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      display: flex; align-items: center; justify-content: center; min-height: 100vh;
    }
    .page{max-width:420px; width: 100%; padding:20px}
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 2px 12px rgba(15,23,42,.06);padding:24px}
    h1{margin:0 0 10px;font-size:22px; font-weight: 800; color: var(--brand)}
    .muted{color:var(--muted);font-size:13px;margin-bottom:12px}
    input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;margin:8px 0;font:inherit; outline-color: var(--brand)}
    button{
      width:100%;padding:12px;border-radius:10px;border:1px solid var(--brand);
      background:var(--brand);color:#fff;font-weight:700;cursor:pointer;margin-top:10px;
      transition: opacity 0.2s;
    }
    button:hover{opacity: 0.9}
    .err{color:#991b1b;background:#fee2e2;border:1px solid #fecaca;padding:10px;border-radius:10px;margin:6px 0 12px;font-weight:700; font-size: 13px}
    .small{font-size:12px;color:var(--muted);margin-top:15px; text-align: center}
  </style>
</head>
<body>
<section class="page">
  <div class="card">
    <h1>üìù Practice Login</h1>
    <div class="muted">Sign in with your credentials to unlock the exercises.</div>
    
    ${msg ? `<div class="err" role="alert">${msg}</div>` : ""}
    
    <form method="POST" action="${formAction}" autocomplete="off">
      <label style="font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase;">Username</label>
      <input type="text" name="username" placeholder="e.g. aluno123" required autofocus />
      
      <label style="font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase;">Password</label>
      <input type="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
      
      <button type="submit">Unlock Exercises</button>
    </form>
    <div class="small">Contact the instructor if you need help.</div>
  </div>
</section>
</body>
</html>`;
}




function reportsLoginPage({ message = "", next = "/reports/html" } = {}) {
  const msg = String(message || "").trim();
  const formAction = next ? `/reports?next=${encodeURIComponent(next)}` : "/reports";
  return `<!doctype html>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>My Dashboard login</title>
<style>
:root{--ink:#0f172a;--muted:#64748b;--line:#e2e8f0;--brand:#1e3a8a}
*{box-sizing:border-box} body{margin:0;background:#fff;color:var(--ink);font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.page{max-width:420px;margin:6vh auto;padding:20px}
.card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 2px 12px rgba(15,23,42,.06);padding:18px}
h1{margin:0 0 10px;font-size:20px}
.muted{color:var(--muted);font-size:13px;margin-bottom:12px}
input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;margin:8px 0;font:inherit}
button{width:100%;padding:11px 14px;border-radius:10px;border:1px solid var(--brand);background:var(--brand);color:#fff;font-weight:600;cursor:pointer;margin-top:8px}
.err{color:#991b1b;background:#fee2e2;border:1px solid #fecaca;padding:10px;border-radius:10px;margin:6px 0 8px;font-weight:700}
.small{font-size:12px;color:var(--muted);margin-top:10px}
</style>
<section class="page">
  <div class="card">
    <h1>My Dashboard</h1>
    <div class="muted">Enter your <strong>username</strong> and <strong>password</strong> to access.</div>
    ${msg ? `<div class="err" role="alert">${escapeHtml(msg)}</div>` : ""}
    <form method="POST" action="/reports" autocomplete="off" spellcheck="false">
      <input type="text" name="username" placeholder="Username" required autofocus autocomplete="username" />
      <input type="password" name="password" placeholder="Password" required autocomplete="current-password" />
      <button type="submit">Enter</button>
    </form>
    <div class="small">If you have issues, contact the instructor.</div>
  </div>
</section>`;
}

function reportsGuardPage() {
  return `<!doctype html>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard</title>
<style>
body{font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:24px;color:#0f172a}
.card{max-width:720px;margin:0 auto;border:1px solid #e2e8f0;border-radius:12px;padding:16px;background:#fff}
h1{margin:0 0 8px;font-size:20px}
.muted{color:#64748b}
a.btn{display:inline-block;margin-top:10px;padding:8px 12px;border-radius:10px;background:#1e3a8a;color:#fff;text-decoration:none}
</style>
<div class="card">
  <h1>Login required</h1>
  <p>To view your Dashboard, please sign in.</p>
  <p class="muted">This page requires an active session cookie.</p>
  <a class="btn" href="/reports">Go to login page</a>
</div>`;
}

// GET /reports -> always show login page
if (is("/reports") && method === "GET") {
  const html = reportsLoginPage();
  return new Response(html, {
    status: 200,
    headers: { ...cors(origin), "Content-Type": "text/html; charset=utf-8", "Cache-Control": "no-store" }
  });
}

// POST /reports -> validate against D1, set cookie, redirect to /reports/html
if (is("/reports") && method === "POST") {
  const ct = (req.headers.get("content-type") || "").toLowerCase();
  let username = "", password = "";

  if (ct.includes("application/json")) {
    const body = (await readJsonBody(req)) || {};
    username = String(body.username || body.user || body.id || "").trim();
    password = String(body.password || body.pass || "").trim();
  } else {
    const fd = await req.formData().catch(() => null);
    username = String(fd?.get("username") || "").trim();
    password = String(fd?.get("password") || "").trim();
  }

  if (!username || !password) {
    const html = reportsLoginPage({ message: "Missing username or password." });
    return new Response(html, { status: 400, headers: { ...cors(origin), "Content-Type": "text/html; charset=utf-8", "Cache-Control": "no-store" } });
  }

  // rate-limit (reuse your rateLimit helper if you already have it; else comment out)
  const ip = req.headers.get("CF-Connecting-IP") || req.headers.get("x-forwarded-for") || "0.0.0.0";
  if (typeof rateLimit === "function") {
    const key = `reportslogin:${ip}:${username.toLowerCase()}`;
    if (!rateLimit(key, 5, 10_000)) {
      const html = reportsLoginPage({ message: "Too many attempts. Please wait and try again." });
      return new Response(html, { status: 429, headers: { ...cors(origin), "Content-Type": "text/html; charset=utf-8", "Cache-Control": "no-store" } });
    }
  }

  const sid = normalizeSid(username);

  // VALIDATE: Adicionei 'prof' e 'term_id' no SELECT para poder usar no log abaixo
  const student = await env.DB.prepare(
    "SELECT student_id, active, prof, term_id FROM t_students_dim WHERE student_id = ? AND password = ?"
  ).bind(sid, String(password).trim()).first();

  if (!student) {
    // LOG DE FALHA (Opcional, mas √∫til para ver quem est√° errando a senha)
    ctx.waitUntil(env.DB.prepare(
        "INSERT INTO t_logins (student_id, status, page) VALUES (?, ?, ?)"
    ).bind(sid, "fail", "practice").run());

    const html = reportsLoginPage({ message: "Invalid username or password." });
    return new Response(html, { status: 401, headers: { ...cors(origin), "Content-Type": "text/html; charset=utf-8", "Cache-Control": "no-store" } });
  }

  if (!student.active) {
    const html = reportsLoginPage({ message: "Access denied." });
    return new Response(html, { status: 403, headers: { ...cors(origin), "Content-Type": "text/html; charset=utf-8", "Cache-Control": "no-store" } });
  }

  // LOG DE SUCESSO: Agora as vari√°veis student.prof e student.term_id estar√£o preenchidas

  const nextStep = url.searchParams.get("next") || "/reports/html";

  const headers = new Headers(cors(origin));
  headers.set("Cache-Control", "no-store");
  headers.set("Set-Cookie", `student_id=${encodeURIComponent(sid)}; Path=/; Secure; SameSite=Lax; HttpOnly; Max-Age=3600`);
  headers.set("Location", nextStep); 
  return new Response(null, { status: 303, headers });
}

// GET /reports/html -> render HTML report (requires cookie)
if (is("/reports/html") && method === "GET") {
  const sid = await getStudentIdFromSession(req);
  if (!sid) {
    const html = reportsGuardPage();
    return new Response(html, {
      status: 401,
      headers: { ...cors(origin), "Content-Type": "text/html; charset=utf-8", "Cache-Control": "no-store" }
    });
  }

  // build report JSON
  const r = await buildReport(env.DB, sid);

  // chat (optional)
  const chatBase = String(env.CHATBOT_BASE_URL || "https://chatbot.hcmrtns.workers.dev").trim();
  const chatTok  = String(env.CHAT_SERVICE_TOKEN || "").trim();

  const chat = await fetchChatInteractionsFromD1(env.CHAT_DB || env.DB, sid, 500);


  r.chat_interactions = chat;

  const html = reportToHTML(r, {
    logoUrl: String(env.FGV_LOGO_URL || "").trim(),
    courseName: env.COURSE_NAME || "Financial Strategy (2026/01)",
    instructorName: env.INSTRUCTOR_NAME || "Henrique Castro Martins (henrique.martins@fgv.br)"
  });

  return new Response(html, {
    status: 200,
    headers: { ...cors(origin), "Content-Type": "text/html; charset=utf-8", "Cache-Control": "no-store" }
  });
}




// ============================================================
// LIKES
// ============================================================
if (is("/likes")) {
      const page = (url.searchParams.get("page") || "").trim();
      const student = (url.searchParams.get("student") || "").trim();

      if (url.searchParams.get("like") || method === "POST") {
        let p = page, s = student;
        if (method === "POST") {
          const body = (await readJsonBody(req)) || {};
          p = String(body.page || p).trim();
          s = String(body.student || s).trim();
        }
        if (!p || !s) return json({ status: "error", message: "missing page/student" }, origin, 400);

        const ip = req.headers.get("CF-Connecting-IP") || "0.0.0.0";
        if (!rateLimit(`like:${s}:${p}:${ip}`, 5, 10_000)) return json({ status: "error", message: "rate limit" }, origin, 429);

        try {
          await env.DB.prepare("INSERT INTO likes (page, student_id, ts_local) VALUES (?, ?, ?)")
            .bind(p, s, tsBRString(Date.now())).run();
          return json({ status: "liked" }, origin);
        } catch {
          return json({ status: "already" }, origin);
        }
      }

      if (method === "GET" && (url.searchParams.get("state") || url.searchParams.get("count"))) {
        const cntRow = await env.DB.prepare("SELECT COUNT(*) AS c FROM likes WHERE page=?").bind(page).first();
        const likedRow = student
          ? await env.DB.prepare("SELECT 1 FROM likes WHERE page=? AND student_id=? LIMIT 1").bind(page, student).first()
          : null;
        return json({ status: "success", count: Number(cntRow?.c || 0), liked: !!likedRow }, origin);
      }
    }


    // ---------- CHECKOUTS ----------
    if (is("/checkouts/status") && method === "GET") {
      const student = (
        url.searchParams.get("student") ||
        url.searchParams.get("student_id") ||
        url.searchParams.get("studentId") ||
        ""
      ).trim();

      const slideId = (
        url.searchParams.get("slide_id") ||
        url.searchParams.get("slideId") ||
        url.searchParams.get("session") ||
        url.searchParams.get("page") ||
        ""
      ).trim();

      if (!student || !slideId) return json({ status:"error", message:"missing student/slide_id" }, origin, 400);
      const row = await env.DB.prepare(
        "SELECT 1 AS ok FROM t_checkouts WHERE student_id=? AND slide_id=? LIMIT 1"
      ).bind(student, slideId).first();
      return json({ status:"success", submitted: !!row }, origin);
    }

    // Envio com valida√ß√£o pela hora de SP
    if ((is("/checkouts") || is("/checkout")) && method === "POST") {
      const body = await readJsonBody(req);
      if (!body) return json({ status:"error", message:"invalid json" }, origin, 400);

      const student_id = String(body.student || body.student_id || "").trim();
      const slide_id   = String(body.slide_id || body.session || body.page || "").trim();
      const ticket     = String(body.ticket || body.text || body.answer || body.message || "").trim();
      const ts_client  = String(body.tsClient || body.ts_client || body.client_ts || "").trim();
      const user_agent = (req.headers.get("user-agent") || "").slice(0,256);

      const wOpenStr   = String(body.open || body.window_open || body["data-open"] || "").trim();
      const wCloseStr  = String(body.close || body.window_close || body["data-close"] || "").trim();

      const likertQuestion = String(body?.likert_question || "").trim();
      const likertValueRaw = body?.likert_value;
      const likertValue = Number.isFinite(Number(likertValueRaw)) ? Number(likertValueRaw) : null;

      if (!student_id) return json({ status:"error", message:"missing student_id" }, origin, 400);
      if (!slide_id)   return json({ status:"error", message:"missing slide_id" }, origin, 400);

      // valida janela somente se ambos vierem
      if (wOpenStr && wCloseStr) {
        const nowStr   = tsBRString(Date.now());
        const openStr  = normalizeBRLocal(wOpenStr);
        const closeStr = normalizeBRLocal(wCloseStr);
        if (!openStr || !closeStr) return json({ status:"error", message:"invalid window" }, origin, 400);
        const nowKey = brKey(nowStr), openKey = brKey(openStr), closeKey = brKey(closeStr);
        if (nowKey < openKey || nowKey > closeKey) {
          return json({ status:"closed_window", now_br:nowStr, open_br:openStr, close_br:closeStr }, origin, 403);
        }
      }

      const timestamp_iso = new Date().toISOString(); // UTC
      const timestamp_br  = tsBRString(Date.now());   // America/Sao_Paulo

      // Vers√£o simplificada para a tabela t_checkouts
      try {
        // Omitimos o created_at/iso pois o D1 preenche automaticamente
        await env.DB.prepare(`
        INSERT INTO t_checkouts (timestamp_br,  student_id, slide_id, ticket, likert_question, likert_value)
        VALUES (?, ?, ?, ?, ?, ?)
      `).bind(
        timestamp_br,
        student_id,
        slide_id,
        ticket,
        likertQuestion,
        likertValue
      ).run();
      
        return json({ status:"success", student_id, slide_id, timestamp_br }, origin);
      
      } catch (e) {
        if (String(e).includes("UNIQUE")) {
          return json({ status:"duplicate", student_id, slide_id }, origin);
        }
        return json({ status:"error", message: String(e) }, origin, 500);
      }
    }

// ============================================================
// AI ‚Äî GENERATE REPLY (OpenAI)
// ============================================================
if (is("/admin/ai/generate-reply") && method === "POST") {
  const body = await readJsonBody(req);

  // Aceita 'ticket' OU 'ticket_text' OU 'student_text'
  const ticket = String(body?.ticket || body?.ticket_text || body?.student_text || "").trim();

  const apiKey = env.OPENAI_API_KEY;
  const model = env.OPENAI_MODEL || "gpt-4o-mini"; // <- ajuste via env se quiser

  if (!apiKey) return json({ reply: "Erro: OPENAI_API_KEY n√£o configurada." }, origin);
  if (!ticket) return json({ reply: "Erro: Nenhum texto recebido." }, origin);

  // (Opcional) voc√™ pode usar isso no prompt se quiser
  const studentId = String(body?.student_id || "").trim();
  const slideId = String(body?.slide_id || "").trim();

  try {
    const apiUrl = "https://api.openai.com/v1/responses";

    const prompt = [
      "You are a finance professor replying to a student's short checkout comment.",
      "Reply in the SAME language as the student's message.",
      "Be brief (2‚Äì5 sentences), friendly, and educational.",
      "There is no need for over-friendliness.",
      "There is no need replying with a question.",
      "Do not mention policies or limitations. Just reply as the instructor.",
      "If you are not sure, do not invent details; give a general clarification tied to the comment.", 
      "Keep the main reply under 270 characters, then append the required ending.",
      "",
      "End with exactly this sentence (verbatim): (Reply AI-assisted, instructor-validated).",
      "",
      slideId ? `Instructor-only context (do not quote): ${slideId}` : "",
      "",
      `Student comment: "${ticket}"`
    ].filter(Boolean).join("\n");

    const response = await fetch(apiUrl, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${apiKey}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model,
        input: [
          { role: "system", content: "You write concise, helpful replies for a finance course." },
          { role: "user", content: prompt }
        ],
        // Ajuste fino (opcionais)
        temperature: 0.4,
        max_output_tokens: 220
      })
    });

    const data = await response.json().catch(() => ({}));

    // Se OpenAI retornou erro (muito comum quando model n√£o existe/sem acesso)
    if (!response.ok) {
      const msg = data?.error?.message || `HTTP ${response.status}`;
      // Log ajuda MUITO no Cloudflare (Workers -> Logs)
      console.log("OPENAI_ERROR_STATUS:", response.status);
      console.log("OPENAI_ERROR_BODY:", JSON.stringify(data));
      return json({ reply: `A IA falhou. (DEBUG: ${msg})` }, origin, 200);
    }

    // Extra√ß√£o robusta do texto
    // 1) output_text (quando dispon√≠vel)
    let aiText = (typeof data?.output_text === "string") ? data.output_text : "";

    // 2) fallback: vasculha output[].content[]
    if (!aiText && Array.isArray(data?.output)) {
      const chunks = [];
      for (const item of data.output) {
        const content = item?.content;
        if (!Array.isArray(content)) continue;
        for (const c of content) {
          if (c?.type === "output_text" && typeof c?.text === "string") chunks.push(c.text);
          if (c?.type === "text" && typeof c?.text === "string") chunks.push(c.text);
        }
      }
      aiText = chunks.join("\n").trim();
    }

    // 3) fallback extra (caso algum formato inesperado apare√ßa)
    if (!aiText) {
      const maybe = data?.choices?.[0]?.message?.content;
      if (typeof maybe === "string") aiText = maybe.trim();
    }

    if (!aiText) {
      console.log("OPENAI_NO_TEXT_FULL_BODY:", JSON.stringify(data));
      return json({ reply: "A IA processou, mas n√£o gerou texto. (DEBUG: sem output_text)" }, origin, 200);
    }

    return json({ reply: aiText.trim() }, origin, 200);

  } catch (e) {
    console.log("OPENAI_FETCH_EXCEPTION:", String(e?.message || e));
    return json({ reply: "Erro na conex√£o com a OpenAI: " + (e?.message || e) }, origin, 200);
  }
}




if (is("/admin/checkouts") && method === "GET") {
  const adminKey = req.headers.get("x-admin-token") || url.searchParams.get("token") || url.searchParams.get("t") || "";

  const html = `<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HCM Admin: Checkouts DM Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
  :root{ --bg:#0b1220; --card:#111a2e; --muted:#93a4c7; --text:#e8eefc; --border:rgba(255,255,255,.10); --accent:#a78bfa; --bad:#fb7185; --success:#34d399; }
  
  * { box-sizing: border-box; }
  
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,sans-serif;padding:15px; padding-bottom: 60px; overflow-x: hidden;}
  .wrap{max-width:1200px;margin:0 auto;}
  
  /* Topo responsivo: Empilha no celular, lado a lado no PC */
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin-bottom:14px;}
  .row > div { flex: 1; min-width: 200px; }

  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;margin-bottom:15px; position: relative;}
  label{display:block;color:var(--muted);font-size:11px;text-transform:uppercase;margin-bottom:4px;}
  select, button{width: 100%; padding:12px; border-radius:10px; border:1px solid var(--border); background:#0e1730; color:var(--text); font:inherit;}
  button{background:rgba(167,139,250,.15);cursor:pointer;font-weight:700;}
  
  /* GRID PRINCIPAL: 1 coluna no celular, 2 no PC */
  .grid{display:grid;grid-template-columns:1fr;gap:15px;margin-bottom:15px;}
  @media(min-width:980px){ .grid{grid-template-columns:1.5fr 1fr;} }
  
  /* --- ESTRAT√âGIA PARA A TABELA NO CELULAR --- */
  table { width: 100%; border-collapse: collapse; }
  
  @media (max-width: 600px) {
    thead { display: none; } /* Esconde o cabe√ßalho no celular */
    tr { 
      display: block; 
      border-bottom: 2px solid var(--border); 
      padding: 15px 0; 
      position: relative;
    }
    td { 
      display: block; 
      padding: 5px 0; 
      width: 100% !important; 
      max-width: none !important;
    }
    /* Estiliza o conte√∫do para parecer um card */
    td:nth-child(1) { font-size: 11px; color: var(--muted); } /* Time */
    td:nth-child(2) { display: inline-block; width: auto !important; margin-right: 10px; } /* Slide */
    td:nth-child(4) { position: absolute; top: 15px; right: 0; color: var(--accent); font-size: 16px; } /* Likert */
    
    .btn-reply { width: 100%; margin: 10px 0 0 0 !important; padding: 12px; }
  }

  /* No PC, mantemos a tabela normal mas com coluna de texto larga */
  @media (min-width: 601px) {
    th,td{padding:12px;border-bottom:1px solid var(--border);text-align:left;}
    td:nth-child(3) { width: 60%; } /* D√° 60% da largura para o texto do aluno */
  }

  .btn-reply { 
    padding: 6px 12px; font-size: 11px; cursor: pointer; background: var(--accent); 
    color: #000; border: none; border-radius: 6px; font-weight: bold;
  }

  /* Modal IA: Ajuste para n√£o estourar a tela */
  #ai-reply-box {
    box-sizing: border-box; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: var(--card); border: 1px solid var(--accent); border-radius: 14px;
    padding: 20px; z-index: 1000; width: 95%; max-width: 500px; display: none;
    max-height: 95vh; overflow-y: auto;
  }
  .analysis-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
  .insight-box { background: rgba(255,255,255,0.03); border-radius: 10px; padding: 12px; border: 1px solid var(--border); }
  .insight-title { font-size: 11px; font-weight: 800; color: var(--accent); text-transform: uppercase; margin-bottom: 8px; }
  .stat-val { font-size: 24px; font-weight: 800; color: var(--success); }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Admin ¬∑ Checkouts</h1>
    <div class="row card">
      <div>
        <label>Available Dates</label>
        <select id="dateSelect"><option value="">Loading days...</option></select>
      </div>
      <div><button id="btnLoad">Load Data</button></div>
      <div id="status" style="font-size:12px;color:var(--muted);margin-left:auto;"></div>
    </div>

    <div class="grid">
      <div class="card">
        <div style="font-weight:700;margin-bottom:10px;">Responses <span id="countPill" class="card" style="padding:2px 8px;font-size:10px;">0</span></div>
        <div style="overflow:auto;max-height:400px;">
          <table>
            <thead><tr><th>Time</th><th>Slide</th><th>Ticket</th><th style="text-align:center">Likert</th></tr></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div id="err" style="color:var(--bad)"></div>
      </div>
      <div class="card">
        <div style="font-weight:700;margin-bottom:10px;">Likert Distribution</div>
        <div style="height:320px;"><canvas id="chart"></canvas></div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:15px;">Pedagogical Insights (Radar)</div>
      <div class="analysis-grid">
        <div class="insight-box">
          <div class="insight-title">üìä Average</div>
          <div id="avgLikert" class="stat-val">0.0</div>
          <div style="font-size:10px; color:var(--muted)">Baseado nos valores Likert (1-5)</div>
        </div>
        <div class="insight-box">
          <div class="insight-title">üîë Common words</div>
          <div id="keywordsBox" style="display:flex; flex-wrap:wrap; gap:5px;"></div>
        </div>
      </div>
    </div>

    <a href="/admin?t=${adminKey}" class="btn-back">
      <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>

    <div id="ai-overlay" class="ai-overlay" onclick="closeReply()"></div>
    <div id="ai-reply-box" style="box-sizing: border-box;"> <div style="display:flex; justify-content:space-between; align-items:center;">
        <label id="reply-label" style="margin:0;"></label>
        <span id="ai-status" style="font-size:10px; color:var(--accent); font-weight:800;"></span>
      </div>
      
      <label style="display:block; margin: 10px 0 6px; opacity:.85;">Student checkout (read-only)</label>
      <textarea id="student-ticket-preview" readonly 
        style="width:100%; min-height:230px; background:#0b1220; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:12px; font-size:13px; box-sizing: border-box;"></textarea>
      
      <label style="display:block; margin: 12px 0 6px; opacity:.85;">AI draft (editable)</label>
      <textarea id="ai-reply-text" placeholder="Aguardando IA..." 
        style="width:100%; height: 150px; background:#0b1220; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:12px; font-size:13px; box-sizing: border-box; resize: vertical;"></textarea>
      
      <div class="ai-modal-btns" style="display: flex; gap: 10px; margin-top: 15px;">
        <button class="ai-btn-confirm" onclick="confirmSend()" style="flex: 2;">SEND DM</button>
        <button class="ai-btn-cancel" onclick="closeReply()" style="flex: 1;">CANCEL</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token') || urlParams.get('t') || "${adminKey}";
    const dateEl = document.getElementById("dateSelect");
    const tbody = document.getElementById("tbody");
    const errEl = document.getElementById("err");
    let chart = null;

    tbody.addEventListener("click", (e) => {
      const btn = e.target.closest(".btn-reply");
      if (!btn) return;
      sendDM(btn.dataset.sid, btn.dataset.slideId, btn.dataset.ticket);
    });
    
    function esc(s){ return s ? String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) : ""; }

    async function fetchJson(path){
      const u = new URL(path, location.origin);
      if(token) u.searchParams.set("token", token);
      const r = await fetch(u);
      if(!r.ok) throw new Error("Erro na API: " + r.status);
      return r.json();
    }

    let currentReplyData = { sid: '', slideId: '' };
    
    async function sendDM(sid, slide_id, ticketContent) {
      const box = document.getElementById("ai-reply-box");
      const overlay = document.getElementById("ai-overlay");
      const textarea = document.getElementById("ai-reply-text");
      const status = document.getElementById("ai-status");
      const studentPreview = document.getElementById("student-ticket-preview");

      currentReplyData = { sid: sid, slide_id: slide_id };
      document.getElementById("reply-label").innerText = "REPLY TO: " + sid;
      textarea.value = ""; 
      status.innerText = "‚ö° GENERATING...";
      studentPreview.value = (ticketContent || "").trim();
      box.style.display = "block";
      overlay.style.display = "block";
    
      try {
        const res = await fetch("/admin/ai/generate-reply?t=" + encodeURIComponent(token), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ticket: ticketContent, student_id: sid, slide_id: slide_id })
        });
        const data = await res.json();
        textarea.value = data.reply || "Erro: Resposta vazia.";
      } catch (e) {
        textarea.value = "Erro de conex√£o: " + e.message;
      } finally {
        status.innerText = "READY";
      }
    }
    
    function closeReply() {
      document.getElementById("ai-reply-box").style.display = "none";
      document.getElementById("ai-overlay").style.display = "none";
    }
    
    async function confirmSend() {
      const msg = document.getElementById("ai-reply-text").value;
      if (!msg) return;
      const btn = document.querySelector(".ai-btn-confirm");
      btn.innerText = "SENDING...";
      btn.disabled = true;
      try {
        const res = await fetch("/admin/dm/send?token=" + token, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            student_id: currentReplyData.sid, 
            context_type: "checkout",
            context_id: currentReplyData.slide_id,
            message_text: msg 
          })
        });
        if (res.ok) closeReply();
        else alert("Erro ao enviar DM");
      } catch (e) { alert("Falha na rede"); }
      finally { btn.innerText = "SEND DM"; btn.disabled = false; }
    }

    async function load(){
      errEl.textContent = "";
      try {
        const day = dateEl.value;
        if(!day) return;
        const [dataRes, likertRes] = await Promise.all([
          fetchJson("/admin/checkouts/data?date=" + day),
          fetchJson("/admin/checkouts/likert?date=" + day)
        ]);
        const rows = dataRes.items || [];
        tbody.innerHTML = rows.map(r => {
          var time = r.timestamp_br ? r.timestamp_br.split(" ")[1] : "--:--";
          return '<tr>' +
            '<td style="color:var(--muted); font-family:monospace">' + esc(time) + '</td>' +
            '<td><span style="background:rgba(167,139,250,0.1); color:var(--accent); padding:2px 6px; border-radius:4px; font-size:10px; font-weight:bold">' + esc(r.slide_id) + '</span></td>' +
            '<td><div style="display:flex; justify-content:space-between; align-items:center;">' +
            '<span>' + esc(r.ticket) + '</span>' +
            '<button class="btn-reply" data-sid="'+esc(r.student_id)+'" data-slide-id="'+esc(r.slide_id)+'" data-ticket="'+esc(r.ticket)+'">REPLY</button>' +
            '</div></td>' +
            '<td style="text-align:center; font-weight:800; color:var(--accent)">' + esc(r.likert_value || "-") + '</td>' +
          '</tr>';
        }).join("");
        document.getElementById("countPill").textContent = rows.length;
        if(likertRes) renderChart(likertRes);
        runAnalysis(rows);
      } catch(e) { errEl.textContent = e.message; }
    }

    function runAnalysis(rows) {
      const vals = rows.map(r => parseInt(r.likert_value)).filter(v => !isNaN(v));
      document.getElementById("avgLikert").textContent = vals.length ? (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2) : "0.0";
      const allText = rows.map(r => r.ticket || "").join(" ").toLowerCase();
      const words = allText.match(/[a-z√†-√ø]+/g) || [];
      const stopWords = ["esse", "como","tamb√©m", "sobre", "seu", "entre", "por", "esta", "para", "que", "com", "uma", "mais", "aula", "hoje", "vimos", "aprendi", "muito"];
      const counts = {};
      words.forEach(w => { if (w.length >= 3 && !stopWords.includes(w)) counts[w] = (counts[w] || 0) + 1; });
      const sorted = Object.keys(counts).map(k => ({word:k, count:counts[k]})).sort((a,b)=>b.count-a.count).slice(0,10);
      document.getElementById("keywordsBox").innerHTML = sorted.map(f => '<span style="background:rgba(167,139,250,0.1); padding:4px 8px; border-radius:6px; font-size:11px; border:1px solid var(--border); font-weight:600;">'+f.word.toUpperCase()+' ('+f.count+')</span>').join("") || '-';
    }

    function renderChart(data){
      if(chart) chart.destroy();
      const labels = data.questions.map(q => q.question);
      const ds = ["1","2","3","4","5"].map((v, i) => ({
        label: v, data: data.questions.map(q => q.counts[v] || 0),
        backgroundColor: ["#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0", "#9966FF"][i], borderRadius: 6
      }));
      chart = new Chart(document.getElementById("chart"), {
        type: 'bar', data: { labels, datasets: ds },
        options: { responsive:true, maintainAspectRatio:false, scales:{x:{ticks:{color:"#93a4c7"}},y:{ticks:{color:"#93a4c7"}}}}
      });
    }

    async function init(){
      const res = await fetchJson("/admin/checkouts/slides");
      dateEl.innerHTML = res.items.map(d => '<option value="'+d+'">'+d+'</option>').join("");
      if(res.items.length) load();
    }
    document.getElementById("btnLoad").onclick = load;
    dateEl.onchange = load;
    init();
  </script>
</body>
</html>`;
  return new Response(html, { headers: { "content-type": "text/html;charset=utf-8" } });
}






    if (is("/admin/dm/send") && method === "POST") {
      const body = await readJsonBody(req);
      const { student_id, checkout_id, message_text, context_type, context_id } = body || {};
    
      const sid = String(student_id || "").trim().toLowerCase();
      const msg = String(message_text || "").trim();
    
      if (!sid || !msg) return json({ error: "Missing data" }, origin, 400);
    
      // Se vier checkout_id, tratamos como reply de checkout.
      // Se n√£o vier, √© DM manual (checkout_id NULL).
      const chk = checkout_id ? String(checkout_id).trim() : null;
    
      const ctype = String(context_type || (chk ? "checkout" : "manual")).trim();
      const cid   = (context_id != null && String(context_id).trim() !== "") ? String(context_id).trim() : (chk ? chk : null);
    
      await env.DB.prepare(`
        INSERT INTO dm (student_id, checkout_id, message_text, context_type, context_id)
        VALUES (?, ?, ?, ?, ?)
      `).bind(sid, chk, msg, ctype, cid).run();
    
      return json({ status: "success" }, origin);
    }
    
    if (is("/admin/dm") && method === "GET") {
      const adminKey = req.headers.get("x-admin-token") || url.searchParams.get("token") || url.searchParams.get("t") || "";
    
      const html = `<!doctype html>
    <html lang="en">
    <head>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width,initial-scale=1"/>
      <title>HCM Admin: Send DM</title>
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
      <style>
        :root{ 
          --bg:#030712; --card:#0b1220; --muted:#94a3b8; --text:#f1f5f9; 
          --border:rgba(255,255,255,.08); --accent:#3b82f6; --ok:#10b981; --bad:#ef4444;
        }
        body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,sans-serif;padding:40px 20px;}
        .wrap{max-width:650px;margin:0 auto;}
        .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);}
        h1{margin:0 0 8px; font-size: 1.5rem;}
        label{display:block;color:var(--muted);font-size:11px;text-transform:uppercase;margin:15px 0 6px; font-weight:700; letter-spacing: 0.05em;}
        
        /* Ajuste de largura e consist√™ncia nos inputs */
        input, textarea{
          width:100%; padding:12px; border-radius:10px; border:1px solid var(--border); 
          background:#111827; color:var(--text); font:inherit; box-sizing: border-box;
          transition: border-color 0.2s;
        }
        input:focus, textarea:focus{ outline:none; border-color: var(--accent); }
        
        textarea{min-height:150px; resize:vertical;}
        
        /* Grid para Context e Type ficarem alinhados */
        .row{display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom: 10px;}
        
        button{
          width: 100%; padding:14px; border-radius:10px; border:none; 
          background:var(--accent); color:white; font-weight:800; cursor:pointer; 
          font-size: 15px; transition: opacity 0.2s;
        }
        button:hover{ opacity: 0.9; }
        
        .status{margin-top:15px; font-size:13px; font-family: monospace;}
        .pill{display:inline-block;padding:2px 8px;border-radius:6px;font-weight:800;font-size:11px;}
        .pill.ok{background:rgba(16,185,129,0.15);color:var(--ok);border:1px solid var(--ok);}
        .pill.bad{background:rgba(239,68,68,0.15);color:var(--bad);border:1px solid var(--bad);}
        
        .hint{font-size:13px; color:var(--muted); margin-bottom:20px; line-height:1.5; border-bottom: 1px solid var(--border); padding-bottom: 15px;}
        
        /* Bot√£o Back to Dashboard */
        .btn-back {
          display: flex; align-items: center; justify-content: center;
          margin-top: 25px; color: #64748b; text-decoration: none;
          font-size: 14px; font-weight: 500; transition: color 0.2s;
        }
        .btn-back:hover { color: #fff; }
        .btn-back i { margin-right: 8px; }
      </style>
    </head>
    <body>
      <div class="wrap">
        <div class="card">
          <h1>Admin ¬∑ Send Manual DM</h1>
    
          <div class="hint">
            Use this page to send a <b>manual DM</b> to any student.<br>
            For checkout replies, use <code>/admin/checkouts</code>.
          </div>
    
          <label>Student ID</label>
          <input id="sid" placeholder="e.g., aluno_teste" />
    
          <div class="row">
            <div>
              <label>Context (optional)</label>
              <input id="context" placeholder="e.g., module1" />
            </div>
            <div>
              <label>Type</label>
              <input id="ctype" value="manual" />
            </div>
          </div>
    
          <label>Message</label>
          <textarea id="msg" placeholder="Write your message here..."></textarea>
    
          <div style="margin-top:20px;">
            <button id="btn">SEND DIRECT MESSAGE</button>
          </div>
    
          <div id="out" class="status"></div>
        </div>

        <a href="/admin?t=${adminKey}" class="btn-back">
          <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
      </div>
    
      <script>
        const params = new URLSearchParams(location.search);
        const token = params.get("t") || params.get("token") || "${String(adminKey).replace(/"/g,'\\"')}";
    
        function show(ok, text){
          const out = document.getElementById("out");
          out.innerHTML = (ok
            ? '<span class="pill ok">SUCCESS</span> '
            : '<span class="pill bad">ERROR</span> '
          ) + (text || "");
        }
    
        async function sendDM(student_id, message_text, context_id){
          const payload = {
            student_id,
            message_text,
            context_type: (document.getElementById("ctype").value || "manual").trim()
          };
    
          if (context_id && context_id.trim()) {
            payload.context_id = context_id.trim();
          }
    
          const res = await fetch("/admin/dm/send?t=" + encodeURIComponent(token), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
    
          const text = await res.text();
          return { ok: res.ok, status: res.status, text };
        }
    
        document.getElementById("btn").onclick = async () => {
          const sid = (document.getElementById("sid").value || "").trim();
          const msg = (document.getElementById("msg").value || "").trim();
          const ctx = (document.getElementById("context").value || "").trim();
          const btn = document.getElementById("btn");
    
          if(!sid || !msg) return show(false, "Missing student_id or message.");
    
          btn.disabled = true;
          btn.innerText = "SENDING...";
          
          try{
            const r = await sendDM(sid, msg, ctx);
            show(r.ok, r.text);
            if(r.ok) {
              document.getElementById("msg").value = ""; // Limpa apenas a mensagem ap√≥s sucesso
            }
          }catch(e){
            show(false, e.message);
          } finally {
            btn.disabled = false;
            btn.innerText = "SEND DIRECT MESSAGE";
          }
        };
      </script>
    </body>
    </html>`;
    
      return new Response(html, { headers: { "Content-Type": "text/html; charset=utf-8", ...cors(origin) } });
    }
      
    



if (is("/admin/checkouts/slides") && method === "GET") {
  try {
    const { results } = await env.DB.prepare(`
      SELECT DISTINCT substr(timestamp_br, 1, 10) as day
      FROM t_checkouts
      ORDER BY day DESC
    `).all();
    return json({ items: (results || []).map(r => r.day) }, origin);
  } catch (e) {
    return json({ error: e.message }, origin, 500);
  }
}

// --- NO ENDPOINT: /admin/checkouts/data ---
if (is("/admin/checkouts/data") && method === "GET") {
  try {
    const url = new URL(req.url);
    const date = (url.searchParams.get("date") || "").trim();

    // Se houver data, filtramos. Se n√£o, mostramos tudo.
    const sql = date 
      ? "SELECT timestamp_br, student_id, slide_id, ticket, likert_question, likert_value FROM t_checkouts WHERE substr(timestamp_br, 1, 10) = ? ORDER BY timestamp_br ASC"
      : "SELECT timestamp_br, student_id, slide_id, ticket, likert_question, likert_value FROM t_checkouts ORDER BY timestamp_br ASC";

    const binds = date ? [date] : [];
    const { results } = await env.DB.prepare(sql).bind(...binds).all();

    return json({ items: results || [] }, origin);
  } catch (e) {
    return json({ error: "D1 Data Error: " + e.message }, origin, 500);
  }
}

// --- NO ENDPOINT: /admin/checkouts/likert ---
if (is("/admin/checkouts/likert") && method === "GET") {
  try {
    const url = new URL(req.url);
    const date = (url.searchParams.get("date") || "").trim();

    // Query fixa para evitar o erro do token "$"
    let sql = "SELECT CAST(likert_question AS TEXT) AS question, CAST(likert_value AS TEXT) AS value, COUNT(*) AS n FROM t_checkouts WHERE likert_question IS NOT NULL AND likert_value IS NOT NULL";
    const binds = [];

    if (date) {
      sql += " AND substr(timestamp_br, 1, 10) = ?";
      binds.push(date);
    }
    sql += " GROUP BY question, value";

    const { results } = await env.DB.prepare(sql).bind(...binds).all();

    const map = new Map();
    const totals = { "1":0, "2":0, "3":0, "4":0, "5":0, total: 0 };

    for (const r of (results || [])) {
      const q = String(r.question || "").trim();
      const v = String(r.value || "").trim();
      const n = Number(r.n || 0);
      if (!["1","2","3","4","5"].includes(v)) continue;
      if (!map.has(q)) map.set(q, { question: q, counts: { "1":0,"2":0,"3":0,"4":0,"5":0 }, total: 0 });
      const obj = map.get(q);
      obj.counts[v] += n;
      obj.total += n;
      totals[v] += n;
      totals.total += n;
    }

    return json({ questions: Array.from(map.values()), totals }, origin);
  } catch (e) {
    return json({ error: "D1 Likert Error: " + e.message }, origin, 500);
  }
}




    // ---------- RANKING (likes) ----------
    if (is("/ranking/score") && method === "GET") {
      const limit = clamp(int(url.searchParams.get("limit"), 100), 1, 1000);
      const rows = (await env.DB.prepare(
        `SELECT student, points, last_ts
           FROM ranking_score_likes
          ORDER BY points DESC, last_ts DESC
          LIMIT ?`
      ).bind(limit).all()).results || [];
      return json({ status: "success", items: rows }, origin);
    }


    // ============================================================
    // RANKING (TOTAL)
    // ============================================================
    if (is("/ranking") && method === "GET") {
      try {
        const topN = clamp(int(url.searchParams.get("top"), 10), 1, 100);
        const who = (url.searchParams.get("who") || "").trim();

        const topRows = (await env.DB.prepare(`
          SELECT student_id, points
          FROM ranking_score_total
          ORDER BY points DESC, student_id COLLATE NOCASE ASC
          LIMIT ?
        `).bind(topN).all()).results || [];

        const top = topRows.map((r, i) => ({
          rank: i + 1,
          studentId: r.student_id,
          student: r.student_id,
          total_points: Number(r.points || 0)
        }));

        let me = null;
        if (who) {
          const meRow = await env.DB.prepare(`
            WITH ranked AS (
              SELECT *, ROW_NUMBER() OVER (ORDER BY points DESC, student_id ASC) AS pos
              FROM ranking_score_total
            )
            SELECT * FROM ranked WHERE student_id = ?
          `).bind(who).first();

          if (meRow) {
            me = {
              rank: meRow.pos,
              studentId: meRow.student_id,
              points: meRow.points,
              likes_points: meRow.likes_points,
              checkouts_points: meRow.checkouts_points,
              poll_points: meRow.poll_points,
            };
          }
        }

        return json({ status: "success", ok: true, top, me, updated_at: new Date().toISOString() }, origin);
      } catch (e) {
        return json({ status: "error", message: "Ranking update in progress..." }, origin, 500);
      }
    }



// ============================================================
// ATTENDANCE
// ============================================================
if (is("/admin/attendance/save") && method === "POST") {
  try {
    const body = await readJsonBody(req);
    const { date, records } = body || {};

    if (!date || !Array.isArray(records)) {
      return json({ ok: false, error: "Missing date or records[]" }, origin, 400);
    }
    if (records.length === 0) {
      return json({ ok: false, error: "records is empty" }, origin, 400);
    }

    const statements = records.map((r) => {
      const sid = String(r.sid || "").trim().toLowerCase();
      const status = String(r.status || "present");

      return env.DB
        .prepare("INSERT OR REPLACE INTO attendance_dates (student_id, date_class, status) VALUES (?, ?, ?)")
        .bind(sid, date, status);
    });

    const out = await env.DB.batch(statements);

    return json(
      { ok: true, inserted: statements.length },
      origin
    );
  } catch (e) {
    return json({ ok: false, error: String(e && e.message ? e.message : e) }, origin, 500);
  }
}

if (is("/admin/attendance") && method === "GET") {
  const instructor = env.INSTRUCTOR_NAME || "Henrique";
  const adminKey = url.searchParams.get("token") || url.searchParams.get("t") || "";

  const { results } = await env.DB.prepare(
    "SELECT student_id, name FROM t_students_dim WHERE prof = ? ORDER BY name ASC"
  ).bind(instructor).all();

  const studentRows = (results || [])
    .map((s) => `
      <div class="student-card" data-sid="${escapeHtml(s.student_id)}">
        <div class="student-info">
          <span class="student-name">${escapeHtml(s.name)}</span>
        </div>
        <div class="status-toggle">
          <button type="button" class="btn-status present active" onclick="setStatus(this, 'present')">P</button>
          <button type="button" class="btn-status partial" onclick="setStatus(this, 'partial')">¬Ω</button>
          <button type="button" class="btn-status absent" onclick="setStatus(this, 'absent')">A</button>
        </div>
      </div>
    `)
    .join("");

  const html = `<!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
      <title>HCM Admin: Attendance</title>
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
      <style>
        :root { 
          --p-color:#10b981; --a-color:#ef4444; --pt-color:#f59e0b; 
          --bg:#0b1220; --card:#1e293b; --text:#f1f5f9; --border:rgba(255,255,255,0.1); 
        }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; padding-bottom: 50px; }
        .container { max-width: 500px; margin: 0 auto; }
        h2 { text-align: center; color: #38bdf8; font-weight: 800; margin-bottom: 20px; }
        
        .date-picker { 
          width: 100%; padding: 15px; border-radius: 12px; border: 1px solid var(--border); 
          background: var(--card); color: white; font-size: 18px; margin-bottom: 20px; box-sizing: border-box; 
        }
    
        .student-card { 
          background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 10px; 
          display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); 
        }
        .student-name { font-weight: 600; color: var(--text); font-size: 15px; }
        
        .status-toggle { display: flex; gap: 6px; }
        .btn-status { 
          border: 1px solid var(--border); background: #0b1220; color: var(--text); 
          padding: 10px 14px; border-radius: 10px; font-weight: 800; cursor: pointer; min-width: 48px; 
          transition: all 0.1s ease;
        }
    
        .btn-status.present.active { background: var(--p-color) !important; color: #0b1220 !important; border-color: var(--p-color); }
        .btn-status.partial.active { background: var(--pt-color) !important; color: #0b1220 !important; border-color: var(--pt-color); }
        .btn-status.absent.active { background: var(--a-color) !important; color: white !important; border-color: var(--a-color); }
        
        .btn-submit { 
          width: 100%; padding: 20px; background: #38bdf8; color: #0b1220; border: none; 
          border-radius: 16px; font-size: 18px; font-weight: 800; margin-top: 20px; 
          cursor: pointer; box-shadow: 0 4px 14px rgba(56,189,248,0.2); 
        }
        .btn-submit:active { transform: scale(0.98); }

        /* ESTILO DO BOT√ÉO VOLTAR */
        .btn-back {
          display: flex;
          align-items: center;
          justify-content: center;
          margin-top: 30px;
          color: #94a3b8;
          text-decoration: none;
          font-size: 15px;
          font-weight: 500;
          transition: color 0.2s;
        }
        .btn-back:hover { color: #fff; }
        .btn-back i { margin-right: 8px; }
      </style>
    </head>
    <body>
      <div class="container">
        <h2><i class="bi bi-calendar3"></i> Roll Call</h2>
        <input type="date" id="class_date" class="date-picker" value="${new Date().toISOString().split("T")[0]}">
        <div id="student_list">
          ${studentRows}
        </div>
        <button class="btn-submit" onclick="submit()">SUBMIT ATTENDANCE</button>
        
        <a href="/admin?t=${adminKey}" class="btn-back">
          <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
      </div>

      <script>
        function setStatus(btn, status) {
          const parent = btn.parentElement;
          parent.querySelectorAll('.btn-status').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          btn.closest('.student-card').dataset.status = status;
        }
    
        async function submit() {
          const urlParams = new URLSearchParams(window.location.search);
          const token = urlParams.get('t') || urlParams.get('token') || "";
          const date = document.getElementById('class_date').value;
          
          const records = Array.from(document.querySelectorAll('.student-card')).map(card => ({
            sid: card.dataset.sid,
            status: card.dataset.status || 'present'
          }));
    
          const btnSubmit = document.querySelector('.btn-submit');
          btnSubmit.disabled = true;
          btnSubmit.innerText = "SAVING...";
    
          try {
            const res = await fetch('/admin/attendance/save?t=' + encodeURIComponent(token), {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ date, records })
            });
    
            if (res.ok) {
              alert('‚úÖ Attendance saved successfully!');
            } else {
              const data = await res.json().catch(() => ({}));
              alert('‚ùå Error: ' + (data.error || res.status));
            }
          } catch (e) {
            alert('‚ùå Network error: ' + e.message);
          } finally {
            btnSubmit.disabled = false;
            btnSubmit.innerText = "SUBMIT ATTENDANCE";
          }
        }
      </script>
    </body>
    </html>`;

  return new Response(html, { headers: { "Content-Type": "text/html", ...cors(origin) } });
}

    // ============================================================
    // HEALTH
    // ============================================================
    if (is("/health")) {
      return json({ ok: true, service: "threads", ts: nowMs() }, origin);
    }




    
    // ============================================================
    // POLL GALLERY (admin)
    // ============================================================
    if (is("/admin/poll/gallery") && method === "GET") {
      const { results } = await env.DB.prepare("SELECT * FROM poll_active ORDER BY poll_id DESC").all();

      const questionsHtml = results.map(q => {
        const opts = JSON.parse(q.options_json || "{}");
        const optionsHtml = Object.entries(opts).map(([letter, text]) => `
          <label style="display:block; margin: 8px 0; cursor:pointer;">
            <input type="radio" name="${q.exercise_id}" value="${letter}"> ${letter}. ${text}
          </label>
        `).join("");
      
        return `
          <div class="question-block" id="block-${q.exercise_id}" data-correct="${q.correct_answer}">
            <p><strong>${q.question_text}</strong></p>
            <form id="form-${q.exercise_id}">${optionsHtml}</form>
            <div id="feedback-${q.exercise_id}" class="feedback" style="display:none; padding:10px; margin-top:10px; border-radius:4px;">
              <strong>Resposta: ${q.correct_answer}</strong><br>${q.feedback_text}
            </div>
          </div>
        `;
      }).join("<hr>");

      const html = `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Question Bank ‚Äî Financial Strategy</title>
  <style>
    body { font-family: system-ui, sans-serif; background: #f1f5f9; padding: 40px 20px; }
    .container { max-width: 800px; margin: 0 auto; }
    h1 { color: #1e3a8a; text-align: center; margin-bottom: 30px; }
    .q-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .q-header { display: flex; justify-content: space-between; font-size: 12px; font-weight: bold; color: #64748b; margin-bottom: 10px; border-bottom: 1px solid #f1f5f9; padding-bottom: 5px; }
    .q-id { color: #1e3a8a; }
    .q-options { display: grid; gap: 8px; margin: 15px 0; }
    .opt { padding: 8px 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; font-size: 14px; }
    .opt.correct { background: #dcfce7; border-color: #bbf7d0; color: #166534; }
    .q-feedback { background: #eff6ff; padding: 10px; border-radius: 8px; font-size: 13px; color: #1e40af; border: 1px solid #dbeafe; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìö Question Bank Gallery</h1>
    ${questionsHtml || "<p>No questions found in database.</p>"}
  </div>
</body>
</html>`;

      return new Response(html, { headers: { "Content-Type": "text/html; charset=utf-8", ...cors(origin) } });
    }

    // ============================================================
    // LIVE POLL SYSTEM
    // ============================================================
    if (is("/poll/status")) {
      const student_id = url.searchParams.get("student_id");
      const activePoll = await env.DB.prepare("SELECT * FROM poll_active WHERE is_active = 1 LIMIT 1").first();
      if (!activePoll) return json(null, origin);

      if (student_id) {
        const alreadyAnswered = await env.DB.prepare(
          "SELECT 1 FROM poll_responses WHERE poll_id = ? AND student_id = ? LIMIT 1"
        ).bind(activePoll.poll_id, student_id).first();

        if (alreadyAnswered) {
          return json({ ...activePoll, is_active: 0, already_answered: true }, origin);
        }
      }
      return json(activePoll, origin);
    }
    
    



    if (is("/poll/vote") && method === "POST") {
      const body = await readJsonBody(req);
      const { student_id, poll_id, choice } = body || {};

      const poll = await env.DB.prepare(
        "SELECT poll_id, correct_option, poll_type, feedback_text FROM poll_active WHERE is_active = 1 LIMIT 1"
      ).first();
      if (!poll) return json({ error: "No active poll" }, origin);

      const cleanChoice = (String(choice) || "").trim().replace(",", ".");
      const cleanCorrect = (String(poll.correct_option) || "").trim().replace(",", ".");

      let is_correct = 0;
      if (poll.poll_type === "numeric") {
        const nChoice = parseFloat(cleanChoice);
        const nCorrect = parseFloat(cleanCorrect);
        const tolerance = 0.01;
        if (!isNaN(nChoice) && !isNaN(nCorrect)) {
          is_correct = Math.abs(nChoice - nCorrect) <= tolerance ? 1 : 0;
        }
      } else {
        is_correct = (cleanChoice.toUpperCase() === cleanCorrect.toUpperCase() && cleanCorrect !== "") ? 1 : 0;
      }

      try {
        await env.DB.prepare(
          "INSERT INTO poll_responses (poll_id, student_id, chosen_option, is_correct, ts_br) VALUES (?, ?, ?, ?, ?)"
        ).bind(poll_id || poll.poll_id, student_id, choice, is_correct, tsBRString(Date.now())).run();

        return json({ status: "success", correct: is_correct, feedback: poll.feedback_text || "" }, origin);
      } catch (e) {
        return json({ status: "error", message: "Already answered" }, origin, 400);
      }
    }

    // ============================================================
    // POLL ADMIN API (protected by admin gate)
    // ============================================================
    if (is("/poll/admin")) {
      // ------------------------------------------------------------
      // GET a single poll row
      // ------------------------------------------------------------
      if (url.searchParams.has("get_poll")) {
        const pollId = url.searchParams.get("get_poll");
        const pollData = await env.DB
          .prepare("SELECT * FROM poll_active WHERE poll_id = ?")
          .bind(pollId)
          .first();
        return json(pollData, origin);
      }
    
      // ------------------------------------------------------------
      // Enable results for a poll (kept as you had it)
      // ------------------------------------------------------------
      if (url.searchParams.has("toggle_results")) {
        const pollId = url.searchParams.get("toggle_results");
        await env.DB
          .prepare("UPDATE poll_active SET show_results = 1 WHERE poll_id = ?")
          .bind(pollId)
          .run();
        return json({ status: "ok", results_enabled: true }, origin);
      }
    
      // ------------------------------------------------------------
      // Delete poll row
      // ------------------------------------------------------------
      if (url.searchParams.has("delete_id")) {
        const pollId = url.searchParams.get("delete_id");
        await env.DB.prepare("DELETE FROM poll_active WHERE poll_id = ?").bind(pollId).run();
        return json({ status: "ok" }, origin);
      }
    
      // ------------------------------------------------------------
      // Activate / Deactivate
      // ------------------------------------------------------------
      const activate = url.searchParams.get("set") === "1";
      const p_id = url.searchParams.get("poll_id");
    
      // OFF (close)
      if (!activate) {
        if (p_id) {
          // Close only this poll
          await env.DB.prepare("UPDATE poll_active SET is_active = 0 WHERE poll_id = ?").bind(p_id).run();
          return json({ status: "closed_one", poll_id: p_id }, origin);
        } else {
          // Close all polls (and reset show_results too, like your original)
          await env.DB.prepare("UPDATE poll_active SET is_active = 0, show_results = 0").run();
          return json({ status: "closed_all" }, origin);
        }
      }
    
      // ON (launch/activate)
      if (activate && p_id) {
        // ‚úÖ MULTI-ACTIVE: do NOT deactivate other polls
        // (This is the line you had before; removed on purpose)
        // await env.DB.prepare("UPDATE poll_active SET is_active = 0 WHERE poll_id != ?").bind(p_id).run();
    
        const q = url.searchParams.get("q");
    
        // If no question text provided, treat as "activate existing poll"
        if (!q || q === "undefined") {
          await env.DB.prepare("UPDATE poll_active SET is_active = 1 WHERE poll_id = ?").bind(p_id).run();
          return json({ status: "ok_activated_existing", poll_id: p_id }, origin);
        }
    
        // Create/update poll payload
        const opts = url.searchParams.get("opts") || "{}";
        const correct = (url.searchParams.get("correct") || "").trim();
        const type = url.searchParams.get("type") || "info";
        const feedback = url.searchParams.get("feedback") || "";
    
        await env.DB.prepare(`
          INSERT INTO poll_active (
            poll_id, question, options_json, correct_option,
            is_active, show_results, poll_type, feedback_text
          )
          VALUES (?, ?, ?, ?, 1, 0, ?, ?)
          ON CONFLICT(poll_id) DO UPDATE SET
            question=excluded.question,
            options_json=excluded.options_json,
            correct_option=excluded.correct_option,
            is_active=1,
            show_results=0,
            poll_type=excluded.poll_type,
            feedback_text=excluded.feedback_text
        `).bind(p_id, q, opts, correct, type, feedback).run();
    
        return json({ status: "ok_launched_new", poll_id: p_id }, origin);
      }
    
      return json({ status: "noop" }, origin);
    }
    

    // ============================================================
    // POLL EXPORT (protected by admin gate)
    // ============================================================
    if (is("/poll/export") && method === "GET") {
      const id = url.searchParams.get("id");
      const format = url.searchParams.get("format");

      const poll = await env.DB.prepare("SELECT * FROM poll_active WHERE poll_id = ?").bind(id).first();
      if (!poll) return new Response("Quest√£o n√£o encontrada no banco D1", { status: 404, headers: cors(origin) });

      const content = (format === "qmd") ? generateQMD(poll) : generateBrightspaceCSV(poll);
      const fileName = (format === "qmd") ? `${id}.qmd` : `${id}_brightspace.csv`;
      const contentType = (format === "qmd") ? "text/plain" : "text/csv";

      return new Response(content, {
        headers: {
          ...cors(origin),
          "Content-Type": `${contentType}; charset=utf-8`,
          "Content-Disposition": `attachment; filename="${fileName}"`
        }
      });
    }

    // ============================================================
    // POLL LIST (protected by admin gate)
    // ============================================================
    if (is("/poll/list") && method === "GET") {
      const list = await env.DB.prepare("SELECT poll_id, question, is_active, poll_type FROM poll_active ORDER BY poll_id DESC LIMIT 50").all();
      return json(list.results || [], origin);
    }





    // ============================================================
    // ADMIN PANEL: /admin/poll  (IMPORT REMOVED + FIXED)
    // ============================================================
    if (is("/admin/poll") && method === "GET") {
      const adminKey = req.headers.get("x-admin-token") || url.searchParams.get("token") || url.searchParams.get("t") || "";

      const html = `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>HCM Admin: Polls</title>
  <style>
    :root { 
      --bg: #0b1220; 
      --card: #1e293b; 
      --accent: #38bdf8; 
      --text: #f1f5f9; 
      --border: rgba(255,255,255,0.1); 
    }
    body { font-family: system-ui, sans-serif; padding: 20px; background: var(--bg); color: var(--text); }
    .card { max-width: 700px; margin: 0 auto 20px auto; background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    h2 { margin-top: 0; color: var(--accent); font-size: 1.2rem; font-weight: 800; }
    label { display: block; font-size: 10px; font-weight: 800; margin: 12px 0 4px; color: #94a3b8; text-transform: uppercase; }
    input, textarea, select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; background: #0b1220; color: white; box-sizing: border-box; font-size: 14px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    button { padding: 12px; border-radius: 10px; border: none; font-weight: 800; cursor: pointer; transition: 0.2s; }
    .btn-launch { background: var(--accent); color: #0b1220; width: 100%; margin-top: 15px; }
    .btn-close { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); width: 100%; margin-top: 8px; }
    #poll_list { margin-top: 25px; border-top: 1px solid var(--border); padding-top: 15px; }
    .poll-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #0b1220; border-radius: 12px; margin-bottom: 8px; border: 1px solid var(--border); }
    .btn-small {padding: 6px 10px; font-size: 10px; text-transform: uppercase; margin-left: 4px; color: #ffffff !important; min-width: 50px; }
    .btn-active {background: #713f12 !important; color: #0f172a !important; border: 1px solid #38bdf8;}
    .btn-toggle { background: #475569; color: white !important; }
    .btn-results { background: #059669; } /* Verde fechado */
    .btn-qmd     { background: #cbd5e1; color: #0f172a !important; }
    .btn-on      { background: #713f12; }
    .btn-csv     { background: #fde047; color: #713f12 !important; } 
    .btn-edit    { background: #1e40af; } /* Azul marinho */
    .btn-del     { background: #991b1b; } /* Vermelho escuro */
    .poll-info b { font-size: 14px; color: #fff; }
    .poll-info small { color: #64748b; font-size: 11px; }
    .btn-back {display: flex; align-items: center; justify-content: center;
      margin-top: 20px; color: #94a3b8; text-decoration: none;
      font-size: 14px; font-weight: 500; transition: color 0.2s;}
    .btn-back:hover { color: #fff; }
    .btn-back::before { content: "‚Üê"; margin-right: 8px; }
  </style>
</head>
<body>
  <div class="card">
    <h2>üöÄ Launch / Edit Poll</h2>

    <div class="grid">
      <select id="poll_type" onchange="toggleMode()">
        <option value="quiz">Quiz (A‚ÄìE)</option>
        <option value="numeric">Numeric (Input)</option>
        <option value="info">Info</option>
      </select>
      <input id="p_id" placeholder="ID (ex: module1_mcq_q1)">
    </div>

    <label>Question</label>
    <textarea id="q" rows="2" placeholder="Question text..."></textarea>

    <div id="options-section">
      <label>Options (A‚ÄìE)</label>
      <div class="grid5">
        <input id="a" placeholder="A">
        <input id="b" placeholder="B">
        <input id="c" placeholder="C">
        <input id="d" placeholder="D">
        <input id="e" placeholder="E">
      </div>
    </div>

    <label>Correct Answer / Target Value</label>
    <input id="correct" placeholder="Correct (A-E or Number)">

    <label>Feedback (Optional)</label>
    <textarea id="feedback" rows="2" placeholder="Feedback..."></textarea>

    <button class="btn-launch" onclick="send(1)">Save & Activate</button>
    <button class="btn-close" onclick="send(0)">Deactivate (this or all)</button>

    <div id="status"></div>

    <h3>History</h3>
    <div id="poll_list">Loading database...</div>
    
    <a href="/admin?t=${adminKey}" class="btn-back">Back to Dashboard</a>
  </div>

  <script>
    function escHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, function(m){
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
      });
    }

    function getToken(){
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('t') || urlParams.get('token') || '';
    }

    async function load() {
      try {
        const token = getToken();
        const res = await fetch('/poll/list?t=' + encodeURIComponent(token), { method: 'GET' });

        const status = res.status;
        const ct = (res.headers.get("content-type") || "").toLowerCase();
        const raw = await res.text();
        
        if (!res.ok) {
          console.error("poll/list HTTP error:", status, raw.slice(0, 300));
          document.getElementById('poll_list').innerHTML =
            'Error loading history. (HTTP ' + status + ')';
          return;
        }
        
        let data = null;
        try {
          data = raw ? JSON.parse(raw) : null;
        } catch (e) {
          console.error("poll/list returned non-JSON:", { status, ct, rawPreview: raw.slice(0, 300) });
          document.getElementById('poll_list').innerHTML =
            'Error loading history. (Invalid JSON response)';
          return;
        }
        
        // Se o backend devolver {error: "..."} ou algo que n√£o seja array:
        if (!Array.isArray(data)) {
          console.error("poll/list JSON is not an array:", data);
          document.getElementById('poll_list').innerHTML =
            'Error loading history. (Unexpected response shape)';
          return;
        }
                
        const listDiv = document.getElementById('poll_list');
        if (!data || data.length === 0) {
          listDiv.innerHTML = '<div style="text-align:center;color:#64748b;padding:20px;">No history yet.</div>';
          return;
        }

        listDiv.innerHTML = data.map(function(p) {
          const statusIcon = p.is_active ? 'üü¢' : '‚ö™';
          const btnClass = p.is_active ? 'btn-small btn-active btn-toggle' : 'btn-small btn-toggle';
          const shortQ = p.question ? String(p.question).substring(0,40) : '';
        
          const pid = String(p.poll_id || "");
          const pidEnc = encodeURIComponent(pid);
        
          const qmdUrl = "/poll/export?id=" + encodeURIComponent(pid) + "&format=qmd&t=" + encodeURIComponent(token);
          const csvUrl = "/poll/export?id=" + encodeURIComponent(pid) + "&format=csv&t=" + encodeURIComponent(token);
        
          const qmdEnc = encodeURIComponent(qmdUrl);
          const csvEnc = encodeURIComponent(csvUrl);
        
          return '<div class="poll-item">' +
            '<div>' +
              '<strong>' + statusIcon + ' ' + escHtml(pid) + '</strong>' +
              '<div style="font-size:11px; color:#64748b">' + escHtml(shortQ) + '...</div>' +
            '</div>' +
            '<div class="actions-gap">' +
              '<button class="btn-small btn-results" style="background:#059669; color:white" data-pid="' + pidEnc + '">Results</button>' +
              '<button class="btn-small btn-qmd" style="background:#e0e7ff; color:#1e3a8a" data-url="' + qmdEnc + '">QMD</button>' +
              '<button class="btn-small btn-csv" style="background:#fef3c7; color:#92400e" data-url="' + csvEnc + '">CSV</button>' +
              '<button class="' + btnClass + ' btn-toggle" data-pid="' + pidEnc + '" data-active="' + (p.is_active ? 1 : 0) + '">' + (p.is_active ? 'OFF' : 'ON') + '</button>' +
              '<button class="btn-small btn-edit" data-pid="' + pidEnc + '">Edit</button>' +
              '<button class="btn-small btn-danger btn-del" data-pid="' + pidEnc + '">Del</button>' +
            '</div>' +
          '</div>';
        }).join('');
        
        // ---- attach handlers AFTER rendering ----
        
        // Results
        listDiv.querySelectorAll(".btn-results").forEach((btn) => {
          btn.addEventListener("click", () => {
            const pid = decodeURIComponent(btn.dataset.pid || "");
            showResults(pid);
          });
        });
        
        // QMD / CSV
        listDiv.querySelectorAll(".btn-qmd").forEach((btn) => {
          btn.addEventListener("click", () => {
            window.open(decodeURIComponent(btn.dataset.url || ""));
          });
        });
        listDiv.querySelectorAll(".btn-csv").forEach((btn) => {
          btn.addEventListener("click", () => {
            window.open(decodeURIComponent(btn.dataset.url || ""));
          });
        });
        
        // Toggle / Edit / Del
        listDiv.querySelectorAll(".btn-toggle").forEach((btn) => {
          btn.addEventListener("click", () => {
            const pid = decodeURIComponent(btn.dataset.pid || "");
            const active = Number(btn.dataset.active || 0);
            toggleStatus(pid, active);
          });
        });
        
        listDiv.querySelectorAll(".btn-edit").forEach((btn) => {
          btn.addEventListener("click", () => {
            const pid = decodeURIComponent(btn.dataset.pid || "");
            editPoll(pid);
          });
        });
        
        listDiv.querySelectorAll(".btn-del").forEach((btn) => {
          btn.addEventListener("click", () => {
            const pid = decodeURIComponent(btn.dataset.pid || "");
            delPoll(pid);
          });
        });
      } catch (e) { 
        console.error("poll/list error:", e);
        document.getElementById('poll_list').innerHTML = 'Error loading history.'; 
      }
    }

    async function toggleStatus(id, activeStatus) {
      const newState = activeStatus === 1 ? 0 : 1;
      const token = getToken();
      await fetch("/poll/admin?poll_id=" + encodeURIComponent(id) + "&set=" + newState + "&t=" + encodeURIComponent(token));
      load();
    }

    async function delPoll(id) {
      if(confirm('Delete?')) {
        const token = getToken();
        await fetch("/poll/admin?delete_id=" + encodeURIComponent(id) + "&t=" + encodeURIComponent(token));
        load();
      }
    }

    async function editPoll(id) {
      const token = getToken();
      const res = await fetch("/poll/admin?get_poll=" + encodeURIComponent(id) + "&t=" + encodeURIComponent(token));
      const p = await res.json();
      if(p) {
        document.getElementById('p_id').value = p.poll_id || "";
        document.getElementById('q').value = p.question || "";
        document.getElementById('poll_type').value = p.poll_type || "quiz";
        document.getElementById('correct').value = p.correct_option || "";
        document.getElementById('feedback').value = p.feedback_text || "";
        let opts = {};
        try { opts = JSON.parse(p.options_json || '{}'); } catch {}
        document.getElementById('a').value = opts.A || '';
        document.getElementById('b').value = opts.B || '';
        document.getElementById('c').value = opts.C || '';
        document.getElementById('d').value = opts.D || '';
        document.getElementById('e').value = opts.E || '';
        window.scrollTo(0,0);
      }
      toggleMode();
    }
    async function send(active) {
      const token = getToken();

      const params = new URLSearchParams({
        set: String(active),
        poll_id: document.getElementById('p_id').value,
        q: document.getElementById('q').value,
        type: document.getElementById('poll_type').value,
        opts: JSON.stringify({
          A: document.getElementById('a').value,
          B: document.getElementById('b').value,
          C: document.getElementById('c').value,
          D: document.getElementById('d').value,
          E: document.getElementById('e').value
        }),
        correct: document.getElementById('correct').value,
        feedback: document.getElementById('feedback').value,
        t: token
      });

      const res = await fetch("/poll/admin?" + params.toString());
      const out = await res.json().catch(()=>null);
      document.getElementById('status').textContent = out?.status ? ("Status: " + out.status) : (res.ok ? "OK" : "Error");
      load();
    }

    function toggleMode() {
      const type = document.getElementById('poll_type').value;
      document.getElementById('options-section').style.display = (type === 'numeric') ? 'none' : 'block';
    }
    window.onload = function(){ toggleMode(); load(); };
    async function showResults(pid) {
      var token = getToken();
      var url = "/poll/results-details?poll_id=" + encodeURIComponent(pid) + "&t=" + encodeURIComponent(token);
      
      try {
        var res = await fetch(url);
        var data = await res.json();
 
        if(!data || data.length === 0) { 
          alert("Ainda n√£o h√° respostas para esta quest√£o."); 
          return; 
        } 
        var correct = data[0] ? data[0].correct : "";
        var total = data.reduce(function(sum, item) { return sum + item.count; }, 0);      
        var modal = document.getElementById('resultsModal');
        var overlay = document.getElementById('modalOverlay');
        if(!modal) {
          modal = document.createElement('div');
          modal.id = 'resultsModal';
          overlay = document.createElement('div');
          overlay.id = 'modalOverlay';
          overlay.className = 'overlay-bg';
          document.body.appendChild(overlay);
          document.body.appendChild(modal);
        }
        var barsHtml = "";
        ["A", "B", "C", "D", "E"].forEach(function(letter) {
          var item = data.find(function(d) { return String(d.chosen_option).toUpperCase() === letter; });
          var count = item ? item.count : 0;
          var pct = total > 0 ? (count / total * 100) : 0;
          var isCorrect = letter === String(correct).toUpperCase(); 
          var barClass = isCorrect ? 'bar-fill is-correct' : 'bar-fill';
          var labelStyle = isCorrect ? 'color:#059669; font-weight:800;' : '';
        
          barsHtml += '<div class="bar-row">' +
            '<span class="bar-label" style="' + labelStyle + '">' + letter + '</span>' +
            '<div class="bar-track"><div class="' + barClass + '" style="width:' + pct + '%"></div></div>' +
            '<span style="font-size:12px; font-weight:700; width:35px; text-align:right;">' + Math.round(pct) + '%</span>' +
          '</div>';
        });
        modal.innerHTML = '<h3 style="margin-top:0; color:#1e3a8a">Resultados: ' + pid + '</h3>' +
          '<div class="bar-container">' + barsHtml + '</div>' +
          '<div style="margin-top:20px; font-size:12px; color:#64748b">Total: <strong>' + total + '</strong></div>' +
          '<button onclick="closeResults()" style="margin-top:15px; width:100%; padding:12px; border-radius:10px; background:#1e3a8a; color:white; font-weight:bold; cursor:pointer">Fechar</button>';
        
        modal.style.display = 'block';
        overlay.style.display = 'block';
      } catch (e) {
        console.error("Erro ao buscar resultados:", e);
      }
    }
    function closeResults() {
      document.getElementById('resultsModal').style.display = 'none';
      document.getElementById('modalOverlay').style.display = 'none';
    }
  </script>
</body>
</html>`;

      return new Response(html, {
        headers: { "Content-Type": "text/html; charset=utf-8", ...cors(origin) }
      });
    }



    if (is("/admin/polls/queue-from-bank") && method === "POST") {
      try {
        const admin_key =
          req.headers.get("x-admin-token") ||
          url.searchParams.get("token") ||
          url.searchParams.get("t") ||
          "";
    
        const expected = String(env.ADMIN_SEMESTER || "").trim();
        if (!admin_key || String(admin_key).trim() !== expected) {
          return json({ error: "unauthorized" }, origin, 401);
        }
    
        const body = await safeReadJsonBody(req);
        if (!body) return json({ error: "invalid or missing JSON body" }, origin, 400);
    
        const exercise_id = String(body.exercise_id || "").trim();
        if (!exercise_id) return json({ error: "missing exercise_id" }, origin, 400);
    
        const qb = await env.DB.prepare(
          "SELECT exercise_id, type FROM questions_bank WHERE exercise_id = ?"
        ).bind(exercise_id).first();
    
        if (!qb) return json({ error: "exercise not found" }, origin, 404);
        if (String(qb.type || "").toLowerCase() !== "mcq") {
          return json({ error: "only mcq can be queued as poll" }, origin, 400);
        }
    
        try {
          await env.DB.prepare(`
            INSERT INTO poll_active (
              poll_id, question, options_json, correct_option,
              is_active, show_results, poll_type, feedback_text
            )
            SELECT
              qb.exercise_id,
              qb.question_text,
              qb.options_json,
              qb.correct_answer,
              0,
              0,
              'quiz',
              qb.feedback_text
            FROM questions_bank qb
            WHERE qb.exercise_id = ?
            ON CONFLICT(poll_id) DO UPDATE SET
              question       = excluded.question,
              options_json   = excluded.options_json,
              correct_option = excluded.correct_option,
              feedback_text  = excluded.feedback_text,
              poll_type      = excluded.poll_type,
              is_active      = 0,
              show_results   = 0;
          `).bind(exercise_id).run();
        } catch (e) {
          return json(
            { error: "db_error", message: String(e?.message || e) },
            origin,
            500
          );
        }
    
        return json({ ok: true, poll_id: exercise_id, is_active: 0 }, origin);
    
      } catch (e) {
        // aqui voc√™ finalmente mata o 500 HTML e v√™ o erro real em JSON
        return json(
          { error: "handler_exception", message: String(e?.stack || e?.message || e) },
          origin,
          500
        );
      }
    }
    
    


// =============================
// ADMIN: IMPORT ONE QUESTION
// =============================
if (is("/admin/questions/import-one") && method === "POST") {
  const sent = req.headers.get("x-admin-token") || url.searchParams.get("t");
  const master = env.ADMIN_SEMESTER || env.ADMIN_TOKEN;
  if (sent !== master) return new Response("Unauthorized", { status: 401 });

  const body = await readJsonBody(req);
  const { raw, manual_id, module, type } = body;
  
  if (!raw || !raw.trim()) return json({ error: "Conte√∫do vazio" }, origin, 400);

  // 1. Parser extrai o conte√∫do (texto, feedback, etc)
  let tpl = parseQuestionBlock(raw);

  // 2. Sobrescreve com os dados das caixas da interface
  tpl.module = module;
  tpl.type = type;

  // 3. L√≥gica de Identifica√ß√£o (Onde a m√°gica acontece)
  if (manual_id) {
    // Se digitou algo na box de ID, usa o que voc√™ digitou
    tpl.exercise_id = `${module}_${type}_${manual_id}`;
  } else {
    // Se deixou vazio, busca o √∫ltimo no banco para o pr√≥ximo n√∫mero
    const lastIdRow = await env.DB.prepare(`
      SELECT exercise_id FROM questions_bank 
      WHERE module = ? AND type = ? 
      ORDER BY CAST(SUBSTR(exercise_id, INSTR(exercise_id, '_q') + 2) AS INTEGER) DESC 
      LIMIT 1
    `).bind(module, type).first();

    let nextNum = 1;
    if (lastIdRow && lastIdRow.exercise_id) {
      const parts = lastIdRow.exercise_id.split('_q');
      if (parts.length > 1) {
        nextNum = parseInt(parts[1], 10) + 1;
      }
    }
    tpl.exercise_id = `${module}_${type}_q${nextNum}`;
  }

  // 4. Salva (upsert)
  await upsertQuestionBank(env, tpl);

  return json({ ok: true, parsed: tpl }, origin);
}
// ============================================================
// INTERFACE VISUAL PARA IMPORTA√á√ÉO (GET)
// ============================================================
  if (is("/admin/questions") && method === "GET") {
    const adminKey = req.headers.get("x-admin-token") || url.searchParams.get("token") || url.searchParams.get("t") || "";
    
    const html = `<!DOCTYPE html>
    <html lang="pt-br">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>HCM Admin: Question Bank Import</title>
      <style>
        :root {
          --bg: #030712;
          --card-bg: #0b1220;
          --border: #1f2937;
          --text: #f3f4f6;
          --accent: #3b82f6;
          --accent-hover: #2563eb;
          --success: #10b981;
          --error: #ef4444;
        }
  
        body { 
          font-family: 'Inter', system-ui, sans-serif; 
          background: var(--bg); 
          color: var(--text); 
          margin: 0;
          padding: 40px 20px;
          display: flex;
          justify-content: center;
        }
  
        .container {
          width: 100%;
          max-width: 850px;
        }
  
        h1 { font-size: 1.8rem; margin-bottom: 24px; font-weight: 700; color: #fff; }
  
        .card {
          background: var(--card-bg);
          border: 1px solid var(--border);
          border-radius: 16px;
          padding: 24px;
          box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
  
        .control-panel { 
          display: grid; 
          grid-template-columns: 1fr 1fr 1fr;
          gap: 15px; 
          margin-bottom: 20px; 
        }
  
        .field { display: flex; flex-direction: column; }
        
        label { 
          font-size: 12px; 
          color: #9ca3af; 
          margin-bottom: 8px; 
          font-weight: 600; 
          text-transform: uppercase;
          letter-spacing: 0.05em;
        }
  
        input, select, textarea { 
          background: #111827; 
          color: white; 
          border: 1px solid var(--border); 
          padding: 12px; 
          border-radius: 8px; 
          font-size: 14px;
          transition: border-color 0.2s;
        }
  
        input:focus, select:focus, textarea:focus {
          outline: none;
          border-color: var(--accent);
        }
  
        textarea { 
          width: 100%; 
          height: 300px; 
          color: #a7f3d0; /* Tom esverdeado para c√≥digo/qmd */
          font-family: 'Fira Code', monospace; 
          box-sizing: border-box; 
          margin-bottom: 20px;
          resize: vertical;
        }
  
        .btn-primary { 
          background: var(--accent); 
          color: white; 
          border: none; 
          padding: 14px; 
          cursor: pointer; 
          border-radius: 8px; 
          width: 100%; 
          font-weight: 600; 
          font-size: 16px; 
          transition: background 0.2s;
        }
  
        .btn-primary:hover { background: var(--accent-hover); }
  
        /* BOT√ÉO BACK TO DASHBOARD */
        .btn-back {
          display: inline-flex;
          align-items: center;
          margin-top: 25px;
          color: #9ca3af;
          text-decoration: none;
          font-size: 14px;
          font-weight: 500;
          transition: color 0.2s;
        }
  
        .btn-back:hover { color: #fff; }
        .btn-back svg { margin-right: 8px; }
  
        #status { 
          margin-top: 20px; 
          padding: 15px; 
          border-radius: 8px; 
          display: none; 
          font-family: monospace; 
          font-size: 14px;
        }
  
        @media (max-width: 600px) {
          .control-panel { grid-template-columns: 1fr; }
        }
      </style>
    </head>
    <body>
      <div class="container">
        <h1>üóÑÔ∏è Question Bank Import</h1>
        
        <div class="card">
          <div class="control-panel">
            <div class="field">
              <label>Manual ID</label>
              <input type="text" id="manual_id" placeholder="Ex: q1 ou v1">
            </div>
            <div class="field">
              <label>Module</label>
              <select id="module_select">
                ${[1,2,3,4,5,6,7,8,9,10].map(n => `<option value="module${n}">Module ${n}</option>`).join('')}
              </select>
            </div>
            <div class="field">
              <label>Question Type</label>
              <select id="type_select">
                <option value="tf">True / False</option>
                <option value="mcq" selected>Multiple Choice (MCQ)</option>
                <option value="multia">Multi-Affirmative</option>
                <option value="num">Numeric / Input</option>
                <option value="long">Long Answer</option>
              </select>
            </div>
          </div>
  
          <label>Content (.qmd / HTML)</label>
          <textarea id="inputQ" placeholder="Write the question here..."></textarea>
          
          <button class="btn-primary" onclick="importar()">SEND TO DATABASE</button>
          <div id="status"></div>
        </div>
  
        <a href="/admin?t=${adminKey}" class="btn-back">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          Back to Dashboard
        </a>
      </div>
  
      <script>
        async function importar() {
          const status = document.getElementById('status');
          const inputQ = document.getElementById('inputQ');
          const manualIdInput = document.getElementById('manual_id');
          
          const payload = {
            raw: inputQ.value,
            manual_id: manualIdInput.value.trim(),
            module: document.getElementById('module_select').value,
            type: document.getElementById('type_select').value
          };
  
          const token = new URLSearchParams(window.location.search).get('t') || "${adminKey}";
          
          status.style.display = 'block';
          status.style.background = '#1f2937';
          status.style.color = '#fff';
          status.innerText = '‚è≥ Processing and saving to D1...';
  
          try {
            const res = await fetch('/admin/questions/import-one?t=' + token, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            
            const data = await res.json();
            
            if (res.ok) {
              status.style.background = 'rgba(16, 185, 129, 0.2)';
              status.style.color = '#10b981';
              status.style.border = '1px solid #10b981';
              status.innerText = '‚úÖ Success! Exercise ID: ' + data.parsed.exercise_id;
              
              inputQ.value = '';
              manualIdInput.value = '';
            } else {
              status.style.background = 'rgba(239, 68, 68, 0.2)';
              status.style.color = '#ef4444';
              status.style.border = '1px solid #ef4444';
              status.innerText = '‚ùå ERROR: ' + (data.error || 'Unknown failure');
            }
          } catch (e) {
            status.style.background = 'rgba(239, 68, 68, 0.2)';
            status.style.color = '#ef4444';
            status.innerText = '‚ùå Connection error: ' + e.message;
          }
        }
      </script>
    </body>
    </html>`;
    return new Response(html, { headers: { "Content-Type": "text/html;charset=utf-8" } });
  }

// ============================================================
// P√ÅGINA DE ESTUDOS DIN√ÇMICA (PRACTICE) - CORRIGIDA
// ============================================================

if (url.pathname === "/admin/view-database") {
  const token = url.searchParams.get("t");
  
  if (token !== "1831") {
    return new Response("Acesso Negado", { status: 403 });
  }

  try {
    const { results } = await env.DB.prepare(`
      SELECT exercise_id, module, type, question_text, options_json, correct_answer, feedback_text 
      FROM questions_bank 
      ORDER BY module ASC, type ASC
    `).all();

    // Ordena√ß√£o l√≥gica por Tipo e depois N√∫mero
    const sortedResults = results.sort((a, b) => {
      if (a.type !== b.type) return a.type.localeCompare(b.type);
      const numA = parseInt(a.exercise_id.replace(/\D/g, '')) || 0;
      const numB = parseInt(b.exercise_id.replace(/\D/g, '')) || 0;
      return numA - numB;
    });

    const html = `
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>HCM Admin: Questions Bank</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    :root { 
      --bg: #030712; --card: #0b1220; --border: #1f2937; --text: #f3f4f6; 
      --muted: #94a3b8; --accent: #3b82f6; --success: #10b981; --error: #ef4444; 
    }
    
    body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; line-height: 1.5; }
    .container { max-width: 1100px; margin: 0 auto; }
    h1 { font-size: 1.5rem; margin-bottom: 20px; color: #fff; }

    /* Filtros Sticky Estilizados */
    .filter-bar { 
      background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid var(--border);
      margin-bottom: 25px; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;
      position: sticky; top: 10px; z-index: 100; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5);
    }
    .filter-group { display: flex; flex-direction: column; flex: 1; min-width: 150px; }
    label { font-size: 10px; font-weight: 800; color: var(--muted); text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.05em; }
    select, input { 
      padding: 12px; border-radius: 8px; border: 1px solid var(--border); 
      background: #111827; color: white; font-size: 14px; outline: none;
    }
    select:focus, input:focus { border-color: var(--accent); }
    
    /* Cards das Quest√µes */
    .card { 
      background: var(--card); border-radius: 16px; border: 1px solid var(--border); 
      margin-bottom: 20px; padding: 20px; transition: transform 0.2s;
    }
    .card:hover { border-color: #374151; }
    
    .header-info { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
    .tags { display: flex; gap: 6px; }
    .tag { padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 800; text-transform: uppercase; }
    .tag-module { background: rgba(59, 130, 246, 0.1); color: var(--accent); border: 1px solid rgba(59, 130, 246, 0.2); }
    .tag-type { background: rgba(167, 139, 250, 0.1); color: #a78bfa; border: 1px solid rgba(167, 139, 250, 0.2); }
    .id-display { font-family: monospace; font-size: 12px; color: var(--muted); }

    .question-text { font-size: 1.1rem; color: #fff; margin-bottom: 15px; font-weight: 500; }
    
    .option-item { 
      padding: 12px; margin-bottom: 8px; border: 1px solid var(--border); 
      border-radius: 10px; background: rgba(255,255,255,0.02); font-size: 14px;
      display: flex; align-items: flex-start;
    }
    .correct-option { border-color: var(--success); background: rgba(16, 185, 129, 0.05); }
    .letter { color: var(--accent); font-weight: 800; margin-right: 12px; min-width: 20px; }

    .feedback-box { 
      background: rgba(245, 158, 11, 0.05); border: 1px solid rgba(245, 158, 11, 0.2); 
      padding: 14px; border-radius: 10px; margin-top: 15px; font-size: 13px; color: #f59e0b; 
    }

    .btn-poll { 
      background: var(--accent); color: white; border: none; padding: 8px 16px; 
      border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 12px; 
    }
    .btn-poll:disabled { background: var(--border); color: var(--muted); }
    
    .mini-status { font-size: 11px; font-weight: 800; }
    .mini-status.ok { color: var(--success); }
    .mini-status.err { color: var(--error); }

    /* Bot√£o Voltar */
    .btn-back {
      display: flex; align-items: center; justify-content: center;
      margin-top: 40px; color: var(--muted); text-decoration: none;
      font-size: 14px; font-weight: 500; transition: color 0.2s;
    }
    .btn-back:hover { color: #fff; }
    .btn-back i { margin-right: 8px; }

    @media (max-width: 600px) {
      .filter-bar { padding: 15px; gap: 10px; }
      .header-info { flex-direction: column; align-items: flex-start; }
      .right-actions { width: 100%; justify-content: space-between; display: flex; align-items: center; margin-top: 10px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üóÑÔ∏è Questions Bank</h1>

    <div class="filter-bar">
      <div class="filter-group">
        <label>Module</label>
        <select id="moduleFilter" onchange="applyFilters()">
          <option value="all">All Modules</option>
          ${[...Array(10)].map((_, i) => `<option value="module${i+1}">Module ${i+1}</option>`).join('')}
        </select>
      </div>
      
      <div class="filter-group">
        <label>Type</label>
        <select id="typeFilter" onchange="applyFilters()">
          <option value="all">All Types</option>
          <option value="mcq">MCQ</option>
          <option value="tf">T/F</option>
          <option value="num">Numeric</option>
          <option value="multia">Multi-Affirmation</option>
          <option value="long">Long answer</option>
        </select>
      </div>

      <div class="filter-group" style="flex-grow: 2;">
        <label>Search Content</label>
        <input type="text" id="searchInput" onkeyup="applyFilters()" placeholder="Keyword search...">
      </div>

      <div id="counter" style="font-size: 13px; font-weight: 800; color: var(--accent);">
          Showing: ${sortedResults.length}
      </div>
    </div>

    <div id="questionsContainer">
      ${sortedResults.map(q => {
        let options = {};
        try { options = JSON.parse(q.options_json || '{}'); } catch (e) { options = {}; }

        return `
          <div class="card" data-module="${q.module}" data-type="${q.type}">
            <div class="header-info">
              <div class="tags">
                <span class="tag tag-module">${q.module}</span>
                <span class="tag tag-type">${q.type}</span>
              </div>

              <div class="right-actions">
                <span class="mini-status" id="status-${q.exercise_id}"></span>
                <button class="btn-poll" onclick="sendToPoll('${q.exercise_id}', this)">SEND TO POLL</button>
                <span class="id-display">${q.exercise_id}</span>
              </div>
            </div>

            <div class="question-text">${q.question_text}</div>
            <div class="options-container">
              ${Object.entries(options).map(([letter, text]) => `
                <div class="option-item ${letter === q.correct_answer ? 'correct-option' : ''}">
                  <span class="letter">${letter})</span> ${text}
                </div>
              `).join('')}
            </div>
            <div style="margin-top:15px; font-size:12px; color: var(--muted);">
              <strong>Correct Answer:</strong> <span style="color: var(--success)">${q.correct_answer}</span>
            </div>
            ${q.feedback_text ? `<div class="feedback-box"><strong>Feedback:</strong> ${q.feedback_text}</div>` : ''}
          </div>
        `;
      }).join('')}
    </div>

    <a href="/admin/dashboard?t=1831" class="btn-back">
      <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
  </div>

  <script>
    const ADMIN_T = "1831";

    function applyFilters() {
      const mVal = document.getElementById('moduleFilter').value;
      const tVal = document.getElementById('typeFilter').value;
      const sVal = document.getElementById('searchInput').value.toLowerCase();
      
      const cards = document.querySelectorAll('.card');
      let visibleCount = 0;
    
      cards.forEach(card => {
        const mCard = card.getAttribute('data-module');
        const tCard = card.getAttribute('data-type');
        const qText = card.querySelector('.question-text').textContent.toLowerCase();
        
        const mMatch = (mVal === 'all' || mCard === mVal);
        const tMatch = (tVal === 'all' || tCard === tVal);
        const sMatch = (sVal === '' || qText.includes(sVal));
        
        if (mMatch && tMatch && sMatch) {
          card.style.display = 'block';
          visibleCount++;
        } else {
          card.style.display = 'none';
        }
      });
      
      document.getElementById('counter').innerHTML = 'Showing: <strong>' + visibleCount + '</strong>';
    }
    
    async function sendToPoll(exerciseId, btnEl) {
      const statusEl = document.getElementById("status-" + exerciseId);
      statusEl.textContent = "‚ö° SENDING...";
      statusEl.className = "mini-status";
      btnEl.disabled = true;

      try {
        const resp = await fetch("/admin/polls/queue-from-bank?t=" + ADMIN_T, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ exercise_id: exerciseId })
        });

        const data = await resp.json().catch(() => ({}));

        if (!resp.ok || data.error) throw new Error(data.error || "Failed");

        statusEl.textContent = "QUEUED ‚úì";
        statusEl.classList.add("ok");
      } catch (err) {
        statusEl.textContent = "ERROR";
        statusEl.classList.add("err");
        btnEl.disabled = false;
      }
    }

    window.onload = applyFilters;
  </script>
</body>
</html>
`;

    return new Response(html, { headers: { "Content-Type": "text/html;charset=UTF-8" } });
  } catch (err) {
    return new Response("Erro: " + err.message, { status: 500 });
  }
}




if (path === "/teaching/financial_strategy/practice") {
  const sid = await getStudentIdFromSession(req);
  if (!sid) {
    const html = practicesLoginPage({ next: url.pathname + url.search });
    return new Response(html, { status: 200, headers: { "Content-Type": "text/html; charset=utf-8", ...cors(origin) } });
  }

  const moduleParam = url.searchParams.get("module") || "module1";
  const typeParam = url.searchParams.get("type") || "tf"; 


  const studentInfo = await env.DB.prepare(
    "SELECT prof, term_id FROM t_students_dim WHERE student_id = ? LIMIT 1"
  ).bind(sid).first();

  // 2. Define a string da p√°gina com os par√¢metros reais
  const detailedPage = `practice?module=${moduleParam}&type=${typeParam}`;

  // 3. Grava o log no banco
  ctx.waitUntil(env.DB.prepare(
    "INSERT INTO t_logins (student_id, status, page, prof, term_id) VALUES (?, ?, ?, ?, ?)"
  ).bind(
    sid, 
    "success", 
    detailedPage, 
    studentInfo?.prof || "", 
    studentInfo?.term_id || ""
  ).run());

  const countsResults = await env.DB.prepare(`
  SELECT 
    type, 
    COUNT(*) as total,
    SUM(CASE WHEN exercise_id IN (
      SELECT exercise_id FROM questions_bank_progress 
      WHERE student_id = ?1 AND is_correct = 1
    ) THEN 1 ELSE 0 END) as completed
  FROM questions_bank 
  WHERE module = ?2
  GROUP BY type
`).bind(sid, moduleParam).all();

const typeStats = {};
(countsResults.results || []).forEach(r => {
  typeStats[r.type] = {
    total: r.total,
    pending: r.total - (r.completed || 0)
  };
});

  const displayModule = moduleParam.replace('module', 'Module #');

  // Contagem de progresso ignorando quest√µes 'long'
  const stats = await env.DB.prepare(`
    SELECT 
      (SELECT name FROM t_students_dim WHERE student_id = ?2 LIMIT 1) as student_name,
      (SELECT COUNT(*) FROM questions_bank WHERE module = ?1 AND type != 'long') as total_module,
      (SELECT COUNT(*) FROM questions_bank_progress WHERE student_id = ?2 AND module = ?1 AND is_correct = 1 AND exercise_id IN (SELECT exercise_id FROM questions_bank WHERE type != 'long')) as correct_module
  `).bind(moduleParam, sid).first();

  const rawName = stats?.student_name || sid;
  const firstName = rawName.split(' ')[0].toLowerCase().replace(/^\w/, (c) => c.toUpperCase());
  const totalModule = stats?.total_module || 0;
  const correctModule = stats?.correct_module || 0;
  const progressPct = totalModule > 0 ? Math.round((correctModule / totalModule) * 100) : 0;

  const hideParam = url.searchParams.get("hide_completed");
  const hideCompleted = hideParam === "true";

  let query = `SELECT q.* FROM questions_bank q WHERE q.module = ?1`;
  let binds = [moduleParam];

  if (hideCompleted) {
    query += ` AND q.exercise_id NOT IN (SELECT exercise_id FROM questions_bank_progress WHERE student_id = ?2 AND is_correct = 1)`;
    binds.push(sid);
  }

  if (typeParam !== "all") {
    query += ` AND q.type = ?${binds.length + 1}`;
    binds.push(typeParam);
  }

  query += " ORDER BY CAST(SUBSTR(q.exercise_id, INSTR(q.exercise_id, '_q') + 2) AS INTEGER) ASC";
  const { results } = await env.DB.prepare(query).bind(...binds).all();

  const pageSize = 5;
  const totalGroups = Math.ceil(results.length / pageSize);
  let groupsHtml = "";
  for (let i = 0; i < totalGroups; i++) {
    const groupNum = i + 1;
    const slice = results.slice(i * pageSize, (i + 1) * pageSize);
    const questionsInGroup = slice.map((q, idx) => {
      const qNum = (i * pageSize) + idx + 1;
      let inputHtml = "";
      let opts = {};
      try { opts = JSON.parse(q.options_json || "{}"); } catch(e) {}

      const isLong = q.type === "long";

      if (q.type === "mcq" || q.type === "multia" || q.type === "tf") {
        const currentOpts = q.type === "tf" ? { "A": "True", "B": "False" } : opts;
        inputHtml = Object.entries(currentOpts).map(([letter, text]) => `
          <label style="display:block; margin:8px 0; cursor:pointer;">
            <input type="radio" name="${q.exercise_id}" value="${letter}" onchange="enableSubmit('${q.exercise_id}')">
            <span style="font-weight:800; color:#1e3a8a; margin-right:5px;">${letter}.</span> ${text}
          </label>
        `).join("");
      } else if (q.type === "num") {
        inputHtml = `<input type="number" step="any" name="${q.exercise_id}" oninput="enableSubmit('${q.exercise_id}')" style="width:150px; padding:6px; border:1px solid #cbd5e1; border-radius:6px;">`;
      }
// Dentro do loop de gera√ß√£o das quest√µes:
if (q.type === "tf") {
  // Alterado: agora o value √© explicitamente 'T' e 'F' para bater com seu banco
  inputHtml = `
    <label style="display:block; margin:8px 0; cursor:pointer;">
      <input type="radio" name="${q.exercise_id}" value="T" onchange="enableSubmit('${q.exercise_id}')">
      <span style="font-weight:800; color:#1e3a8a; margin-right:5px;">A.</span> True
    </label>
    <label style="display:block; margin:8px 0; cursor:pointer;">
      <input type="radio" name="${q.exercise_id}" value="F" onchange="enableSubmit('${q.exercise_id}')">
      <span style="font-weight:800; color:#1e3a8a; margin-right:5px;">B.</span> False
    </label>`;
}

// E na fun√ß√£o submitOne(id) dentro do <script>:
async function submitOne(id) {
  const block = document.getElementById('block-' + id);
  const status = document.getElementById('status-' + id);
  const feedback = document.getElementById('feedback-' + id);
  const type = block.dataset.type;
  
  // Normaliza√ß√£o: Tira espa√ßos e garante que T/F ou A/B/C sejam comparados corretamente
  const correctAns = (block.dataset.correct || "").trim().toUpperCase();
  let userAns = "";

  if (type === "num") { 
    userAns = document.querySelector('input[name="'+id+'"]').value; 
  } else { 
    const sel = document.querySelector('input[name="'+id+'"]:checked'); 
    userAns = sel ? sel.value.toUpperCase() : ""; 
  }

  // Valida√ß√£o: Agora userAns ser√° 'T' ou 'F' para quest√µes TF
  let isCorrect = (type === "num") ? Math.abs(parseFloat(userAns) - parseFloat(correctAns)) <= 0.01 : (userAns === correctAns);

  feedback.style.display = 'block';
  if(isCorrect) {
    feedback.style.background = "#dcfce7"; feedback.style.color = "#166534";
    status.innerHTML = "‚úÖ Correct!"; status.style.color = "var(--success)";
  } else {
    feedback.style.background = "#fee2e2"; feedback.style.color = "#991b1b";
    status.innerHTML = "‚ùå Try again!"; status.style.color = "var(--error)";
  }

  // Envio para o D1
  try {
    await fetch('/api/practice/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        exercise_id: id, 
        module: '${moduleParam}', 
        is_correct: isCorrect ? 1 : 0, 
        user_answer: userAns 
      })
    });
  } catch (e) { console.error("D1 Sync Error:", e); }
}
      return `
        <div class="q-row">
          <div class="q-label">Q${qNum}.</div>
          <div class="q-body" id="block-${q.exercise_id}" data-type="${q.type}" data-correct="${q.correct_answer}">
            <span class="exercise-id-watermark">${q.exercise_id}</span>
            <div class="q-text">${q.question_text}</div>
            ${!isLong ? `<div class="q-inputs">${inputHtml}</div>` : ""}
            
            ${!isLong ? `
            <div style="margin-top:15px; display:flex; gap:12px; align-items:center;">
              <button id="btn-${q.exercise_id}" class="btn-submit-q" disabled onclick="submitOne('${q.exercise_id}')">Submit & Validate</button>
              <span id="status-${q.exercise_id}" style="font-size:12px; font-weight:bold;"></span>
            </div>
            <div id="feedback-${q.exercise_id}" class="feedback-box" style="display:none; margin-top:10px; padding:15px; border-radius:8px; background:#f8fafc; border:1px solid #e2e8f0; font-size:14px; color:#475569;">
              ${q.feedback_text}
            </div>` : ""}
          </div>
        </div>`;
    }).join("");
    groupsHtml += `<div id="group${groupNum}" class="question-group" style="display:${i === 0 ? 'block' : 'none'};">${questionsInGroup}</div>`;
  }

  const pillsHtml = Array.from({ length: totalGroups }, (_, i) => `<button class="grp-btn ${i === 0 ? 'active' : ''}" data-group="${i + 1}" onclick="showGroup(${i + 1})">${i + 1}</button>`).join("");
  
// Localize este bloco pr√≥ximo √† linha 1264 e substitua:
const urlShowAll = new URL(req.url); 
urlShowAll.searchParams.delete("hide_completed");

const urlOnlyPending = new URL(req.url); 
urlOnlyPending.searchParams.set("hide_completed", "true");

// Localize a defini√ß√£o de typeNavHtml (perto da linha 1253) e substitua por:
const typeNavHtml = [
  { id: 'tf', label: 'T/F', icon: 'bi-check-circle' },
  { id: 'mcq', label: 'MCQ', icon: 'bi-list-ul' },
  { id: 'multia', label: 'MultiA', icon: 'bi-card-checklist' },
  { id: 'num', label: 'Num.', icon: 'bi-hash' },
  { id: 'long', label: 'Long', icon: 'bi-pencil-square' }
].map(t => {
  const stats = typeStats[t.id] || { total: 0, pending: 0 };
  // Define se mostra o total ou apenas as pendentes
  const displayNum = hideCompleted ? stats.pending : stats.total;
  
  return `
    <a href="?module=${moduleParam}&type=${t.id}${hideCompleted ? '&hide_completed=true' : ''}" 
       class="type-nav-btn ${typeParam === t.id ? 'active' : ''}">
      <i class="bi ${t.icon}"></i> 
      <span>${t.label} (${displayNum})</span>
    </a>`;
}).join('');

  const finalHtml = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Practice - ${displayModule}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    :root { --accent: #1e3a8a; --text: #0f172a; --muted: #64748b; --success: #10b981; --error: #ef4444; }
    body { font-family: 'Inter', sans-serif; background:#ffffff; color: var(--text); margin:0; }
    header { padding: 1.2rem 8%; display: flex; justify-content: space-between; align-items: center; background: white; border-bottom: 1px solid #eee; }
    .nav-brand { font-size: 1.1rem; font-weight: 600; text-decoration: none; color: #1e293b; }
    .container { max-width:900px; margin:40px auto; padding:0 20px; }
    .welcome-block { background: #f8fafc; border: 1px solid #e2e8f0; padding: 25px; border-radius: 20px; margin-bottom: 30px; }
    .progress-container { background: #e2e8f0; border-radius: 50px; height: 12px; width: 100%; overflow: hidden; margin-top:15px; }
    .progress-bar { background: linear-gradient(90deg, #10b981, #34d399); height: 100%; transition: width 0.8s ease; }
    .practice-info-bar { display: flex; align-items: center; justify-content: space-between; gap: 15px; padding: 10px 15px; background: white; border-radius: 12px; border: 1px solid #e5e7eb; margin-bottom: 25px; flex-wrap: wrap; }
    .type-navigation { display: flex; gap: 5px; background: #f1f5f9; padding: 4px; border-radius: 10px; }
    .type-nav-btn { display: flex; align-items: center; gap: 6px; padding: 6px 12px; text-decoration: none; font-size: 12px; font-weight: 700; color: var(--muted); border-radius: 7px; }
    .type-nav-btn.active { background: white; color: var(--accent); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .filter-group { display: flex; gap: 5px; background: #f1f5f9; padding: 4px; border-radius: 10px; }
    .filter-btn { padding: 6px 12px; font-size: 11px; font-weight: 800; text-decoration: none; color: var(--muted); border-radius: 7px; border: 1px solid transparent; }
    .filter-btn.active { background: white; color: var(--success); box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
    .q-row { display:flex; gap:10px; padding:25px 15px; border-top:1px solid #f1f5f9; position: relative; }
    .q-label { font-weight:800; min-width:44px; color:#1e293b; font-size: 1.1rem; }
    .q-text { font-weight:500; margin-bottom:15px; line-height:1.6; font-size: 1.05rem; }
    .exercise-id-watermark { position: absolute; top: 5px; left: 10px; font-size: 9px; color: #cbd5e1; font-family: monospace; }
    .btn-submit-q { background: #f1f5f9; color: #94a3b8; border: 1px solid #e2e8f0; padding: 8px 16px; border-radius: 8px; font-weight: 700; cursor: pointer; }
    .btn-submit-q:not(:disabled) { background: var(--accent); color: white; border-color: var(--accent); }
    .sticky-bar { position:sticky; bottom:20px; background:white; padding:15px 25px; border-radius:50px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 10px 30px rgba(0,0,0,0.1); border:1px solid #e2e8f0; z-index: 1000; }
    .btn-fb { background:#007BFF; color:white; border:none; padding:10px 20px; border-radius:8px; font-weight:bold; cursor:pointer; }
    .grp-btn { padding:8px 14px; border:1px solid #e2e8f0; background:#fff; border-radius:999px; cursor:pointer; font-weight:600; margin-right:5px; }
    .grp-btn.active { background:#3b82f6; color:#fff; }
    .divider { width: 1px; height: 20px; background: #e5e7eb; }
    /* Adicione isso dentro da sua tag <style> no finalHtml */
.type-nav-btn span {
  white-space: nowrap;
}
.type-nav-btn small {
  font-size: 0.8em;
  opacity: 0.7;
  margin-left: 2px;
}
  </style>
</head>
<body>
<header>
  <a href="/" class="nav-brand">Henrique Castro Martins</a>
  <nav style="display:flex; gap:20px; align-items:center;"><a href="/teaching" style="text-decoration:none; color:#64748b;">Teaching</a><a href="/research" style="text-decoration:none; color:#64748b;">Research</a></nav>
</header>

<div class="container">
    <div class="welcome-block">
      <div style="display:flex; justify-content:space-between; align-items:flex-end;">
        <div>
          <div style="font-size: 1.4rem; font-weight: 800; color: var(--accent);">Hello, ${firstName}! üëã</div>
          <div style="font-size: 14px; color: var(--muted); margin-top: 4px;">You've mastered <b>${correctModule}</b> out of <b>${totalModule}</b> questions in this module.</div>
        </div>
        <div style="text-align: right;">
          <span style="font-size: 22px; font-weight: 800; color: var(--success);">${progressPct}%</span>
          <div style="font-size: 10px; font-weight: 700; color: var(--muted); text-transform: uppercase;">Completed</div>
        </div>
      </div>
      <div class="progress-container"><div class="progress-bar" style="width: ${progressPct}%;"></div></div>
    </div>

    <div class="practice-info-bar">
    <div style="display:flex; align-items:center; gap:15px; flex-shrink: 0;">
      <span style="font-weight:800; color:var(--accent); font-size:15px;">${displayModule}</span>
    </div>
    <div class="divider"></div>
    <div class="type-navigation" style="flex-grow: 1; justify-content: center;">
      ${typeNavHtml}
    </div>
    <div class="divider"></div>
    <div class="filter-group" style="flex-shrink: 0;">
      <a href="${urlShowAll.search}" class="filter-btn ${!hideCompleted ? 'active' : ''}">SHOW ALL</a>
      <a href="${urlOnlyPending.search}" class="filter-btn ${hideCompleted ? 'active' : ''}">ONLY PENDING</a>
    </div>
  </div>

    <div style="margin-bottom:20px;">
      <span style="font-size:12px; font-weight:bold; color:var(--muted); margin-right:10px;">GROUPS:</span>
      ${pillsHtml}
    </div>
    
    <div id="quiz-container" style="background:white; border:1px solid #e2e8f0; border-radius:16px; margin-bottom:20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
      ${groupsHtml}
    </div>

    <div class="sticky-bar">
    <div style="display:flex; gap:8px; align-items:center;">
      <a href="/teaching/financial_strategy" class="grp-btn" style="text-decoration:none; display:inline-flex; align-items:center; background:#f1f5f9;">
        <i class="bi bi-arrow-left" style="margin-right:5px;"></i> Back
      </a>
      <div class="divider" style="margin: 0 5px;"></div>
      <button class="grp-btn" onclick="prevGroup()">Prev</button>
      <button class="grp-btn" onclick="nextGroup()">Next</button>
    </div>
    <div style="display:flex; gap:15px; align-items:center;">
      <div id="score-summary" style="font-weight:700; color:var(--accent); font-size:14px;"></div>
      </div>
</div>

    </div>
</div>

<script>
    let currentGroup = 1;
    const totalGroups = ${totalGroups};

    function enableSubmit(id) { document.getElementById('btn-' + id).disabled = false; }

    async function submitOne(id) {
      const block = document.getElementById('block-' + id);
      const status = document.getElementById('status-' + id);
      const feedback = document.getElementById('feedback-' + id);
      const type = block.dataset.type;
      
      // Normaliza√ß√£o: Tira espa√ßos e garante que T/F ou A/B/C sejam comparados corretamente
      const correctAns = (block.dataset.correct || "").trim().toUpperCase();
      let userAns = "";
    
      if (type === "num") { 
        userAns = document.querySelector('input[name="'+id+'"]').value; 
      } else { 
        const sel = document.querySelector('input[name="'+id+'"]:checked'); 
        userAns = sel ? sel.value.toUpperCase() : ""; 
      }
    
      // Valida√ß√£o: Agora userAns ser√° 'T' ou 'F' para quest√µes TF
      let isCorrect = (type === "num") ? Math.abs(parseFloat(userAns) - parseFloat(correctAns)) <= 0.01 : (userAns === correctAns);
    
      feedback.style.display = 'block';
      if(isCorrect) {
        feedback.style.background = "#dcfce7"; feedback.style.color = "#166534";
        status.innerHTML = "‚úÖ Correct!"; status.style.color = "var(--success)";
      } else {
        feedback.style.background = "#fee2e2"; feedback.style.color = "#991b1b";
        status.innerHTML = "‚ùå Try again!"; status.style.color = "var(--error)";
      }
    
      // Envio para o D1
      try {
        await fetch('/api/practice/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            exercise_id: id, 
            module: '${moduleParam}', 
            is_correct: isCorrect ? 1 : 0, 
            user_answer: userAns 
          })
        });
      } catch (e) { console.error("D1 Sync Error:", e); }
    }

    function showGroup(idx) {
      if(idx < 1 || idx > totalGroups) return;
      document.querySelectorAll('.question-group').forEach((g, i) => g.style.display = (i+1 === idx) ? 'block' : 'none');
      document.querySelectorAll('.grp-btn[data-group]').forEach(b => b.classList.toggle('active', Number(b.dataset.group) === idx));
      currentGroup = idx;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    function nextGroup() { showGroup(currentGroup + 1); }
    function prevGroup() { showGroup(currentGroup - 1); }
    
    function toggleFeedback() {
      const btn = document.getElementById('toggle-feedback-btn');
      const isShowing = btn.innerText.includes("Hide");
      const currentBlocks = document.querySelector('.question-group[style*="block"]')?.querySelectorAll('.q-body') || [];
      
      currentBlocks.forEach(block => {
        const id = block.id.replace('block-', '');
        const fb = document.getElementById('feedback-' + id);
        if(fb) fb.style.display = isShowing ? 'none' : 'block';
      });
      btn.innerText = isShowing ? "Show All Feedback" : "Hide All Feedback";
    }
    // Adicione ou verifique se existe no seu <script> final:
window.onload = function() {
  // Se quiser que ele volte ao grupo 1 sempre que mudar o filtro:
  showGroup(1); 
  
  // Ou, se quiser ser sofisticado e ler da URL:
  const params = new URLSearchParams(window.location.search);
  const g = parseInt(params.get('group')) || 1;
  showGroup(g);
};

// E atualize sua fun√ß√£o showGroup para n√£o dar erro se o grupo n√£o existir:
function showGroup(idx) {
  if(idx < 1 || idx > totalGroups) idx = 1; // Fallback para o primeiro grupo
  document.querySelectorAll('.question-group').forEach((g, i) => {
    g.style.display = (i + 1 === idx) ? 'block' : 'none';
  });
  document.querySelectorAll('.grp-btn[data-group]').forEach(b => {
    b.classList.toggle('active', Number(b.dataset.group) === idx);
  });
  currentGroup = idx;
}
</script>
</body>
</html>`;

  return new Response(finalHtml, { headers: { "Content-Type": "text/html;charset=utf-8" } });
}


// ============================================================
// ADMIN: Question Bank Analytics
// ============================================================
if (is("/admin/analytics") && method === "GET") {
  const fMod = url.searchParams.get("mod") || "";
  const fType = url.searchParams.get("type") || "";

  let where = "";
  if (fMod) where += ` AND q.module = '${fMod}'`;
  if (fType) where += ` AND q.type = '${fType}'`;

  const stats = await env.DB.prepare(`
    SELECT 
      q.exercise_id, q.module, q.type, q.question_text,
      COUNT(DISTINCT p.student_id) as total_students,
      AVG(p.attempts) as avg_attempts
    FROM questions_bank q
    LEFT JOIN questions_bank_progress p ON q.exercise_id = p.exercise_id
    WHERE 1=1 ${where}
    GROUP BY q.exercise_id
    ORDER BY avg_attempts DESC
  `).all();

  const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"><title>HCM Admin: Analytics Questions radar</title>
  <style>
    :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --text: #f1f5f9; --bad: #ef4444; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 30px; margin: 0; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #334155; padding-bottom: 15px; }
    .filters { margin-bottom: 20px; display: flex; gap: 10px; }
    select { background: #1e293b; color: white; border: 1px solid #334155; padding: 8px; border-radius: 6px; }
    table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 12px; overflow: hidden; }
    th, td { padding: 15px; text-align: left; border-bottom: 1px solid #334155; }
    th { background: #334155; text-transform: uppercase; font-size: 11px; letter-spacing: 1px; color: #94a3b8; }
    .preview { font-size: 12px; color: #94a3b8; max-width: 350px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
    .effort-val { font-size: 18px; font-weight: 800; }
    .critical { color: var(--bad); }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìä Question Effort Radar</h1>
    <a href="/admin/analytics/students?t=${url.searchParams.get('t')}" style="color:var(--accent); text-decoration:none; font-weight:bold;">‚Üí View Student Progress</a>
  </div>

  <div class="filters">
    <select onchange="const u=new URL(window.location); u.searchParams.set('mod', this.value); window.location=u;">
      <option value="">All Modules</option>
      ${[1,2,3,4,5,6,7,8,9,10].map(m => `<option value="module${m}" ${fMod==='module'+m?'selected':''}>Module ${m}</option>`).join('')}
    </select>
    <select onchange="const u=new URL(window.location); u.searchParams.set('type', this.value); window.location=u;">
      <option value="">All Types</option>
      ${['tf','mcq','num','multia','long'].map(t => `<option value="${t}" ${fType===t?'selected':''}>${t.toUpperCase()}</option>`).join('')}
    </select>
  </div>

  <table>
    <thead>
      <tr>
        <th>ID / M√≥dulo</th>
        <th>Question Preview</th>
        <th>Students</th>
        <th>Avg. Efforts (Attempts)</th>
      </tr>
    </thead>
    <tbody>
      ${stats.results.map(r => {
        const attempts = Number(r.avg_attempts || 0).toFixed(1);
        const isCritical = attempts > 3.0;
        return `
          <tr>
            <td><strong>${r.exercise_id}</strong><br><small style="color:#64748b">${r.type}</small></td>
            <td><span class="preview" title="${r.question_text.replace(/"/g, '&quot;')}">${r.question_text}</span></td>
            <td>${r.total_students || 0}</td>
            <td class="effort-val ${isCritical ? 'critical' : ''}">${attempts} ${isCritical ? '‚ö†Ô∏è' : ''}</td>
          </tr>
        `;
      }).join('')}
    </tbody>
  </table>
</body>
</html>`;
  return new Response(html, { headers: { "Content-Type": "text/html;charset=utf-8" } });
}

if (is("/admin/analytics/students") && method === "GET") {
  const adminKey = url.searchParams.get("t") || "";
  const fProfRaw = url.searchParams.get("prof") || "";
  const fProf = String(fProfRaw || "").trim();

  // 1) Lista de professores √∫nicos (ordenado)
  const profs = await env.DB
    .prepare(`
      SELECT DISTINCT prof
      FROM t_students_dim
      WHERE prof IS NOT NULL AND TRIM(prof) <> ''
      ORDER BY prof
    `)
    .all();

  // 2) Query principal com filtro seguro (bind)
  const sql = `
  SELECT 
    s.name, 
    s.student_id, 
    s.prof, 
    -- Usamos COALESCE para garantir que o m√≥dulo apare√ßa mesmo sem progresso
    COALESCE(q.module, 'module1') AS module,
    -- Contamos apenas exerc√≠cios que existem no banco e n√£o s√£o 'long'
    COUNT(DISTINCT CASE WHEN q.exercise_id IS NOT NULL AND q.type != 'long' THEN p.exercise_id END) AS done,
    -- Denominador sincronizado (apenas o que existe e n√£o √© 'long')
    (SELECT COUNT(*) FROM questions_bank WHERE module = COALESCE(q.module, 'module1') AND type != 'long') AS total
  FROM t_students_dim s
  -- Primeiro LEFT JOIN garante que trazemos todos os alunos
  LEFT JOIN questions_bank_progress p ON s.student_id = p.student_id AND p.is_correct = 1
  -- Segundo LEFT JOIN garante que validamos se a quest√£o ainda existe no banco
  LEFT JOIN questions_bank q ON p.exercise_id = q.exercise_id
  WHERE 1=1
    AND (?1 = '' OR s.prof = ?1)
  GROUP BY s.student_id, q.module
  ORDER BY s.name ASC
`;





  
  const studentData = await env.DB.prepare(sql).bind(fProf).all();

  const studentMap = {};
  studentData.results.forEach((row) => {
    if (!studentMap[row.student_id]) {
      studentMap[row.student_id] = { name: row.name, prof: row.prof, mods: {} };
    }
    if (row.module) {
      const total = Number(row.total || 0);
      const done = Number(row.done || 0);
      const pct = total > 0 ? Math.round((done / total) * 100) : 0;
      studentMap[row.student_id].mods[row.module] = pct;
    }
  });

  const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"><title>HCM Admin: Student Monitoring</title>
  <style>
    :root { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --accent: #38bdf8; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 30px; margin:0; }
    .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid #334155; padding-bottom: 15px; gap: 20px; }
    .nav-links { display: flex; gap: 15px; align-items: center; }
    select { background: #1e293b; color: white; border: 1px solid #334155; padding: 8px 12px; border-radius: 8px; font-weight: 600; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 12px; overflow: hidden; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #334155; font-size: 13px; }
    th { background: #334155; text-transform: uppercase; font-size: 11px; color: #94a3b8; letter-spacing: 1px; }
    .mod-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; min-width: 350px; }
    .mod-box { padding: 4px 0; text-align: center; border-radius: 4px; font-size: 9px; background: #334155; color: #94a3b8; font-weight: bold; }
    .done-high { background: #059669; color: white; }
    .done-mid { background: #d97706; color: white; }
    .done-low { background: #dc2626; color: white; }
    .prof-tag { font-size: 10px; background: rgba(56, 189, 248, 0.1); color: var(--accent); padding: 2px 6px; border-radius: 4px; border: 1px solid rgba(56, 189, 248, 0.2); }
  </style>
</head>
<body>
  <div class="header-bar">
    <div style="display:flex; align-items:center; gap:20px;">
      <h1 style="font-size:1.2rem; margin:0;">üë• Student Monitoring</h1>

      <select id="profFilter">
        <option value="">Filter by Professor (All)</option>
        ${profs.results
          .map((p) => {
            const v = String(p.prof || "").trim();
            const sel = (fProf === v) ? "selected" : "";
            return `<option value="${escapeHtml(v)}" ${sel}>${escapeHtml(v)}</option>`;
          })
          .join("")}
      </select>
    </div>

    <div class="nav-links">
      <a href="/admin/analytics?t=${encodeURIComponent(adminKey)}" style="color:var(--accent); text-decoration:none; font-size:13px; font-weight:bold;">‚Üê Questions Analytics</a>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Student Name</th>
        <th>Professor</th>
        <th>Progress by Module (1-10)</th>
      </tr>
    </thead>
    <tbody>
      ${Object.entries(studentMap).map(([sid, data]) => `
        <tr>
          <td><strong>${escapeHtml(data.name || "")}</strong><br><small style="color:#64748b">${escapeHtml(sid)}</small></td>
          <td><span class="prof-tag">${escapeHtml(data.prof || "N/A")}</span></td>
          <td>
            <div class="mod-grid">
              ${Array.from({ length: 10 }, (_, i) => {
                const m = `module${i + 1}`;
                const pct = data.mods[m] || 0;
                const cls = pct > 80 ? "done-high" : (pct > 30 ? "done-mid" : (pct > 0 ? "done-low" : ""));
                return `<div class="mod-box ${cls}" title="Module ${i + 1}">${pct}%</div>`;
              }).join("")}
            </div>
          </td>
        </tr>
      `).join("")}
    </tbody>
  </table>

  <script>
    // Minimal, keeps token and cleans up prof param
    (function(){
      const sel = document.getElementById("profFilter");
      sel.addEventListener("change", function(){
        const u = new URL(window.location.href);
        const v = (sel.value || "").trim();
        if (v) u.searchParams.set("prof", v);
        else u.searchParams.delete("prof");
        // keep admin token
        if (!u.searchParams.get("t")) u.searchParams.set("t", ${JSON.stringify(adminKey)});
        window.location = u.toString();
      });
    })();

    // Tiny HTML escaper for safe rendering in options/table
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, function(m){
        return ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;" })[m];
      });
    }
  </script>
</body>
</html>`;

  return new Response(html, { headers: { "Content-Type": "text/html;charset=utf-8" } });
}


// --- ROTA: FORMUL√ÅRIO DE CADASTRO (GET) ---
if (path === "/admin/students" && method === "GET") {
  const token = new URLSearchParams(url.search).get('t') || "";
  const html = `<!DOCTYPE html>
  <html>
  <head>
    <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin: New Student</title>
    <style>
      :root { --bg: #0b1220; --card: #1e293b; --accent: #38bdf8; --text: #f1f5f9; --border: rgba(255,255,255,0.1); }
      body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
      .card { max-width: 450px; margin: 20px auto; background: var(--card); padding: 25px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
      h2 { margin: 0 0 20px 0; color: var(--accent); font-size: 1.5rem; text-align: center; }
      label { display: block; font-size: 10px; font-weight: 800; margin-top: 15px; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }
      input { width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 12px; background: #0b1220; color: white; box-sizing: border-box; margin-top: 5px; font-size: 16px; transition: 0.2s; }
      input:focus { border-color: var(--accent); outline: none; }
      .btn-save { width: 100%; padding: 18px; background: var(--accent); color: #0b1220; border: none; border-radius: 12px; font-weight: 800; margin-top: 25px; cursor: pointer; font-size: 16px; }
      .btn-save:active { transform: scale(0.98); }
      .back-link { display: block; text-align: center; margin-top: 20px; color: #64748b; text-decoration: none; font-size: 14px; font-weight: 600; }
    </style>
  </head>
  <body>
    <div class="card">
      <h2><i class="bi bi-person-fill-add"></i> New Student</h2>
      
      <label>Student ID (Username)</label>
      <input id="sid" type="text" placeholder="ex: joao_silva" autocomplete="off">
      
      <label>Full Name</label>
      <input id="name" type="text" placeholder="EX: JO√ÉO DA SILVA" autocomplete="off">
      
      <label>Password</label>
      <input id="pass" type="text" placeholder="ex: fgv2026">
      
      <label>Professor</label>
      <input id="prof" type="text" value="Henrique">
      
      <label>Active</label>
      <select id="active" style="width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 12px; background: #0b1220; color: white; margin-top: 5px; font-size: 16px;">
        <option value="1" selected>1</option>
        <option value="1">0</option>
      </select>

      <label>Term / Semester</label>
      <select id="term_id" style="width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 12px; background: #0b1220; color: white; margin-top: 5px; font-size: 16px;">
        <option value="2026S1" selected>2026S1</option>
      </select>

      <button class="btn-save" onclick="save()">CREATE ACCOUNT</button>
      <a href="/admin?t=${token}" class="back-link">‚Üê Back to Dashboard</a>
    </div>

    <script>
      async function save() {
        const btn = document.querySelector('.btn-save');
        const token = new URLSearchParams(window.location.search).get('t');
        
        // Dentro da fun√ß√£o save() no seu script do formul√°rio:
        const payload = {
          student_id: document.getElementById('sid').value.trim().toLowerCase(),
          name: document.getElementById('name').value.trim(),
          password: document.getElementById('pass').value.trim(),
          prof: document.getElementById('prof').value.trim(),
          active: document.getElementById('active').value.trim(),
          term_id: document.getElementById('term_id').value 
        };;

        if(!payload.student_id || !payload.name) {
          return alert('Please fill in ID and Name.');
        }

        btn.disabled = true;
        btn.innerText = "SAVING...";

        try {
          const res = await fetch('/admin/students/save?t=' + token, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
          });

          if(res.ok) {
            alert('‚úÖ Student registered successfully!');
            document.getElementById('sid').value = "";
            document.getElementById('name').value = "";
          } else {
            const err = await res.json();
            alert('‚ùå Error: ' + (err.error || 'Failed to save'));
          }
        } catch (e) {
          alert('‚ùå Network error');
        } finally {
          btn.disabled = false;
          btn.innerText = "CREATE ACCOUNT";
        }
      }
    </script>
  </body>
  </html>`;
  return new Response(html, { headers: { "Content-Type": "text/html; charset=utf-8" } });
}
// --- ROTA: SALVAMENTO NO D1 (POST) ---
if (path === "/admin/students/save" && method === "POST") {
  try {
    // Corrigido de 'request' para 'req' para coincidir com o par√¢metro da sua fun√ß√£o fetch
    const data = await req.json(); 
    
    if (!data.student_id || !data.name) {
      return new Response(JSON.stringify({ error: "Missing fields" }), { 
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }

    // Executa o Insert conforme o esquema da sua tabela t_students_dim
    await env.DB.prepare(`
      INSERT INTO t_students_dim (student_id, password, name, prof, active, term_id)
      VALUES (?, ?, ?, ?, ?, ?)
    `).bind(
      data.student_id.toLowerCase(), 
      data.password, 
      data.name, 
      data.prof,
      data.active,
      data.term_id
    ).run();
    
    return new Response(JSON.stringify({ success: true }), { 
      headers: { "Content-Type": "application/json" } 
    });
  } catch (e) {
    console.error("D1 Error:", e.message);
    return new Response(JSON.stringify({ error: "Database error: " + e.message }), { 
      status: 500, 
      headers: { "Content-Type": "application/json" } 
    });
  }
}

// ============================================================
// Research
// ============================================================
if (path === "/research" || path === "/research/") {
  const papersHtml = researchPapers.map(p => `
    <div class="res-item">
      <div class="res-year">${new Date(p.date).getFullYear()}</div>
      <div class="res-body">
        <div class="res-meta">${p.categories[1] || p.categories[0]} ‚Äî ${p.journal}</div>
        <h3 class="res-title">${p.title}</h3>
        <p class="res-desc">${p.description}</p>
        <div class="res-actions">
          <a href="${p.doi}" target="_blank" class="btn-minimal">
            <i class="bi bi-file-earmark-text"></i> DOI / Full Text
          </a>
        </div>
      </div>
    </div>
  `).join('');

  const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Research - ${profile.name}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    
    :root { 
      --accent: #1e3a8a; 
      --text: #1e293b; 
      --muted: #64748b; 
      --line: #e2e8f0;
    }

    body { font-family: 'Inter', sans-serif; margin: 0; background: #ffffff; color: var(--text); line-height: 1.6; }
    
    header { padding: 1.2rem 8%; display: flex; justify-content: space-between; align-items: center; background: white; border-bottom: 1px solid var(--line); position: sticky; top: 0; z-index: 100; }
    .nav-brand { font-size: 1.1rem; font-weight: 700; text-decoration: none; color: var(--text); }
    nav a { text-decoration: none; color: var(--muted); margin-left: 20px; font-size: 0.9rem; font-weight: 600; }

    .container { max-width: 900px; margin: 80px auto; padding: 0 40px; }
    
    h1 { font-size: 2.5rem; font-weight: 800; margin-bottom: 50px; color: #0f172a; border-bottom: 4px solid var(--accent); display: inline-block; padding-bottom: 10px; }

    /* Layout de Lista Minimalista */
    .res-list { display: flex; flex-direction: column; gap: 40px; }
    
    .res-item { display: grid; grid-template-columns: 80px 1fr; gap: 30px; position: relative; }
    
    /* Ano na lateral */
    .res-year { 
      font-size: 1.1rem; font-weight: 800; color: var(--accent); 
      padding-top: 5px; opacity: 0.8;
    }
    
    .res-body { padding-bottom: 40px; border-bottom: 1px solid var(--line); }
    .res-item:last-child .res-body { border-bottom: none; }

    .res-meta { font-size: 0.75rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 10px; }
    .res-title { font-size: 1.4rem; margin: 0 0 15px; color: #0f172a; line-height: 1.3; font-weight: 700; }
    .res-desc { font-size: 1rem; color: #475569; margin-bottom: 20px; }
    
    .btn-minimal { 
      text-decoration: none; color: var(--accent); font-weight: 700; font-size: 0.9rem; 
      display: inline-flex; align-items: center; gap: 6px; 
      padding: 8px 16px; background: #eff6ff; border-radius: 6px; transition: 0.2s;
    }
    .btn-minimal:hover { background: var(--accent); color: white; }

    @media (max-width: 768px) {
      .res-item { grid-template-columns: 1fr; gap: 10px; }
      .res-year { border-bottom: 2px solid var(--accent); display: inline-block; width: fit-content; margin-bottom: 10px; }
    }
  </style>
</head>
<body>
  <header>
    <a href="/" class="nav-brand">${profile.name}</a>
    <nav>
      <a href="/teaching">Teaching</a>
      <a href="/research" style="color:var(--accent);">Research</a>
      <a href="https://www.linkedin.com/in/henriquecastror/" target="_blank" style="text-decoration:none; color:#64748b;" title="Linkedin">
      <i class="bi bi-linkedin"></i>
    </a>    </nav>
  </header>

  <div class="container">
    <h1>Research</h1>
    <div class="res-list">
      ${papersHtml}
    </div>
  </div>
</body>
</html>`;
  return new Response(html, { headers: { "Content-Type": "text/html;charset=UTF-8" } });
}

// ============================================================
// DEFAULT: Assets fetch (Pages)
// ============================================================
return withCors(await env.ASSETS.fetch(req), origin);
  }
};







// ============================================================
// HELPERS
// ============================================================

function tsBRString(ms = Date.now()) {
  const parts = new Intl.DateTimeFormat("en-CA", {
    timeZone: "America/Sao_Paulo",
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hour12: false
  }).formatToParts(ms);

  const get = (t) => parts.find((p) => p.type === t)?.value;
  return `${get("year")}-${get("month")}-${get("day")} ${get("hour")}:${get("minute")}:${get("second")}`;
}
// Accepts "YYYY-MM-DD HH:MM:SS" or "YYYY-MM-DDTHH:MM:SS" or "YYYY-MM-DD"
function normalizeBRLocal(s) {
  const raw = String(s || "").trim();
  if (!raw) return "";

  // If it's already in "YYYY-MM-DD HH:MM:SS" (or without seconds), normalize seconds
  const m1 = raw.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{2}):(\d{2})(?::(\d{2}))?)?$/);
  if (m1) {
    const Y = m1[1], M = m1[2], D = m1[3];
    const hh = m1[4] ?? "00";
    const mm = m1[5] ?? "00";
    const ss = m1[6] ?? "00";
    return `${Y}-${M}-${D} ${hh}:${mm}:${ss}`;
  }

  // Try parsing as Date (ISO, etc.)
  const d = new Date(raw);
  if (Number.isNaN(d.getTime())) return "";

  // Convert to Sao Paulo time string in the same format
  return tsBRString(d.getTime());
}

// Comparable sortable key: "YYYYMMDDHHMMSS"
function brKey(brDateTime) {
  const s = String(brDateTime || "");
  const m = s.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2}):(\d{2})$/);
  if (!m) return "";
  return `${m[1]}${m[2]}${m[3]}${m[4]}${m[5]}${m[6]}`;
}

function cors(origin) {
  return {
    "Access-Control-Allow-Origin": origin,
    "Vary": "Origin",
    "Access-Control-Allow-Methods": "GET,POST,DELETE,OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type,Authorization,x-admin-token,x-student-id",
    "Access-Control-Max-Age": "86400"
  };
}
function resolveOrigin(req, env) {
  const reqOriginRaw = (req.headers.get("Origin") || "").trim();
  
  // 1. Sempre permitir localhost para seus testes locais
  if (reqOriginRaw.includes("localhost") || reqOriginRaw.includes("127.0.0.1")) {
    return reqOriginRaw;
  }

  // 2. Definir dom√≠nios permitidos (Obrigat√≥rio incluir o novo .co)
  const allowRaw = [
    "https://henriquemartins.co", 
    "https://www.henriquemartins.co"
  ];

  // 3. Se n√£o houver Origin (navega√ß√£o direta), permitir
  if (!reqOriginRaw) return "*";

  // 4. Helper para limpar a URL
  const safeOrigin = (o) => {
    try { return new URL(o).origin; } catch { return ""; }
  };
  const reqOrigin = safeOrigin(reqOriginRaw);

  // 5. Se a origem estiver na nossa lista, retornar ela mesma (CORS OK)
  if (allowRaw.includes(reqOrigin)) return reqOrigin;

  // 6. Fallback: Se for qualquer outra origem, usamos o fail-open
  // para n√£o quebrar o ranking ou chat em dispositivos variados
  return "*";
}


function withCors(res, origin) {
  const h = new Headers(res.headers);

  // aplica seus headers cors
  const c = cors(origin);
  for (const [k, v] of Object.entries(c)) h.set(k, v);

  return new Response(res.body, {
    status: res.status,
    statusText: res.statusText,
    headers: h,
  });
}

async function readJsonBody(req) {
  try { return await req.clone().json(); } catch {}
  try {
    const fd = await req.clone().formData();
    const p = fd.get("payload") || fd.get("data");
    if (typeof p === "string" && p.trim()) {
      try { return JSON.parse(p); } catch {}
    }
  } catch {}
  try {
    const raw = await req.text();
    if (raw && raw.trim().startsWith("{")) return JSON.parse(raw);
  } catch {}
  return null;
}

async function safeReadJsonBody(req) {
  return await readJsonBody(req);
}



async function fetchChatInteractionsFromD1(db, sid, limit = 200) {
  const clean = (s) => String(s ?? "").trim();
  const s = clean(sid).toLowerCase();
  const lim = Math.max(1, Math.min(parseInt(limit, 10) || 200, 500));

  if (!db) {
    return { ok: false, total_interactions: 0, items: [], returned: 0, error: "missing CHAT_DB binding" };
  }
  if (!s) {
    return { ok: false, total_interactions: 0, items: [], returned: 0, error: "missing sid" };
  }

  try {
    const totalRow = await db
      .prepare("SELECT COUNT(*) AS c FROM student_interactions WHERE student_id = ?")
      .bind(s)
      .first();

    const rows = (
      await db
        .prepare(`
          SELECT id, student_message, bot_response, created_at
          FROM student_interactions
          WHERE student_id = ?
          ORDER BY datetime(created_at) DESC
          LIMIT ?
        `)
        .bind(s, lim)
        .all()
    ).results || [];

    return {
      ok: true,
      total_interactions: Number(totalRow?.c || 0),
      items: rows.map((r) => ({
        id: r.id,
        student_message: r.student_message,
        bot_response: r.bot_response,
        created_at: r.created_at
      })),
      returned: rows.length
    };
  } catch (e) {
    return { ok: false, total_interactions: 0, items: [], returned: 0, error: String(e?.message || e) };
  }
}


function json(obj, origin, status = 200) {
  return new Response(JSON.stringify(obj), {
    status,
    headers: { "Content-Type": "application/json", ...cors(origin) }
  });
}

function escapeHtml(s) {
  return String(s ?? "").replace(/[&<>"']/g, (m) => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#39;"
  }[m]));
}

// ensure indexes/rules (idempotent)
async function ensureSchema(env) {
  const stmts = [
    "CREATE UNIQUE INDEX IF NOT EXISTS ux_likes ON likes(page, student_id);",
    "CREATE UNIQUE INDEX IF NOT EXISTS ux_check_student_slide ON t_checkouts(student_id, slide_id);",
    "CREATE INDEX IF NOT EXISTS ix_checkouts_student_time ON t_checkouts(student_id, timestamp_br);",
    "CREATE INDEX IF NOT EXISTS ix_checkouts_slide_time ON t_checkouts(slide_id, timestamp_br);"
  ];

  for (const sql of stmts) {
    try { await env.DB.prepare(sql).run(); } catch {}
  }
}


// =============================
// HELPERS (FORA do fetch)
// =============================
function parseQuestionBlock(raw) {
  const text = String(raw || "");

  // -------- Helpers --------
  const stripTags = (s) =>
    String(s || "")
      .replace(/<script[\s\S]*?<\/script>/gi, "")
      .replace(/<\/?[^>]+>/g, "")
      .replace(/\s+/g, " ")
      .trim();

  const extractIdFromCheckAnswer = (s) => {
  const m = s.match(/checkAnswer\(['"]([^'"]+)['"]\)/i);
  return m ? m[1] : "";
};

  const extractFormId = (s) => {
    // Procura especificamente o id dentro da tag <form
    const m = s.match(/<form[^>]*\sid=["']([^"']+)["'][^>]*>/i);
    return m ? m[1] : "";
  };

  const extractAnyId = (s) => {
    // Procura IDs no texto, mas ignora propositalmente os que cont√™m "feedback"
    const matches = s.matchAll(/id=["']([^"']+)["']/gi);
    for (const match of matches) {
      if (!match[1].toLowerCase().includes("feedback")) {
        return match[1];
      }
    }
    return "";
  };

  const extractCorrect = (s) => {
    const m = s.match(/data-correct-answer=["']([^"']+)["']/i);
    return m ? m[1].trim() : "";
  };

  const extractFeedback = (s) => {
    const m = s.match(
      /<div[^>]*class=["'][^"']*(?:feedback|feedback-box)[^"']*["'][^>]*>([\s\S]*?)<\/div>/i
    );
    if (!m) return "";
    return stripTags(m[1]);
  };

  const extractQuestionGeneric = (s) => {
    const m = s.match(/<strong[^>]*>([\s\S]*?)<\/strong>/i) || s.match(/<form[^>]*>([\s\S]*?)(?:<label|<input)/i);
    if (!m) return "";
    return stripTags(m[1]);
  };

  const extractOptionsFromLabels = (s) => {
    const options = {};
    // Regex melhorado: busca o value="A" e captura o texto que vem depois, 
    // parando antes de encontrar a pr√≥xima tag <br> ou <label> ou </form>
    const re = /value=["']([A-E])["'][^>]*>(?:\s*[A-E](?:[.)\:]))?\s*([^<]+)/gi;
    
    for (const mm of s.matchAll(re)) {
      const letter = mm[1].toUpperCase();
      const optText = String(mm[2] || "").trim();
      if (optText) options[letter] = optText;
    }
    return options;
  };

  // -------- Parse core --------
  // Tenta primeiro o ID do formul√°rio, depois qualquer outro ID que n√£o seja feedback
let exercise_id = extractIdFromCheckAnswer(text) || extractFormId(text) || extractAnyId(text);
  
  if (!exercise_id) return { error: "could not parse exercise_id" };

  const correct_raw = extractCorrect(text);
  const feedback_text = extractFeedback(text);

  // Divide o ID para encontrar o m√≥dulo (ex: module1_mcq_q1 -> module1)
  const parts = exercise_id.split("_");
  const module = parts[0] || "general";
  const type = (parts[1] || "mcq").toLowerCase();

  let question_text = extractQuestionGeneric(text);

  let options = extractOptionsFromLabels(text);
  let correct_answer = correct_raw;

  // Normaliza√ß√£o para quest√µes de Verdadeiro ou Falso (TF)
if (type === "tf") {
  // Mantemos o JSON vazio para seguir o padr√£o do seu 2¬∫ print ou preenchemos se preferir
  options = {}; 
  
  const c = String(correct_raw || "").trim().toUpperCase();
  
  // Agora mapeia tudo para T ou F (exatamente como no seu banco de dados)
  if (c === "T" || c === "TRUE" || c === "A") {
    correct_answer = "T";
  } else if (c === "F" || c === "FALSE" || c === "B") {
    correct_answer = "F";
  }
}
  return {
    exercise_id,
    module,
    type,
    question_text,
    options_json: JSON.stringify(options || {}),
    correct_answer,
    feedback_text
  };
}

async function upsertQuestionBank(env, tpl) {
  return env.DB.prepare(`
    INSERT INTO questions_bank (exercise_id, module, type, question_text, options_json, correct_answer, feedback_text)
    VALUES (?, ?, ?, ?, ?, ?, ?)
    ON CONFLICT(exercise_id) DO UPDATE SET
      question_text = excluded.question_text,
      options_json = excluded.options_json,
      correct_answer = excluded.correct_answer,
      feedback_text = excluded.feedback_text
  `).bind(tpl.exercise_id, tpl.module, tpl.type, tpl.question_text, tpl.options_json, tpl.correct_answer, tpl.feedback_text).run();
}

function renderPollsPage(polls, sid) {
  const pollCards = polls.map(p => {
    let opts = {};
    try { opts = JSON.parse(p.options_json || "{}"); } catch(e) {}
    
    const isNumeric = p.poll_type === 'numeric';
    
    let optionsHtml = "";
    if (!isNumeric) {
      optionsHtml = Object.entries(opts).map(([letter, text]) => `
        <label class="poll-option">
          <input type="radio" name="poll_${p.poll_id}" value="${letter}">
          <span class="letter">${letter}</span>
          <span class="text">${text}</span>
        </label>
      `).join("");
    } else {
      optionsHtml = `<input type="number" step="any" class="poll-input" id="input_${p.poll_id}" placeholder="Type answer...">`;
    }

    return `
      <div class="poll-card" id="card_${p.poll_id}">
        <div class="poll-id">${p.poll_id}</div>
        <div class="poll-question">${p.question}</div>
        <div class="poll-options">${optionsHtml}</div>
        <button class="poll-submit" onclick="submitPollAnswer('${p.poll_id}', '${p.poll_type}')">Send answer</button>
        <div class="poll-feedback" id="feedback_${p.poll_id}"></div>
      </div>
    `;
  }).join("");

  return `<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Live Polls - Financial Strategy</title>
  <style>
    :root { --primary: #1e3a8a; --bg: #f8fafc; --text: #0f172a; }
    body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 20px; line-height: 1.5; }
    .container { max-width: 600px; margin: 0 auto; }
    h1 { font-size: 1.5rem; text-align: center; color: var(--primary); margin-bottom: 30px; }
    .poll-card { background: white; border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; position: relative; }
    .poll-id { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px; }
    .poll-question { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; }
    .poll-option { display: flex; align-items: center; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
    .poll-option:hover { background: #f1f5f9; }
    .poll-option input { margin-right: 12px; }
    .letter { font-weight: 800; color: var(--primary); margin-right: 8px; }
    .poll-submit { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; margin-top: 10px; }
    .poll-submit:disabled { background: #cbd5e1; cursor: not-allowed; }
    .poll-input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; margin-bottom: 15px; box-sizing: border-box; }
    .poll-feedback { margin-top: 15px; padding: 12px; border-radius: 8px; display: none; font-size: 14px; font-weight: 600; }
    .student-badge { text-align: center; font-size: 12px; color: #64748b; margin-top: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìä Active Polls</h1>
    ${pollCards}
    <div class="student-badge">Logged as: <strong>${sid || 'An√¥nimo'}</strong></div>
  </div>

  <script>
    async function submitPollAnswer(pollId, type) {
      const btn = document.querySelector('#card_' + pollId + ' .poll-submit');
      const feedback = document.getElementById('feedback_' + pollId);
      let choice = "";

      if (type === 'numeric') {
        choice = document.getElementById('input_' + pollId).value;
      } else {
        const selected = document.querySelector('input[name="poll_' + pollId + '"]:checked');
        if (!selected) { alert('Selecione uma op√ß√£o!'); return; }
        choice = selected.value;
      }

      btn.disabled = true;
      btn.innerText = "Sending...";

      try {
        const res = await fetch('/poll/vote', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            student_id: '${sid}', // Injetado pelo Worker
            poll_id: pollId,
            choice: choice
          })
        });
        const data = await res.json();
        
        feedback.style.display = 'block';
        if (res.ok) {
          feedback.style.background = '#dcfce7'; feedback.style.color = '#166534';
          feedback.innerText = "‚úÖ Success!";
          btn.innerText = "Sent";
        } else {
          feedback.style.background = '#fee2e2'; feedback.style.color = '#991b1b';
          feedback.innerText = "‚ùå " + (data.message || "Erro ao votar.");
          btn.disabled = false; btn.innerText = "Try again";
        }
      } catch (e) {
        alert("Erro de conex√£o.");
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>`;
}

function renderNoPollsPage() {
  return `<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>body{font-family:system-ui,sans-serif; display:flex; align-items:center; justify-content:center; height:100vh; margin:0; background:#f8fafc; color:#64748b;}</style></head><body><div style="text-align:center;"><h1>üò¥ No active questions at the moment </h1><p>Please wait for the instructor to launch a question.</p></div></body></html>`;
}


function renderRankingPage(top, me, sid) {
  const esc = (s) => String(s || "").replace(/[&<>"']/g, (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m]));
  
  const rowsHtml = top.map((row, i) => {
    const rank = i + 1;
    let rankClass = "";
    if (rank === 1) rankClass = "ü•á";
    else if (rank === 2) rankClass = "ü•à";
    else if (rank === 3) rankClass = "ü•â";
    else rankClass = rank;

    const isMe = sid && (row.student_id === sid);

    return `
      <tr class="${isMe ? 'row-me' : ''}">
        <td class="rank-col">${rankClass}</td>
        <td class="name-col">${esc(row.student_id)} ${isMe ? '<span class="me-tag">(You)</span>' : ''}</td>
        <td class="pts-col"><strong>${row.points}</strong> <small>pts</small></td>
      </tr>
    `;
  }).join("");

  // Detalhes da faixa pessoal
  let personalSection = "";
  if (me) {
    personalSection = `
      <div class="personal-banner">
        <div class="p-rank">Your Rank: #${me.pos}</div>
        <div class="p-details">
          <span>Likes: ${me.likes_points || 0}</span> ‚Ä¢ 
          <span>Checkouts: ${me.checkouts_points || 0}</span> ‚Ä¢ 
          <span>Polls: ${me.poll_points || 0}</span>
        </div>
        <div class="p-total">${me.points} TOTAL PTS</div>
      </div>
    `;
  }

  return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ranking - Financial Strategy</title>
  <style>
    :root { --primary: #1e3a8a; --accent: #6d5df5; --bg: #f8fafc; --text: #1e293b; }
    body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
    .container { max-width: 500px; margin: 0 auto; }
    h1 { text-align: center; color: var(--primary); font-weight: 800; margin-bottom: 30px; }
    .ranking-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
    .ranking-table tr { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .ranking-table td { padding: 15px; border: 1px solid #f1f5f9; }
    .ranking-table td:first-child { border-radius: 12px 0 0 12px; border-right: none; }
    .ranking-table td:last-child { border-radius: 0 12px 12px 0; border-left: none; }
    .rank-col { font-weight: 800; color: var(--primary); width: 40px; text-align: center; }
    .name-col { font-weight: 600; }
    .pts-col { text-align: right; white-space: nowrap; }
    .row-me { outline: 2px solid var(--accent); }
    .me-tag { font-size: 10px; background: var(--accent); color: white; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
    .personal-banner { background: linear-gradient(135deg, #1e3a8a, #6d5df5); color: white; padding: 20px; border-radius: 16px; margin-bottom: 25px; text-align: center; box-shadow: 0 10px 20px rgba(30,58,138,0.2); }
    .p-rank { font-size: 1.2rem; font-weight: 800; margin-bottom: 5px; }
    .p-details { font-size: 0.8rem; opacity: 0.9; margin-bottom: 10px; }
    .p-total { font-weight: 800; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px; }
    .footer-note { text-align: center; font-size: 11px; color: #94a3b8; margin-top: 30px; }
    .btn-back { display: block; text-align: center; margin-bottom: 20px; text-decoration: none; color: var(--primary); font-weight: 700; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèÜ Leaderboard</h1>
    ${personalSection}
    <table class="ranking-table">
      <tbody>${rowsHtml}</tbody>
    </table>
    <div class="footer-note">Ranking is updated every few minutes. Keep practicing!</div>
  </div>
  <div id="refresh-container" style="text-align: center; font-size: 11px; color: #94a3b8; margin-bottom: 10px;">
  <i class="bi bi-clock-history"></i> Refreshing in: <span id="timer">15</span>s
</div>

<script>
  let secondsLeft = 15;
  const timerEl = document.getElementById('timer');

  async function refreshRanking() {
    try {
      const res = await fetch('/ranking?top=5&who=${sid || ""}');
      const data = await res.json();
      
      if (data.ok) {
        location.reload(); 
      }
    } catch (e) {
      console.error("Erro ao atualizar ranking", e);
    }
  }

  function startCountdown() {
    setInterval(() => {
      secondsLeft--;
      timerEl.innerText = secondsLeft;

      if (secondsLeft <= 0) {
        secondsLeft = 15;
        // Se quiser apenas atualizar os dados sem piscar a tela, 
        // use fetch. Se quiser garantir que tudo atualize, use:
        location.reload();
      }
    }, 1000);
  }

  window.onload = startCountdown;
</script>
</body>
</html>`;
}


// ============================================================
// Export helpers
// ============================================================
function generateQMD(p) {
  let opts = {};
  try { opts = JSON.parse(p.options_json || "{}"); } catch {}

  const cleanOpt = (text, letter) => {
    if (!text) return "";
    const prefix = letter + ". ";
    return String(text).startsWith(prefix) ? String(text).replace(prefix, "") : String(text);
  };

  let optionsHtml = "";
  ["A","B","C","D","E"].forEach((l) => {
    if (opts[l]) {
      const text = cleanOpt(opts[l], l);
      optionsHtml += `<label><input type="radio" name="${escapeHtml(p.poll_id)}" value="${l}"> ${l}. ${escapeHtml(text)}</label><br>\n`;
    }
  });

  return `::: {.question-block}
<form onsubmit="event.preventDefault(); checkAnswer('${escapeHtml(p.poll_id)}')" data-correct-answer="${escapeHtml(p.correct_option)}">
  <strong style="display: block;">${escapeHtml(p.question)}</strong>
  ${optionsHtml}
</form>
<div id="feedback-${escapeHtml(p.poll_id)}" class="feedback" data-status="" style="display:none;">
  ‚úÖ Correct: ${escapeHtml(p.correct_option)}. ${escapeHtml(p.feedback_text || "")}
</div>
:::`;
}

function generateBrightspaceCSV(p) {
  let opts = {};
  try { opts = JSON.parse(p.options_json || "{}"); } catch {}

  const q = String(p.question || "").replace(/"/g, '""');
  let csv = `NewQuestion,MC,,,,\nID,${p.poll_id},,,,\nQuestionText,"${q}",,,,\n`;

  ["A","B","C","D","E"].forEach((l) => {
    if (opts[l]) {
      const weight = (l === p.correct_option) ? "100" : "0";
      const txt = String(opts[l]).replace(/"/g, '""');
      csv += `Option,${weight},"${txt}",,,,\n`;
    }
  });
  return csv;
}

async function buildReport(db, sid) {
  try {
    const row = await db.prepare(REPORT_SQL).bind(sid).first();
    const payload = row?.report_json;
    if (!payload) {
      return {
        student_id: sid,
        generated_at: tsBRString(Date.now()),
        ranking: null,
        attendance: null,
        attendance_history: [],
        polls_history: [],
        checkouts: [],
        likes_count: 0,
        _warning: "No data returned by REPORT_SQL (row empty)."
      };
    }

    return JSON.parse(payload);
  } catch (e) {
    return {
      student_id: sid,
      generated_at: tsBRString(Date.now()),
      ranking: null,
      attendance: null,
      attendance_history: [],
      polls_history: [],
      checkouts: [],
      likes_count: 0,
      _error: String(e && e.message ? e.message : e)
    };
  }
}

function reportToHTML(
  r,
  {
    logoUrl = "",
    courseName = "Financial Strategy (2026/01)",
    instructorName = "Henrique C. Martins - henrique.martins@fgv.br"
  } = {}
) {
  const esc = escapeHtml;
  const n = (x) => Number.isFinite(+x) ? +x : 0;

    // Chat rendering (safe defaults)
    const chatTotal = n(r?.chat_interactions?.total_interactions || 0);
    const chatOk = !!r?.chat_interactions?.ok;
    const chatItems = Array.isArray(r?.chat_interactions?.items) ? r.chat_interactions.items : [];
  
    const chatHtml =
      chatItems.map((it) => `
        <div class="checkout-card">
          <div class="checkout-header">
            <span class="slide-tag">üí¨ Chat</span>
            <span class="checkout-time">${esc(it.created_at || "")}</span>
          </div>
          <div class="checkout-body"><strong>Q:</strong> ${esc(it.student_message || "")}</div>
          <div class="checkout-body" style="margin-top:8px;"><strong>A:</strong> ${esc(it.bot_response || "")}</div>
        </div>
      `).join("") || `<p class="empty-state">No chat interactions found.</p>`;

      
  const nowBR = new Intl.DateTimeFormat("en-US", {
    dateStyle: "medium",
    timeStyle: "short",
    timeZone: "America/Sao_Paulo"
  }).format(new Date());

  const modProgress = r.module_progress || [];
  const moduleGridHtml = modProgress.map(m => {
      const pct = n(m.pct);
      let cls = pct >= 80 ? "done-high" : (pct >= 30 ? "done-mid" : (pct > 0 ? "done-low" : ""));
      return `<div class="mod-box ${cls}" title="${esc(m.module)}">
                <div style="font-size:9px; opacity:0.8;">${esc(m.module).replace('module','M')}</div>
                <div style="font-size:12px; font-weight:800;">${pct}%</div>
              </div>`;
  }).join("");
  
  const renderOptions = (optionsJson) => {
    try {
      const opts = JSON.parse(optionsJson);
      if (!opts || Object.keys(opts).length === 0) return "";
      return `<div class="options-container">
        ${Object.entries(opts)
          .filter(([_, val]) => val)
          .map(([key, val]) => `<div class="option-pill"><strong>${esc(key)}:</strong> ${esc(val)}</div>`)
          .join("")}
      </div>`;
    } catch {
      return "";
    }
  };

  const pollRows =
    (r.polls_history || []).map((p) => `
      <div class="card-item">
        <div class="status-indicator ${p.is_correct ? "success" : "error"}"></div>
        <div class="content">
          <div class="activity-title"><strong>${esc(p.id)}</strong> ‚Äî ${esc(p.question)}</div>
          ${p.options_json ? renderOptions(p.options_json) : ""}
          <div class="activity-result">
            <span>Your Entry: <strong class="${p.is_correct ? "text-success" : "text-error"}">${esc(p.your_answer)}</strong></span>
            ${!p.is_correct ? `<span class="correct-val"> / Correct: <strong>${esc(p.correct_answer)}</strong></span>` : ""}
          </div>
          <div class="timestamp">${esc(p.when)}</div>
        </div>
      </div>
    `).join("") || `<p class="empty-state">No poll history available.</p>`;

  const rk = r.ranking || { likes: 0, checkouts: 0, polls: 0, total: 0 };
  const att = r.attendance || { attended: 0, total: 0, absences: 0, pct: 0 };

  const attendanceHistoryHtml =
    (r.attendance_history || []).map((a) => {
      let colors = { bg: "#f0fff4", text: "#22543d", border: "#c6f6d5", badge: "#48bb78" };
      if (a.status === "absent") colors = { bg: "#fff5f5", text: "#c53030", border: "#fed7d7", badge: "#f56565" };
      else if (a.status === "partial") colors = { bg: "#fffaf0", text: "#9c4221", border: "#feebc8", badge: "#ed8936" };

      return `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:${colors.bg};border:1px solid ${colors.border};border-radius:8px;margin-top:8px;font-size:13px;">
        <span style="color:${colors.text};font-weight:600;">üìÖ ${esc(a.date)}</span>
        <span style="background:${colors.badge};color:white;padding:2px 8px;border-radius:4px;font-weight:800;text-transform:uppercase;font-size:10px;">${esc(a.status)}</span>
      </div>`;
    }).join("") || `<p class="empty-state">No attendance records yet.</p>`;

    const checkoutsHtml =
    (r.checkouts || []).map((c) => {
      const hasLikert = (c.likert_value !== null && c.likert_value !== undefined && String(c.likert_value).trim() !== "");
      const q = (c.likert_question || "").trim();
      const v = c.likert_value;
  
      return `
        <div class="checkout-card">
          <div class="checkout-header">
            <span class="slide-tag">Slide ${esc(c.slide_id)}</span>
            <span class="checkout-time">${esc(c.when)}</span>
          </div>
  
          ${
            hasLikert
              ? `<div style="margin-bottom:8px; font-size:12px; color: #334155;">
                   <span style="font-weight:800; color:#1e3a8a;">${esc(q || "Likert")}</span>
                   <span style="margin-left:8px; display:inline-block; padding:2px 8px; border-radius:999px; background:#e0e7ff; color:#1e3a8a; font-weight:800;">
                     ${esc(v)}
                   </span>
                 </div>`
              : ``
          }
          <div class="checkout-body">${esc(c.ticket)}</div>
        </div>
      `;
    }).join("") || `<p class="empty-state">No checkouts found.</p>`;
  

  return `<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Student Dashboard ‚Äî ${esc(r.student_id)}</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#1e3a8a; --bg:#f1f5f9; --card:#fff; --text:#1e293b; --muted:#64748b;
      --border:#e2e8f0; --success:#10b981; --error:#ef4444;
    }
    @media print{
      .no-print{display:none!important}
      body{background:white!important;padding:0!important}
      .container{max-width:100%!important;border:none!important}
      .card{box-shadow:none!important;border:1px solid var(--border)!important;page-break-inside:avoid}
    }
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:'Plus Jakarta Sans',sans-serif;padding:40px 20px;line-height:1.5
    }
    .container{max-width:850px;margin:0 auto}
    header{
      background:var(--card);padding:30px;border-radius:20px;
      box-shadow:0 4px 6px -1px rgba(0,0,0,0.05);
      border:1px solid var(--border);
      display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px
    }
    .header-details h1{margin:0 0 15px 0;font-size:24px;font-weight:800;color:var(--primary)}
    .header-details{font-size:14px;line-height:1.6}
    .today-tag{color:var(--muted);font-size:12px;margin-top:8px}
    .actions{display:flex;justify-content:flex-end;margin-bottom:15px}
    .btn-print{
      background:var(--primary);color:white;border:none;padding:10px 20px;border-radius:10px;
      font-weight:700;cursor:pointer;font-size:13px
    }
    .card{
      background:var(--card);border-radius:20px;padding:24px;margin-bottom:24px;
      box-shadow:0 4px 6px -1px rgba(0,0,0,0.05);border:1px solid var(--border)
    }
    h2{
      font-size:13px;font-weight:700;color:var(--muted);margin:0 0 20px;
      text-transform:uppercase;letter-spacing:.05em
    }
    .stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:15px}
    .stat-card{
      background:#f8fafc;padding:15px;border-radius:12px;border:1px solid var(--border);text-align:center
    }
    .stat-card.featured{background:#eff6ff;border-color:#bfdbfe}
    .stat-val{font-size:22px;font-weight:800;color:var(--primary);display:block}
    .stat-label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase}
    .att-summary{
      display:flex;gap:40px;font-weight:600;font-size:15px;border-bottom:1px solid var(--border);
      padding-bottom:15px
    }
    .att-summary span b{color:var(--primary)}
    .card-item{display:flex;gap:15px;padding:15px 0;border-bottom:1px solid #f1f5f9}
    .card-item:last-child{border-bottom:none}
    .status-indicator{width:6px;border-radius:10px;flex-shrink:0}
    .status-indicator.success{background:var(--success)}
    .status-indicator.error{background:var(--error)}
    .activity-title{font-size:14px;font-weight:600;margin-bottom:8px}
    .options-container{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px}
    .option-pill{
      background:#f1f5f9;padding:3px 8px;border-radius:6px;font-size:11px;color:var(--muted);
      border:1px solid #e2e8f0
    }
    .activity-result{font-size:13px}
    .text-success{color:var(--success)}
    .text-error{color:var(--error)}
    .timestamp{font-size:11px;color:var(--muted);margin-top:8px}
    .checkout-card{
      background:#f8fafc;border-radius:15px;padding:15px;margin-bottom:15px;border:1px solid var(--border)
    }
    .checkout-header{display:flex;justify-content:space-between;margin-bottom:8px;font-size:11px;font-weight:700}
    .slide-tag{color:var(--primary);background:#e0e7ff;padding:2px 6px;border-radius:4px}
    .checkout-body{font-size:13px;color:#334155;line-height:1.5}
    .mono{font-family:ui-monospace,monospace;font-weight:600}
    /* Substitua as classes antigas por estas */
    .mod-grid-container {
      display: grid;
      /* Cria 10 colunas de tamanho igual, mas com largura m√°xima para n√£o virar uma faixa */
      grid-template-columns: repeat(10, minmax(40px, 1fr)); 
      gap: 8px;
      margin-top: 10px;
    }
    
    .mod-box { 
      padding: 10px 2px; 
      text-align: center; 
      border-radius: 8px; 
      background: #334155; /* Cor escura igual ao seu Analytics */
      color: #94a3b8; 
      border: 1px solid rgba(255,255,255,0.1);
      min-width: 0; /* Evita que o conte√∫do quebre o grid */
    }
    
    .mod-box.done-high { background: #059669; color: white; border-color: #10b981; }
    .mod-box.done-mid { background: #d97706; color: white; border-color: #f59e0b; }
    .mod-box.done-low { background: #dc2626; color: white; border-color: #ef4444; }
  </style>
</head>
<body>
  <div class="container">
    <div class="actions no-print">
      <button class="btn-print" onclick="window.print()">Download PDF Report</button>
    </div>

    <header>
      <div class="header-details">
        <h1>Performance Dashboard</h1>
        <div><strong>${esc(courseName)}</strong></div>
        <div>Instructor: ${esc(instructorName)}</div>
        <div>Student ID: <span class="mono">${esc(r.student_id)}</span></div>
        <div class="today-tag">Today: ${esc(nowBR)}</div>
      </div>
      ${logoUrl ? `<img src="${esc(logoUrl)}" style="height:45px;">` : ""}
    </header>

    <div class="card">
      <h2>Engagement Scoreboard</h2>
      <div class="stats-row">
        <div class="stat-card"><span class="stat-label">Likes</span><span class="stat-val">${n(rk.likes)}</span></div>
        <div class="stat-card"><span class="stat-label">Checkouts</span><span class="stat-val">${n(rk.checkouts)}</span></div>
        <div class="stat-card"><span class="stat-label">Polls</span><span class="stat-val">${n(rk.polls)}</span></div>
        <div class="stat-card featured"><span class="stat-label">Total Credits</span><span class="stat-val">${n(rk.total)}</span></div>
      </div>
    </div>
<div class="card">
  <h2>Practice Progress (Modules 1-10)</h2>
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); gap: 10px;">
    ${moduleGridHtml}
  </div>
  <div style="margin-top: 15px; display: flex; gap: 15px; font-size: 10px; font-weight: 700; color: var(--muted);">
    <span><span style="color:#059669">‚óè</span> MASTERED (>80%)</span>
    <span><span style="color:#d97706">‚óè</span> IN PROGRESS</span>
    <span><span style="color:#dc2626">‚óè</span> CRITICAL (<30%)</span>
  </div>
</div>
    <div class="card">
      <h2>Attendance Tracking</h2>
      <div class="att-summary">
        <span>Days Attended: <b>${n(att.attended)} / ${n(att.total)}</b></span>
        <span>Presence Rate: <b>${(n(att.pct) * 100).toFixed(1)}%</b></span>
      </div>

      <div style="font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; margin-top: 15px;">
        Full Attendance History
      </div>

      ${attendanceHistoryHtml}
    </div>

    <div class="card">
      <h2>Activity History (Polls)</h2>
      ${pollRows}
    </div>

    <div class="card">
      <h2>Knowledge Checkouts</h2>
      ${checkoutsHtml}
    </div>

    <div class="card">
    <h2>Chat Interactions <span style="float:right;color:var(--muted);font-size:12px;font-weight:700;text-transform:none;">Total: ${chatTotal}</span></h2>
    ${!chatOk ? `<p class="empty-state">Chat service unavailable for now.</p>` : chatHtml}
  </div>

  </div>
</body>
</html>`;
}

function renderAdminDashboard(token) {
  return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <title>HCM Admin: instructor only</title>
  
  <link rel="manifest" href="/admin/manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/admin/sw.js');
    }
  </script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    :root { --bg: #0b1220; --card: #1e293b; --accent: #38bdf8; --text: #f1f5f9; --cloud: #f38020; --teaching: #10b981; }
    body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
    h1 { font-size: 1.2rem; font-weight: 800; margin-bottom: 20px; color: var(--accent); text-align: center; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .btn-app { 
      background: var(--card); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px;
      padding: 20px 10px; display: flex; flex-direction: column; align-items: center;
      text-decoration: none; color: white; transition: 0.2s;
    }
    .btn-app i { font-size: 1.8rem; margin-bottom: 8px; color: var(--accent); }
    .btn-app span { font-size: 11px; font-weight: 700; text-align: center; text-transform: uppercase; letter-spacing: 0.5px; }
    .btn-app:active { transform: scale(0.95); background: #2d3a4f; }
    .footer { text-align: center; margin-top: 30px; font-size: 11px; color: #64748b; }
  </style>
</head>
<body>
  <h1><i class="bi bi-person-badge"></i> Financial Strategy Admin</h1>
  <div class="grid">
      <a href="/teaching/financial_strategy" class="btn-app" style="border-color: var(--teaching); grid-column: span 2; margin-top: 8px;">
      <i class="bi bi-mortarboard" style="color: var(--teaching);"></i>
      <span style="color: var(--teaching);">Go to Course Page</span>
    </a>
    <a href="/admin/poll?t=${token}" class="btn-app"><i class="bi bi-lightning-charge"></i><span>Poll Launch</span></a>
    <a href="/admin/attendance?t=${token}" class="btn-app"><i class="bi bi-calendar-check"></i><span>Roll Call</span></a>
    <a href="/admin/checkouts?t=${token}" class="btn-app"><i class="bi bi-chat-left-dots"></i><span>Reply Checkouts</span></a>
    <a href="/admin/dm?t=${token}" class="btn-app"><i class="bi bi-envelope-paper"></i><span>Manual DM</span></a>
    <a href="/admin/questions?t=${token}" class="btn-app"><i class="bi bi-database-add"></i><span>Import Questions</span></a>
    <a href="/admin/view-database?t=${token}" class="btn-app"><i class="bi bi-search"></i><span>Question Bank</span></a>
    <a href="/admin/analytics/students?t=${token}" class="btn-app"><i class="bi bi-graph-up-arrow"></i><span>Monitoring</span></a>
    <a href="/admin/checkout/manager?t=${token}" class="btn-app"><i class="bi bi-clock-history"></i><span>Checkout Manager</span></a>
    <a href="/admin/students?t=${token}" class="btn-app" style="border-color: var(--accent);"><i class="bi bi-person-fill-add"></i><span>Add Student</span></a>
    
    <a href="https://dash.cloudflare.com/f4663e60fa6df0aa0e925d92e62e7a8d/r2/default/buckets/course-slides" target="_blank" class="btn-app" style="border-color: var(--cloud);">
      <i class="bi bi-cloud-arrow-up" style="color: var(--cloud);"></i>
      <span>R2 Slides Upload</span>
    </a>

    <a href="https://dash.cloudflare.com/f4663e60fa6df0aa0e925d92e62e7a8d/workers/d1/databases/04f35a64-9bd7-4cbf-87d0-ce646433f77d/studio" target="_blank" class="btn-app" style="border-color: var(--cloud);">
      <i class="bi bi-cloud-haze2" style="color: var(--cloud);"></i>
      <span>Cloudflare DB</span>
    </a>
    
  </div>
  <div class="footer">henriquemartins.co ‚Ä¢ 2026.02</div>
</body>
</html>`;
}


function renderAdminLoginPage() {
  return `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  
  <link rel="manifest" href="/admin/manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/admin/sw.js');
    }
  </script>

  <style>
    body{background:#0b1220;color:white;font-family:sans-serif;display:flex;align-items:center;justify-content:center;height:100vh;margin:0;}
    .card{background:#1e293b;padding:30px;border-radius:20px;text-align:center;box-shadow:0 10px 25px rgba(0,0,0,0.3);width:80%;max-width:300px;}
    input{width:100%;padding:12px;border-radius:10px;border:none;margin:15px 0;box-sizing:border-box;text-align:center;font-size:18px;}
    button{width:100%;padding:12px;border-radius:10px;border:none;background:#38bdf8;color:#0b1220;font-weight:800;cursor:pointer;}
  </style>
</head>
<body>
    <div class="card">
      <h2>Admin Login</h2>
      <input type="password" id="pw" placeholder="Token">
      <button onclick="location.href='/admin?t='+document.getElementById('pw').value">Enter</button>
    </div>
</body>
</html>`;
}

function isLoggedInSid(req) {
  const sid = normalizeSid(getCookie(req, "student_id"));
  return sid || "";
}

function redirectToCourseLogin(origin) {
  const headers = new Headers(cors(origin));
  headers.set("Location", "/teaching/financial_strategy/login");
  return new Response(null, { status: 303, headers });
}

function courseLoginPage({ message = "" } = {}) {
  const msg = String(message || "").trim();

  return `<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Financial Strategy ‚Äî Login</title>
  <style>
    :root{--ink:#0f172a;--muted:#64748b;--line:#e2e8f0;--brand:#1e3a8a}
    *{box-sizing:border-box}
    body{
      margin:0;background:#f8fafc;color:var(--ink);
      font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      display:flex;align-items:center;justify-content:center;min-height:100vh;
    }
    .page{max-width:420px;width:100%;padding:20px}
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 2px 12px rgba(15,23,42,.06);padding:24px}
    h1{margin:0 0 10px;font-size:22px;font-weight:800;color:var(--brand)}
    .muted{color:var(--muted);font-size:13px;margin-bottom:12px}
    input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;margin:8px 0;font:inherit;outline-color:var(--brand)}
    button{
      width:100%;padding:12px;border-radius:10px;border:1px solid var(--brand);
      background:var(--brand);color:#fff;font-weight:700;cursor:pointer;margin-top:10px;
    }
    .err{color:#991b1b;background:#fee2e2;border:1px solid #fecaca;padding:10px;border-radius:10px;margin:6px 0 12px;font-weight:700;font-size:13px}
    .small{font-size:12px;color:var(--muted);margin-top:15px;text-align:center}
  </style>
</head>
<body>
<section class="page">
  <div class="card">
    <h1>üîê Course Login</h1>
    <div class="muted">Sign in once to unlock the course pages.</div>
    ${msg ? `<div class="err" role="alert">${escapeHtml(msg)}</div>` : ""}
    <form method="POST" action="/teaching/financial_strategy/login" autocomplete="off">
      <label style="font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase;">Username</label>
      <input type="text" name="username" required autofocus />
      <label style="font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase;">Password</label>
      <input type="password" name="password" required />
      <button type="submit">Enter</button>
    </form>
    <div class="small">If you have issues, contact the instructor.</div>
  </div>
</section>
</body>
</html>`;
}
