<!-- submit-to-sheets2.html ‚Äî Exercises ‚Üí Cloudflare Worker (/exercises) -->
<style>
  :root{
    --card-bg:#192233; --card-fg:#fff; --pill-bg:rgba(255,255,255,.08); --pill-bd:rgba(255,255,255,.18);
    --ok:#16a34a; --warn:#f59e0b; --err:#ff4d4f;
    --btn1:#1992d4; --btn2:#0ea5e9; --btn1-off:#7cc5ff; --btn2-off:#a6d9f7;
    --shadow:0 16px 44px rgba(0,0,0,.35); --msg-size:1.1rem;
  }
  @media (prefers-color-scheme: dark){ :root{ --pill-bg:rgba(255,255,255,.10); --pill-bd:rgba(255,255,255,.24); --shadow:0 20px 50px rgba(0,0,0,.55);} }

  .exw-card{ margin:8px 0 14px; padding:14px 16px; background:var(--card-bg); color:var(--card-fg);
    border-radius:16px; box-shadow:var(--shadow); display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
  .exw-title{ font-weight:800; font-size:1.1rem; letter-spacing:.2px; }
  .exw-dot{ width:10px; height:10px; border-radius:50%; background:#94a3b8; }
  .exw.open  .exw-dot{ background:var(--ok); }
  .exw.soon  .exw-dot{ background:var(--warn); }
  .exw.closed .exw-dot{ background:var(--err); }
  .exw-pill{ margin-left:auto; display:inline-flex; align-items:center; gap:8px; padding:6px 12px; border-radius:999px;
    background:var(--pill-bg); border:1px solid var(--pill-bd); font-size:.92rem; white-space:nowrap; }
  .exw-msg{ width:100%; margin-top:4px; font-weight:800; font-size:var(--msg-size); }
  .exw.open  .exw-msg{ color:var(--ok); } .exw.soon .exw-msg{ color:var(--warn); } .exw.closed .exw-msg{ color:var(--err); }

  .sid-bar{ background:var(--card-bg); color:var(--card-fg); border-radius:14px; padding:12px 14px; box-shadow:var(--shadow);
    display:flex; align-items:center; gap:10px; margin:8px 0 14px; }
  .sid-bar label{ font-weight:800; }
  .ex-sid{ background:#fff; color:#111; border-radius:10px; border:none; padding:10px 12px; min-width:260px; outline:none; }

  .row-actions{ display:flex; gap:12px; margin:2px 0 12px; flex-wrap:wrap; }
  .ex-btn{ border:none; border-radius:12px; padding:10px 16px; color:#fff; font-weight:800; cursor:pointer;
    box-shadow:0 8px 20px rgba(30,58,138,.25); transition:filter .15s ease, transform .06s ease, opacity .15s ease; }
  .ex-btn.primary{ background:linear-gradient(135deg, var(--btn1), var(--btn2)); }
  .ex-btn.primary:hover{ transform:translateY(-1px); filter:saturate(110%); }
  .ex-btn.secondary{ background:linear-gradient(135deg, var(--btn2), #38bdf8); }
  .ex-btn.secondary:hover{ transform:translateY(-1px); filter:saturate(110%); }
  .ex-btn:disabled{ cursor:not-allowed; transform:none; filter:none; background:linear-gradient(135deg, var(--btn1-off), var(--btn2-off)); color:#234; opacity:.95; box-shadow:none; }

  .feedback[data-status="correct"]{ color:#16a34a; }
  .feedback[data-status="incorrect"]{ color:#ff4d4f; }
</style>

<div class="exw-card exw" id="exw-card" aria-live="polite">
  <span class="exw-dot" aria-hidden="true"></span>
  <div class="exw-title">Submit your answers</div>
  <div class="exw-pill"><span id="exw-pill-text">‚Äî</span></div>
  <div class="exw-msg" id="exw-msg">‚Äî</div>
</div>

<div class="sid-bar">
  <label for="student-id">Student ID:</label>
  <input type="text" id="student-id" class="ex-sid" placeholder="Enter your ID">
</div>

<div class="row-actions">
  <button id="submit-btn" class="ex-btn primary">Submit</button>
  <button id="download-btn" class="ex-btn primary" disabled>üìÑ Download My Answers (TXT)</button>
  <button id="toggle-feedback-btn" class="ex-btn secondary" disabled>Show Feedback</button>
</div>

<script>
/* ===== CONFIG ===== */
window.COURSE_WORKER = window.COURSE_WORKER || "https://course-chat.hcmrtns.workers.dev";
/* For√ßa pop-ups (caixa de aviso) */
window.EXW_USE_ALERT = true;

(function(){
  const script = document.currentScript;
  const slide  = script.closest('section') || script.parentElement || document.body;
  const ENDPOINT = (window.COURSE_WORKER || "").replace(/\/$/,'') + "/exercises";
  const TZ_LABEL = "S√£o Paulo time";

  // ===== Short helpers
  const $  = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const trim = s => (s||'').toString().trim();
  const sidInput = $('#student-id', slide);
  const btnSubmit= $('#submit-btn', slide);
  const btnDown  = $('#download-btn', slide);
  const btnFB    = $('#toggle-feedback-btn', slide);
  const card     = $('#exw-card', slide);
  const pillText = $('#exw-pill-text', slide);
  const msgEl    = $('#exw-msg', slide);

  function getIds(){
    const sid = trim(window.studentId || localStorage.getItem('studentId') || sessionStorage.getItem('studentId') || sidInput?.value || '');
    const el  = $('#slide-id', slide) || $('input#slide-id');
    const slideId = el ? el.value : (slide.getAttribute('data-slide-key') || 'unknown');
    return { studentId: sid, slideId, slideEl: slide, slideIdEl: el };
  }

  // ===== Window parsing (BR local "YYYY-MM-DD HH:MM[:SS]")
  function parseBR(ts){ if(!ts) return null; const [d,t='00:00:00'] = ts.split(' '); const hhmm = t.length===5 ? t+':00' : t; return new Date(`${d}T${hhmm}-03:00`); }
  function fmtDurSeconds(s){ const m=Math.floor(s/60), r=s%60; if(m>=60){const h=Math.floor(m/60), mm=m%60; return `${h}h ${mm}m`;} if(m>0) return `${m}m ${r}s`; return `${r}s`; }
  function statusNow(openStr, closeStr){
    const now=new Date(); const open=parseBR(openStr), close=parseBR(closeStr);
    if(!open && !close) return {state:'open', msg:'Submission is OPEN'};
    if(open && now<open){ const secs = Math.max(0, (open-now)/1000|0); return {state:'soon', msg:`Submission not open yet. Opens in ${fmtDurSeconds(secs)}.`}; }
    if(close && now>close) return {state:'closed', msg:'Submission is CLOSED'};
    if(close){ const secs = Math.max(0, (close-now)/1000|0); return {state:'open', msg:`Submission is OPEN. Closes in ${fmtDurSeconds(secs)}.`}; }
    return {state:'open', msg:'Submission is OPEN'};
  }

  // ===== Avisos (pop-up obrigat√≥rio)
  function notify(msg){
    if (window.EXW_USE_ALERT) { alert(msg); return; }
    console.log("[EXW]", msg);
  }

  // ===== UI sync
  function findFeedbackBlocks(){
    const b = $$('.feedback', slide);
    return b.length ? b : $$('.feedback');
  }
  function markSubmittedUI(){
    btnSubmit.disabled = true;
    btnSubmit.textContent = 'Submitted ‚úì';
    btnDown.disabled = !slide.__lastSubmittedAnswers;
  }
  function restoreSubmitUI(){
    btnSubmit.disabled = false;
    btnSubmit.textContent = 'Submit';
  }
  function syncButtons(state){
    const ids = getIds();
    const locked = isLocked(ids);
    if (state !== 'open' || locked) markSubmittedUI(); else restoreSubmitUI();

    const hasFB = findFeedbackBlocks().length > 0;
    btnFB.disabled = !(state === 'closed' && hasFB);

    btnDown.disabled = !slide.__lastSubmittedAnswers;
  }

  // ===== Lock local (persiste no navegador)
  function lockKey(ids){ return `exw_lock_${ids.slideId}:${ids.studentId}`; }
  function isLocked(ids){ return !!localStorage.getItem(lockKey(ids)); }
  function setLock(ids){ localStorage.setItem(lockKey(ids), '1'); }
  function clearLock(ids){ localStorage.removeItem(lockKey(ids)); }

  // ===== Card + rel√≥gio
  function paintWindow(){
    const ids = getIds();
    const el  = ids.slideIdEl;
    const openS = el?.getAttribute('data-open') || '';
    const closeS= el?.getAttribute('data-close')|| '';

    pillText.textContent = (openS || closeS) ? `${openS} ‚Üí ${closeS} (${TZ_LABEL})` : 'No window set';

    const st = statusNow(openS, closeS);
    card.classList.remove('open','soon','closed'); card.classList.add(st.state);
    msgEl.textContent = st.msg;

    syncButtons(st.state);
  }

  // ===== Coleta respostas
  function collectAnswers(){
    const out = {};
    $$('input[type="text"], input[type="number"]', slide).forEach(inp=>{
      const key = inp.name || inp.id || '';
      if(!(key && (key.startsWith('q') || key.startsWith('module')))) return;
      const v = trim(inp.value); if(v!=='') out[key]=v;
    });
    const names = new Set();
    $$('input[type="radio"]', slide).forEach(r=>{ if(r.name && (r.name.startsWith('q')||r.name.startsWith('module'))) names.add(r.name); });
    names.forEach(name=>{ const sel = slide.querySelector(`input[type="radio"][name="${CSS.escape(name)}"]:checked`); if(sel) out[name]=sel.value; });
    $$('input[type="checkbox"]', slide).forEach(ch=>{
      const key = ch.name || ch.id || ''; if(!(key && (key.startsWith('q')||key.startsWith('module')))) return;
      if(ch.checked) out[key] = ch.value || 'on';
    });
    $$('textarea, select', slide).forEach(el=>{
      const key = el.name || el.id || ''; if(!(key && (key.startsWith('q')||key.startsWith('module')))) return;
      const v = trim(el.value); if(v!=='') out[key]=v;
    });
    return out;
  }

  // ===== Submit
  let submitting=false;
  async function doSubmit(){
    const ids = getIds();
    const openS  = ids.slideIdEl?.getAttribute('data-open')  || '';
    const closeS = ids.slideIdEl?.getAttribute('data-close') || '';
    const gate = statusNow(openS, closeS);
    if (gate.state !== 'open'){
      notify(gate.state==='soon'
        ? `This exercise is not open yet. It opens at ${openS} (${TZ_LABEL}).`
        : `This exercise is already closed. It closed at ${closeS} (${TZ_LABEL}).`);
      return;
    }
    if (!ids.studentId){ notify("Please enter your student ID (or log in)."); sidInput?.focus(); return; }

    const answers = collectAnswers();
    if (!Object.keys(answers).length){ notify("No filled answers on this slide."); return; }

    if (submitting) return;
    submitting = true;
    const prevTxt = btnSubmit.textContent;
    btnSubmit.textContent = '‚è≥ Sending‚Ä¶';
    btnSubmit.disabled = true;

    // salva payload p/ download
    slide.__lastSubmittedAnswers = {
      studentId: ids.studentId,
      slide: ids.slideId,
      timestamp: new Date().toLocaleString("pt-BR",{timeZone:"America/Sao_Paulo"}),
      answers
    };

    try{
      const res = await fetch(ENDPOINT, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          student: ids.studentId,
          exercise_id: ids.slideId,
          answers,
          tsClient: new Date().toISOString(),
          open:  openS,
          close: closeS
        }),
        credentials:"omit"
      });
      const data = await res.json().catch(()=> ({}));

      if (res.status === 403 && data?.status === "closed_window"){
        notify("Submission blocked: window closed.");
        slide.__lastSubmittedAnswers = null; btnDown.disabled = true;
        clearLock(ids); restoreSubmitUI();
      } else if (res.ok && (data.status === "success" || data.status === "duplicate")){
        setLock(ids);        // trava local
        markSubmittedUI();   // trava UI
        btnDown.disabled = false;
        notify(data.status === "duplicate" ? "You had already submitted this exercise." : "Submitted! Thank you.");
      } else {
        const err = data?.message || `HTTP ${res.status}`;
        notify("Submission error: " + err);
        slide.__lastSubmittedAnswers = null; btnDown.disabled = true;
        clearLock(ids); restoreSubmitUI();
      }
    } catch(e){
      notify("Submission error: " + e.message);
      slide.__lastSubmittedAnswers = null; btnDown.disabled = true;
      clearLock(ids); restoreSubmitUI();
    } finally{
      submitting=false; btnSubmit.textContent = prevTxt;
      paintWindow(); // reavalia estado
    }
  }

  // ===== Download
  function downloadTXT(){
    const p = slide.__lastSubmittedAnswers;
    if (!p){ notify("No answers available to download yet."); return; }
    let txt = "üìù Student Answers Summary\n\n";
    txt += `Student ID: ${p.studentId}\nSlide: ${p.slide}\nTimestamp: ${p.timestamp}\n\n`;
    txt += "Answers:\n";
    for (const [qid,val] of Object.entries(p.answers)){
      txt += `- ${qid}: ${typeof val==='object' && val ? val.value : val}\n`;
    }
    const blob = new Blob([txt], {type:"text/plain"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${p.studentId}_${p.slide}_${p.timestamp.replace(/[/:\s]/g,'-')}_answers.txt`;
    document.body.appendChild(a); a.click(); a.remove();
  }

  // ===== Feedback
  let fbShown=false;
  function toggleFeedback(){
    const ids = getIds();
    const st  = statusNow(ids.slideIdEl?.getAttribute('data-open')||'', ids.slideIdEl?.getAttribute('data-close')||'').state;
    if (st !== 'closed'){ btnFB.disabled = true; return; }
    const blocks = findFeedbackBlocks(); if(!blocks.length){ notify("Feedback unavailable at the moment."); return; }
    fbShown=!fbShown; blocks.forEach(b=> b.style.display = fbShown ? 'block' : 'none');
    btnFB.textContent = fbShown ? 'Hide Feedback' : 'Show Feedback';
  }

  // ===== Checagem no servidor (j√° submetido?)
  async function checkServerSubmitted(){
    try{
      const ids = getIds(); if(!(ids.studentId && ids.slideId)) return;
      const u = new URL(ENDPOINT);
      u.searchParams.set('student', ids.studentId);
      u.searchParams.set('exercise_id', ids.slideId);
      const r = await fetch(u, { method:'GET', credentials:'omit' });
      const d = await r.json().catch(()=> ({}));
      if (d && d.found){
        setLock(ids);
        // pr√©-preenche p/ permitir download (sem reabrir inputs)
        slide.__lastSubmittedAnswers = slide.__lastSubmittedAnswers || { studentId: ids.studentId, slide: ids.slideId, timestamp: new Date().toLocaleString("pt-BR",{timeZone:"America/Sao_Paulo"}), answers: collectAnswers() };
        markSubmittedUI();
      }
    }catch{ /* ignora */ }
  }

  // ===== Init
  function init(){
    // Preenche ID se poss√≠vel
    const auto = trim(window.studentId || localStorage.getItem('studentId') || sessionStorage.getItem('studentId') || '');
    if (sidInput && auto) sidInput.value = auto;

    btnSubmit.addEventListener('click', doSubmit);
    btnDown.addEventListener('click', downloadTXT);
    btnFB.addEventListener('click', toggleFeedback);

    paintWindow();
    setInterval(paintWindow, 1000);

    // Trava pela mem√≥ria local + confirma no servidor
    const ids = getIds();
    if (isLocked(ids)) markSubmittedUI();
    checkServerSubmitted();
  }

  if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', init, {once:true}); }
  else { init(); }
})();
</script>
