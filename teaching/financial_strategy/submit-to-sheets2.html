<!-- submit-to-sheets2.html — Exercises → Cloudflare Worker (/exercises) -->
<style>
  :root{
    --card-bg:#b6c2d9; --card-fg:#0b1220;
    --pill-bg:rgba(15,23,42,.16); --pill-bd:rgba(15,23,42,.30);
    --input-bg:#edf3fa; --input-bd:#c7d2e3; --divider:#cbd7e6;
    --ok:#16a34a; --warn:#f59e0b; --err:#ff4d4f;
    --btn1:#1992d4; --btn2:#0ea5e9; --btn1-off:#93c5fd; --btn2-off:#bae6fd;
    --shadow:0 12px 28px rgba(2,6,23,.14);
    --msg-size:1.02rem;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --card-bg:#192233; --card-fg:#eaf2ff;
      --pill-bg:rgba(255,255,255,.10); --pill-bd:rgba(255,255,255,.24);
      --input-bg:#0f172a; --input-bd:#263043; --divider:rgba(148,163,184,.28);
      --shadow:0 18px 42px rgba(0,0,0,.55);
    }
  }

  .exw-card{
    margin:8px 0 12px; padding:12px 14px;
    background:var(--card-bg); color:var(--card-fg);
    border:1px solid var(--divider); border-radius:16px; box-shadow:var(--shadow);
    display:flex; align-items:center; gap:10px; flex-wrap:wrap;
  }
  .exw-title{ font-weight:800; font-size:1.06rem; letter-spacing:.2px; }
  .exw-dot{ width:9px; height:9px; border-radius:50%; background:#94a3b8; }
  .exw.open  .exw-dot{ background:var(--ok); }
  .exw.soon  .exw-dot{ background:var(--warn); }
  .exw.closed .exw-dot{ background:var(--err); }

  .exw-pill{
    margin-left:auto; display:inline-flex; align-items:center; gap:8px;
    padding:6px 12px; border-radius:999px; background:var(--pill-bg);
    border:1px solid var(--pill-bd); font-size:.92rem; white-space:nowrap;
  }

  .exw-msg{ width:100%; margin-top:2px; font-weight:800; font-size:var(--msg-size); }
  .exw.open  .exw-msg{ color:var(--ok); }
  .exw.soon  .exw-msg{ color:var(--warn); }
  .exw.closed .exw-msg{ color:var(--err); }

  /* Student ID compacto (altura menor) */
  .sid-inline{
    width:100%; margin-top:8px; padding-top:6px;
    border-top:1px solid var(--pill-bd);
    display:flex; align-items:center; gap:10px;
  }
  .sid-inline label{ font-weight:800; color:var(--card-fg); opacity:.95; }
  .sid-inline .ex-sid{
    background:var(--input-bg); color:var(--card-fg);
    border:1px solid var(--input-bd); border-radius:10px;
    padding:6px 10px; min-width:260px; outline:none;
  }
  .sid-inline .ex-sid::placeholder{ color:rgba(100,116,139,.9); }

  .row-actions{ display:flex; gap:10px; margin:6px 0 12px; flex-wrap:wrap; }
  .ex-btn{
    border:none; border-radius:12px; padding:10px 16px; color:#fff; font-weight:800; cursor:pointer;
    box-shadow:0 8px 20px rgba(30,58,138,.25); transition:filter .15s, transform .06s, opacity .15s;
  }
  .ex-btn.primary{ background:linear-gradient(135deg, var(--btn1), var(--btn2)); }
  .ex-btn.primary:hover{ transform:translateY(-1px); filter:saturate(110%); }
  .ex-btn.secondary{ background:linear-gradient(135deg, var(--btn2), #38bdf8); }
  .ex-btn.secondary:hover{ transform:translateY(-1px); filter:saturate(110%); }
  .ex-btn:disabled{
    cursor:not-allowed; transform:none; filter:none;
    background:linear-gradient(135deg, var(--btn1-off), var(--btn2-off));
    color:#234; opacity:.95; box-shadow:none;
  }

  .feedback[data-status="correct"]{ color:#16a34a; }
  .feedback[data-status="incorrect"]{ color:#ff4d4f; }
</style>

<div class="exw-card exw" id="exw-card" aria-live="polite">
  <span class="exw-dot" aria-hidden="true"></span>
  <div class="exw-title">Submit your answers</div>

  <div class="exw-pill"><span id="exw-pill-text">Loading…</span></div>
  <div class="exw-msg" id="exw-msg">—</div>

  <!-- Placeholder: o JS cria label+input aqui para não serem escapados -->
  <div class="sid-inline" id="sid-inline"></div>
</div>

<div class="row-actions">
  <button id="submit-btn" class="ex-btn primary">Submit</button>
  <button id="download-btn" class="ex-btn primary" disabled>📄 Download My Answers (TXT)</button>
  <button id="toggle-feedback-btn" class="ex-btn secondary" disabled>Show Feedback</button>
</div>

<script>
window.COURSE_WORKER = window.COURSE_WORKER || "https://course-chat.hcmrtns.workers.dev";
window.EXW_USE_ALERT = true;

(function(){
  try{
    var script = document.currentScript;
    var slide  = script ? (script.closest('section') || script.parentElement || document.body) : document.body;
    var ENDPOINT = String(window.COURSE_WORKER || "").replace(/\/$/,'') + "/exercises";
    var TZ_LABEL = "São Paulo time";

    function $(sel, root){ return (root||document).querySelector(sel); }
    function $$(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }
    function trim(s){ return (s==null?'':String(s)).trim(); }

    // monta o campo de ID via DOM (evita HTML escapado pelo builder)
    function mountSID(){
      var mount = $('#sid-inline', slide);
      if (!mount || mount.__mounted) return;
      mount.__mounted = true;

      var label = document.createElement('label');
      label.setAttribute('for','student-id');
      label.textContent = 'Student ID:';

      var input = document.createElement('input');
      input.type = 'text';
      input.id = 'student-id';
      input.className = 'ex-sid';
      input.placeholder = 'Enter your ID';

      mount.appendChild(label);
      mount.appendChild(input);
    }
    mountSID();

    var sidInput = $('#student-id', slide);
    var btnSubmit= $('#submit-btn', slide);
    var btnDown  = $('#download-btn', slide);
    var btnFB    = $('#toggle-feedback-btn', slide);
    var card     = $('#exw-card', slide);
    var pillText = $('#exw-pill-text', slide);
    var msgEl    = $('#exw-msg', slide);

    function getIds(){
      // garante que pegamos o input mesmo se montado depois
      sidInput = sidInput || $('#student-id', slide);
      var sid = trim(window.studentId || localStorage.getItem('studentId') || sessionStorage.getItem('studentId') || (sidInput && sidInput.value) || '');
      var el  = $('#slide-id', slide) || $('input#slide-id');
      var slideId = el ? el.value : (slide.getAttribute('data-slide-key') || 'unknown');
      return { studentId:sid, slideId:slideId, slideIdEl:el };
    }

    function parseBR(ts){
      if(!ts) return null;
      var sp = ts.split(' '), d=sp[0], t=(sp[1]||'00:00:00');
      if(t.length===5) t = t + ':00';
      return new Date(d+'T'+t+'-03:00');
    }
    function fmtDurSeconds(s){
      var m=Math.floor(s/60), r=s%60;
      if(m>=60){ var h=Math.floor(m/60), mm=m%60; return h+'h '+mm+'m'; }
      if(m>0) return m+'m '+r+'s';
      return r+'s';
    }
    function statusNow(openStr, closeStr){
      var now=new Date(), open=parseBR(openStr), close=parseBR(closeStr);
      if(!open && !close) return {state:'open', msg:'Submission is OPEN'};
      if(open && now<open){ var s1=Math.max(0, ((open-now)/1000)|0); return {state:'soon', msg:'Submission not open yet. Opens in '+fmtDurSeconds(s1)+'.'}; }
      if(close && now>close) return {state:'closed', msg:'Submission is CLOSED'};
      if(close){ var s2=Math.max(0, ((close-now)/1000)|0); return {state:'open', msg:'Submission is OPEN. Closes in '+fmtDurSeconds(s2)+'.'}; }
      return {state:'open', msg:'Submission is OPEN'};
    }

    function notify(msg){ if(window.EXW_USE_ALERT){ alert(msg); } else { console.log('[EXW]', msg); } }

    function findFeedbackBlocks(){
      var b = $$('.feedback', slide);
      return b.length ? b : $$('.feedback');
    }
    function lockKey(ids){ return 'exw_lock_'+ids.slideId+':'+ids.studentId; }
    function isLocked(ids){ try{ return !!localStorage.getItem(lockKey(ids)); }catch(e){ return false; } }
    function setLock(ids){ try{ localStorage.setItem(lockKey(ids),'1'); }catch(e){} }
    function clearLock(ids){ try{ localStorage.removeItem(lockKey(ids)); }catch(e){} }

    function markSubmittedUI(){ if(!btnSubmit) return; btnSubmit.disabled=true; btnSubmit.textContent='Submitted ✓'; if(btnDown) btnDown.disabled = !slide.__lastSubmittedAnswers; }
    function restoreSubmitUI(){ if(!btnSubmit) return; btnSubmit.disabled=false; btnSubmit.textContent='Submit'; }

    function syncButtons(state){
      var ids = getIds();
      var locked = isLocked(ids);
      if(state!=='open' || locked) markSubmittedUI(); else restoreSubmitUI();
      var hasFB = findFeedbackBlocks().length > 0;
      if(btnFB) btnFB.disabled = !(state==='closed' && hasFB);
      if(btnDown) btnDown.disabled = !slide.__lastSubmittedAnswers;
    }

    function paintWindow(){
      var ids = getIds();
      var el  = ids.slideIdEl;
      var openS  = el ? (el.getAttribute('data-open') || '')  : '';
      var closeS = el ? (el.getAttribute('data-close') || '') : '';
      pillText.textContent = (openS || closeS) ? (openS+' → '+closeS+' ('+TZ_LABEL+')') : 'No window set';
      var st = statusNow(openS, closeS);
      card.classList.remove('open','soon','closed');
      card.classList.add(st.state);
      msgEl.textContent = st.msg;
      syncButtons(st.state);
    }

    function collectAnswers(){
      var out = {};
      $$('input[type="text"], input[type="number"]', slide).forEach(function(inp){
        var key = inp.name || inp.id || '';
        if(!(key && (key.indexOf('q')===0 || key.indexOf('module')===0))) return;
        var v = trim(inp.value); if(v!=='') out[key]=v;
      });
      var names = {};
      $$('input[type="radio"]', slide).forEach(function(r){
        if(r.name && (r.name.indexOf('q')===0 || r.name.indexOf('module')===0)) names[r.name]=1;
      });
      Object.keys(names).forEach(function(name){
        var sel = slide.querySelector('input[type="radio"][name="'+CSS.escape(name)+'"]:checked');
        if(sel) out[name]=sel.value;
      });
      $$('input[type="checkbox"]', slide).forEach(function(ch){
        var key = ch.name || ch.id || '';
        if(!(key && (key.indexOf('q')===0 || key.indexOf('module')===0))) return;
        if(ch.checked) out[key] = ch.value || 'on';
      });
      $$('textarea, select', slide).forEach(function(el){
        var key = el.name || el.id || '';
        if(!(key && (key.indexOf('q')===0 || key.indexOf('module')===0))) return;
        var v = trim(el.value); if(v!=='') out[key]=v;
      });
      return out;
    }

    var submitting=false;
    async function doSubmit(){
      var ids = getIds();
      var el  = ids.slideIdEl;
      var openS  = el ? (el.getAttribute('data-open') || '')  : '';
      var closeS = el ? (el.getAttribute('data-close') || '') : '';
      var gate = statusNow(openS, closeS);
      if(gate.state!=='open'){
        notify(gate.state==='soon' ? ('This exercise is not open yet. It opens at '+openS+' ('+TZ_LABEL+').') : ('This exercise is already closed. It closed at '+closeS+' ('+TZ_LABEL+').'));
        return;
      }
      if(!ids.studentId){ notify('Please enter your student ID (or log in).'); if(sidInput) sidInput.focus(); return; }
      var answers = collectAnswers();
      if(!Object.keys(answers).length){ notify('No filled answers on this slide.'); return; }
      if(submitting) return; submitting=true;

      var prevTxt = btnSubmit.textContent;
      btnSubmit.textContent='⏳ Sending…'; btnSubmit.disabled=true;

      slide.__lastSubmittedAnswers = {
        studentId: ids.studentId, slide: ids.slideId,
        timestamp: new Date().toLocaleString('pt-BR',{timeZone:'America/Sao_Paulo'}),
        answers: answers
      };

      try{
        var res = await fetch(ENDPOINT, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            student: ids.studentId,
            exercise_id: ids.slideId,
            answers: answers,
            tsClient: new Date().toISOString(),
            open: openS, close: closeS
          }),
          credentials:'omit'
        });
        var data = {}; try{ data = await res.json(); }catch(e){}
        if(res.status===403 && data && data.status==='closed_window'){
          notify('Submission blocked: window closed.');
          slide.__lastSubmittedAnswers = null; if(btnDown) btnDown.disabled=true;
          clearLock(ids); restoreSubmitUI();
        }else if(res.ok && data && (data.status==='success' || data.status==='duplicate')){
          setLock(ids); markSubmittedUI(); if(btnDown) btnDown.disabled=false;
          notify(data.status==='duplicate' ? 'You had already submitted this exercise.' : 'Submitted! Thank you.');
        }else{
          notify('Submission error: '+(data && data.message ? data.message : ('HTTP '+res.status)));
          slide.__lastSubmittedAnswers = null; if(btnDown) btnDown.disabled=true;
          clearLock(ids); restoreSubmitUI();
        }
      }catch(e){
        notify('Submission error: '+e.message);
        slide.__lastSubmittedAnswers = null; if(btnDown) btnDown.disabled=true;
        clearLock(ids); restoreSubmitUI();
      }finally{
        submitting=false; btnSubmit.textContent=prevTxt; paintWindow();
      }
    }

    function downloadTXT(){
      var p = slide.__lastSubmittedAnswers;
      if(!p){ notify('No answers available to download yet.'); return; }
      var txt = '📝 Student Answers Summary\n\n';
      txt += 'Student ID: '+p.studentId+'\nSlide: '+p.slide+'\nTimestamp: '+p.timestamp+'\n\nAnswers:\n';
      Object.keys(p.answers).forEach(function(k){ txt += '- '+k+': '+p.answers[k]+'\n'; });
      var blob = new Blob([txt], {type:'text/plain'});
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (p.studentId+'_'+p.slide+'_'+p.timestamp.replace(/[/:\s]/g,'-')+'_answers.txt');
      document.body.appendChild(a); a.click(); a.remove();
    }

    var fbShown=false;
    function toggleFeedback(){
      var ids = getIds();
      var el  = ids.slideIdEl;
      var st  = statusNow(el?el.getAttribute('data-open'):'', el?el.getAttribute('data-close'):'').state;
      if(st!=='closed'){ if(btnFB) btnFB.disabled=true; return; }
      var blocks = findFeedbackBlocks(); if(!blocks.length){ notify('Feedback unavailable at the moment.'); return; }
      fbShown=!fbShown; blocks.forEach(function(b){ b.style.display = fbShown ? 'block' : 'none'; });
      btnFB.textContent = fbShown ? 'Hide Feedback' : 'Show Feedback';
    }

    async function checkServerSubmitted(){
      try{
        var ids = getIds(); if(!(ids.studentId && ids.slideId)) return;
        var u = new URL(ENDPOINT);
        u.searchParams.set('student', ids.studentId);
        u.searchParams.set('exercise_id', ids.slideId);
        var r = await fetch(u, { method:'GET', credentials:'omit' });
        var d = {}; try{ d = await r.json(); }catch(e){}
        if(d && d.found){
          setLock(ids);
          slide.__lastSubmittedAnswers = slide.__lastSubmittedAnswers || {
            studentId: ids.studentId, slide: ids.slideId,
            timestamp: new Date().toLocaleString('pt-BR',{timeZone:'America/Sao_Paulo'}),
            answers: collectAnswers()
          };
          markSubmittedUI();
        }
      }catch(e){}
    }

    function init(){
      // autopreenche ID se existir
      var auto = trim(window.studentId || localStorage.getItem('studentId') || sessionStorage.getItem('studentId') || '');
      sidInput = $('#student-id', slide);
      if (sidInput && auto) sidInput.value = auto;

      if(btnSubmit) btnSubmit.addEventListener('click', doSubmit);
      if(btnDown)   btnDown.addEventListener('click', downloadTXT);
      if(btnFB)     btnFB.addEventListener('click', toggleFeedback);

      paintWindow(); setInterval(paintWindow, 1000);

      var ids = getIds();
      if(isLocked(ids)) markSubmittedUI();
      checkServerSubmitted();
    }

    if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init, {once:true}); }
    else { init(); }
  }catch(err){
    console.error('[EXW] init error:', err);
  }
})();
</script>
