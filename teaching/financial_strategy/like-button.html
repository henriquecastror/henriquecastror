<div class="like-container">
  <button class="like-btn" title="Click if you got this">
    ✅ <span class="like-text">Got it</span>
    <span class="like-count">(0)</span>
  </button>
</div>

<script>
(function() {
  const root = document.currentScript && document.currentScript.previousElementSibling;
  if (!root || !root.matches('.like-container')) return;
  const btn = root.querySelector('.like-btn');
  const textSpan = btn && btn.querySelector('.like-text');
  const countSpan = btn && btn.querySelector('.like-count');
  if (!btn || !textSpan || !countSpan) return;

  const scriptURL = "https://script.google.com/macros/s/AKfycbxfBAS6Bhm9CwTH8OKjSwPuffvcm7DkdfAc0EeatJBHSSzStLWv-6U7-W4ZgvGdmusoeA/exec";

  function getSlideHashForSection(sec) {
    if (sec && sec.id) return `#/${sec.id}`;
    if (window.Reveal && Reveal.getIndices) {
      const idx = Reveal.getIndices(sec || Reveal.getCurrentSlide());
      if (idx && typeof idx.h === 'number') {
        return typeof idx.v === 'number' && idx.v > 0 ? `#/${idx.h}/${idx.v}` : `#/${idx.h}`;
      }
    }
    return location.hash || '#';
  }

  function getSlideURLForThisButton() {
    const sec = root.closest('section');
    const hash = getSlideHashForSection(sec);
    return location.origin + location.pathname + location.search + hash;
  }

  function pageId() {
    return getSlideURLForThisButton();
  }

  function setGotItState() {
    textSpan.textContent = "Got it ✔";
    btn.classList.add("liked");
    btn.title = "You have already confirmed";
  }

  if (localStorage.getItem(`liked_${pageId()}`)) setGotItState();

  btn.addEventListener("click", () => {
    const pid = pageId();
    if (localStorage.getItem(`liked_${pid}`)) return;

    localStorage.setItem(`liked_${pid}`, "true");
    setGotItState();
    btn.classList.add("pulse");
    setTimeout(() => btn.classList.remove("pulse"), 300);

    const currentCount = parseInt(countSpan.textContent.replace(/[^\d]/g, '')) || 0;
    countSpan.textContent = `(${currentCount + 1})`;

    fetch(`${scriptURL}?like=1&page=${encodeURIComponent(pid)}`)
      .then(res => res.json())
      .then(() => updateCount())
      .catch(err => console.error("Error marking got it:", err));
  });

  function updateCount() {
    const pid = pageId();
    fetch(`${scriptURL}?getLikes=1&page=${encodeURIComponent(pid)}`)
      .then(res => res.json())
      .then(data => {
        const count = data && typeof data.count === 'number' ? data.count : 0;
        countSpan.textContent = `(${count})`;
        if (localStorage.getItem(`liked_${pid}`)) setGotItState();
      })
      .catch(() => {});
  }

  updateCount();
  const interval = setInterval(updateCount, 3000);

  const obs = new MutationObserver(() => {
    if (!document.body.contains(root)) {
      clearInterval(interval);
      obs.disconnect();
    }
  });
  obs.observe(document.body, { childList: true, subtree: true });

  if (window.Reveal && Reveal.addEventListener) {
    Reveal.addEventListener('slidechanged', updateCount);
  }
})();
</script>

<style>
.like-container { position: relative; margin-top: 20px; text-align: right; }
.like-btn {
  background-color: #f0fdf4; border: 2px solid #86efac; color: #15803d;
  padding: 8px 16px; font-size: 16px; border-radius: 25px;
  display: inline-flex; align-items: center; gap: 8px; font-weight: 500;
  box-shadow: 1px 1px 4px rgba(0,0,0,0.08);
  transition: background-color 0.2s, color 0.2s, opacity 0.2s, transform 0.15s;
  cursor: pointer;
}
.like-btn:hover { background-color: #dcfce7; border-color: #4ade80; color: #166534; }
.like-btn.liked { background-color: #f0f0f0; color: #888; border-color: #ddd; opacity: 0.6; cursor: default; }
.like-btn .like-count {
  background-color: #86efac; color: #064e3b; padding: 2px 8px; border-radius: 12px;
  font-size: 14px; font-weight: bold;
}
@keyframes pulse { 0% {transform:scale(1)} 50% {transform:scale(1.08)} 100% {transform:scale(1)} }
.pulse { animation: pulse 0.3s ease; }
</style>
