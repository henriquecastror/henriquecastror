<!-- threads-gate.html -->
<!-- Gate + conte√∫do inline do threads, injetado somente para logins permitidos -->

<script>
  // ===== Allowlist (inclui professor) =====
  const CHAT_ALLOWLIST = new Set([
    'hcm', // professor
    'aluno5',
    'bruno_pereira',
    'jos√©_allocca',
    'ana_santos',
    'eduardo_senedese',
    'vanessa_meieler',
    'leonardo_derviche',
    'jo√£o_coghi',
    'luisa_fernandes',
    'laura_nakama',
    'ludmilla_moraes',
    // variantes sem acento (robustez)
    'jose_allocca', 'joao_coghi'
  ]);

  const stripDiacritics = s => (s || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  const normalizeLogin  = s => {
    const raw = String(s || '').trim().toLowerCase();
    if (!raw) return '';
    return raw.includes('@') ? raw.split('@')[0] : raw;
  };

  function getCurrentUser(){
    try{
      const seq = [
        () => localStorage.getItem('studentId'),
        () => localStorage.getItem('login'),
        () => (window.VHCM && window.VHCM.user) ? String(window.VHCM.user) : '',
      ];
      for (const f of seq){
        const out = normalizeLogin(f());
        if (out) return out;
      }
      const m = document.cookie.match(/(?:^|;\s*)(studentId|login|vhcm_user|vhcm_login|user)=([^;]+)/i);
      if (m) return normalizeLogin(decodeURIComponent(m[2]));
    }catch(_){}
    return '';
  }

  function isAllowed(){
    const user  = getCurrentUser();
    const ascii = stripDiacritics(user);
    return CHAT_ALLOWLIST.has(user) || CHAT_ALLOWLIST.has(ascii);
  }

  // Injeta o conte√∫do do template apenas se permitido

  async function injectIfAllowed(){
    if (!isAllowed()){
      console.debug('[threads-gate] user not allowed, chat hidden');
      return;
    }
    if (document.querySelector('[data-vhcm-chat="threads"]')) return;

    const tpl = document.getElementById('vhcm-threads-tpl');
    if (!tpl){ console.warn('[threads-gate] template n√£o encontrado'); return; }

    // 1) injeta o HTML
    const holder = document.createElement('div');
    holder.setAttribute('data-vhcm-chat','threads');
    holder.innerHTML = tpl.innerHTML;
    document.body.appendChild(holder);

    // 2) for√ßa execu√ß√£o de TODOS os <script> rec√©m-inseridos (na ordem)
    const scripts = holder.querySelectorAll('script');
    for (const old of scripts) {
      const s = document.createElement('script');
      // copia atributos (type, etc.)
      for (const {name, value} of Array.from(old.attributes)) s.setAttribute(name, value);
      if (old.src) {
        s.src = old.src;              // se um dia voc√™ usar scripts externos
        s.async = false;
      } else {
        s.textContent = old.textContent; // inline JS
      }
      old.replaceWith(s);             // substitui para preservar a ordem de execu√ß√£o
    }

    console.debug('[threads-gate] chat injected & scripts executed');
  }





  document.addEventListener('DOMContentLoaded', () => {
    injectIfAllowed();
    // se o login for setado um pouco depois:
    setTimeout(injectIfAllowed, 400);
    setTimeout(injectIfAllowed, 1000);
    // se disparar evento de login
    document.addEventListener('auth:login', () => setTimeout(injectIfAllowed, 50));
    // se outra aba/setter atualizar credenciais
    window.addEventListener('storage', (e)=>{
      if (['studentId','login','vhcm_user','vhcm_login','user'].includes(e.key||'')){
        setTimeout(injectIfAllowed, 50);
      }
    });
  });
</script>

<!-- ============== CONTE√öDO ORIGINAL DO threads.html, INATIVO EM TEMPLATE ============== -->
<template id="vhcm-threads-tpl">
  <!-- ===================== CLASS CHAT (Widget) ===================== -->
  <script>
  function onLoginSuccess(studentId) {
    window.studentId = String(studentId || '').trim();
    localStorage.setItem('studentId', window.studentId);
    document.dispatchEvent(new CustomEvent('auth:login', { detail: { studentId: window.studentId }}));
    console.debug('[Login] onLoginSuccess ‚Üí', window.studentId);
  }
  </script>

  <div id="cmt-root">
    <button id="cmt-bubble" aria-label="Open class chat">
      <span class="cmt-icon">üí¨</span><span class="cmt-badge" id="cmt-count">0</span>
    </button>

    <aside id="cmt-panel" aria-hidden="true" aria-label="Class chat panel">
      <header class="cmt-header">
        <div class="cmt-title"><span class="cmt-dot"></span><span>Class chat</span></div>
        <div class="cmt-actions">
          <select id="cmt-target" class="cmt-filter" style="display:none"></select>
          <button id="cmt-find" class="cmt-ghost" title="Buscar/abrir login (Ctrl+K)" aria-label="Find student" style="display:none">üîé</button>
          <button id="cmt-key" class="cmt-ghost" title="Set admin token" aria-label="Set admin token" style="display:none">üîë</button>
          <button id="cmt-close" class="cmt-ghost" title="Close" aria-label="Close">‚úï</button>
        </div>
      </header>

      <div id="cmt-list" class="cmt-body" role="list"></div>

      <footer class="cmt-input">
        <textarea id="cmt-text" placeholder="Write anything to the instructor‚Ä¶"></textarea>
        <div class="cmt-row cmt-end">
          <button id="cmt-send" class="cmt-primary" aria-label="Send">Send</button>
        </div>
      </footer>
    </aside>
  </div>

  <style>
  /* === seu CSS original === */
  #cmt-root { all: initial; }
  #cmt-root * { box-sizing: border-box; font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; }
  #cmt-root button { display:inline-flex; align-items:center; justify-content:center; cursor:pointer; }
  #cmt-root input, #cmt-root textarea, #cmt-root select { display:block; }

  /* Bubble */
  #cmt-root #cmt-bubble{
    position: fixed; left:max(20px,env(safe-area-inset-left)); bottom:max(20px,env(safe-area-inset-bottom));
    display:inline-flex; gap:8px; background:linear-gradient(135deg,#7c3aed 0%,#06b6d4 100%); color:#fff;
    border:1px solid rgba(255,255,255,.18); border-radius:16px; padding:10px 12px; box-shadow:0 18px 40px rgba(0,0,0,.28);
    z-index:11000; transition:transform .18s ease, box-shadow .18s ease, opacity .18s ease;
  }
  #cmt-root #cmt-bubble:hover{ transform: translateY(-2px) }
  #cmt-root .cmt-icon{ font-size:18px; line-height:1; }
  #cmt-root .cmt-badge{ min-width:20px; height:20px; padding:0 6px; display:inline-flex; align-items:center; justify-content:center;
    background:rgba(255,255,255,.95); color:#1f2937; font-size:12px; font-weight:800; border-radius:999px; box-shadow:0 2px 6px rgba(0,0,0,.18); }
  #cmt-root .cmt-badge.alert{ background:#dc2626 !important; color:#fff !important; }

  /* Panel */
  #cmt-root #cmt-panel{
    position: fixed; left:max(20px,env(safe-area-inset-left));
    bottom: calc(max(20px,env(safe-area-inset-bottom)) + 56px);
    width: 360px; height: 600px; min-width:300px; min-height:360px; max-width:94vw; max-height:84vh;
    display:grid; grid-template-rows:auto 1fr auto; background:rgba(248,250,252,.85); color:#0f172a;
    -webkit-backdrop-filter:saturate(140%) blur(10px); backdrop-filter:saturate(140%) blur(10px);
    border:1px solid rgba(30,41,59,.12); box-shadow:0 16px 50px rgba(0,0,0,.35); border-radius:18px; overflow:hidden; z-index:12000;
    opacity:0; transform:translateY(8px) scale(.98); pointer-events:none; transition:opacity .22s ease, transform .22s ease; resize:both;
  }
  #cmt-root #cmt-panel.open{ opacity:1; transform:translateY(0) scale(1); pointer-events:auto; }

  /* Header */
  #cmt-root .cmt-header{ display:flex; align-items:center; gap:10px; padding:12px 14px; background:linear-gradient(180deg,#334155 0%,#475569 100%); color:#fff; }
  #cmt-root .cmt-title{ display:flex; align-items:center; gap:8px; font-weight:700; letter-spacing:.2px;}
  #cmt-root .cmt-dot{ width:10px; height:10px; border-radius:50%; background:#22c55e; box-shadow:0 0 0 3px rgba(34,197,94,.22); }
  #cmt-root .cmt-dot.alert{ background:#f97316; }
  #cmt-root .cmt-dot.pulse{ animation:cmtPing 1.5s ease-out infinite; }
  @keyframes cmtPing{
    0%{box-shadow:0 0 0 0 rgba(249,115,22,.45);}
    70%{box-shadow:0 0 0 12px rgba(249,115,22,0);}
    100%{box-shadow:0 0 0 0 rgba(249,115,22,0);}
  }
  #cmt-root .cmt-actions{ margin-left:auto; display:flex; gap:8px; align-items:center; flex-wrap:nowrap; }
  #cmt-root .cmt-ghost{ padding:6px 10px; border-radius:10px; background:rgba(255,255,255,.18); border:1px solid rgba(255,255,255,.25); }
  #cmt-root .cmt-ghost:hover{ background:rgba(255,255,255,.28); }

  /* Select */
  #cmt-root .cmt-filter{
    max-width:260px; padding:6px 8px; border-radius:8px; font-size:12px;
    background:#fff; color:#0f172a; border:1px solid rgba(30,41,59,.25);
    appearance:auto;
  }
  #cmt-root .cmt-filter option{ color:#0f172a; background:#fff; }

  /* Body */
  #cmt-root .cmt-body{ padding:12px 10px 16px 10px; overflow:auto; }

  /* Mensagens */
  #cmt-root .cmt-msg{
    position:relative; display:flex; align-items:flex-end; gap:8px; margin:12px 6px;
    width:auto; max-width:calc(100% - 20px);
  }
  #cmt-root .cmt-msg.other{ flex-direction:row; justify-content:flex-start; margin-right:auto; margin-left:0; }
  #cmt-root .cmt-msg.me   { flex-direction:row-reverse; justify-content:flex-end; margin-left:auto; margin-right:0 !important; }

  #cmt-root .cmt-avatar{
    width:28px; height:28px; min-width:28px; min-height:28px; border-radius:50%; color:#fff; font-weight:700;
    display:flex; align-items:center; justify-content:center; box-shadow:0 4px 12px rgba(0,0,0,.12);
    font-size:12px;
  }
  #cmt-root .cmt-avatar.instr{ background:#7c3aed; font-size:10.5px; } /* 'hcm' */

  #cmt-root .cmt-meta-wrap{ position:relative; display:flex; flex-direction:column; align-items:flex-start; max-width:78%; }
  #cmt-root .cmt-msg.me .cmt-meta-wrap{ align-items:flex-end; }
  #cmt-root .cmt-msg.me .cmt-meta{ text-align:right; justify-content:flex-end; width:100%; }
  #cmt-root .cmt-meta{ display:flex; align-items:center; gap:8px; font-size:11px; color:#64748b; margin:0 4px 6px 4px; line-height:1.2; word-break:break-word; overflow-wrap:anywhere; }
  #cmt-root .cmt-url{ font-size:11px; margin:0 4px 6px 4px; word-break:break-all; }
  #cmt-root .cmt-url a{ color:#0ea5e9; }

  #cmt-root .cmt-bubble{ display:inline-block; max-width:100%; padding:10px 12px; border-radius:14px; border:1px solid rgba(30,41,59,.12);
    background:rgba(255,255,255,.92); box-shadow:0 6px 14px rgba(0,0,0,.06); line-height:1.45; white-space:pre-wrap; word-break:break-word; overflow-wrap:anywhere; font-size:12px; }
  #cmt-root .cmt-msg.me .cmt-bubble{ background:#eef2ff; border-color:rgba(79,70,229,.20); margin-left:auto; }

  /* Delete */
  #cmt-root .cmt-del{
    position:absolute; top:-2px; opacity:0; transform:translateY(-2px);
    padding:4px 6px; font-size:11px; border-radius:8px; line-height:1;
    background:rgba(244,63,94,.12); color:#ef4444; border:1px solid rgba(239,68,68,.25);
    transition:opacity .15s ease, transform .15s ease;
  }
  #cmt-root .cmt-msg.other .cmt-del{ left:-26px; }
  #cmt-root .cmt-msg.me .cmt-del{ right:-26px; }
  #cmt-root .cmt-msg:hover .cmt-del{ opacity:1; transform:translateY(0); }

  /* Input */
  #cmt-root .cmt-input{ border-top:1px solid rgba(30,41,59,.12); padding:12px; display:flex; flex-direction:column; gap:8px; background:rgba(255,255,255,.6); }
  #cmt-root .cmt-row{ display:flex; gap:8px; }
  #cmt-root .cmt-end{ justify-content:flex-end; }
  #cmt-root .cmt-input textarea{ width:100%; font-size:14px; padding:10px 12px; border-radius:12px; border:1px solid rgba(30,41,59,.15);
    color:#0f172a; background:rgba(255,255,255,.9); outline:none; min-height:100px; max-height:160px; resize:vertical; }
  #cmt-root .cmt-primary{ background:#6366f1; color:#fff; border:none; padding:10px 14px; border-radius:12px; font-weight:600;
    box-shadow:0 6px 18px rgba(99,102,241,.35); transition:transform .15s ease, box-shadow .2s ease, opacity .2s ease; }
  #cmt-root .cmt-primary:hover{ transform:translateY(-1px); box-shadow:0 10px 24px rgba(99,102,241,.42); }
  </style>

  <script>
  /* Slide id helper */
  window.__getSlideId = window.__getSlideId || function(){
    if (window.Reveal?.getCurrentSlide) {
      const s = Reveal.getCurrentSlide();
      if (s?.getAttribute('id')) return s.getAttribute('id');
      if (Reveal.getIndices) { const idx = Reveal.getIndices(); return `h${idx.h}_v${idx.v||0}`; }
    }
    const hash = (location.hash||'').replace(/^#\/?/, '');
    return hash || 'slide-unknown';
  };
  </script>

  <script>
  (function(){
    const COMMENTS_SCOPE = 'presentation';
    const scriptURL = 'https://course-chat.hcmrtns.workers.dev';
    const INSTRUCTOR_KEY = (document.querySelector('meta[name="cmt-instructor-login"]')?.content || 'hcm').toLowerCase();

    const root=document.getElementById('cmt-root'),
          bubble=root.querySelector('#cmt-bubble'),
          bubbleCt=root.querySelector('#cmt-count'),
          panel=root.querySelector('#cmt-panel'),
          closeBtn=root.querySelector('#cmt-close'),
          listEl=root.querySelector('#cmt-list'),
          textIn=root.querySelector('#cmt-text'),
          sendBtn=root.querySelector('#cmt-send'),
          targetSel=root.querySelector('#cmt-target'),
          keyBtn=root.querySelector('#cmt-key'),
          findBtn=root.querySelector('#cmt-find'),
          dot=root.querySelector('.cmt-dot');

    let __lastTsMs=0, __haveInitial=false, __posting=false, __lastSent={sig:'',at:0}, pollTimer=null;
    let inboxTimer=null, __inboxMs=0;

    const loadJSON = (k, def)=> { try{ return JSON.parse(localStorage.getItem(k) || 'null') ?? def; }catch{ return def; } };
    const saveJSON = (k, v)=> localStorage.setItem(k, JSON.stringify(v));
    let unread = loadJSON('cmt_unread', {});
    let newUntil = loadJSON('cmt_new_until', {});
    let selfUnread = Number(localStorage.getItem('cmt_unread_self')||'0') || 0;

    const forceInstructor = localStorage.getItem('cmt_force_instructor') === '1';
    function setForceInstructor(on){ localStorage.setItem('cmt_force_instructor', on ? '1' : '0'); }

    const loggedLogin = ()=>{
      const seq=[
        ()=> (window.studentId||'').toString().trim(),
        ()=> (localStorage.getItem('studentId')||'').toString().trim(),
        ()=> (window.__auth?.student?.login||'').toString().trim(),
        ()=> (document.getElementById('student-id')?.value||'').toString().trim(),
        ()=> (localStorage.getItem('login')||'').toString().trim(),
      ];
      for (const f of seq){ const v=f(); if (v) return v; }
      return '';
    };

    const adminToken = ()=> (localStorage.getItem('cmt_admin_token')||'').trim();
    const isInstructorMode = ()=> forceInstructor || (loggedLogin()||'').toLowerCase().includes(INSTRUCTOR_KEY);

    const scopeId = ()=> COMMENTS_SCOPE==='slide'
      ? (window.__getSlideId ? window.__getSlideId() : 'slide-unknown')
      : (location.origin + location.pathname + location.search);

    function detectModuleId(){
      const meta = document.querySelector('meta[name="module-id"]');
      if (meta?.content) return String(meta.content).trim();
      const d = document.body?.dataset?.moduleId; if (d) return String(d).trim();
      const m = (location.pathname||'').match(/mod(?:ulo)?[-_]?(\d+)/i) || (location.pathname||'').match(/(mod\d+)/i);
      return m ? (m[1] ? `mod${m[1]}` : m[0]) : '';
    }
    function hashColor(s){ let h=0; for(let i=0;i<s.length;i++) h=((h<<5)-h)+s.charCodeAt(i)|0; return `hsl(${Math.abs(h)%360},70%,50%)`; }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;', '"':'&quot;', "'":'&#39;' }[m])); }
    function stripUrls(text){ return String(text||'').replace(/https?:\/\/[^\s)]+/g,'').trim(); }
    const looksLikeUrl = (s)=> /^https?:\/\//i.test(String(s||'').trim());
    function itemKey(c){ const id=(c.id||'').trim(); if (id) return id; const who=(c.student||'').trim(), ts=(String(c.ts||c.timestamp)||'').trim(), txt=(c.comment||'').slice(0,24); return `k_${who}__${ts}__${txt}`; }

    const unreadTotal = ()=> Object.values(unread).reduce((a,b)=> a + (Number(b)||0), 0);
    function clearAlerts(){ bubbleCt.classList.remove('alert'); if (dot) dot.classList.remove('alert','pulse'); }
    function updateBubbleCount(){ bubbleCt.textContent = String(isInstructorMode() ? unreadTotal() : selfUnread); }
    function maybeAlert(){
      const count = isInstructorMode() ? unreadTotal() : selfUnread;
      if (!panel.classList.contains('open') && count>0){
        bubbleCt.classList.add('alert'); if (dot) dot.classList.add('alert','pulse');
      } else { clearAlerts(); }
    }

    function optionLabel(login){
      const n = unread[login] || 0;
      const isNew = (newUntil[login]||0) > Date.now();
      return `${isNew ? 'NEW ‚Äì ' : ''}${login}${n>0 ? ' ['+n+']' : ''}`;
    }
    function renderSelect(){
      if (!isInstructorMode()) { targetSel.style.display='none'; findBtn.style.display='none'; return; }
      const current = localStorage.getItem('cmt_last_target') || '';
      const base = Object.keys(unread).filter(Boolean);
      if (current && !base.includes(current)) base.unshift(current);
      const ordered = [...new Set(base)].sort((a,b)=> ((unread[b]||0)-(unread[a]||0)) || a.localeCompare(b));
      if (!ordered.length){
        targetSel.innerHTML = `<option disabled>‚Äî sem novas ‚Äî</option>`;
        targetSel.style.display=''; findBtn.style.display=''; return;
      }
      targetSel.innerHTML = ordered.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(optionLabel(s))}</option>`).join('');
      const hasCurrent = ordered.includes(current);
      if (hasCurrent) targetSel.value=current; else targetSel.selectedIndex=0;
      targetSel.style.display=''; findBtn.style.display='';
    }

    targetSel.addEventListener('change', ()=>{
      const sel = targetSel.value || '';
      localStorage.setItem('cmt_last_target', sel);
      if (unread[sel]) { delete unread[sel]; saveJSON('cmt_unread', unread); }
      if (newUntil[sel]) { delete newUntil[sel]; saveJSON('cmt_new_until', newUntil); }
      clearAlerts(); renderSelect(); updateBubbleCount(); hardReload();
    });

    function askLogin(){
      const v = prompt('Digite o login do aluno:', localStorage.getItem('cmt_last_target')||'') || '';
      const login = v.trim(); if (!login) return;
      localStorage.setItem('cmt_last_target', login);
      if (unread[login]) { delete unread[login]; saveJSON('cmt_unread', unread); }
      if (newUntil[login]) { delete newUntil[login]; saveJSON('cmt_new_until', newUntil); }
      clearAlerts(); renderSelect(); updateBubbleCount(); hardReload();
    }
    findBtn.addEventListener('click', askLogin);
    window.addEventListener('keydown', (e)=>{ if (e.ctrlKey && (e.key==='k' || e.key==='K')){ e.preventDefault(); askLogin(); } });

    function startInboxWatch(){
      if (!isInstructorMode()) return;
      if (inboxTimer) { clearInterval(inboxTimer); inboxTimer=null; }
      const headers = adminToken()? {'x-admin-token': adminToken()} : {};
      __inboxMs = Date.now() - 60000;

      inboxTimer = setInterval(async ()=>{
        try{
          const url = `${scriptURL}/comments?all=1&since_ms=${__inboxMs}`;
          const r = await fetch(url, { headers });
          if (!r.ok) return;
          const j = await r.json();
          const items = (j.items||[]).map(x=>{ if(!x.ts && x.timestamp){ const ms=Date.parse(x.timestamp); if (isFinite(ms)) x.ts=ms; } return x; });
          if (!items.length) return;

          for (const it of items){ const ms=Number(it.ts||0); if (isFinite(ms) && ms > __inboxMs) __inboxMs=ms; }

          const viewing = (targetSel.value || localStorage.getItem('cmt_last_target') || '').trim();
          const isOpen = panel.classList.contains('open');

          let changed=false, anyAlert=false;
          for (const it of items){
            const isStudent = String(it.author||'').toLowerCase()==='student';
            const who = String(it.student||'').trim();
            if (!who || !isStudent) continue;

            if (isOpen && who === viewing) continue;

            unread[who] = (unread[who]||0) + 1;
            if (!newUntil[who]) newUntil[who] = Date.now() + 10*60*1000;
            changed=true; anyAlert=true;
          }

          if (changed){
            saveJSON('cmt_unread', unread);
            saveJSON('cmt_new_until', newUntil);
            renderSelect();
            updateBubbleCount();
            if (anyAlert) { maybeAlert(); }
          }
        }catch(_){}
      }, 4000);
    }

    function buildMsgHTML(c, viewer){
      const who = String(c.student||'').trim();
      const author = String(c.author||'').toLowerCase();
      const isInstr = author === 'instructor';

      const whenMs=c.ts?Number(c.ts):(c.timestamp?Date.parse(c.timestamp):NaN);
      const when=isFinite(whenMs)? new Date(whenMs).toLocaleString() : (c.timestamp||'');

      const whoLabel = isInstr ? 'hcm' : who;

      const asInstructor = viewer.mode==='instructor';
      const loginLower = (viewer.login||'').toLowerCase();
      const isMe = asInstructor ? isInstr : (!isInstr && who.toLowerCase()===loginLower);

      const metaParts=[when, whoLabel, (c.module_id||''), (c.slide_id||'')].filter(p=>p && !looksLikeUrl(p));
      const meta=metaParts.join(' ‚Ä¢ ');

      const urlHtml = (!isInstr && c.page_url)
        ? `<div class="cmt-url"><a href="${escapeHtml(c.page_url)}" target="_blank" rel="noopener">${escapeHtml(c.page_url)}</a></div>` : '';

      const safe=escapeHtml(stripUrls(String(c.comment||'')));

      const cls=isMe?'me':'other';
      const init = isInstr ? 'hcm' : (who||'Anonymous').slice(0,2).toUpperCase();
      const avatarCls = isInstr ? 'cmt-avatar instr' : 'cmt-avatar';
      const col=isInstr?'#7c3aed':hashColor(who||'Anonymous');
      const key=itemKey(c);

      const canDelete = !!(viewer.canDelete && (c.id||'').trim());
      const delBtn = canDelete ? `<button class="cmt-del" data-del="${escapeHtml(c.id)}" title="Delete">üóëÔ∏è</button>` : '';

      return `<div class="cmt-msg ${cls}" role="listitem" data-id="${key}">
        <div class="${avatarCls}" style="background:${col}">${init}</div>
        <div class="cmt-meta-wrap">
          ${delBtn}
          <div class="cmt-meta"><span>${meta}</span></div>
          ${urlHtml}
          <div class="cmt-bubble">${safe}</div>
        </div>
      </div>`;
    }

    function render(items, viewer){ listEl.innerHTML = items.map(c=> buildMsgHTML(c, viewer)).join(''); }
    const isNearBottom=()=> listEl.scrollHeight - (listEl.scrollTop + listEl.clientHeight) < 120;
    const scrollToBottom=()=>{ listEl.scrollTop = listEl.scrollHeight; };

    const BASE_POLL_MS=3000;
    function scheduleNextPoll(delay){
      if (pollTimer) clearTimeout(pollTimer);
      if (document.hidden) return;
      pollTimer=setTimeout(()=> load({forceScroll:isNearBottom()}), delay ?? BASE_POLL_MS);
    }
    function normalizeItems(arr){ return (arr||[]).map(x=>{ if(!x.ts && x.timestamp){ const ms=Date.parse(x.timestamp); if (isFinite(ms)) x.ts=ms; } return x; }); }

    async function deleteComment(id){
      if (!adminToken()){ alert('Admin token ausente. Clique no üîë para setar.'); return; }
      if (!confirm('Excluir este coment√°rio?')) return;
      const headers = {'x-admin-token': adminToken()};
      let ok=false;
      try{ const r = await fetch(`${scriptURL}/comments/${encodeURIComponent(id)}`, { method:'DELETE', headers }); ok = r.ok; }catch(_){}
      if (!ok){
        try{
          const r2 = await fetch(`${scriptURL}/comments/delete`, { method:'POST', headers:{...headers,'Content-Type':'application/json'}, body:JSON.stringify({id}) });
          ok = r2.ok || (await r2.json().catch(()=>({}))).status==='success';
        }catch(_){}
      }
      if (!ok){ alert('Falha ao excluir. Verifique o token e as permiss√µes.'); return; }
      const msg = listEl.querySelector(`[data-id="${CSS.escape(id)}"]`) || listEl.querySelector(`[data-del="${CSS.escape(id)}"]`)?.closest('.cmt-msg');
      if (msg) msg.remove();
    }
    listEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('button.cmt-del');
      if (!btn) return;
      const id = btn.getAttribute('data-del');
      if (id) deleteComment(id);
    });

    function load({forceScroll=false}={}){
      const shouldStick = forceScroll || isNearBottom();
      const meLogin=(loggedLogin()||'').trim();

      const viewer = {
        mode: isInstructorMode() ? 'instructor' : 'student',
        login: meLogin,
        canDelete: isInstructorMode() && !!adminToken()
      };

      let viewing = meLogin;
      if (isInstructorMode()){
        viewing = targetSel.value || localStorage.getItem('cmt_last_target') || meLogin;
      }
      if (!viewing){ scheduleNextPoll(); return; }

      const base=`${scriptURL}/comments?student=${encodeURIComponent(viewing)}&limit=1000`;
      const url=(__haveInitial && __lastTsMs) ? `${base}&since_ms=${__lastTsMs}` : base;

      fetch(url).then(r=>r.json()).then(d=>{
        const incoming=normalizeItems(Array.isArray(d.items)? d.items.slice() : []);
        incoming.sort((a,b)=> (Number(a.ts||0)-Number(b.ts||0)));
        for (const it of incoming){ const ms=Number(it.ts||0); if (ms > __lastTsMs) __lastTsMs=ms; }

        if (!__haveInitial){
          render(incoming, viewer);
          __haveInitial=true; if (shouldStick) scrollToBottom();
        } else if (incoming.length){
          const fresh=incoming.filter(c=> !listEl.querySelector(`[data-id="${itemKey(c)}"]`));
          if (fresh.length){
            const frag=fresh.map(c=> buildMsgHTML(c, viewer)).join('');
            const keepBottom=isNearBottom();
            listEl.insertAdjacentHTML('beforeend', frag);
            if (keepBottom) scrollToBottom();

            const instrFreshCount = fresh.filter(c => String(c.author||'').toLowerCase() === 'instructor').length;
            if (viewer.mode==='student' && instrFreshCount>0 && !panel.classList.contains('open')){
              selfUnread += instrFreshCount;
              localStorage.setItem('cmt_unread_self', String(selfUnread));
              updateBubbleCount();
              maybeAlert();
            }
          }
        }
      }).catch(()=>{}).finally(()=> scheduleNextPoll());
    }

    function updateKeyBtnLabel(){
      const tok = adminToken();
      if (tok) { keyBtn.title = `Admin token set (‚Ä¶${tok.slice(-4)})`; keyBtn.textContent='üîë‚úì'; }
      else     { keyBtn.title='Set admin token'; keyBtn.textContent='üîë'; }
    }

    function setInstructorUI(){
      const on = isInstructorMode();
      keyBtn.style.display  = (on || !!adminToken()) ? '' : 'none';
      findBtn.style.display = on ? '' : 'none';
      if (on){ updateKeyBtnLabel(); renderSelect(); startInboxWatch(); }
      updateBubbleCount();
    }

    keyBtn.addEventListener('click', ()=>{
      const current = adminToken();
      const next = prompt(current ? 'Replace admin token (vazio para limpar):' : 'Cole o admin token:', current || '');
      if (next === null) return;
      const v = String(next||'').trim();
      if (v) localStorage.setItem('cmt_admin_token', v);
      else   localStorage.removeItem('cmt_admin_token');
      updateKeyBtnLabel(); clearAlerts(); renderSelect(); updateBubbleCount(); startInboxWatch();
    });

    function hardReload(){ __haveInitial=false; __lastTsMs=0; load({forceScroll:true}); }

    const openPanel=()=>{ 
      panel.classList.add('open'); 
      panel.setAttribute('aria-hidden','false'); 
      clearAlerts();

      if (isInstructorMode()){
        unread = {}; newUntil = {};
        saveJSON('cmt_unread', unread);
        saveJSON('cmt_new_until', newUntil);
      } else {
        selfUnread = 0;
        localStorage.setItem('cmt_unread_self', '0');
      }

      renderSelect(); 
      updateBubbleCount(); 
      startInboxWatch(); 
      hardReload(); 
      setTimeout(scrollToBottom,80); 
    };

    const closePanel=()=>{ 
      panel.classList.remove('open'); 
      panel.setAttribute('aria-hidden','true'); 
      maybeAlert(); 
    };

    bubble.addEventListener('click', ()=> panel.classList.contains('open') ? closePanel() : openPanel());
    closeBtn.addEventListener('click', closePanel);
    sendBtn.addEventListener('click', post);
    textIn.addEventListener('keydown', e=>{ if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); post(); } });

    window.addEventListener('keydown', (e)=>{
      if (e.ctrlKey && e.altKey && (e.key==='i' || e.key==='I')){
        const now = !(localStorage.getItem('cmt_force_instructor')==='1');
        setForceInstructor(now);
        alert(`Instructor UI: ${now ? 'ON' : 'OFF'}`);
        setInstructorUI();
        if (now) startInboxWatch();
      }
      if (e.ctrlKey && (e.key==='k' || e.key==='K')){ e.preventDefault(); askLogin(); }
    });

    document.addEventListener('visibilitychange', ()=>{
      if (document.hidden){
        if (pollTimer){ clearTimeout(pollTimer); pollTimer=null; }
      } else {
        renderSelect(); startInboxWatch(); updateBubbleCount(); scheduleNextPoll(100);
      }
    });

    function post(){
      if (__posting) return;
      const s=loggedLogin(); const t=(textIn.value||'').trim();
      if (!t){ alert('Please write a comment.'); return; }

      const asInstructor=isInstructorMode();
      const targetStudent= asInstructor ? (targetSel.value||localStorage.getItem('cmt_last_target')||s) : s;
      if (asInstructor && !targetStudent){ alert("Selecione ou busque o login do aluno (üîé)."); return; }
      if (!asInstructor && !s){ alert('Fa√ßa login para comentar.'); return; }

      const now=Date.now(); const sig=`${targetStudent}__${scopeId()}__${t}`;
      if (__lastSent.sig===sig && (now-__lastSent.at)<12000){ textIn.focus(); return; }
      __lastSent={sig,at:now};

      __posting=true; sendBtn.disabled=true; sendBtn.setAttribute('aria-busy','true'); sendBtn.style.opacity='.7';

      const tempId='temp-'+now, temp={ id:tempId, ts:now, student:targetStudent, author: asInstructor?'instructor':'student',
        slide_id:scopeId(), module_id:detectModuleId(), page_url:location.href, comment:t };

      if (panel.classList.contains('open')){
        const viewer = asInstructor ? {mode:'instructor', canDelete:isInstructorMode()&&!!adminToken()} : {mode:'student', login:s, canDelete:false};
        const html=buildMsgHTML(temp, viewer);
        const keepBottom=isNearBottom(); listEl.insertAdjacentHTML('beforeend', html); if (keepBottom) scrollToBottom();
      }

      fetch(`${scriptURL}/comments`,{
        method:'POST',
        headers:{ 'Content-Type':'application/json', ...(asInstructor? {'x-admin-token': adminToken()} : {}) },
        body:JSON.stringify({ student:targetStudent, author:temp.author, slide_id:scopeId(), page_url:temp.page_url, module_id:temp.module_id, comment:t, user_agent:navigator.userAgent })
      }).then(r=>r.json()).then(d=>{
        if (d.status==='success'){
          textIn.value='';
          const tempEl=listEl.querySelector(`[data-id="${tempId}"]`); if (tempEl) tempEl.setAttribute('data-id', d.id||tempId);
          scheduleNextPoll(200);
        } else {
          const el=listEl.querySelector(`[data-id="${tempId}"]`); if (el) el.remove(); alert('Error: '+(d.message||'Unable to post'));
        }
      }).catch(()=>{
        const el=listEl.querySelector(`[data-id="${tempId}"]`); if (el) el.remove(); alert('Network error: failed to send');
      }).finally(()=>{
        __posting=false; sendBtn.disabled=false; sendBtn.removeAttribute('aria-busy'); sendBtn.style.opacity='';
      });
    }

    setInstructorUI();
    updateBubbleCount();
    load();
  })();
  </script>
</template>
