<div id="live-poll-container" style="display:none; z-index:999999; transition: all 0.4s ease;"></div>

<script>
(function() {
    const WORKER_URL = "https://course-chat.hcmrtns.workers.dev"; 
    let lastPollId = null;

    // FunÃ§Ã£o auxiliar para pegar o ID do aluno (Cookie > LocalStorage)
    const getStudentId = () => {
        const cookieSid = document.cookie.split('; ').find(row => row.startsWith('student_id='))?.split('=')[1];
        return cookieSid || localStorage.getItem("studentId") || localStorage.getItem("fs_user") || "guest";
    };

    async function checkPoll() {
        // 1. Tenta encontrar o container. Se nÃ£o achar, sai sem quebrar o resto do site.
        const pollContainer = document.getElementById('live-poll-container');
        if (!pollContainer) return;

        try {
            const sid = getStudentId();
            const res = await fetch(`${WORKER_URL}/poll/status?student_id=${sid}`);
            const data = await res.json();

            if (!data || data.is_active !== 1) {
                pollContainer.style.display = 'none';
                return;
            }

            // Centraliza o container na tela apenas se estiver ativo
            const applyStyle = () => {
                pollContainer.style.position = 'fixed';
                pollContainer.style.top = '50%';
                pollContainer.style.left = '50%';
                pollContainer.style.transform = 'translate(-50%, -50%)';
                pollContainer.style.width = '90%';
                pollContainer.style.maxWidth = '700px';
                pollContainer.style.display = 'block';
            };

            if (data.show_results === 1) {
                renderResults(pollContainer, data);
                applyStyle();
                return;
            }

            if (!localStorage.getItem('answered_' + data.poll_id)) {
                if (data.poll_id !== lastPollId) {
                    lastPollId = data.poll_id;
                    renderPoll(pollContainer, data);
                }
                applyStyle();
            } else {
                pollContainer.style.display = 'none';
            }
        } catch (e) { console.warn("Poll check failed:", e); }
    }

    function renderPoll(container, data) {
        const isNumeric = data.poll_type === 'numeric';
        const accentColor = isNumeric ? "#0891b2" : (data.poll_type === 'quiz' ? "#b91c1c" : "#1e3a8a");
        
        let inputHtml = '';
        if (isNumeric) {
            inputHtml = `<input type="number" step="any" id="numeric_answer" placeholder="Ex: 12,34" style="width:100%; padding:12px; border:2px solid #cbd5e1; border-radius:10px; font-size:1.4em; text-align:center;">`;
        } else {
            const options = JSON.parse(data.options_json || '{}');
            for (const [key, val] of Object.entries(options)) {
                if(!val) continue; 
                inputHtml += `
                    <label style="display:flex; align-items:center; margin:10px 0; padding:12px; border:1px solid #cbd5e1; border-radius:10px; cursor:pointer; background:#f8fafc;">
                        <input type="radio" name="poll_choice" value="${key}" style="margin-right:12px;"> 
                        <span><strong>${key})</strong> ${val}</span>
                    </label>`;
            }
        }

        container.innerHTML = `
            <div id="poll-inner-card" style="background:white; border-radius:15px; padding:25px; box-shadow:0 25px 50px rgba(0,0,0,0.5); border: 4px solid ${accentColor}; color: #1e293b;">
                <h3 style="margin:0 0 10px; color:${accentColor};">${isNumeric ? 'ðŸ”¢ Numeric' : 'ðŸ“Š Quiz'}</h3>
                <p style="font-weight:700; font-size:1.1em;">${data.question}</p>
                <form id="poll-form">
                    ${inputHtml}
                    <button type="submit" style="width:100%; background:${accentColor}; color:white; border:none; border-radius:8px; padding:15px; font-weight:bold; cursor:pointer; margin-top:15px;">Submit Answer</button>
                </form>
            </div>`;

        document.getElementById('poll-form').onsubmit = async (e) => {
            e.preventDefault();
            const sid = getStudentId();
            let choice = isNumeric ? document.getElementById('numeric_answer').value : document.querySelector('input[name="poll_choice"]:checked')?.value;
            if (!choice) return;

            await fetch(`${WORKER_URL}/poll/vote`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ student_id: sid, poll_id: data.poll_id, choice: choice })
            });
            localStorage.setItem('answered_' + data.poll_id, 'true');
            checkPoll();
        };
    }

    async function renderResults(container, pollData) {
        const res = await fetch(`${WORKER_URL}/poll/results`);
        const stats = await res.json();
        // ... (LÃ³gica de resultados se mantÃ©m similar, mas usando 'container' passado por argumento)
        container.innerHTML = `<div style="background:white; padding:25px; border-radius:15px; border:4px solid #059669; color: #1e293b;">
            <h3>ðŸ“Š Results</h3>
            <p>Participations: ${stats.reduce((a,b)=>a+b.count,0)}</p>
            <button onclick="this.closest('#live-poll-container').style.display='none'" style="width:100%; padding:10px; cursor:pointer;">Close</button>
        </div>`;
    }

    // Inicia o loop
    setInterval(checkPoll, 5000);
    // Aguarda um pouco o Quarto carregar o DOM
    setTimeout(checkPoll, 1000);
})();
</script>