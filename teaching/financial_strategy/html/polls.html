<div id="live-poll-container" style="display:none; z-index:9999; transition: all 0.4s ease;"></div>
<script>
(function() {
    const WORKER_URL = "https://course-chat.hcmrtns.workers.dev"; 
    const pollContainer = document.getElementById('live-poll-container');
    let lastPollId = null;

    function applyResponsiveStyle() {
        pollContainer.style.position = 'fixed';
        pollContainer.style.top = '50%';
        pollContainer.style.left = '50%';
        pollContainer.style.transform = 'translate(-50%, -50%)';
        pollContainer.style.width = '90%';
        pollContainer.style.maxWidth = '700px';
        pollContainer.style.display = 'block';
    }

    async function checkPoll() {
        try {
            const sid = localStorage.getItem("studentId") || localStorage.getItem("fs_user") || "guest";
            const res = await fetch(`${WORKER_URL}/poll/status?student_id=${sid}`); // <-- Adicionei o ?student_id=
            const data = await res.json();

            if (!data || data.is_active !== 1) {
                pollContainer.style.display = 'none';
                return;
            }

            if (data.show_results === 1) {
                renderResults(data);
                applyResponsiveStyle();
                return;
            }

            if (!localStorage.getItem('answered_' + data.poll_id)) {
                if (data.poll_id !== lastPollId) {
                    lastPollId = data.poll_id;
                    renderPoll(data);
                }
                applyResponsiveStyle();
            } else {
                // Se jÃ¡ respondeu e nÃ£o Ã© hora de mostrar resultados, mantÃ©m fechado
                pollContainer.style.display = 'none';
            }
        } catch (e) { console.error(e); }
    }

    function renderPoll(data) {
        const isNumeric = data.poll_type === 'numeric';
        const accentColor = isNumeric ? "#0891b2" : (data.poll_type === 'quiz' ? "#b91c1c" : "#1e3a8a");
        const icon = isNumeric ? "ðŸ”¢ Numeric Question" : (data.poll_type === 'quiz' ? "ðŸ† Quiz" : "ðŸ“Š Info");

        let inputHtml = '';
        if (isNumeric) {
            inputHtml = `
                <div style="margin: 20px 0; text-align: center;">
                    <input type="number" step="any" id="numeric_answer" placeholder="Use comma & two decimais (ex. 12,34)" 
                        style="width:450px; padding:12px; border:2px solid #cbd5e1; border-radius:10px; font-size:1.4em; text-align:center;">
                </div>`;
        } else {
            const options = JSON.parse(data.options_json || '{}');
            for (const [key, val] of Object.entries(options)) {
                if(!val) continue; 
                inputHtml += `
                    <label style="display:flex; align-items:center; margin:12px 0; padding:15px; border:1px solid #cbd5e1; border-radius:10px; cursor:pointer; background:#f8fafc;">
                        <input type="radio" name="poll_choice" value="${key}" style="width:18px; height:18px; margin-right:12px;"> 
                        <span style="font-size:1.1em;"><strong>${key})</strong> ${val}</span>
                    </label>`;
            }
        }

        pollContainer.innerHTML = `
            <div id="poll-inner-card" style="background:white; border-radius:15px; padding:30px; box-shadow:0 25px 50px rgba(0,0,0,0.3); border: 4px solid ${accentColor};">
                <h3 style="margin:0 0 15px; color:${accentColor}; font-size:1.4em;">${icon}</h3>
                <p style="font-size:1.2em; margin-bottom:20px; font-weight:600;">${data.question}</p>
                <form id="poll-form">
                    ${inputHtml}
                    <button type="submit" style="width:100%; background:${accentColor}; color:white; border:none; border-radius:8px; padding:15px; font-weight:bold; cursor:pointer; font-size:1.1em;">Submit Answer</button>
                </form>
            </div>`;

        document.getElementById('poll-form').onsubmit = async (e) => {
            e.preventDefault();
            const isNumericType = data.poll_type === 'numeric';
            let choice = isNumericType ? document.getElementById('numeric_answer').value : document.querySelector('input[name="poll_choice"]:checked')?.value;
            
            if (!choice) return;

            const student_id = localStorage.getItem("studentId") || localStorage.getItem("fs_user") || "guest";
            const res = await fetch(`${WORKER_URL}/poll/vote`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ student_id, poll_id: data.poll_id, choice: choice })
            });

            if (res.ok) {
                localStorage.setItem('answered_' + data.poll_id, 'true');
                
                // Substitui o conteÃºdo da box pela mensagem de sucesso
                const innerCard = document.getElementById('poll-inner-card');
                innerCard.style.borderColor = "#059669";
                innerCard.innerHTML = `
                    <div style="text-align:center; padding: 20px 0;">
                        <div style="font-size:3em; margin-bottom:10px;">âœ…</div>
                        <h3 style="color:#059669; margin-bottom:10px;">Answer Saved!</h3>
                        <p style="font-size:1.1em; color:#475569;">Please wait for the professor to release the results.</p>
                        <button onclick="document.getElementById('live-poll-container').style.display='none'" 
                            style="margin-top:20px; background:#059669; color:white; border:none; padding:10px 25px; border-radius:8px; cursor:pointer; font-weight:bold;">
                            Done
                        </button>
                    </div>`;
            }
        };
    }

    async function renderResults(pollData) {
        const res = await fetch(`${WORKER_URL}/poll/results`);
        const stats = await res.json();
        const isNumeric = pollData.poll_type === 'numeric';
        const total = stats.reduce((acc, curr) => acc + curr.count, 0);
        
        let chartHtml = '<div style="margin-top:20px;">';

        if (isNumeric) {
            chartHtml += `<p style="text-align:center; font-size:1.2em;">Correct Answer: <strong style="color:#059669;">${pollData.correct_option}</strong></p>`;
            chartHtml += `<p style="text-align:center; color:#64748b;">Total participations: ${total}</p>`;
        } else {
            const definedOptions = JSON.parse(pollData.options_json || '{}');
            const correctAns = (pollData.correct_option || "").trim().toUpperCase();
            for (const [key, val] of Object.entries(definedOptions)) {
                if (!val) continue;
                const isCorrect = key.toUpperCase() === correctAns;
                const voteData = stats.find(s => s.chosen_option === key.toUpperCase()) || {count: 0};
                const percent = total > 0 ? Math.round((voteData.count / total) * 100) : 0;
                const barColor = isCorrect ? "#22c55e" : "#1e3a8a";

                chartHtml += `
                    <div style="margin-bottom:15px;">
                        <div style="display:flex; justify-content:between; margin-bottom:5px; font-weight:bold;">
                            <span>Option ${key}: ${val} ${ (isCorrect) ? 'âœ…' : ''}</span>
                            <span style="margin-left:auto;">${percent}%</span>
                        </div>
                        <div style="background:#e2e8f0; border-radius:8px; height:20px; width:100%; overflow:hidden;">
                            <div style="background:${barColor}; width:${percent}%; height:100%; transition:width 1s ease;"></div>
                        </div>
                    </div>`;
            }
        }
        chartHtml += '</div>';

        const feedbackHtml = pollData.feedback_text ? `
            <div style="margin-top:20px; padding:15px; background:#f8fafc; border-left:4px solid #059669; color:#334155; font-size:0.95em;">
                <strong>Professor's Explanation:</strong><br>${pollData.feedback_text}
            </div>` : '';

        pollContainer.innerHTML = `
            <div style="background:white; border-radius:15px; padding:30px; box-shadow:0 25px 50px rgba(0,0,0,0.4); border: 4px solid #059669;">
                <h3 style="margin:0; color:#059669; font-size:1.4em;">ðŸ“Š Final Results</h3>
                ${chartHtml}
                ${feedbackHtml}
                <button onclick="document.getElementById('live-poll-container').style.display='none'" style="width:100%; margin-top:20px; padding:10px; border-radius:8px; border:none; background:#e2e8f0; cursor:pointer; font-weight:bold;">Close</button>
            </div>`;
    }

    setInterval(checkPoll, 5000);
    checkPoll();
})();
</script>