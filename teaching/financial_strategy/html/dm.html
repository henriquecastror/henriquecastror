<script>
(function () {
  try {
    if (window.DM_INITIALIZED) return;
    window.DM_INITIALIZED = true;

    const WORKER_BASE = "https://course-chat.hcmrtns.workers.dev";

    const getCookie = (name) => {
      const value = "; " + document.cookie;
      const parts = value.split("; " + name + "=");
      return parts.length === 2 ? parts.pop().split(";").shift() : null;
    };

    const getSid = () => {
      const c = getCookie("student_id");
      return (
        (c ? decodeURIComponent(c) : "") ||
        localStorage.getItem("studentId") ||
        localStorage.getItem("fs_user") ||
        localStorage.getItem("student_id") ||
        ""
      ).trim().toLowerCase();
    };

    const sid = getSid();
    if (!sid) return;

    const injectToast = (m) => {
      if (document.getElementById("dm-toast-container")) return;

      const toast = document.createElement("div");
      toast.id = "dm-toast-container";
      toast.setAttribute(
        "style",
        "position:fixed; top:20px; right:20px; background:#1e3a8a; color:white; padding:18px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.5); z-index:2147483647; max-width:320px; font-family:sans-serif; border:2px solid #a78bfa; animation: dmSlideIn 0.5s ease-out;"
      );

      toast.innerHTML =
        '<div style="font-weight:800; font-size:11px; color:#a78bfa; margin-bottom:8px; text-transform:uppercase; letter-spacing:1px;">Mensagem do Professor</div>' +
        '<div style="font-size:14px; line-height:1.5; margin-bottom:12px; font-weight:500;"></div>' +
        '<button id="dmReadBtn" style="background:#a78bfa; border:none; color:#0b1220; padding:10px; border-radius:6px; cursor:pointer; font-weight:800; width:100%; font-size:12px;">OK, ENTENDI</button>';

      // evita XSS e problemas de HTML quebrado
      toast.querySelector("div:nth-of-type(2)").textContent = m.message_text || "";

      document.body.appendChild(toast);

      document.getElementById("dmReadBtn").onclick = function () {
        fetch(WORKER_BASE + "/api/messages/mark-read", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message_id: m.id, student_id: sid })
        }).finally(() => toast.remove());
      };
    };

    const init = () => {
      fetch(WORKER_BASE + "/api/messages/check?sid=" + encodeURIComponent(sid), { cache: "no-store" })
        .then((r) => r.json())
        .then((data) => {
          if (data && data.message) injectToast(data.message);
        })
        .catch((err) => console.error("DM fetch error:", err));
    };

    if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
    else init();

    const style = document.createElement("style");
    style.textContent = "@keyframes dmSlideIn { from { transform:translateX(100%); opacity:0; } to { transform:translateX(0); opacity:1; } }";
    document.head.appendChild(style);
  } catch (e) {
    console.warn("DM script error:", e);
  }
})();
</script>
