<!-- notices-on-login.html -->
<style>
  .notice-modal-backdrop{
    position:fixed; inset:0; background:rgba(15,23,42,.35);
    display:none; align-items:center; justify-content:center;
    z-index:2147483647; /* topo de tudo */
  }
  .notice-modal{
    width:min(92vw, 680px); background:#fff; border-radius:16px;
    box-shadow:0 18px 50px rgba(0,0,0,.25);
    padding:18px 18px 12px; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    border:1px solid rgba(0,0,0,.08);
  }
  .notice-title{ font-size:1.1rem; font-weight:700; margin:0 0 6px; color:#0f172a; }
  .notice-body{ color:#334155; line-height:1.5; }
  .notice-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:14px; }

  .notice-btn{
    padding:10px 14px; border-radius:10px;
    border:1px solid rgba(0,0,0,.1); background:#0ea5e9; color:#fff; cursor:pointer;
  }

  /* Bot√µes das op√ß√µes */
  .notice-choice{
    padding:10px 14px; border-radius:999px;
    border:1px solid rgba(15,23,42,.08);
    background: linear-gradient(180deg,#3b82f6,#2563eb);
    color:#fff; cursor:pointer; box-shadow: 0 2px 0 rgba(0,0,0,.06);
    transition: transform .12s ease, filter .12s ease, opacity .12s ease;
  }
  .notice-choice:hover{ transform: translateY(-1px); filter: brightness(1.05); }
  .notice-choice:disabled{ opacity:.7; cursor:default; transform:none; }

  /* Estado visual ap√≥s clique */
  .notice-choice.is-selected{
    background: linear-gradient(180deg,#2563eb,#1d4ed8);
    border-color: rgba(37,99,235,.35);
  }
  .notice-choice.is-correct{
    background: linear-gradient(180deg,#16a34a,#15803d);
    border-color: rgba(22,163,74,.35);
  }
  .notice-choice.is-wrong{
    background: linear-gradient(180deg,#dc2626,#b91c1c);
    border-color: rgba(220,38,38,.35);
  }
</style>

<div class="notice-modal-backdrop" id="noticeBackdrop" aria-hidden="true" style="display:none">
  <div class="notice-modal" role="dialog" aria-modal="true">
    <div class="notice-title" id="noticeTitle">Notice</div>
    <div class="notice-body" id="noticeBody"></div>
    <div class="notice-actions">
      <button class="notice-btn" id="noticeOkBtn" type="button">Ok, got it</button>
    </div>
  </div>
</div>

<script>
(function(){
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbw1stXhHVbcinNcagloc6XNr3MYW9zn8EctaxxLuOJ086ODpCBvNCPwdfzbJxwl1XgDfw/exec';
  const SESSION_FLAG = 'notice_shown_this_load';
  const FEEDBACK_AUTO_CLOSE_MS = 15000; // V/F: tempo p/ ler feedback (0 = fecha s√≥ no "Ok, got it")
  const DEBUG = false;

  /* Preconnect + dns-prefetch */
  try {
    const l1=document.createElement('link'); l1.rel='preconnect';   l1.href='https://script.google.com'; document.head.appendChild(l1);
    const l2=document.createElement('link'); l2.rel='dns-prefetch'; l2.href='https://script.google.com'; document.head.appendChild(l2);
  } catch(_) {}

  /* üî• Warm-up imediato do GAS */
  try {
    const warm = new Image();
    warm.referrerPolicy = 'no-referrer';
    warm.src = `${ENDPOINT}?action=ping&t=${Date.now()}`;
  } catch(_) {}

  /* Helpers b√°sicos */
  function ensureModal(){
    let backdrop = document.getElementById('noticeBackdrop');
    if (!backdrop) {
      const tpl = document.createElement('div');
      tpl.innerHTML = `
        <div class="notice-modal-backdrop" id="noticeBackdrop" aria-hidden="true" style="display:none">
          <div class="notice-modal" role="dialog" aria-modal="true">
            <div class="notice-title" id="noticeTitle">Notice</div>
            <div class="notice-body" id="noticeBody"></div>
            <div class="notice-actions">
              <button class="notice-btn" id="noticeOkBtn" type="button">Ok, got it</button>
            </div>
          </div>
        </div>`;
      document.body.appendChild(tpl.firstElementChild);
      if (DEBUG) console.log('[notice] backdrop injected');
    }
  }
  function getStudentId(){
    try { return (localStorage.getItem('studentId') || sessionStorage.getItem('studentId') || window.__lastLoginStudentId || '').trim(); }
    catch(e){ return ''; }
  }
  function normalizeModule(m){
    if (!m) return '';
    const s = String(m).trim().toLowerCase();
    const m1 = s.match(/^module(\d+)$/); if (m1) return `mod${m1[1]}`;
    return s;
  }
  function getModule(){
    try {
      const el = document.getElementById('current-module'); if (el && el.value) return normalizeModule(el.value);
      const byStorage = localStorage.getItem('module') || sessionStorage.getItem('module'); if (byStorage) return normalizeModule(byStorage);
      const dm = document.body && document.body.getAttribute('data-module'); if (dm) return normalizeModule(dm);
      if (window.VHCM && window.VHCM.module) return normalizeModule(window.VHCM.module);
      return '';
    } catch(e){ return ''; }
  }
  function fetchJSON(url){
    return fetch(url, { credentials:'omit', cache:'no-store' })
      .then(r => { if(!r.ok) throw new Error('HTTP ' + r.status); return r.json(); });
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function personalize(s, studentId, module){
    return String(s || '')
      .replace(/\{\{\s*studentId\s*\}\}/gi, escapeHtml(studentId || ''))
      .replace(/\{\{\s*module\s*\}\}/gi, escapeHtml(module || ''));
  }
  function fireAndForget(url){
    try { const img = new Image(); img.referrerPolicy='no-referrer'; img.src = url; } catch(_) {}
  }
  function ackAndClose(studentId, notice_id){
    const modal = document.getElementById('noticeBackdrop');
    if (modal) modal.style.display = 'none';
    const qs2 = new URLSearchParams({ action:'ack', studentId, notice_id, t: Date.now().toString() });
    fireAndForget(`${ENDPOINT}?${qs2.toString()}`);
  }

  /* Normaliza r√≥tulos T/F em v√°rios formatos */
  function normalizeTF(x){
    const s = String(x || '').trim().toLowerCase();
    if (['true','t','verdadeiro','v','yes','y','sim','‚úÖ','‚úîÔ∏è'].includes(s)) return 'true';
    if (['false','f','falso','no','n','nao','n√£o','‚ùå','‚úñÔ∏è'].includes(s)) return 'false';
    if (s.startsWith('true'))  return 'true';
    if (s.startsWith('false')) return 'false';
    return '';
  }

  /* Render de poll (normal e T/F) */
  function renderPoll(notice, studentId, module){
    const body = document.getElementById('noticeBody');
    const okBtn = document.getElementById('noticeOkBtn');
    const opts = Array.isArray(notice.poll_options) ? notice.poll_options : [];
    const q    = notice.poll_question || 'Vote:';

    const correctKey = normalizeTF(notice.poll_correct);
    const isQuizTF   = (correctKey === 'true' || correctKey === 'false');
    let autoTimer = null;

    const pollWrap = document.createElement('div');
    pollWrap.innerHTML = `
      <div style="margin:8px 0 12px 0;"><strong>${escapeHtml(q)}</strong></div>
      <div id="pollBtns" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
      <div id="pollFeedback" style="margin-top:10px;"></div>
    `;
    body.appendChild(pollWrap);

    const btns = pollWrap.querySelector('#pollBtns');
    const fb   = pollWrap.querySelector('#pollFeedback');

    // T/F: deixa "Ok, got it" para leitura do feedback
    if (isQuizTF && okBtn) {
      okBtn.style.display = '';
      okBtn.onclick = (ev) => {
        ev.preventDefault(); ev.stopPropagation();
        if (autoTimer) { clearTimeout(autoTimer); autoTimer = null; }
        ackAndClose(studentId, notice.notice_id);
      };
    }

    opts.forEach((label) => {
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'notice-choice';
      b.textContent = label;

      b.addEventListener('click', () => {
        // desabilita todos imediatamente
        const all = [...btns.querySelectorAll('button')];
        all.forEach(x => x.disabled = true);

        // envia voto (fire-and-forget)
        const qs = new URLSearchParams({
          action: 'poll_vote',
          studentId,
          module: module || '',
          poll_id: notice.poll_id || '',
          choice: label,
          t: Date.now().toString()
        });
        fireAndForget(`${ENDPOINT}?${qs.toString()}`);

        if (!isQuizTF) {
          // Poll "opini√£o": s√≥ marca sele√ß√£o e fecha j√°
          b.classList.add('is-selected');
          ackAndClose(studentId, notice.notice_id);
          return;
        }

        // T/F: decide correto/errado usando normaliza√ß√£o
        const choiceKey = normalizeTF(label);
        const isCorrect = (choiceKey && choiceKey === correctKey);

        b.classList.add(isCorrect ? 'is-correct' : 'is-wrong');

        // Feedback amig√°vel
        fb.style.color = isCorrect ? '#065f46' : '#b91c1c';
        fb.innerHTML = isCorrect
          ? (notice.feedback_correct_html || '<p><strong>‚úÖ Correct.</strong></p>')
          : (notice.feedback_wrong_html  || '<p><strong>‚ùå Not quite.</strong></p>');

        // Auto-fecha ap√≥s leitura (se configurado)
        if (FEEDBACK_AUTO_CLOSE_MS > 0) {
          autoTimer = setTimeout(() => {
            autoTimer = null;
            ackAndClose(studentId, notice.notice_id);
          }, FEEDBACK_AUTO_CLOSE_MS);
        }
      });

      btns.appendChild(b);
    });
  }

  /* Mostra aviso/poll */
  async function showNotice(studentId){
    try { if (sessionStorage.getItem(SESSION_FLAG)) return false; } catch(e){}

    const module = getModule();
    const qs = new URLSearchParams({ action:'get', studentId });
    if (module) qs.set('module', module);

    const data = await fetchJSON(`${ENDPOINT}?${qs.toString()}`);
    if (!data.ok || !data.hasNotice || !data.notice) return false;

    ensureModal();

    const notice = data.notice;
    const titleEl = document.getElementById('noticeTitle');
    const bodyEl  = document.getElementById('noticeBody');
    const okBtn   = document.getElementById('noticeOkBtn');
    const modal   = document.getElementById('noticeBackdrop');
    if (!titleEl || !bodyEl || !okBtn || !modal) return false;

    titleEl.textContent = personalize(notice.title || (notice.type === 'poll' ? 'Quick poll' : 'Notice'), studentId, module);
    bodyEl.innerHTML = personalize(notice.message_html || '', studentId, module);
    modal.style.display = 'flex';

    if (notice.type === 'poll' && !notice.already_voted) {
      const correctKey = normalizeTF(notice.poll_correct);
      const isQuizTF   = (correctKey === 'true' || correctKey === 'false');

      // Para poll de opini√£o: esconda o "Ok, got it"
      okBtn.style.display = isQuizTF ? '' : 'none';
      if (!isQuizTF) {
        okBtn.onclick = (ev) => { ev.preventDefault(); ev.stopPropagation(); ackAndClose(studentId, notice.notice_id); };
      }

      renderPoll(notice, studentId, module);
    } else {
      // Aviso HTML simples
      okBtn.style.display = '';
      okBtn.onclick = (ev) => { ev.preventDefault(); ev.stopPropagation(); ackAndClose(studentId, notice.notice_id); };
    }

    try { sessionStorage.setItem(SESSION_FLAG, notice.notice_id); } catch(e){}
    return true;
  }

  /* API global opcional */
  window.noticeCenter = {
    onLogin: (studentId) => { try { window.__lastLoginStudentId = studentId; } catch(e){}; showNotice(String(studentId || '').trim()); },
    showNow: () => { try{ sessionStorage.removeItem(SESSION_FLAG); }catch(_){};
      const sid = getStudentId(); if (sid) showNotice(sid);
    }
  };

  /* Espera login e mostra (fallback) */
  async function waitForLoginAndShow(maxMs=20000){
    const start = Date.now();
    while (Date.now() - start < maxMs) {
      const sid = getStudentId();
      if (sid) { await showNotice(sid); return; }
      await new Promise(r => setTimeout(r, 150));
    }
  }

  /* Gatilhos */
  document.addEventListener('auth:login', (ev) => {
    const sid = (ev && ev.detail && ev.detail.studentId) ? String(ev.detail.studentId).trim() : getStudentId();
    if (sid) window.noticeCenter.onLogin(sid);
  });
  window.addEventListener('login:success', (ev) => {
    const sid = (ev && ev.detail && ev.detail.studentId) ? String(ev.detail.studentId).trim() : getStudentId();
    if (sid) window.noticeCenter.onLogin(sid);
  });

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => { waitForLoginAndShow(); });
  } else {
    waitForLoginAndShow();
  }
})();
</script>
