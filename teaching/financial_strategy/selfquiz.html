<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Self-Quiz Launcher</title>
<style>
  :root{--ink:#111827;--muted:#6b7280;--line:#e5e7eb;--chip:#eef2ff}
  *{box-sizing:border-box} body{margin:0;font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink)}
  .page{max-width:860px;margin:28px auto;padding:18px}
  h1{margin:0 0 6px;font-size:22px}
  .sub{color:var(--muted);margin:0 0 16px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:10px 0}
  input[type=text],input[type=number]{padding:10px 12px;border:1px solid var(--line);border-radius:10px;min-width:180px}
  .pill{display:inline-flex;align-items:center;gap:8px;background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:6px 10px}
  .sq-split{display:inline-flex; position:relative; border:1px solid var(--line); border-radius:12px; overflow:hidden}
  .sq-main {padding:10px 14px; border:0; background:var(--chip); cursor:pointer}
  .sq-caret{padding:10px 12px; border:0; background:#e5e7eb; cursor:pointer}
  .sq-menu {position:absolute; right:0; top:100%; margin-top:4px; list-style:none; padding:6px 0;
            background:#fff; border:1px solid var(--line); border-radius:10px; display:none; min-width:160px; z-index:20}
  .sq-menu li{padding:8px 12px; cursor:pointer} .sq-menu li:hover{background:#f3f4f6}
  .sq-split.open .sq-menu{display:block}
  .start{padding:12px 16px; border:1px solid var(--line); border-radius:12px; background:#1f2937; color:#fff; cursor:pointer}
  .hint{color:var(--muted); font-size:13px; margin-top:12px}
</style>

<div class="page">
  <h1>Self-Quiz</h1>
  <p class="sub">Escolha o modo e inicie o simulado para o módulo <b id="mLabel"></b>.</p>

  <div class="row">
    <span class="pill">Módulo: <span id="mChip"></span></span>
    <div class="sq-split" id="modeWrap">
      <button class="sq-main" type="button">Start <span class="sq-mode-label">Module</span></button>
      <button class="sq-caret" type="button" aria-haspopup="menu" aria-expanded="false" aria-label="Choose mode">▾</button>
      <ul class="sq-menu" role="menu">
        <li role="menuitem" data-mode="module">Module</li>
        <li role="menuitem" data-mode="midterm">Midterm</li>
        <li role="menuitem" data-mode="final">Final</li>
      </ul>
    </div>
  </div>

  <div class="row">
    <label>Student ID
      <input id="st" type="text" placeholder="ex.: a12345" />
    </label>
    <label>Questions
      <input id="qty" type="number" min="1" max="100" value="10" />
    </label>
    <label>Minutes
      <input id="mins" type="number" min="1" max="180" value="20" />
    </label>
    <button class="start" id="go">Start quiz</button>
  </div>

  <p class="hint">Dica: o modo escolhido fica salvo no seu navegador para este módulo.</p>
</div>

<script>
  // ----- helpers -----
  const qs = new URLSearchParams(location.search);
  const moduleId = (qs.get("module") || "").trim();       // ex: "module1"
  const qtyQS    = Number(qs.get("n"));
  const minsQS   = Number(qs.get("mins"));
  const pretty = (m)=> m==="midterm"?"Midterm":(m==="final"?"Final":"Module");
  const modeKey = (mod)=> `sq.mode.${mod}`;
  const getMode = (mod)=> localStorage.getItem(modeKey(mod)) || "module";
  const setMode = (mod,mode)=> localStorage.setItem(modeKey(mod), mode);
  const getStudentId = ()=> window.STUDENT_ID || qs.get("student") || localStorage.getItem("student_id") || "";

  function buildUrl(mod, mode, n, mins, student){
    const p = new URLSearchParams({ module: mod, n:String(n), mins:String(mins), student: student, track: mode });
    return `/selfquiz/preview?` + p.toString();
  }

  // ----- init UI -----
  (function init(){
    if(!moduleId){
      document.body.innerHTML = "<div class='page'><h1>Self-Quiz</h1><p>Faltou o parâmetro <code>?module=moduleX</code> no link.</p></div>";
      return;
    }
    document.getElementById("mLabel").textContent = moduleId;
    document.getElementById("mChip").textContent  = moduleId;

    const st = document.getElementById("st");
    const qty = document.getElementById("qty");
    const mins = document.getElementById("mins");
    const modeWrap = document.getElementById("modeWrap");
    const modeLabel = modeWrap.querySelector(".sq-mode-label");

    // defaults vindos da querystring (opcional)
    if(Number.isFinite(qtyQS) && qtyQS>0) qty.value = qtyQS;
    if(Number.isFinite(minsQS) && minsQS>0) mins.value = minsQS;
    st.value = getStudentId();

    // mostra modo salvo
    modeLabel.textContent = pretty(getMode(moduleId));

    // abre/fecha menu
    const caret = modeWrap.querySelector(".sq-caret");
    caret.addEventListener("click", (e)=>{
      e.stopPropagation();
      document.querySelectorAll(".sq-split.open").forEach(el=>{ if(el!==modeWrap) el.classList.remove("open"); });
      modeWrap.classList.toggle("open");
      caret.setAttribute("aria-expanded", modeWrap.classList.contains("open"));
    });
    document.addEventListener("click", ()=> modeWrap.classList.remove("open"));

    // escolher modo
    modeWrap.querySelectorAll(".sq-menu [data-mode]").forEach(item=>{
      item.addEventListener("click", ()=>{
        const mode = item.dataset.mode;
        setMode(moduleId, mode);
        modeLabel.textContent = pretty(mode);
        modeWrap.classList.remove("open");
      });
    });

    // botão principal do split: inicia com modo atual
    modeWrap.querySelector(".sq-main").addEventListener("click", ()=>{
      go(buildUrl(moduleId, getMode(moduleId), qty.value, mins.value, st.value || "demo"));
    });

    // botão "Start quiz"
    document.getElementById("go").addEventListener("click", ()=>{
      const mode = getMode(moduleId);
      if (st.value) localStorage.setItem("student_id", st.value);
      go(buildUrl(moduleId, mode, qty.value, mins.value, st.value || "demo"));
    });
  })();

  function go(url){ window.location.href = url; /* ou: window.open(url,"_blank") */ }
</script>
