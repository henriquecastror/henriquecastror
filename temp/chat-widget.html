<!-- chat-widget-deluxe.html : Floating chat for all slides (Quarto + revealjs) -->
<style>
  :root{
    /* Fundo geral claro e elegante */
    --bg: rgba(255,255,255,.88);
    --border: rgba(15,23,42,.12);
    --shadow: 0 12px 40px rgba(20,20,40,.18);

    --brand1: #4f46e5; /* indigo */
    --brand2: #06b6d4; /* cyan */
    --brand-weak: rgba(79,70,229,.10);

    --text: #0f172a;
    --muted: #475569;
    --danger: #b91c1c;

    --bubble-user: #ffffff;
    --bubble-ai:   #fbfdff;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg: rgba(19,26,42,.72);
      --border: rgba(255,255,255,.10);
      --shadow: 0 18px 50px rgba(0,0,0,.55);
      --text: #e6e9ef;
      --muted: #b6bfca;
      --brand-weak: rgba(79,70,229,.20);

      --bubble-user: rgba(255,255,255,.08);
      --bubble-ai:   rgba(255,255,255,.06);
    }
  }

  .vhcm-panel, .vhcm-input textarea, .vhcm-bubble {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    font-feature-settings: "liga" 1, "kern" 1;
  }

  /* FAB button */
  .vhcm-fab{position:fixed; right:18px; bottom:18px; z-index:9999; display:flex; align-items:center; gap:10px}
  .vhcm-fab button{border:none; border-radius:16px; padding:12px 14px; cursor:pointer; background:linear-gradient(135deg,var(--brand1),var(--brand2)); color:#fff; box-shadow:var(--shadow); display:flex; align-items:center; gap:10px; font-weight:600}
  .vhcm-fab svg{width:20px; height:20px}

  /* Panel (redimensionável) */
  .vhcm-panel{
    position:fixed; right:18px; bottom:78px;
    width:325px; height:600px;
    min-width:280px; min-height:360px;
    max-width:94vw; max-height:84vh;

    display:none; flex-direction:column; border:1px solid var(--border);
    border-radius:18px; box-shadow:var(--shadow); overflow:hidden; z-index:9999;
    backdrop-filter: blur(16px) saturate(140%); -webkit-backdrop-filter: blur(16px) saturate(140%);
    background: var(--bg); animation:vslide .25s ease-out;

    /* permite redimensionar pelo canto inferior direito */
    resize: both;
  }
  @keyframes vslide{from{transform: translateY(8px); opacity:0} to{transform:none; opacity:1}}

  .vhcm-header{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border); background:linear-gradient(135deg, rgba(79,70,229,.10), rgba(6,182,212,.08));}
  .vhcm-brand{display:flex; align-items:center; gap:10px}
  .vhcm-logo{width:28px; height:28px; border-radius:10px; background:linear-gradient(135deg,var(--brand1),var(--brand2)); color:#fff; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; box-shadow:0 4px 16px var(--brand-weak)}
  .vhcm-title{font-weight:700; letter-spacing:.2px; color:var(--text)}
  .vhcm-status{display:flex; align-items:center; gap:6px; color:var(--muted); font-size:12px}
  .vhcm-dot{width:8px; height:8px; border-radius:50%; background:#22c55e; box-shadow:0 0 0 2px rgba(34,197,94,.25)}
  .vhcm-close{border:none; background:transparent; font-size:18px; cursor:pointer; color:var(--muted)}

  /* Botão meia tela */
  .vhcm-half{
    border:none; background:transparent; cursor:pointer;
    font-size:16px; color:var(--muted); margin-right:6px;
  }
  .vhcm-half:hover{ color: var(--text); }

  /* Painel em meia tela (50vw x 50vh) */
  .vhcm-panel.vhcm--half{
    width: 50vw !important;
    height: 50vh !important;
    max-width: 95vw;
    max-height: 95vh;
    border-radius: 12px;
  }

  .vhcm-body{flex:1; overflow:auto; padding:14px; background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,0));}
  .vhcm-typing{font-size:12px; color:var(--muted); display:none; padding:6px 2px}
  .vhcm-dots{display:inline-flex; gap:3px; margin-left:4px}
  .vhcm-dots span{width:6px; height:6px; border-radius:50%; background:var(--muted); opacity:.6; animation:blink 1.2s infinite}
  .vhcm-dots span:nth-child(2){animation-delay:.2s}
  .vhcm-dots span:nth-child(3){animation-delay:.4s}
  @keyframes blink{0%,80%,100%{opacity:.2; transform:translateY(0)} 40%{opacity:.9; transform:translateY(-2px)}}

  .vhcm-input{
    display:flex; align-items:flex-end; gap:8px; padding:12px;
    border-top:1px solid var(--border);
    background:linear-gradient(180deg, rgba(255,255,255,.40), rgba(255,255,255,.20));
  }
  .vhcm-input textarea{
    flex:1;
    resize:none;
    min-height:44px;
    max-height:140px;
    padding:12px 14px;
    border:1px solid var(--border);
    border-radius:14px;
    background:#ffffff;
    color:#0f172a;
    font: 500 14px/1.45 system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    caret-color: var(--brand1);
    box-shadow: 0 1px 0 rgba(0,0,0,.02) inset;
  }
  .vhcm-input textarea::placeholder{ color:#475569; }

  .vhcm-send{background:linear-gradient(135deg,var(--brand1),var(--brand2)); color:#fff; border:none; border-radius:12px; padding:10px 14px; cursor:pointer; display:flex; align-items:center; gap:8px; font-weight:600}
  .vhcm-send svg{width:18px; height:18px}

  .vhcm-msg{display:flex; gap:10px; margin-bottom:12px; align-items:flex-end}
  .vhcm-avatar{width:28px; height:28px; border-radius:10px; background:var(--brand-weak); display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; color:var(--text)}
  .vhcm-bubble{
    max-width:78%; padding:12px 14px; border-radius:14px; border:1px solid var(--border);
    box-shadow: 0 6px 18px rgba(0,0,0,.06);
    line-height:1.48; font-weight:500;
  }
  .vhcm-msg.user{justify-content:flex-end}
  .vhcm-msg.user .vhcm-bubble{
    background: var(--bubble-user);
    color: var(--text);
    border-color: rgba(15,23,42,.10);
  }
  .vhcm-msg.user .vhcm-avatar{display:none}
  .vhcm-msg.ai .vhcm-bubble{
    background: var(--bubble-ai);
    color: var(--text);
    border-color: rgba(15,23,42,.10);
  }

  .vhcm-error{color:var(--danger); font-size:12px; margin:6px 2px}
</style>

<div class="vhcm-fab">
  <button id="vhcm-open" title="Virtual HCM">
    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22c4.97 0 9-3.582 9-8 0-1.93-.71-3.706-1.92-5.126l.86-3.006-3.01.847C15.87 5.6 14 5 12 5 7.03 5 3 8.582 3 13s4.03 9 9 9Z" stroke="currentColor" stroke-width="1.2"/></svg>
    Virtual HCM
  </button>
</div>

<div class="vhcm-panel" id="vhcm-panel" role="dialog" aria-label="Virtual HCM chat">
  <div class="vhcm-header">
    <div class="vhcm-brand">
      <div class="vhcm-logo">VH</div>
      <div>
        <div class="vhcm-title">Virtual HCM</div>
        <div class="vhcm-status"><span class="vhcm-dot"></span><span id="vhcm-module-label">module1</span></div>
      </div>
    </div>
    <div>
      <button id="vhcm-half" class="vhcm-half" aria-label="Half screen" title="Half screen">⤢</button>
      <button id="vhcm-close" class="vhcm-close" aria-label="Close">✕</button>
    </div>
  </div>
  <div class="vhcm-body" id="vhcm-body"></div>
  <div class="vhcm-typing" id="vhcm-typing">Virtual HCM is typing <span class="vhcm-dots"><span></span><span></span><span></span></span></div>
  <div class="vhcm-input">
    <textarea id="vhcm-text" placeholder="Ask anything about this module…"></textarea>
    <button class="vhcm-send" id="vhcm-send" title="Send">
      <svg viewBox="0 0 24 24"  fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 11l17-8-8 17-1-7-8-2Z" stroke="#fff" stroke-width="1.6"/></svg>
      Send
    </button>
  </div>
</div>

<script>
(function(){
  // ====== CONFIG ======
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzChhp9-_AoDBO0LTlZ4GUVbOFgaFb6gleZZbuwSajO6QFU_vJvTwOnIBd6qXkUwKX2Dw/exec"; // troque se necessário
  const DEFAULT_MODULE = "module1";
  const STORAGE_OPEN   = "vhcm_open";
  const STORAGE_SIZE   = "vhcm_size";
  const STORAGE_HALF   = "vhcm_half_mode";
  const STORAGE_SIZE_PREV = "vhcm_size_prev";

  // ====== Elements ======
  const btnOpen = document.getElementById('vhcm-open');
  const btnClose = document.getElementById('vhcm-close');
  const btnHalf = document.getElementById('vhcm-half');
  const panel = document.getElementById('vhcm-panel');
  const body = document.getElementById('vhcm-body');
  const typing = document.getElementById('vhcm-typing');
  const text = document.getElementById('vhcm-text');
  const send = document.getElementById('vhcm-send');
  const moduleLabel = document.getElementById('vhcm-module-label');

  // ====== Module detection (robusta, sem quebrar compatibilidade) ======
  function detectModule(){
    try {
      // 1) Override explícito via window.VHCM.module
      if (window.VHCM && window.VHCM.module) {
        const v = String(window.VHCM.module).trim();
        if (v) return v;
      }
      // 2) Reveal slide atual com data-module
      if (window.Reveal && typeof Reveal.getCurrentSlide === 'function') {
        const s = Reveal.getCurrentSlide && Reveal.getCurrentSlide();
        const v = (s && (s.dataset.module || s.getAttribute('data-module'))) || '';
        if (v && String(v).trim()) return String(v).trim();
      }
      // 3) <meta name="vhcm-module" content="moduleX">
      const meta = document.querySelector('meta[name="vhcm-module"]');
      if (meta && meta.content && meta.content.trim()) return meta.content.trim();
      // 4) atributo data-module no <body>
      const dm = document.body && document.body.getAttribute && document.body.getAttribute('data-module');
      if (dm && dm.trim()) return dm.trim();
      // 5) querystring ?module=moduleX
      const qs = new URLSearchParams(location.search).get('module');
      if (qs && qs.trim()) return qs.trim();
      // 6) regex no caminho (module2, m2, p2.html)
      const path = (location.pathname || '').toLowerCase();
      let m = path.match(/module(\d+)/); if (m) return `module${m[1]}`;
      m = path.match(/\/m(\d+)\b/);     if (m) return `module${m[1]}`;
      m = path.match(/\/p(\d+)\.html/); if (m) return `module${m[1]}`;
      // 7) compat: window.CURRENT_MODULE (caso você já defina em algum lugar)
      if (window.CURRENT_MODULE) return String(window.CURRENT_MODULE).trim();
    } catch(_){}
    // 8) fallback
    return DEFAULT_MODULE;
  }

  // ====== Helpers ======
  // (ÚNICA MUDANÇA) → pega o aluno logado do localStorage, priorizando o ID salvo no login
  function getStudent(){
    try{
      const u = (localStorage.getItem('fs_user')
              || localStorage.getItem('studentId')
              || localStorage.getItem('studentName')
              || 'Anonimo').trim();
      return u || 'Anonimo';
    }catch(_){
      return 'Anonimo';
    }
  }
  function currentModule(){ return detectModule(); }

  function bubble(author, textHtml, isUser=false){
    const wrap = document.createElement('div');
    wrap.className = 'vhcm-msg' + (isUser ? ' user' : ' ai');
    const avatar = document.createElement('div');
    avatar.className = 'vhcm-avatar';
    avatar.textContent = isUser ? 'You' : 'VH';
    const bub = document.createElement('div');
    bub.className = 'vhcm-bubble';
    bub.innerHTML = String(textHtml || '').replace(/\n/g,'<br>');
    if (isUser){ wrap.appendChild(bub); wrap.appendChild(avatar); }
    else { wrap.appendChild(avatar); wrap.appendChild(bub); }
    body.appendChild(wrap); body.scrollTop = body.scrollHeight;
  }
  function setOpen(open){ panel.style.display = open ? 'flex' : 'none'; localStorage.setItem(STORAGE_OPEN, open ? '1' : '0'); }

  // ====== Restaurar tamanho salvo ======
  (function restoreSize(){
    try{
      const saved = JSON.parse(localStorage.getItem(STORAGE_SIZE) || 'null');
      if (saved?.w && saved?.h) {
        panel.style.width = saved.w;
        panel.style.height = saved.h;
      }
    }catch(_){}
  })();

  // ====== Observar e salvar mudanças de tamanho ======
  (function watchSize(){
    if (!('ResizeObserver' in window)) return;
    const ro = new ResizeObserver(entries => {
      for (const e of entries) {
        const { width, height } = e.contentRect || {};
        if (!width || !height) continue;
        localStorage.setItem(STORAGE_SIZE, JSON.stringify({
          w: Math.round(width) + 'px',
          h: Math.round(height) + 'px'
        }));
      }
    });
    ro.observe(panel);
  })();

  // ====== Open/Close & persist state ======
  btnOpen.addEventListener('click', ()=> setOpen(panel.style.display !== 'flex'));
  btnClose.addEventListener('click', ()=> setOpen(false));
  if (localStorage.getItem(STORAGE_OPEN) === '1') setOpen(true);

  // ====== Module label sync ======
  function updateModuleLabel(){ moduleLabel.textContent = currentModule(); }
  updateModuleLabel();
  if (window.Reveal && typeof Reveal.on === 'function'){ Reveal.on('slidechanged', updateModuleLabel); }
  window.addEventListener('hashchange', updateModuleLabel); // caso mude via URL/anchor

  // ====== Meia tela (toggle) ======
  function readSize(){ try { return JSON.parse(localStorage.getItem(STORAGE_SIZE) || 'null'); } catch(_){ return null; } }
  function savePrevSize(){
    const rect = panel.getBoundingClientRect();
    localStorage.setItem(STORAGE_SIZE_PREV, JSON.stringify({
      w: Math.round(rect.width) + 'px',
      h: Math.round(rect.height) + 'px'
    }));
  }
  function readPrevSize(){ try { return JSON.parse(localStorage.getItem(STORAGE_SIZE_PREV) || 'null'); } catch(_){ return null; } }

  function setHalfMode(on){
    if (on){
      // guarda tamanho atual antes de mudar
      savePrevSize();
      panel.classList.add('vhcm--half');
      panel.style.width  = '50vw';
      panel.style.height = '50vh';
      localStorage.setItem(STORAGE_HALF, '1');
      btnHalf.title = 'Exit half screen';
    } else {
      panel.classList.remove('vhcm--half');
      localStorage.setItem(STORAGE_HALF, '0');
      btnHalf.title = 'Half screen';
      const prev = readPrevSize() || readSize();
      if (prev?.w && prev?.h){
        panel.style.width  = prev.w;
        panel.style.height = prev.h;
      } else {
        panel.style.width  = '';
        panel.style.height = '';
      }
    }
  }

  btnHalf.addEventListener('click', ()=>{
    const isOn = panel.classList.contains('vhcm--half');
    setHalfMode(!isOn);
  });

  // Restaurar modo meia tela se estava ativo
  if (localStorage.getItem(STORAGE_HALF) === '1') {
    setHalfMode(true);
  }

  // ====== Send logic ======
  async function sendQuestion(){
    const q = text.value.trim(); if (!q) return;
    const mod = currentModule(); updateModuleLabel();
    bubble('You', q, true); text.value=''; typing.style.display='block';
    try{
      const resp = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        // sem headers pra evitar preflight; servidor já aceita JSON puro
        body: JSON.stringify({ question: q, student: getStudent(), module: mod })
      });
      const raw = await resp.text();
      let data = {}; try { data = JSON.parse(raw); } catch(_){ data = { answer: 'Server returned an invalid response.' }; }
      typing.style.display='none';
      bubble('Virtual HCM', data.answer || 'No answer received.', false);
    } catch(e){
      typing.style.display='none';
      bubble('Error', 'Could not contact the server.', false);
    }
  }

  send.addEventListener('click', sendQuestion);
  text.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendQuestion(); }
  });
})();
</script>
