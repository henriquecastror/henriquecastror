<!DOCTYPE html>
<html lang="en"><head>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-html/tabby.min.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-html.min.css" rel="stylesheet" data-mode="light">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.4.549">

  <meta name="author" content="Henrique C. Martins">
  <title>Henrique Castro Martins - Estrat√©gia Financeira</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="../../../site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="../../../site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
  </style>
  <link rel="stylesheet" href="../../../site_libs/revealjs/dist/theme/quarto.css">
  <link rel="stylesheet" href="../logo.css">
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-771J5563G0"></script>

  <script type="text/javascript">

  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-771J5563G0', { 'anonymize_ip': true});
  </script>
  <link href="../../../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="../../../site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="../../../site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="../../../site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">

  .callout {
    margin-top: 1em;
    margin-bottom: 1em;  
    border-radius: .25rem;
  }

  .callout.callout-style-simple { 
    padding: 0em 0.5em;
    border-left: solid #acacac .3rem;
    border-right: solid 1px silver;
    border-top: solid 1px silver;
    border-bottom: solid 1px silver;
    display: flex;
  }

  .callout.callout-style-default {
    border-left: solid #acacac .3rem;
    border-right: solid 1px silver;
    border-top: solid 1px silver;
    border-bottom: solid 1px silver;
  }

  .callout .callout-body-container {
    flex-grow: 1;
  }

  .callout.callout-style-simple .callout-body {
    font-size: 1rem;
    font-weight: 400;
  }

  .callout.callout-style-default .callout-body {
    font-size: 0.9rem;
    font-weight: 400;
  }

  .callout.callout-titled.callout-style-simple .callout-body {
    margin-top: 0.2em;
  }

  .callout:not(.callout-titled) .callout-body {
      display: flex;
  }

  .callout:not(.no-icon).callout-titled.callout-style-simple .callout-content {
    padding-left: 1.6em;
  }

  .callout.callout-titled .callout-header {
    padding-top: 0.2em;
    margin-bottom: -0.2em;
  }

  .callout.callout-titled .callout-title  p {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }
    
  .callout.callout-titled.callout-style-simple .callout-content  p {
    margin-top: 0;
  }

  .callout.callout-titled.callout-style-default .callout-content  p {
    margin-top: 0.7em;
  }

  .callout.callout-style-simple div.callout-title {
    border-bottom: none;
    font-size: .9rem;
    font-weight: 600;
    opacity: 75%;
  }

  .callout.callout-style-default  div.callout-title {
    border-bottom: none;
    font-weight: 600;
    opacity: 85%;
    font-size: 0.9rem;
    padding-left: 0.5em;
    padding-right: 0.5em;
  }

  .callout.callout-style-default div.callout-content {
    padding-left: 0.5em;
    padding-right: 0.5em;
  }

  .callout.callout-style-simple .callout-icon::before {
    height: 1rem;
    width: 1rem;
    display: inline-block;
    content: "";
    background-repeat: no-repeat;
    background-size: 1rem 1rem;
  }

  .callout.callout-style-default .callout-icon::before {
    height: 0.9rem;
    width: 0.9rem;
    display: inline-block;
    content: "";
    background-repeat: no-repeat;
    background-size: 0.9rem 0.9rem;
  }

  .callout-title {
    display: flex
  }
    
  .callout-icon::before {
    margin-top: 1rem;
    padding-right: .5rem;
  }

  .callout.no-icon::before {
    display: none !important;
  }

  .callout.callout-titled .callout-body > .callout-content > :last-child {
    padding-bottom: 0.5rem;
    margin-bottom: 0;
  }

  .callout.callout-titled .callout-icon::before {
    margin-top: .5rem;
    padding-right: .5rem;
  }

  .callout:not(.callout-titled) .callout-icon::before {
    margin-top: 1rem;
    padding-right: .5rem;
  }

  /* Callout Types */

  div.callout-note {
    border-left-color: #4582ec !important;
  }

  div.callout-note .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAEU0lEQVRYCcVXTWhcVRQ+586kSUMMxkyaElstCto2SIhitS5Ek8xUKV2poatCcVHtUlFQk8mbaaziwpWgglJwVaquitBOfhQXFlqlzSJpFSpIYyXNjBNiTCck7x2/8/LeNDOZxDuEkgOXe++553zfefee+/OYLOXFk3+1LLrRdiO81yNqZ6K9cG0P3MeFaMIQjXssE8Z1JzLO9ls20MBZX7oG8w9GxB0goaPrW5aNMp1yOZIa7Wv6o2ykpLtmAPs/vrG14Z+6d4jpbSKuhdcSyq9wGMPXjonwmESXrriLzFGOdDBLB8Y6MNYBu0dRokSygMA/mrun8MGFN3behm6VVAwg4WR3i6FvYK1T7MHo9BK7ydH+1uurECoouk5MPRyVSBrBHMYwVobG2aOXM07sWrn5qgB60rc6mcwIDJtQrnrEr44kmy+UO9r0u9O5/YbkS9juQckLed3DyW2XV/qWBBB3ptvI8EUY3I9p/67OW+g967TNr3Sotn3IuVlfMLVnsBwH4fsnebJvyGm5GeIUA3jljERmrv49SizPYuq+z7c2H/jlGC+Ghhupn/hcapqmcudB9jwJ/3jvnvu6vu5lVzF1fXyZuZZ7U8nRmVzytvT+H3kilYvH09mLWrQdwFSsFEsxFVs5fK7A0g8gMZjbif4ACpKbjv7gNGaD8bUrlk8x+KRflttr22JEMRUbTUwwDQScyzPgedQHZT0xnx7ujw2jfVfExwYHwOsDTjLdJ2ebmeQIlJ7neo41s/DrsL3kl+W2lWvAga0tR3zueGr6GL78M3ifH0rGXrBC2aAR8uYcIA5gwV8zIE8onoh8u0Fca/ciF7j1uOzEnqcIm59sEXoGc0+z6+H45V1CvAvHcD7THztu669cnp+L0okAeIc6zjbM/24LgGM1gZk7jnRu1aQWoU9sfUOuhrmtaPIO3YY1KLLWZaEO5TKUbMY5zx8W9UJ6elpLwKXbsaZ4EFl7B4bMtDv0iRipKoDQT2sNQI9b1utXFdYisi+wzZ/ri/1m7QfDgEuvgUUEIJPq3DhX/5DWNqIXDOweC2wvIR90Oq3lDpdMIgD2r0dXvGdsEW5H6x6HLRJYU7C69VefO1x8Gde1ZFSJLfWS1jbCnhtOPxmpfv2LXOA2Xk2tvnwKKPFuZ/oRmwBwqRQDcKNeVQkYcOjtWVBuM/JuYw5b6isojIkYxyYAFn5K7ZBF10fea52y8QltAg6jnMqNHFBmGkQ1j+U43HMi2xMar1Nv0zGsf1s8nUsmUtPOOrbFIR8bHFDMB5zL13Gmr/kGlCkUzedTzzmzsaJXhYawnA3UmARpiYj5ooJZiUoxFRtK3X6pgNPv+IZVPcnwbOl6f+aBaO1CNvPW9n9LmCp01nuSaTRF2YxHqZ8DYQT6WsXT+RD6eUztwYLZ8rM+rcPxamv1VQzFUkzFXvkiVrySGQgJNvXHJAxiU3/NwiC03rSf05VBaPtu/Z7/B8Yn/w7eguloAAAAAElFTkSuQmCC');
  }

  div.callout-note.callout-style-default .callout-title {
    background-color: #dae6fb
  }

  div.callout-important {
    border-left-color: #d9534f !important;
  }

  div.callout-important .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAEKklEQVRYCcVXTWhcVRS+575MJym48A+hSRFr00ySRQhURRfd2HYjk2SSTokuBCkU2o0LoSKKraKIBTcuFCoidGFD08nkBzdREbpQ1EDNIv8qSGMFUboImMSZd4/f9zJv8ibJMC8xJQfO3HPPPef7zrvvvnvviIkpC9nsw0UttFunbUhpFzFtarSd6WJkStVMw5xyVqYTvkwfzuf/5FgtkVoB0729j1rjXwThS7Vio+Mo6DNnvLfahoZ+i/o32lULuJ3NNiz7q6+pyAUkJaFF6JwaM2lUJlV0MlnQn5aTRbEu0SEqHUa0A4AdiGuB1kFXRfVyg5d87+Dg4DL6m2TLAub60ilj7A1Ec4odSAc8X95sHh7+ZRPCFo6Fnp7HfU/fBng/hi10CjCnWnJjsxvDNxWw0NfV6Rv5GgP3I3jGWXumdTD/3cbEOP2ZbOZp69yniG3FQ9z1jD7bnBu9Fc2tKGC2q+uAJOQHBDRiZX1x36o7fWBs7J9ownbtO+n0/qWkvW7UPIfc37WgT6ZGR++EOJyeQDSb9UB+DZ1G6DdLDzyS+b/kBCYGsYgJbSQHuThGKRcw5xdeQf8YdNHsc6ePXrlSYMBuSIAFTGAtQo+VuALo4BX83N190NWZWbynBjhOHsmNfFWLeL6v+ynsA58zDvvAC8j5PkbOcXCMg2PZFk3q8MjI7WAG/Dp9AwP7jdGBOOQkAvlFUB+irtm16I1Zw9YBcpGTGXYmk3kQIC/Cds55l+iMI3jqhjAuaoe+am2Jw5GT3Nbz3CkE12NavmzN5+erJW7046n/CH1RO/RVa8lBLozXk9uqykkGAyRXLWlLv5jyp4RFsG5vGVzpDLnIjTWgnRy2Rr+tDKvRc7Y8AyZq10jj8DqXdnIRNtFZb+t/ZRtXcDiVnzpqx8mPcDWxgARUqx0W1QB9MeUZiNrV4qP+Ehc+BpNgATsTX8ozYKL2NtFYAHc84fG7ndxUPr+AR/iQSns7uSUufAymwDOb2+NjK27lEFocm/EE2WpyIy/Hi66MWuMKJn8RvxIcj87IM5Vh9663ziW36kR0HNenXuxmfaD8JC7tfKbrhFr7LiZCrMjrzTeGx+PmkosrkNzW94ObzwocJ7A1HokLolY+AvkTiD/q1H0cN48c5EL8Crkttsa/AXQVDmutfyku0E7jShx49XqV3MFK8IryDhYVbj7Sj2P2eBxwcXoe8T8idsKKPRcnZw1b+slFTubwUwhktrfnAt7J++jwQtLZcm3sr9LQrjRzz6cfMv9aLvgmnAGvpoaGLxM4mAEaLV7iAzQ3oU0IvD5x9ix3yF2RAAuYAOO2f7PEFWCXZ4C9Pb2UsgDeVnFSpbFK7/IWu7TPTvBqzbGdCHOJQSxiEjt6IyZmxQyEJHv6xyQsYk//moVFsN2zP6fRImjfq7/n/wFDguUQFNEwugAAAABJRU5ErkJggg==');
  }

  div.callout-important.callout-style-default .callout-title {
    background-color: #f7dddc
  }

  div.callout-warning {
    border-left-color: #f0ad4e !important;
  }

  div.callout-warning .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAETklEQVRYCeVWW2gcVRg+58yaTUnizqbipZeX4uWhBEniBaoUX1Ioze52t7sRq6APio9V9MEaoWlVsFasRq0gltaAPuxms8lu0gcviE/FFOstVbSIxgcv6SU7EZqmdc7v9+9mJtNks51NTUH84ed889/PP+cmxP+d5FIbMJmNbpREu4WUkiTtCicKny0l1pIKmBzovF2S+hIJHX8iEu3hZJ5lNZGqyRrGSIQpq15AzF28jgpeY6yk6GVdrfFqdrD6Iw+QlB8g0YS2g7dyQmXM/IDhBhT0UCiRf59lfqmmDvzRt6kByV/m4JjtzuaujMUM2c5Z2d6JdKrRb3K2q6mA+oYVz8JnDdKPmmNthzkAk/lN63sYPgevrguc72aZX/L9C6x09GYyxBgCX4NlvyGUHOKELlm5rXeR1kchuChJt4SSwyddZRXgvwMGvYo4QSlk3/zkHD8UHxwVJA6zjZZqP8v8kK8OWLnIZtLyCAJagYC4rTGW/9Pqj92N/c+LUaAj27movwbi19tk/whRCIE7Q9vyI6yvRpftAKVTdUjOW40X3h5OXsKCdmFcx0xlLJoSuQngnrJe7Kcjm4OMq9FlC7CMmScQANuNvjfP3PjGXDBaUQmbp296S5L4DrpbrHN1T87ZVEZVCzg1FF0Ft+dKrlLukI+/c9ENo+TvlTDbYFvuKPtQ9+l052rXrgKoWkDAFnvh0wTOmYn8R5f4k/jN/fZiCM1tQx9jQQ4ANhqG4hiL0qIFTGViG9DKB7GYzgubnpofgYRwO+DFjh0Zin2m4b/97EDkXkc+f6xYAPX0KK2I/7fUQuwzuwo/L3AkcjugPNixC8cHf0FyPjWlItmLxWw4Ou9YsQCr5fijMGoD/zpdRy95HRysyXA74MWOnscpO4j2y3HAVisw85hX5+AFBRSHt4ShfLFkIMXTqyKFc46xdzQM6XbAi702a7sy04J0+feReMFKp5q9esYLCqAZYw/k14E/xcLLsFElaornTuJB0svMuJINy8xkIYuL+xPAlWRceH6+HX7THJ0djLUom46zREu7tTkxwmf/FdOZ/sh6Q8qvEAiHpm4PJ4a/doJe0gH1t+aHRgCzOvBvJedEK5OFE5jpm4AGP2a8Dxe3gGJ/pAutug9Gp6he92CsSsWBaEcxGx0FHytmIpuqGkOpldqNYQK8cSoXvd+xLxXADw0kf6UkJNFtdo5MOgaLjiQOQHcn+A6h5NuL2s0qsC2LOM75PcF3yr5STuBSAcGG+meA14K/CI21HcS4LBT6tv0QAh8Dr5l93AhZzG5ZJ4VxAqdZUEl9z7WJ4aN+svMvwHHL21UKTd1mqvChH7/Za5xzXBBKrUcB0TQ+Ulgkfbi/H/YT5EptrGzsEK7tR1B7ln9BBwckYfMiuSqklSznIuoIIOM42MQO+QnduCoFCI0bpkzjCjddHPN/F+2Yu+sd9bKNpVwHhbS3LluK/0zgfwD0xYI5dXuzlQAAAABJRU5ErkJggg==');
  }

  div.callout-warning.callout-style-default .callout-title {
    background-color: #fcefdc
  }

  div.callout-tip {
    border-left-color: #02b875 !important;
  }

  div.callout-tip .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAADr0lEQVRYCe1XTWgTQRj9ZjZV8a9SPIkKgj8I1bMHsUWrqYLVg4Ue6v9BwZOxSYsIerFao7UiUryIqJcqgtpimhbBXoSCVxUFe9CTiogUrUp2Pt+3aUI2u5vdNh4dmMzOzHvvezuz8xNFM0mjnbXaNu1MvFWRXkXEyE6aYOYJpdW4IXuA4r0fo8qqSMDBU0v1HJUgVieAXxzCsdE/YJTdFcVIZQNMyhruOMJKXYFoLfIfIvVIMWdsrd+Rpd86ZmyzzjJmLStqRn0v8lzkb4rVIXvnpScOJuAn2ACC65FkPzEdEy4TPWRLJ2h7z4cArXzzaOdKlbOvKKX25Wl00jSnrwVxAg3o4dRxhO13RBSdNvH0xSARv3adTXbBdTf64IWO2vH0LT+cv4GR1DJt+DUItaQogeBX/chhbTBxEiZ6gftlDNXTrvT7co4ub5A6gp9HIcHvzTa46OS5fBeP87Qm0fQkr4FsYgVQ7Qg+ZayaDg9jhg1GkWj8RG6lkeSacrrHgDaxdoBiZPg+NXV/KifMuB6//JmYH4CntVEHy/keA6x4h4CU5oFy8GzrBS18cLJMXcljAKB6INjWsRcuZBWVaS3GDrqB7rdapVIeA+isQ57Eev9eCqzqOa81CY05VLd6SamW2wA2H3SiTbnbSxmzfp7WtKZkqy4mdyAlGx7ennghYf8voqp9cLSgKdqNfa6RdRsAAkPwRuJZNbpByn+RrJi1RXTwdi8RQF6ymDwGMAtZ6TVE+4uoKh+MYkcLsT0Hk8eAienbiGdjJHZTpmNjlbFJNKDVAp2fJlYju6IreQxQ08UJDNYdoLSl6AadO+fFuCQqVMB1NJwPm69T04Wv5WhfcWyfXQB+wXRs1pt+nCknRa0LVzSA/2B+a9+zQJadb7IyyV24YAxKp2Jqs3emZTuNnKxsah+uabKbMk7CbTgJx/zIgQYErIeTKRQ9yD9wxVof5YolPHqaWo7TD6tJlh7jQnK5z2n3+fGdggIOx2kaa2YI9QWarc5Ce1ipNWMKeSG4DysFF52KBmTNMmn5HqCFkwy34rDg05gDwgH3bBi+sgFhN/e8QvRn8kbamCOhgrZ9GJhFDgfcMHzFb6BAtjKpFhzTjwv1KCVuxHvCbsSiEz4CANnj84cwHdFXAbAOJ4LTSAawGWFn5tDhLMYz6nWeU2wJfIhmIJBefcd/A5FWQWGgrWzyORZ3Q6HuV+Jf0Bj+BTX69fm1zWgK7By1YTXchFDORywnfQ7GpzOo6S+qECrsx2ifVQAAAABJRU5ErkJggg==');
  }

  div.callout-tip.callout-style-default .callout-title {
    background-color: #ccf1e3
  }

  div.callout-caution {
    border-left-color: #fd7e14 !important;
  }

  div.callout-caution .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAACV0lEQVRYCdVWzWoUQRCuqp2ICBLJXgITZL1EfQDBW/bkzUMUD7klD+ATSHBEfAIfQO+iXsWDxJsHL96EHAwhgzlkg8nBg25XWb0zIb0zs9muYYWkoKeru+vn664fBqElyZNuyh167NXJ8Ut8McjbmEraKHkd7uAnAFku+VWdb3reSmRV8PKSLfZ0Gjn3a6Xlcq9YGb6tADjn+lUfTXtVmaZ1KwBIvFI11rRXlWlatwIAAv2asaa9mlB9wwygiDX26qaw1yYPzFXg2N1GgG0FMF8Oj+VIx7E/03lHx8UhvYyNZLN7BwSPgekXXLribw7w5/c8EF+DBK5idvDVYtEEwMeYefjjLAdEyQ3M9nfOkgnPTEkYU+sxMq0BxNR6jExrAI31H1rzvLEfRIdgcv1XEdj6QTQAS2wtstEALLG1yEZ3QhH6oDX7ExBSFEkFINXH98NTrme5IOaaA7kIfiu2L8A3qhH9zRbukdCqdsA98TdElyeMe5BI8Rs2xHRIsoTSSVFfCFCWGPn9XHb4cdobRIWABNf0add9jakDjQJpJ1bTXOJXnnRXHRf+dNL1ZV1MBRCXhMbaHqGI1JkKIL7+i8uffuP6wVQAzO7+qVEbF6NbS0LJureYcWXUUhH66nLR5rYmva+2tjRFtojkM2aD76HEGAD3tPtKM309FJg5j/K682ywcWJ3PASCcycH/22u+Bh7Aa0ehM2Fu4z0SAE81HF9RkB21c5bEn4Dzw+/qNOyXr3DCTQDMBOdhi4nAgiFDGCinIa2owCEChUwD8qzd03PG+qdW/4fDzjUMcE1ZpIAAAAASUVORK5CYII=');
  }

  div.callout-caution.callout-style-default .callout-title {
    background-color: #ffe5d0
  }

  </style>
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
  <!-- === login-start.html (com prote√ß√£o para p√°ginas e slides + turbo + warmup + remember blindado) === -->

  <style>
    /* Card padr√£o (p√°ginas normais) */
    #login-form {
      max-width: 300px;
      margin: 100px auto 40px auto;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      background: #fff;
      box-sizing: border-box;
    }
    #login-form input {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    /* ‚úÖ FIX layout do checkbox: n√£o herdar width/padding dos inputs de texto */
    #login-form input[type="checkbox"] {
      width: auto !important;
      padding: 0 !important;
      margin: 0 !important;
      border: none !important;
      box-shadow: none !important;
      vertical-align: middle;
    }

    #login-form button {
      width: 100%; padding: 10px; margin-top: 10px;
      background-color: #0066cc; color: #fff; border: 0; border-radius: 5px; cursor: pointer;
    }
    #login-error { color: red; text-align: center; margin-top: 10px; }
    #loading-msg{ display:none; text-align:center; margin-top:10px; color:gray; }

    /* Desabilitado durante autentica√ß√£o */
    #login-form button:disabled { opacity:.6; cursor:not-allowed; }
    #login-form input:disabled  { opacity:.7; }

    /* Conte√∫do de p√°ginas normais (fica atr√°s do login at√© destravar) */
    html.locked #after-login-content,
    body.locked #after-login-content { display: none !important; }

    /* Slides (Reveal.js): desfoca deck e bloqueia intera√ß√£o */
    html.locked.reveal-page .reveal,
    body.locked.reveal-page .reveal { filter: blur(4px); pointer-events: none; user-select: none; }

    #login-scrim { display:none; }
    html.locked.reveal-page #login-scrim,
    body.locked.reveal-page #login-scrim{
      display:block; position:fixed; inset:0; background:rgba(255,255,255,.92); z-index:9998;
    }
    html.locked.reveal-page #login-form,
    body.locked.reveal-page #login-form{
      position: fixed; top:50%; left:50%; transform: translate(-50%,-50%);
      margin:0; max-width:340px; width:min(340px,92vw); z-index:9999;
    }

    /* Oculta o "Welcome" nos slides */
    .reveal-page #welcome-message { display: none !important; }

    /* Remember me */
    .remember-row{
      display:flex; align-items:center; gap:8px; margin-top:6px; font-size:.95rem; color:#444; white-space:nowrap;
    }
    .remember-row label{ display:flex; align-items:center; gap:6px; cursor:pointer; }

    /* Fallback duro para p√°ginas comuns: esconde TUDO (qualquer descendente) menos o form/scrim) */
    html.locked body:not(.reveal-page) :not(#login-form):not(#login-form *):not(#login-scrim):not(script):not(style):not(link) {
      display: none !important;
    }

    /* Garante que o form fique acima de qualquer layout do tema */
    #login-form { position: relative; z-index: 10000; }
    #login-scrim { z-index: 9998; }

    /* Scrim e formul√°rio fixos tamb√©m em p√°ginas N√ÉO-reveal enquanto locked */
    html.locked #login-scrim,
    body.locked #login-scrim {
      display: block !important;
      position: fixed !important;
      inset: 0 !important;
      background: #ffffff !important;
      z-index: 2147483646 !important;
    }
    html.locked #login-form,
    body.locked #login-form {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      margin: 0 !important;
      max-width: 340px !important;
      width: min(340px, 92vw) !important;
      z-index: 2147483647 !important;
    }

    /* Evita rolagem/scroll do conte√∫do ao fundo enquanto locked */
    html.locked, body.locked { overflow: hidden !important; }

    /* üîí Blindagem extra contra webexercises esconder a checkbox */
    #login-form .remember-row { display:flex !important; visibility:visible !important; }
    #login-form #remember-me { display:inline-block !important; }

    /* üßº Esconde imediatamente artefatos escapados (qualquer descendente code/pre/sourceCode etc) DENTRO do form */
    #login-form pre,
    #login-form code,
    #login-form .sourceCode,
    #login-form .sourcecode,
    #login-form .quarto-code-cell,
    #login-form .cell-output,
    #login-form .cell-output-display,
    #login-form .cell { display: none !important; }
  </style>

  <!-- Aplica 'locked' em <html> imediatamente e em <body> quando dispon√≠vel + preconnect -->
  <script>
    (function(){
      const addLocked = el => { if (el && !el.classList.contains('locked')) el.classList.add('locked'); };
      addLocked(document.documentElement);
      if (document.body) { addLocked(document.body); }
      else { document.addEventListener('DOMContentLoaded', () => addLocked(document.body)); }

      // preconnect/dns-prefetch para acelerar chamadas ao GAS de login
      try {
        const l1=document.createElement('link'); l1.rel='preconnect';   l1.href='https://script.google.com'; document.head.appendChild(l1);
        const l2=document.createElement('link'); l2.rel='dns-prefetch'; l2.href='https://script.google.com'; document.head.appendChild(l2);
      } catch(_) {}
    })();
  </script>

  <!-- shim seguro: define onLoginSuccess se ainda n√£o existir -->
  <script>
    if (typeof window.onLoginSuccess !== 'function') {
      window.onLoginSuccess = function(studentId){
        try {
          const sid = String(studentId || '').trim();
          window.studentId = sid;
          localStorage.setItem('studentId', sid);
          // compat com widgets antigos
          document.dispatchEvent(new CustomEvent('auth:login',   { detail: { studentId: sid } }));
          setTimeout(() => window.dispatchEvent(new CustomEvent('login:success', { detail:{ studentId: sid } })), 0);
          // hook imediato para o notice center (se j√° carregado)
          if (window.noticeCenter && typeof window.noticeCenter.onLogin === 'function') {
            window.noticeCenter.onLogin(sid);
          }
          if (window.VHCM) window.VHCM.lastLoginAt = Date.now();
          console.debug('[Login] onLoginSuccess ‚Üí', sid);
        } catch(e) {
          console.warn('onLoginSuccess shim warn:', e);
        }
      };
    }
  </script>

  <meta property="og:title" content="Henrique Castro Martins - Estrat√©gia Financeira">
<meta property="og:description" content="Part 10 - Ch 17 Payout Policy">
<meta property="og:site_name" content="Henrique Castro Martins">
<meta name="twitter:title" content="Henrique Castro Martins - Estrat√©gia Financeira">
<meta name="twitter:description" content="Part 10 - Ch 17 Payout Policy">
<meta name="twitter:card" content="summary">
</head><body class="quarto-light"><form id="login-form" onsubmit="event.preventDefault(); validateLogin();">
    <h3 style="text-align:center;">Login</h3>
    <input type="text" id="username" placeholder="Username" autocomplete="username" required="">
    <input type="password" id="password" placeholder="Password" autocomplete="current-password" required="">

    <!-- Remember: input separado + label com 'for' (alinhado como na 2¬™ imagem) -->
    <div class="remember-row">
      <input type="checkbox" id="remember-me" checked="">
      <label for="remember-me">Remember me</label>
    </div>

    <button type="submit" id="login-submit">Enter</button>
    <div id="loading-msg"></div>
    <div id="login-error"></div>
  </form>

  <div id="login-scrim" aria-hidden="true"></div>

  <div id="after-login-content" style="display:none;">
    <h4 id="welcome-message" style="text-align:center; display:none; margin-top:10px; font-size:1.8em; color:#333;"></h4>
  </div>

  <script>
    /***** CONFIG *****/
    const REMEMBER_PASSWORD  = true;
    const GAS_URL            = 'https://script.google.com/macros/s/AKfycbxb3Z73DvsgGiGwK-jVp89jA5EGEYk24nbPNblQiNxFZPYvvDTvO-v4S4N_L-4YZ8KZfQ/exec';
    const SESSION_MAX_HOURS  = 8;     // validade do "lembrado"
    const FAST_WINDOW_HOURS  = 2;     // turbo: libera instant√¢neo
    const VALIDATE_TIMEOUTMS = 3000;  // timeout da valida√ß√£o

    /* üî• Warm-up silencioso do GAS: acorda a fun√ß√£o antes do 1¬∫ login real */
    window.addEventListener('load', () => {
      try {
        const warm = new Image();
        warm.referrerPolicy = 'no-referrer';
        warm.src = `${GAS_URL}?username=&password=&page=WARMUP&t=${Date.now()}`;
      } catch(_) {}
    });

    /***** Marca slides (se houver Reveal) *****/
    document.addEventListener('DOMContentLoaded', () => {
      if (document.querySelector('.reveal')) document.body.classList.add('reveal-page');
    });

    /***** Pr√©-preenche campos com Remember (se houver) *****/
    document.addEventListener('DOMContentLoaded', () => {
      try{
        const u = localStorage.getItem('fs_user');
        const p = localStorage.getItem('fs_pass');
        if (u) document.getElementById('username').value = u;
        if (REMEMBER_PASSWORD && p) document.getElementById('password').value = p;
      }catch(_){}
    });

    /***** Storage helpers *****/
    function saveRemember(u,p,checked){
      try{
        if(checked){
          localStorage.setItem('fs_user', u);
          localStorage.setItem('fs_last_login_at', Date.now().toString());
          if (REMEMBER_PASSWORD) localStorage.setItem('fs_pass', p); else localStorage.removeItem('fs_pass');
        }else{
          localStorage.removeItem('fs_user'); localStorage.removeItem('fs_pass'); localStorage.removeItem('fs_last_login_at');
        }
      }catch(_){}
    }
    function getRemember(){
      try{
        const u=localStorage.getItem('fs_user');
        const p=localStorage.getItem('fs_pass');
        const t=parseInt(localStorage.getItem('fs_last_login_at')||'0',10);
        if(!u||!t) return null; return {u,p,t};
      }catch(_){ return null; }
    }
    const within=(ts,h)=> (Date.now()-ts) < h*3600*1000;

    /* üîí Desativa/Reativa o form durante autentica√ß√£o */
    function setAuthLoading(isLoading){
      const btn = document.getElementById('login-submit');
      const u   = document.getElementById('username');
      const p   = document.getElementById('password');
      const cb  = document.getElementById('remember-me');
      if (btn){
        btn.disabled = isLoading;
        btn.textContent = isLoading ? 'Signing in...' : 'Enter';
      }
      [u,p,cb].forEach(el => { if (el) el.disabled = isLoading; });
    }

    /***** GAS helpers *****/
    function logWithImage(u,p,page){
      const img=new Image(); img.referrerPolicy='no-referrer';
      img.src=`${GAS_URL}?username=${encodeURIComponent(u)}&password=${encodeURIComponent(p||'')}&page=${encodeURIComponent(page)}&t=${Date.now()}`;
    }
    async function gasAuth(u,p,page,timeoutMs){
      async function _once(ms){
        const ctrl=new AbortController();
        const timer=setTimeout(()=>ctrl.abort('timeout'), ms||0);
        try{
          const res=await fetch(`${GAS_URL}?username=${encodeURIComponent(u)}&password=${encodeURIComponent(p||'')}&page=${encodeURIComponent(page)}`, {signal:ctrl.signal, cache:'no-store'});
          return (await res.text()||'').trim();
        } finally { clearTimeout(timer); }
      }
      try{
        return await _once(timeoutMs||12000);   // 1¬™ tentativa
      }catch(_){
        return await _once(15000);              // retry mais folgado
      }
    }

    /***** UI helpers *****/
    function unlockAs(u){
      const welcome=document.getElementById('welcome-message');
      if (welcome && !document.body.classList.contains('reveal-page')){
        welcome.textContent=`Welcome, ${u}!`; welcome.style.display='block';
      }
      document.getElementById('login-form').style.display='none';
      const after=document.getElementById('after-login-content'); if(after) after.style.display='block';

      // Remover 'locked' de html e body
      document.documentElement.classList.remove('locked');
      if (document.body) document.body.classList.remove('locked');

      const scrim=document.getElementById('login-scrim'); if(scrim) scrim.style.display='none';
    }

    /***** Auto-login com janela turbo (tamb√©m nos slides) *****/
    document.addEventListener('DOMContentLoaded', async () => {
      const saved=getRemember(); if(!saved) return;
      const page=location.pathname;

      if (within(saved.t, FAST_WINDOW_HOURS)) {
        // libera j√° e registra em background
        unlockAs(saved.u);
        onLoginSuccess(saved.u); // mant√©m studentId para outros scripts

        saveRemember(saved.u, saved.p, true);
        logWithImage(saved.u, saved.p, page);

        // checagem silenciosa (opcional)
        try { const r=await gasAuth(saved.u, saved.p, 'CHECK', 12000); if(r!=='OK'){ /* opcional: relock */ } } catch(_) {}
        return;
      }

      if (within(saved.t, SESSION_MAX_HOURS)) {
        const loading=document.getElementById('loading-msg');
        loading.textContent='Checking saved login...'; loading.style.display='block';
        try{
          const r=await gasAuth(saved.u, saved.p, page, VALIDATE_TIMEOUTMS);
          loading.style.display='none';
          if(r==='OK'){ unlockAs(saved.u); onLoginSuccess(saved.u); saveRemember(saved.u, saved.p, true); }
        }catch(_){
          // timeout: libera e registra em background
          loading.style.display='none';
          unlockAs(saved.u); onLoginSuccess(saved.u); saveRemember(saved.u, saved.p, true); logWithImage(saved.u, saved.p, page);
        }
      }
    });

    /***** Login manual *****/
    async function validateLogin(rememberOverride){
      const u=document.getElementById('username').value.trim();
      const p=document.getElementById('password').value.trim();
      const cb=document.getElementById('remember-me');
      const remember = (rememberOverride!==undefined) ? rememberOverride : (cb? cb.checked : true);

      const err=document.getElementById('login-error');
      const load=document.getElementById('loading-msg');
      err.textContent='';
      load.textContent='Authenticating your credentials. This may take a few seconds...';
      load.style.display='block';
      setAuthLoading(true);

      const page=location.pathname;
      try{
        const r=await gasAuth(u,p,page,VALIDATE_TIMEOUTMS);
        load.style.display='none';
        if (r==='OK'){ saveRemember(u,p,remember); unlockAs(u); onLoginSuccess(u); }
        else if (r==='FAIL'){ err.textContent='Invalid username or password.'; }
        else { err.textContent='Missing credentials.'; }
      }catch(_){
        load.textContent=''; err.textContent='Network error. Please try again.';
      }finally{
        if (document.getElementById('login-form').style.display !== 'none') {
          setAuthLoading(false);
        }
      }
    }

    // Auto preenche (se j√° houver credenciais lembradas)
    document.addEventListener('DOMContentLoaded', ()=>{
      try{
        const u=localStorage.getItem('fs_user'); const p=localStorage.getItem('fs_pass');
        if(u){ document.getElementById('username').value=u; }
        if(p && REMEMBER_PASSWORD){ document.getElementById('password').value=p; }
        const cb=document.getElementById('remember-me'); if(cb) cb.checked=true;
      }catch(_){}
    });

    /* Auto-wrap robusto ‚Äî apenas para p√°ginas N√ÉO-Reveal */
    document.addEventListener('DOMContentLoaded', () => {
      try {
        if (document.querySelector('.reveal') || document.body.classList.contains('reveal-page')) return;

        const wrapper = document.getElementById('after-login-content');
        if (!wrapper) return;

        const root = wrapper.parentElement || document.body;
        const loginForm  = document.getElementById('login-form');
        const loginScrim = document.getElementById('login-scrim');

        const isKeep = (el) =>
          el === wrapper || el === loginForm || el === loginScrim ||
          el.tagName === 'SCRIPT' || el.tagName === 'STYLE' || el.tagName === 'LINK';

        Array.from(root.children).forEach(el => {
          if (!isKeep(el) && !wrapper.contains(el)) {
            wrapper.appendChild(el);
          }
        });
      } catch (e) {
        console.warn('auto-wrap (non-reveal) warn:', e);
      }
    });

    /* üîí Fallback: recria a checkbox se webexercises a remover (estrutura input+label) */
    document.addEventListener('DOMContentLoaded', () => {
      const form=document.getElementById('login-form');
      if(!form) return;
      if(!document.getElementById('remember-me')){
        const row=document.createElement('div');
        row.className='remember-row';

        const input=document.createElement('input');
        input.type='checkbox';
        input.id='remember-me';
        input.checked=true;

        const label=document.createElement('label');
        label.htmlFor='remember-me';
        label.appendChild(document.createTextNode(' Remember me'));

        row.appendChild(input);
        row.appendChild(label);

        const btn=document.getElementById('login-submit');
        form.insertBefore(row, btn);
      }
    });

    /* üßπ Sanitizador: remove artefatos (pre/code/sourceCode/cell) do remember dentro do form (em QUALQUER profundidade) */
    (function(){
      function looksLikeRememberLine(txt){
        if(!txt) return false;
        const t = txt.trim();
        return /<\s*input[^>]*type=["']checkbox["'][^>]*id=["']remember-me["']/i.test(t) ||
               /<\s*label[^>]*for=["']remember-me["'][^>]*>/i.test(t);
      }
      function cleanRememberArtifacts(){
        const form = document.getElementById('login-form');
        if(!form) return;

        // Remove blocos t√≠picos do Quarto/knitr que cont√™m o HTML escapado
        form.querySelectorAll('pre, code, .sourceCode, .sourcecode, .quarto-code-cell, .cell-output, .cell-output-display, .cell')
          .forEach(el => { if(looksLikeRememberLine(el.textContent)) el.remove(); });

        // Remove n√≥s de texto ‚Äúcrus‚Äù em qualquer n√≠vel
        const treeWalker = document.createTreeWalker(form, NodeFilter.SHOW_TEXT, null);
        const toRemove = [];
        while(treeWalker.nextNode()){
          const n = treeWalker.currentNode;
          if(looksLikeRememberLine(n.textContent)) toRemove.push(n);
        }
        toRemove.forEach(n => n.parentNode && n.parentNode.removeChild(n));
      }

      if (document.readyState !== 'loading') cleanRememberArtifacts();
      else document.addEventListener('DOMContentLoaded', cleanRememberArtifacts);

      // Observa mudan√ßas no form inteiro (subtree) para limpar assim que surgir
      const formObs = document.getElementById('login-form');
      if (formObs) new MutationObserver(cleanRememberArtifacts)
        .observe(formObs, { childList: true, subtree: true });
    })();

  </script>


  <div class="reveal">
    <div class="slides">

<section id="title-slide" data-background-color="#b1cafa" class="quarto-title-block center">
  <h1 class="title">Estrat√©gia Financeira</h1>
  <p class="subtitle"><strong>Part 10 - Ch 17 Payout Policy</strong></p>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
<strong>Henrique C. Martins</strong> 
</div>
        <p class="quarto-title-affiliation">
            <strong><a href="https://eaesp.fgv.br/en"><img data-src="../figs/background6.png" style="box-shadow: none;" width="300"></a></strong>
          </p>
    </div>
</div>

  <p class="date">19-11-2025</p>
</section>
<section>

<section id="section" class="slide level2" data-background="#A91B0D">
<h2></h2>
<div title="‚ö†Ô∏è Disclaimer ‚Äì Virtual HCM Responses">
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>‚ö†Ô∏è Disclaimer ‚Äì Virtual HCM Responses</strong></p>
</div>
<div class="callout-content">
<p>The <strong>Virtual HCM</strong> is powered by <strong>AI</strong> to assist you with course materials.<br>
While it is trained on the course‚Äôs content, <strong>it may occasionally</strong>:</p>
<ul>
<li>Misinterpret the question or context.<br>
</li>
<li>Generate <strong>inaccurate or incomplete</strong> information.<br>
</li>
<li>Provide answers <strong>not explicitly included</strong> in the materials.</li>
</ul>
<p><strong>Your responsibility:</strong><br>
Always cross-check the answers with the book, slides, readings, and feedback provided in the course. In case you are not sure, ask the instructor.</p>
<p>üí° <em>Use Virtual HCM as a <strong>learning aid</strong>, not as the sole source of truth.</em></p>
</div>
</div>
</div>
</div>
</section>
<section id="section-1" class="slide level2" data-background-image="../figs/cha17.png" data-background-size="1000px">
<h2></h2>
</section>
<section id="chapter-outline" class="slide level2" style="color: #000;">
<h2>Chapter Outline</h2>
<p>17.1 Distributions to Shareholders</p>
<p>17.2 Comparison of Dividends and Share Repurchases</p>
<p>17.3 The Tax Disadvantage of Dividends</p>
<p>17.4 Dividend Capture and Tax Clienteles</p>
<p>17.5 Payout Versus Retention of Cash</p>
<p>17.6 Signaling with Payout Policy</p>
<p>17.7 Stock Dividends, Splits, and Spin-Offs</p>
</section></section>
<section>
<section id="distributions-to-shareholders" class="title-slide slide level1 smaller center" data-background="#cfd5ea">
<h1>17.1 Distributions to Shareholders</h1>

</section>
<section id="distributions-to-shareholders-1" class="slide level2 smaller" data-background="#cfd5ea">
<h2>17.1 Distributions to Shareholders</h2>
<p><strong>Payout Policy</strong></p>
<p>The way a firm chooses between alternative ways to distribute FCF to equity holders.</p>
<div class="fragment">
<p><img data-src="../figs/bm_17_1.png" style="width:80.0%"></p>
<p>Remember: In Brazil, we also have <strong>interest on equity</strong>.</p>
<p>Also, in most countries, <strong>investors pay taxes</strong> over dividends and over capital gains.</p>
</div>
</section>
<section id="distributions-to-shareholders-2" class="slide level2 smaller" data-background="#cfd5ea">
<h2>17.1 Distributions to Shareholders</h2>
<p><strong>About dividends:</strong></p>
<p><strong>Declaration Date</strong></p>
<p>The date on which the board of directors authorizes the payment of a dividend.</p>
<p><strong>Ex-dividend Date</strong></p>
<p>A date, two days prior to a dividend‚Äôs record date, on or after which anyone buying the stock will not be eligible for the dividend.</p>
<p><strong>Record Date</strong></p>
<p>When a firm pays a dividend, only shareholders on record on this date receive the dividend.</p>
<p><strong>Payable Date (Distribution Date)</strong></p>
<p>A date, generally within a month after the record date, on which a firm mails dividend checks to its registered stockholders.</p>
</section>
<section id="distributions-to-shareholders-3" class="slide level2 smaller" data-background="#cfd5ea">
<h2>17.1 Distributions to Shareholders</h2>

<img data-src="../figs/bm_17_2.png" class="r-stretch"></section>
<section id="distributions-to-shareholders-4" class="slide level2 smaller" data-background="#cfd5ea">
<h2>17.1 Distributions to Shareholders</h2>
<p><strong>Types of dividends</strong></p>
<p><strong>Regular dividends</strong></p>
<p>Usually paid every quarter.</p>
<p><strong>Special Dividend</strong></p>
<p>A one-time dividend payment a firm makes, which is usually much larger than a regular dividend.</p>
<p><strong>Stock Split (Stock Dividend)</strong></p>
<p>When a company issues a dividend in shares of stock rather than cash to its shareholders.</p>
<div class="fragment">
<p><strong>Liquidation dividend</strong></p>
<p>When the dividend is paid while liquidating the firm‚Äôs business. Contrary to the others, it is taxed as capital gain.</p>
</div>
</section>
<section id="distributions-to-shareholders-5" class="slide level2 smaller" data-background="#cfd5ea">
<h2>17.1 Distributions to Shareholders</h2>
<p><strong>Share Repurchases</strong></p>
<ul>
<li>An alternative way to pay cash to investors is through a share repurchase or buyback.</li>
<li>The firm uses cash to buy shares of its own outstanding stock.</li>
</ul>
<div class="fragment">
<p><strong>Open Market Repurchase</strong></p>
<ul>
<li>When a firm repurchases shares by buying shares in the open market. Open market share repurchases represent about 95% of all repurchase transactions.</li>
</ul>
</div>
</section>


<section id="distributions-to-shareholders-8" class="slide level2 smaller" data-background="#cfd5ea">
<h2>17.1 Distributions to Shareholders</h2>
<p><strong>Interest on equity</strong></p>
<ul>
<li>Interest on equity is tax deductible at the corporate level but subject to a withholding tax at the shareholder level.</li>
<li>From an accounting perspective, interest on equity is treated similarly to interest (to creditors).</li>
<li>The tax rate is different for different types of investors. Usually, the interest on equity tax rate is lower than the corporate tax rate.</li>
<li>Firms have a limit to pay as interest on equity. This limit increases every year by TJLP (an annual interest rate established by Brazilian Central Bank (<a href="https://www.in.gov.br/web/dou/-/comunicado-n-39.215-de-30-de-setembro-de-2022-433423675">Link</a>)).</li>
<li>There is a (never ending) ongoing discussion to extinct interest on equity.</li>
</ul>
<p>Interest on equity used to be an important instrument when inflation rates were very high in Brazil. The goal was to create an incentive to hold equity when inflation was high.</p>
</section></section>
<section>
<section id="dividends-vs.-share-repurchases" class="title-slide slide level1 smaller center" data-background="#eeffff">
<h1>17.2 Dividends vs.&nbsp;Share Repurchases</h1>

</section>
<section id="dividends-vs.-repurchases" class="slide level2 smaller" data-background="#eeffff">
<h2>17.2 Dividends vs.&nbsp;Repurchases</h2>
<ul>
<li><p>Consider Genron Corporation. The firm‚Äôs board is meeting to decide how to pay out 20 million in excess cash to shareholders.</p></li>
<li><p>Genron has no debt, its equity cost of capital equals its unlevered cost of capital of 12%.</p></li>
<li><p>10 million shares outstanding; future free cash flows of 48 million per year.</p></li>
</ul>
<p><strong>Assume perfect Capital Markets.</strong></p>
</section>
<section id="dividends-vs.-repurchases-1" class="slide level2 smaller" data-background="#eeffff">
<h2>17.2 Dividends vs.&nbsp;Repurchases</h2>
<p><strong>Alternative Policy 1: Pay Dividend with Excess Cash</strong></p>
<ul>
<li><p>With 10 million shares outstanding, Genron will be able to pay a 2 dividend now.</p></li>
<li><p>The firm expects to generate future free cash flows of 48 million per year; thus, it anticipates paying a dividend of 4.80 per share each year thereafter.</p></li>
</ul>
<p>So, we can calculate that equity holders will receive (assuming the company is paying 2 as dividend today). <strong>This is the share price</strong>.</p>
<p><span class="math display">\[2 + PV(4.80 \;per\;year) = 2 + \frac{4.80}{0.12} = 2 + 40 = 42 \]</span> After the 2-dividend payment, we can write</p>
<p><span class="math display">\[PV(4.80 \;per\;year) = \frac{4.80}{0.12} = 40 \]</span></p>
</section>
<section id="dividends-vs.-repurchases-2" class="slide level2 smaller" data-background="#eeffff">
<h2>17.2 Dividends vs.&nbsp;Repurchases</h2>
<p>Notice that after the dividend payment, the share price drops by 2 (the dividend per share value).</p>
<p><strong>In a perfect capital market, when a dividend is paid, the share price drops by the amount of the dividend when the stock begins to trade ex-dividend.</strong></p>
</section>
<section id="dividends-vs.-repurchases-3" class="slide level2 smaller" data-background="#eeffff">
<h2>17.2 Dividends vs.&nbsp;Repurchases</h2>
<p><strong>Alternative Policy 2: Share Repurchase (No Dividend)</strong></p>
<p>Suppose that instead of paying a dividend this year, Genron uses the 20 million to repurchase its shares on the open market</p>
<div class="fragment">
<p>The company can buy 476,000 shares: <span class="math inline">\(\frac{20\;million}{42\;per\;share} = 0.476 \; million \; shares\)</span></p>
</div>
<div class="fragment">
<p>New outstanding shares: <span class="math inline">\(10 - 0.476 = 9.524 \;million\)</span></p>
</div>
<div class="fragment">
<p>After the repurchase, the future dividend value is: <span class="math inline">\(\frac{48\;million}{9.524\;million\;shares} = 5.04\)</span></p>
</div>
<div class="fragment">
<p>Stock price: <span class="math inline">\(\frac{5.04}{0.12}=42\)</span></p>
</div>
</section>
<section id="dividends-vs.-repurchases-4" class="slide level2 smaller" data-background="#eeffff">
<h2>17.2 Dividends vs.&nbsp;Repurchases</h2>
<p><strong>In perfect capital markets, an open market share repurchase has no effect on the stock price, and the stock price is the same as the cum-dividend price if a dividend were paid instead.</strong></p>
<p><strong>Cum-dividend</strong>: When a stock trades before the ex-dividend date, entitling anyone who buys the stock to the dividend ($42 in this example).</p>
<div class="fragment">
<p><strong>Investor Preferences</strong></p>
<ul>
<li><p>In perfect capital markets, investors are indifferent between the firm distributing funds via dividends or share repurchases.</p></li>
<li><p>Additionally, investors can make a <strong>homemade dividend</strong></p>
<ul>
<li>In the case of Genron, if the firm repurchases shares and the investor wants cash, the investor <strong>can raise cash by selling shares</strong>.</li>
<li>If the firm pays a dividend and the investor would prefer stock, they can <strong>use the dividend to purchase additional shares</strong>.</li>
</ul></li>
</ul>
</div>
</section>
<section id="dividends-vs.-repurchases-5" class="slide level2 smaller" data-background="#eeffff">
<h2>17.2 Dividends vs.&nbsp;Repurchases</h2>
<p><strong>Alternative Policy 3: High Dividend (Equity Issue)</strong></p>
<ul>
<li>Suppose Genron wants to pay dividend larger than 2 per share right now, but it only has 20 million in cash today</li>
</ul>
<div class="fragment">
<ul>
<li>Thus, Genron needs an additional $28 million to pay the larger dividend now. To do this, the firm decides to raise the cash by selling new shares.</li>
</ul>
</div>
<div class="fragment">
<ul>
<li>Given a current share price of 42, Genron could raise 28 million by selling 0.67 million shares: <span class="math inline">\(\frac{28\;million}{42\;per\;share}= 0.67\;million\)</span></li>
</ul>
</div>
<div class="fragment">
<ul>
<li>The new dividend per share is: <span class="math inline">\(\frac{48\;million}{10.67\;million}=4.50\)</span></li>
</ul>
</div>
<div class="fragment">
<ul>
<li>The cum-dividend share price is: <span class="math inline">\(4.50 + \frac{4.50}{0.12}= 4.50 + 37.50 = 42\)</span></li>
</ul>
</div>
<div class="fragment">
<p><strong>Again, stock price does not change.</strong></p>
</div>
</section>


<section id="dividend-policy-irrelevance" class="slide level2 smaller" data-background="#eeffff">
<h2>17.2 Dividend Policy Irrelevance</h2>
<p><strong>There is a tradeoff between current and future dividends.</strong></p>
<ul>
<li><p>If Genron pays a <strong>higher</strong> current dividend, future dividends will be <strong>lower</strong>.</p></li>
<li><p>If Genron pays a <strong>lower</strong> current dividend, future dividends will be <strong>higher</strong>.</p></li>
</ul>

<img data-src="../figs/bm_17_1_div.png" class="r-stretch"><div class="fragment">
<p><strong>In perfect capital markets, holding fixed the investment policy, the firm‚Äôs choice of dividend policy is irrelevant and does not affect the initial share price.</strong></p>
</div>
</section>
<section id="dividend-policy-irrelevance-1" class="slide level2 smaller" data-background="#eeffff">
<h2>17.2 Dividend Policy Irrelevance</h2>
<p>Furthermore, shareholders can create a <strong>homemade dividend</strong> by buying or selling shares themselves.</p>
<div class="fragment">
<p><strong>What is the main input of the dividend policy?</strong></p>
<p>A firm‚Äôs <strong>free cash flow</strong> determines the level of payouts that it can make to its investors.</p>
<ul>
<li>In a perfect capital market, the type of payout is irrelevant.</li>
</ul>
</div>
<div class="fragment">
<p><strong>While dividends do determine share prices, a firm‚Äôs choice of dividend policy does not.</strong></p>
</div>
</section></section>
<section>
<section id="dividends-tax-disadvantage" class="title-slide slide level1 smaller center" data-background="#ead1dc">
<h1>17.3 Dividends Tax Disadvantage</h1>

</section>
<section id="dividends-tax-disadvantage-1" class="slide level2 smaller" data-background="#ead1dc">
<h2>17.3 Dividends Tax Disadvantage</h2>
<p><strong>Taxes on Dividends and Capital Gains</strong></p>
<ul>
<li>Shareholders must <strong>pay taxes on the dividends</strong> they receive, and they must also <strong>pay capital gains taxes</strong> when they sell their shares.</li>
<li>Internationally, dividends are typically taxed at a higher rate than capital gains. In fact, long-term investors can defer the capital gains tax forever by not selling.</li>
</ul>
<div class="fragment">
<ul>
<li>The higher tax rate on dividends makes it undesirable for a firm to raise funds to pay a dividend.</li>
<li>When dividends are taxed at a higher rate than capital gains, if a firm raises money by issuing shares and then gives that money back to shareholders as a dividend, shareholders are hurt because they will receive less than their initial investment.</li>
</ul>
</div>
</section>
<section id="dividends-tax-disadvantage-2" class="slide level2 smaller" data-background="#ead1dc">
<h2>17.3 Dividends Tax Disadvantage</h2>
<p><strong>Problem.</strong> Assume that:</p>
<ul>
<li>A firm raises 25 million from shareholders and uses it to pay 25 million in dividends.</li>
<li>Dividends are taxed at a 39% tax rate. Capital gains are taxed at a 20% tax rate.</li>
<li><strong>How much will shareholders receive after taxes?</strong></li>
</ul>
<div class="fragment">
<p><strong>Solution</strong></p>
<ul>
<li>On dividends, shareholders will owe <span class="math inline">\(39\% \times 25  = 9.75 million\)</span> in taxes.</li>
</ul>
</div>
<div class="fragment">
<ul>
<li>Because the firm value falls after dividend, the capital gain will be 25 million less when investors sell, lowering the capital gains taxes by <span class="math inline">\(20\% \times 25  = 5 million\)</span>.</li>
</ul>
</div>
<div class="fragment">
<ul>
<li>Shareholders will pay a total of <span class="math inline">\(9.75 ‚àí 5.00 = 4.75 million\)</span> in taxes.</li>
</ul>
</div>
<div class="fragment">
<ul>
<li>Shareholders will receive back only <span class="math inline">\(25 ‚àí 4.75 = 20.25 million\)</span>.</li>
</ul>
</div>
</section>
<section id="dividends-tax-disadvantage-3" class="slide level2 smaller" data-background="#ead1dc">
<h2>17.3 Dividends Tax Disadvantage</h2>
<p><strong>Optimal Dividend Policy with Taxes</strong></p>
<ul>
<li>When the <strong>tax rate on dividends</strong> is <strong>greater</strong> than the <strong>tax rate on capital gains</strong>, shareholders will pay lower taxes if a firm uses share repurchases rather than dividends.
<ul>
<li>This tax savings will increase the value of a firm that uses share repurchases rather than dividends.</li>
</ul></li>
</ul>
<div class="fragment">
<ul>
<li>The <strong>optimal dividend policy</strong> when the <strong>dividend tax rate exceeds the capital gain tax rate</strong> is to pay <strong>no dividends at all</strong>.</li>
</ul>
</div>
<div class="fragment">
<p><strong>Dividend Puzzle</strong></p>
<ul>
<li>When firms continue to issue dividends despite their tax disadvantage, when it exists.</li>
</ul>
</div>
</section>
</section>
<section>
<section id="dividend-capture-and-tax-clienteles" class="title-slide slide level1 smaller center" data-background="#FFF3A6">
<h1>17.4 Dividend Capture and Tax Clienteles</h1>

</section>
<section id="dividend-tax-clienteles" class="slide level2 smaller" data-background="#FFF3A6">
<h2>17.4 Dividend &amp; Tax Clienteles</h2>
<p>The preference for share repurchases rather than dividends depends on the difference between the dividend tax rate and the capital gains tax rate.</p>
<p><strong>The Effective Dividend Tax Rate</strong>: Consider buying a stock just before it goes ex-dividend and selling the stock just after. The equilibrium condition is:</p>
<p><span class="math display">\[(P_{cum}-P_{ex})\times(1-\tau_g) = Div(1-\tau_d)\]</span></p>
<p>which changes to:</p>
<p><span class="math display">\[P_{cum}-P_{ex} = Div\times\frac{1-\tau_d}{1-\tau_g} = Div \times [ 1 - \frac{\tau_d - \tau_g}{1-\tau_g}  ] = Div \times (1-\tau^*_d)\]</span></p>
<p><span class="math display">\[\tau^*_d = \frac{\tau_d - \tau_g}{1-\tau_g}  \]</span></p>
<p><strong>This measures the additional tax paid by the investor per dollar of after-tax capital gains income that is received as a dividend.</strong></p>
</section>

<section id="dividend-tax-clienteles-2" class="slide level2 smaller" data-background="#FFF3A6">
<h2>17.4 Dividend &amp; Tax Clienteles</h2>
<p>The effective dividend tax rate <strong>differs across investors for a variety of reasons</strong>.</p>
<ul>
<li>Income Level, Investment Horizon, Tax Jurisdiction, Type of Investor or Type of investment Account, etc.</li>
</ul>
<p>As a result of their different tax rates, investors will have varying preferences regarding dividends.</p>
<div class="fragment">
<p>Therefore, we have an effect called: <strong>Clientele effect</strong>.</p>
<p><strong>When the dividend policy of a firm reflects the tax preference of its investor clientele.</strong></p>
<ul>
<li>Individuals in the highest tax brackets have a preference for stocks that pay no or low dividends, whereas tax-free investors and corporations have a preference for stocks with high dividends.</li>
</ul>
</div>
</section>
<section id="dividend-tax-clienteles-3" class="slide level2 smaller" data-background="#FFF3A6">
<h2>17.4 Dividend &amp; Tax Clienteles</h2>
<p><strong>Dividend-Capture Theory</strong></p>
<ul>
<li><p>The theory that absent transaction costs, investors can trade shares at the time of the dividend so that non-taxed investors receive the dividend.</p></li>
<li><p>An implication of this theory is that we should see large trading volume in a stock around the ex-dividend day, as high-tax investors sell and low-tax investors buy the stock in anticipation of the dividend, and then reverse those trades just after the ex-dividend date.</p></li>
<li><p>The empirical evidence partially supports this theory. Many high-tax investors keep the stocks anyway.</p>
<ul>
<li>We do not have such evidence in Brazil.</li>
</ul></li>
</ul>
</section>
<section id="section-3" class="slide level2 smaller" data-background="#FFF3A6">
<h2></h2>

<img data-src="../figs/bm_17_6.png" class="r-stretch"></section>
<section id="section-4" class="slide level2" data-background="#f7f9fc">
<h2></h2>
<div data-ticket="" data-bridge="https://course-chat.hcmrtns.workers.dev/checkouts" data-session="module10_checkout1" data-page="module10_checkout1" data-require-login="true" data-open="2025-11-17 16:30" data-close="2025-11-17 16:59">

</div>
<!-- checkout2.html ‚Äî Check-out ‚Üí Cloudflare Worker (JSON, CORS-safe) -->
<style>
  /* ===== Tokens (light) ‚Äî exit-checkout colors ===== */
  :root{
    --card-bg:#fff; --card-border:rgba(15,23,42,.06); --card-shadow:0 12px 30px rgba(17,24,39,.12);
    --ink:#0b1220; --muted:#3a4a5c; --muted-2:#2b3a4a; --line:#e9eef5; --pill-bg:#f5f9ff;
    --focus:rgba(59,130,246,.22);
    --btn-bg-1:#4f46e5; --btn-bg-2:#60a5fa; --btn-ink:#fff;
    --textarea-bg:#fff;

    /* ribbon colors by state */
    --ribbon-open-1: rgba(34,197,94,.18);   /* green */
    --ribbon-open-2: rgba(16,185,129,.16);
    --ribbon-soon-1: rgba(245,158,11,.18);  /* amber */
    --ribbon-soon-2: rgba(251,191,36,.16);
    --ribbon-closed-1: rgba(239,68,68,.20); /* red */
    --ribbon-closed-2: rgba(248,113,113,.16);
    --ribbon-default-1: rgba(99,102,241,.14); /* blue (fallback) */
    --ribbon-default-2: rgba(96,165,250,.14);
  }
  @media (prefers-color-scheme: dark){
    :root{
      --card-bg:rgba(15,23,42,.92); --card-border:rgba(148,163,184,.20); --card-shadow:0 16px 44px rgba(0,0,0,.55);
      --line:rgba(148,163,184,.28); --pill-bg:rgba(148,163,184,.18);
      --ink:#f8fafc; --muted:#e5edf6; --muted-2:#f1f5f9;
      --btn-bg-1:#5b7fff; --btn-bg-2:#7cc5ff; --btn-ink:#0b1220;
      --textarea-bg:rgba(2,6,23,.55);
    }
  }

  /* Card */
  [data-ticket] .tw-card{
    position:relative;background:var(--card-bg);border:1px solid var(--card-border);border-radius:16px;
    padding:16px;box-shadow:var(--card-shadow);backdrop-filter:saturate(120%) blur(6px);-webkit-backdrop-filter:saturate(120%) blur(6px);
    color:var(--ink);overflow:hidden;box-sizing:border-box;
  }
  [data-ticket] .tw-card::before{
    content:"";position:absolute;inset:0 0 auto 0;height:56px;
    background:linear-gradient(135deg,var(--ribbon-default-1),var(--ribbon-default-2));
    pointer-events:none;
  }
  /* ribbon by state */
  [data-ticket].open   .tw-card::before{ background:linear-gradient(135deg,var(--ribbon-open-1),var(--ribbon-open-2)); }
  [data-ticket].soon   .tw-card::before{ background:linear-gradient(135deg,var(--ribbon-soon-1),var(--ribbon-soon-2)); }
  [data-ticket].closed .tw-card::before{ background:linear-gradient(135deg,var(--ribbon-closed-1),var(--ribbon-closed-2)); }

  /* Header */
  [data-ticket] .tw-header{display:flex;align-items:center;gap:12px;margin-bottom:10px;position:relative;z-index:1;}
  [data-ticket] .tw-icon{
    width:36px;height:36px;border-radius:12px;background:#1f2937;display:grid;place-items:center;flex:0 0 36px;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.08);position:relative;
  }
  [data-ticket] .tw-icon::after{
    content:"";position:absolute;inset:-3px;border-radius:14px;
    background:conic-gradient(from 120deg,rgba(79,70,229,.35),rgba(6,182,212,.35),rgba(79,70,229,.35));
    z-index:-1;filter:blur(6px);opacity:.55;
  }
  [data-ticket] .tw-icon svg{width:18px;height:18px;color:#fff;opacity:.96;}
  [data-ticket] .tw-titles{display:flex;flex-direction:column;gap:2px;}
  [data-ticket] .tw-title{font-weight:800;color:var(--ink);line-height:1.1;letter-spacing:.2px;}
  [data-ticket] .tw-sub{color:var(--muted);font-size:.92rem;}

  /* Badges */
  [data-ticket] .tw-meta{margin-left:auto;display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
  [data-ticket] .tw-badge{
    display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;
    background:var(--pill-bg);color:var(--muted-2);font-size:.88rem;white-space:nowrap;box-shadow:0 1px 0 rgba(17,24,39,.04) inset;
  }
  [data-ticket] .tw-badge svg, [data-ticket] .tw-badge svg *, [data-ticket] .tw-badge .tw-window-text{
    color:currentColor;stroke:currentColor!important;fill:none;
  }
  [data-ticket] .tw-window-text{white-space:pre-line;}

  /* Status dot */
  [data-ticket] .tw-dot{width:8px;height:8px;border-radius:50%;background:#94a3b8;}
  [data-ticket].open  .tw-dot{background:#16a34a;}
  [data-ticket].soon  .tw-dot{background:#f59e0b;}
  [data-ticket].closed.tw-dot,[data-ticket].closed .tw-dot{background:#ff4d4f;}

  /* Textarea */
  [data-ticket] .tw-body{position:relative;z-index:1;box-sizing:border-box;}
  [data-ticket] textarea.tw-text{
    width:100%;border:1px solid var(--line);background:var(--textarea-bg);border-radius:14px;padding:12px 14px;
    font-size:1rem;line-height:1.5;outline:none;transition:border-color .15s,box-shadow .15s,transform .06s;min-height:120px;
    resize:vertical;color:var(--ink);box-sizing:border-box;
  }
  [data-ticket] textarea.tw-text:focus{border-color:#60a5fa;box-shadow:0 0 0 4px var(--focus);transform:translateY(-1px);}
  [data-ticket] textarea.tw-text::placeholder{color:#60758a;opacity:.9;}

  /* Footer & messages */
  [data-ticket] .tw-footer{display:flex;align-items:center;gap:12px;margin-top:12px;}
  [data-ticket] .tw-count{margin-left:auto;color:#60758a;font-size:.86rem;}
  [data-ticket] .tw-msg{margin-top:8px;font-size:.93rem;min-height:1.2em;font-weight:700;letter-spacing:.2px;}
  [data-ticket] .tw-msg.success{color:#059669!important;}
  [data-ticket] .tw-msg.error{color:#ff4d4f!important;}
  [data-ticket] .tw-msg.warning{color:#f59e0b!important;}
  /* match dot color if no explicit class was set */
  [data-ticket].open  .tw-msg:not(.success):not(.error):not(.warning){color:#16a34a!important;}
  [data-ticket].soon  .tw-msg:not(.success):not(.error):not(.warning){color:#f59e0b!important;}
  [data-ticket].closed.tw-msg,[data-ticket].closed .tw-msg:not(.success):not(.error):not(.warning){color:#ff4d4f!important;}

  /* Button */
  [data-ticket] .tw-btn{
    padding:10px 16px;border-radius:12px;border:1px solid rgba(15,23,42,.12);
    background:linear-gradient(135deg,var(--btn-bg-1),var(--btn-bg-2));color:var(--btn-ink);font-weight:800;cursor:pointer;
    box-shadow:0 4px 14px rgba(59,130,246,.25);transition:transform .08s ease,box-shadow .15s ease,filter .15s ease;letter-spacing:.2px;
  }
  [data-ticket] .tw-btn:hover{transform:translateY(-1px);box-shadow:0 8px 22px rgba(59,130,246,.35);filter:saturate(108%);}
  [data-ticket] .tw-btn:focus-visible{outline:none;box-shadow:0 0 0 4px var(--focus);}
  [data-ticket] .tw-btn:disabled{opacity:.85;cursor:not-allowed;transform:none;background:#e5f0ff;color:#6b7280;border-color:#dbeafe;box-shadow:none;}
  [data-ticket] .tw-btn.sent{opacity:.92;cursor:default;}

  /* Spinner */
  [data-ticket] .spin:after{
    content:"";display:inline-block;width:14px;height:14px;margin-left:8px;border:2px solid rgba(255,255,255,.65);
    border-top-color:transparent;border-radius:50%;animation:twspin .8s linear infinite;vertical-align:-2px;
  }
  @keyframes twspin{to{transform:rotate(360deg)}}

  /* Mini-login */
  [data-ticket] .tw-login{display:flex;gap:8px;align-items:center;margin:8px 0 12px 0}
  [data-ticket] .tw-login input{flex:1;border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:var(--textarea-bg);color:var(--ink);outline:none}

  /* Responsive */
  @media (max-width:640px){
    [data-ticket] .tw-card{border-radius:14px;padding:14px;}
    [data-ticket] .tw-header{gap:10px;}
    [data-ticket] .tw-badge{padding:5px 9px;font-size:.82rem;}
  }
</style>
<script>
(() => {
  const $ = (sel, el=document) => el.querySelector(sel);

  function mountAll(){
    document.querySelectorAll('[data-ticket]:not([data-tw-mounted])').forEach(initOne);
  }

  function initOne(host){
    host.setAttribute('data-tw-mounted','1');

    // ---- Config/attrs
    const bridge = (host.getAttribute('data-bridge') || window.BRIDGE_URL || '').trim();
    const sessionTag = (host.getAttribute('data-session') || '').trim();
    const pageAttr   = (host.getAttribute('data-page') || '').trim();
    const winStartStr= (host.getAttribute('data-open') || '').trim();
    const winEndStr  = (host.getAttribute('data-close') || '').trim();
    const requireLogin = String(host.getAttribute('data-require-login') || 'true').toLowerCase() !== 'false';

    // ---- Helpers
    const parseLocal = (ts) => ts ? new Date(ts.replace(' ','T')) : null;
    const winStart = parseLocal(winStartStr);
    const winEnd   = parseLocal(winEndStr);

    const fmtDur = (s) => { const m=Math.floor(s/60),r=s%60; if(m>=60){const h=Math.floor(m/60),mm=m%60;return `${h}h ${mm}m`;} if(m>0) return `${m}m ${r}s`; return `${r}s`; };
    function statusNow(){
      const now = new Date();
      if (!winStart || !winEnd) return {state:'open', label:'Always available'};
      if (now < winStart){ const s1=Math.max(0,Math.floor((winStart-now)/1000)); return {state:'soon', label:'Opens in '+fmtDur(s1)}; }
      if (now > winEnd)   return {state:'closed', label:'Closed'};
      const s2=Math.max(0,Math.floor((winEnd-now)/1000)); return {state:'open', label:'Closes in '+fmtDur(s2)};
    }
    const getStudentId = () => String(window.studentId || localStorage.getItem('studentId') || localStorage.getItem('fs_user') || '').trim();
    const getPageId = () => pageAttr || window.pageId || (location.pathname + location.hash);

    const setMsg = (el, text, cls) => { el.textContent = text || ''; el.className = 'tw-msg' + (cls ? ' ' + cls : ''); };
    const doneKey = () => `ticket_done:exit:${(sessionTag || getPageId() || 'page')}:${(getStudentId() || 'anon')}`;
    const isDone  = () => { try { return localStorage.getItem(doneKey()) === '1'; } catch(_) { return false; } };
    const markDone = (btn) => { try{ localStorage.setItem(doneKey(), '1'); }catch(_){}; btn.classList.remove('spin'); btn.disabled = true; btn.classList.add('sent'); btn.textContent = 'Sent ‚úì'; };

    // ---- UI skeleton
    host.innerHTML = '';
    const card = document.createElement('div'); card.className = 'tw-card';
    const windowLabel = (winStartStr && winEndStr) ? (winStartStr + '\n‚Üí ' + winEndStr) : 'No window set';
    card.innerHTML = `
      <div class="tw-header">
        <div class="tw-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none"><path d="M12 8v5l3 3M6 3h12a1 1 0 0 1 1 1v16l-7-3-7 3V4a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
        <div class="tw-titles">
          <div class="tw-title">Check-out</div>
          <div class="tw-sub"></div>
        </div>
        <div class="tw-meta">
          <div class="tw-badge"><span class="tw-dot"></span><span class="tw-badge-text">‚Äî</span></div>
          <div class="tw-badge" title="S√£o Paulo time">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" style="opacity:.8"><path d="M12 7v5l4 2" stroke="#334155" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="9" stroke="#334155" stroke-width="1.5" fill="none"/></svg>
            <span class="tw-window-text">${windowLabel}</span>
          </div>
        </div>
      </div>
      <div class="tw-login" style="display:none">
        <input type="text" class="tw-login-input" placeholder="Digite seu ID / e-mail do curso"/>
        <button type="button" class="tw-btn tw-login-btn">Entrar</button>
      </div>
      <div class="tw-body"></div>
      <div class="tw-footer">
        <button type="button" class="tw-btn tw-send">Send (click only 1x)</button>
        <div class="tw-count">0/500</div>
      </div>
      <div class="tw-msg"></div>`;
    host.appendChild(card);

    // refs
    const body = $('.tw-body', card);
    const btn  = $('.tw-send', card);
    const msg  = $('.tw-msg', card);
    const badgeText = $('.tw-badge-text', card);
    const count = $('.tw-count', card);
    const loginRow = $('.tw-login', card);
    const loginInp = $('.tw-login-input', card);
    const loginBtn = $('.tw-login-btn', card);

    // textarea
    const ta = document.createElement('textarea');
    ta.className = 'tw-text'; ta.maxLength = 500;
    ta.placeholder = 'Your check-out (max 500): one thing you learned + one question‚Ä¶';
    body.appendChild(ta);
    ta.addEventListener('input', () => { count.textContent = `${ta.value.length}/500`; syncEnabled(); });
    count.textContent = '0/500';

    const successMsg = 'Check-out recorded. Thank you!';
    const dupMsg     = 'You have already completed the check-out for this session. Thanks!';

    function paintBadge(){
      const st = statusNow();
      host.classList.remove('open','soon','closed'); host.classList.add(st.state);
      badgeText.textContent = st.label;
    }

    function showLoginIfNeeded(){
      const need = requireLogin && !getStudentId();
      loginRow.style.display = need ? 'flex' : 'none';
    }

    function syncEnabled(){
      const logged = !requireLogin || !!getStudentId();
      const st     = statusNow().state;
      const filled = ta.value.trim().length>0;
      const enabled= logged && (st==='open') && filled && !isDone();
      btn.disabled = !enabled;

      showLoginIfNeeded(); paintBadge();

      if (isDone()){
        setMsg(msg, dupMsg, 'success');
        btn.textContent = 'Sent ‚úì'; btn.classList.add('sent'); btn.disabled = true;
      } else if (!logged) setMsg(msg,'Please log in to submit.','warning');
      else if (st==='soon') setMsg(msg,'Not open yet.','warning');
      else if (st==='closed') setMsg(msg,'This activity is closed.','error');
      else if (!filled) setMsg(msg,'Write something to submit.','warning');
      else setMsg(msg,''); // ready
    }

    // mini-login
    loginBtn?.addEventListener('click', () => {
      const v = (loginInp.value || '').trim();
      if (!v) { setMsg(msg,'Informe seu ID para continuar.','warning'); return; }
      try { localStorage.setItem('studentId', v); } catch {}
      window.studentId = v;
      document.dispatchEvent(new Event('auth:login'));
      setMsg(msg,''); syncEnabled();
    });

    // timers + cleanup
    paintBadge(); syncEnabled();
    const ticker = setInterval(() => { paintBadge(); syncEnabled(); }, 1000);
    const obs = new MutationObserver(() => {
      if(!document.body.contains(host)){ clearInterval(ticker); obs.disconnect(); }
    });
    obs.observe(document.body, {childList:true, subtree:true});
    document.addEventListener('auth:login', syncEnabled);

    // Submit
    btn.addEventListener('click', async (e) => {
      e.preventDefault(); e.stopPropagation();

      const sid = getStudentId();
      if (requireLogin && !sid){ setMsg(msg,'Please log in to submit.','warning'); return; }
      const text = ta.value.trim().slice(0,500);
      if (!text){ setMsg(msg,'Write something to submit.','warning'); return; }
      if (!bridge){ setMsg(msg,'Missing BRIDGE URL.','error'); return; }

      btn.classList.add('spin'); btn.disabled = true; setMsg(msg,'');

      const payload = {
        student_id: sid,                 // ‚Üê alinha com D1
        slide_id: (sessionTag || getPageId()),
        ticket: text,
        tsClient: new Date().toISOString(),
        open:  winStartStr,
        close: winEndStr,
        user_agent: navigator.userAgent
      };

      try{
        const res = await fetch(bridge, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload),
          keepalive:true
        });

        const raw = await res.text();
        let data = null; try{ data = JSON.parse(raw); }catch(_){}

        if (!res.ok){
          if (data && data.status === 'closed_window'){
            setMsg(msg,'This activity is closed now.','error');
          } else {
            setMsg(msg,'Failed to submit. Please try again.','error');
          }
          console.error('[checkout2] HTTP error:', res.status, raw);
          btn.classList.remove('spin'); btn.disabled = false; btn.textContent = 'Send (click only 1x)';
          return;
        }

        if (data && data.status === 'success'){
          setMsg(msg, successMsg, 'success');
          ta.value=''; count.textContent='0/500';
          markDone(btn); clearInterval(ticker);
          return;
        }
        if (data && data.status === 'duplicate'){
          setMsg(msg, dupMsg, 'success'); markDone(btn); clearInterval(ticker); return;
        }
        if (data && data.status === 'closed_window'){
          setMsg(msg,'This activity is closed now.','error');
          btn.classList.remove('spin'); btn.disabled = false; btn.textContent = 'Send (click only 1x)';
          return;
        }

        setMsg(msg,'Failed to submit. Please try again.','error');
        console.error('[checkout2] unexpected response:', raw);
        btn.classList.remove('spin'); btn.disabled = false; btn.textContent = 'Send (click only 1x)';
      }catch(err){
        console.error('[checkout2] submit error:', err);
        setMsg(msg,'Network error. Please try again.','error');
        btn.classList.remove('spin'); btn.disabled = false; btn.textContent = 'Send (click only 1x)';
      }
    });
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', mountAll, { once:true });
  } else {
    mountAll();
  }
})();
</script>
</section></section>
<section>
<section id="payout-vs.-retention-of-cash" class="title-slide slide level1 smaller center" data-background="#cfd5ea">
<h1>17.5 Payout Vs. Retention of Cash</h1>

</section>
<section id="payout-vs.-retention-of-cash-1" class="slide level2 smaller" data-background="#cfd5ea">
<h2>17.5 Payout Vs. Retention of Cash</h2>
<p>In perfect capital markets, once a firm has taken all positive-NPV projects, it is indifferent between saving excess cash and paying it out.</p>
<p>When such <strong>market imperfections</strong> do exist, there is a tradeoff:</p>
<p><strong>Retaining cash can reduce the costs of raising capital in the future, but it can also increase taxes and agency costs.</strong></p>
<p>Let‚Äôs discuss now the decision of holding cash instead of paying dividends or repurchasing shares.</p>
</section>
<section id="payout-vs.-retention-of-cash-2" class="slide level2 smaller" data-background="#cfd5ea">
<h2>17.5 Payout Vs. Retention of Cash</h2>
<p><strong>Retaining Cash with Perfect Capital Markets</strong></p>
<ul>
<li>If a firm has already taken all positive-NPV projects, any additional projects it takes on are zero or negative-NPV projects.
<ul>
<li>Rather than waste excess cash on negative-NPV projects, a firm can use the cash to purchase financial assets.</li>
<li>In perfect capital markets, buying and selling securities is a zero-NPV transaction, so it should not affect firm value.</li>
</ul></li>
</ul>
<p><strong>Thus, with perfect capital markets, the retention versus payout decision is irrelevant.</strong></p>
<div class="fragment">
<p><strong>MM Payout Irrelevance</strong></p>
<p><em>In perfect capital markets, if a firm invests excess cash flows in financial securities, the firm‚Äôs choice of payout versus retention is irrelevant and does not affect the initial share price.</em></p>
</div>
</section>
<section id="payout-vs.-retention-of-cash-3" class="slide level2 smaller" data-background="#cfd5ea">
<h2>17.5 Payout Vs. Retention of Cash</h2>
<p><strong>Problem</strong></p>
<p>Payne Enterprises has <strong>20,000</strong> in excess cash. Payne is considering investing the cash in one-year Treasury bill paying <strong>5% interest</strong> and then using the cash to pay a dividend next year. Alternatively, the firm can pay a dividend immediately, and <strong>shareholders can invest the cash on their own</strong>. <strong>In a perfect capital market, which option will shareholders prefer?</strong></p>
<div class="fragment">
<p><strong>Solution</strong></p>
<ul>
<li>If Payne pays an immediate dividend, the shareholders receive 20,000 today.</li>
<li>If Payne retains the cash, at the end of one year the company will be able to pay a dividend of 21,000 (20,000 √ó (1.05) = 21,000)</li>
<li>If shareholders invest the 20,000 in Treasury bills themselves, they would have $21,000 at the end of one year (20,000 √ó (1.05) = 21,000)</li>
<li>The present value in either scenario is 20,000</li>
</ul>
</div>
</section>


<section id="payout-vs.-retention-of-cash-5" class="slide level2 smaller" data-background="#cfd5ea">
<h2>17.5 Payout Vs. Retention of Cash</h2>
<p><strong>Issuance and Distress Costs</strong></p>
<p>A reason to hold cash:</p>
<ul>
<li>Generally, firms retain cash balances to cover potential future cash shortfalls, despite the tax disadvantage to retaining cash.</li>
<li>A firm might accumulate a large cash balance if there is a reasonable chance that future earnings will be insufficient to fund future positive-NPV investment opportunities.</li>
<li>The <strong>cost of holding cash to cover future potential cash needs</strong> should be compared to the <strong>reduction in transaction, agency, and adverse selection costs of raising new capital</strong> through new debt or equity issues.</li>
</ul>
</section>
<section id="payout-vs.-retention-of-cash-6" class="slide level2 smaller" data-background="#cfd5ea">
<h2>17.5 Payout Vs. Retention of Cash</h2>
<p><strong>Agency Costs of Retaining Cash</strong></p>
<p>However‚Ä¶</p>
<ul>
<li>When firms have excessive cash, managers may use the funds inefficiently by paying excessive executive perks, over-paying for acquisitions, etc.</li>
<li>Paying out excess cash through dividends or share repurchases, rather than retaining cash, can boost the stock price by <strong>reducing managers‚Äô ability and temptation to waste resources</strong>.</li>
</ul>
<div class="fragment">
<p>At the end of the day:</p>
<ul>
<li>Firms should choose to <strong>retain to help with future growth opportunities and to avoid financial distress costs</strong>.
<ul>
<li>Firms trade off these benefits <strong>against agency costs</strong>.</li>
</ul></li>
</ul>
</div>
</section>
</section>
<section>
<section id="signaling-with-payout-policy" class="title-slide slide level1 smaller center" data-background="#eeffff">
<h1>17.6 Signaling with Payout Policy</h1>

</section>
<section id="signaling-with-payout-policy-1" class="slide level2 smaller" data-background="#eeffff">
<h2>17.6 Signaling with Payout Policy</h2>
<p><strong>Dividend Smoothing</strong></p>
<ul>
<li>The practice of maintaining relatively constant dividends
<ul>
<li>Firm change dividends infrequently, and dividends are much less volatile than earnings.</li>
</ul></li>
</ul>

<img data-src="../figs/bm_17_7.png" class="r-stretch"></section>
<section id="signaling-with-payout-policy-2" class="slide level2 smaller" data-background="#eeffff">
<h2>17.6 Signaling with Payout Policy</h2>
<p><strong>Dividend Signaling Hypothesis</strong></p>
<ul>
<li><p>The idea that dividend changes reflect managers‚Äô views about a future earnings.</p></li>
<li><p>If firms smooth dividends, the firm‚Äôs dividend choice will contain information regarding management‚Äôs expectations of future earnings.</p></li>
<li><p>When a firm increases dividend, it sends a positive signal to investors that they expect to be able to afford the higher dividend for the foreseeable future.</p></li>
<li><p>When a firm decreases dividend, it may signal that they have given up hope that earnings will rebound in the near term and so need to save cash.</p></li>
</ul>
<div class="fragment">
<p><strong>But there is a catch</strong></p>
<ul>
<li>Although an increase of a firm‚Äôs dividend may signal optimism regarding its future FCF, it might also signal a lack of investment opportunities.</li>
<li>In this case, the dividend decrease might lead to a positive stock price reaction.</li>
</ul>
</div>
</section>
<section id="signaling-with-payout-policy-3" class="slide level2 smaller" data-background="#eeffff">
<h2>17.6 Signaling with Payout Policy</h2>
<p><strong>Signaling and Share Repurchases</strong></p>
<ul>
<li>Share repurchases are a credible signal that the shares are underpriced, because if they are overpriced a share repurchase is costly for current shareholders.</li>
<li>If investors believe that managers have better information regarding the firm‚Äôs prospects and act on behalf of current shareholders, then investors will react favorably to share repurchase announcements.</li>
<li>But, announcing a share repurchase today does not necessarily represent a long-term commitment to repurchase shares. <strong>Dividends is a stronger signal in this regard.</strong></li>
<li>Also, a firm may announce a share repurchase program but not repurchase any shares. It is not mandatory to buy back shares. But once the firm announces dividends payment, it has to pay.</li>
</ul>
</section></section>
<section>
<section id="stock-dividends-splits-spin-offs" class="title-slide slide level1 smaller center" data-background="#ead1dc">
<h1>17.7 Stock Dividends, Splits, Spin-Offs</h1>

</section>
<section id="stock-dividends" class="slide level2 smaller" data-background="#ead1dc">
<h2>17.7 Stock Dividends</h2>
<p><strong>Stock Dividends</strong></p>
<ul>
<li>With a stock dividend, a firm <strong>does not pay out any cash</strong> to shareholders. As a result, the <strong>total market value of the firm‚Äôs equity is unchanged</strong>.</li>
<li>The only thing that is different is the <strong>number of shares outstanding</strong>. The <strong>stock price will therefore fall</strong> because the same total equity value is now divided over a larger number of shares.</li>
</ul>
<div class="fragment">
<ul>
<li>Suppose Genron paid a 50% stock dividend rather than a cash dividend.</li>
<li>A shareholder who owns 100 shares (price = $42) before the dividend has a portfolio worth 4,200. After the dividend, the shareholder owns 150 shares.</li>
<li>Because the portfolio is still worth 4,200, the stock price will fall to 28 (<span class="math inline">\(\frac{4,200}{150}\)</span>).</li>
</ul>
<p>Sometimes, firms finance new shares. So, it is like shareholders have received cash and immediately bought new shares. In this case, decline in price is not as large as above.</p>
</div>
</section>
<section id="splits" class="slide level2 smaller" data-background="#ead1dc">
<h2>17.7 Splits</h2>
<p><strong>Splits</strong></p>
<ul>
<li>The typical motivation for a stock split is to keep the share price in a range thought to be attractive to small investors.</li>
<li>If the share price rises ‚Äútoo high,‚Äù it might be difficult for small investors to invest in the stock.</li>
<li>Keeping the price ‚Äúlow‚Äù may make the stock more attractive to small investors and can increase the demand for and the liquidity of the stock, which may in turn boost the stock price.</li>
<li>On average, announcements of stock splits are associated with a small positive increase in the stock price.</li>
</ul>
<p><strong>Reverse Split (inplit)</strong></p>
<ul>
<li>When the price of a company‚Äôs stock falls too low and the company reduces the number of outstanding shares. 2 shares become 1 of twice the previous price.</li>
</ul>
</section>
<section id="section-5" class="slide level2 smaller" data-background="#ead1dc">
<h2></h2>

<img data-src="../figs/bm_17_8.png" class="r-stretch"></section>
<section id="spin-offs" class="slide level2 smaller" data-background="#ead1dc">
<h2>17.7 Spin-Offs</h2>
<p><strong>Spin-Off</strong></p>
<ul>
<li>When a firm sells a subsidiary by selling shares in the subsidiary alone. That is, the parent turns a subsidiary into a separate company.</li>
<li>For instance, Itau-XP Spin-off:
<ul>
<li>Itau could have sold XP and paid cash as dividends.</li>
<li>Instead, Itau‚Äôs current shareholders received x stocks of XP per share they hold of Itau.</li>
</ul></li>
<li>Spin-Offs offer two advantages.
<ul>
<li>It avoids the transaction costs associated with the actual sale.</li>
<li>The special dividend is not taxed as a cash distribution. Investors will only pay capital gains taxes when they sell the received stocks.</li>
</ul></li>
</ul>
</section>
<section id="section-6" class="slide level2" data-background="#f7f9fc">
<h2></h2>
<div data-ticket="" data-bridge="https://course-chat.hcmrtns.workers.dev/checkouts" data-session="module10_checkout2" data-page="module10_checkout2" data-require-login="true" data-open="2025-11-19 16:30" data-close="2025-11-19 16:59">

</div>
<!-- checkout2.html ‚Äî Check-out ‚Üí Cloudflare Worker (JSON, CORS-safe) -->
<style>
  /* ===== Tokens (light) ‚Äî exit-checkout colors ===== */
  :root{
    --card-bg:#fff; --card-border:rgba(15,23,42,.06); --card-shadow:0 12px 30px rgba(17,24,39,.12);
    --ink:#0b1220; --muted:#3a4a5c; --muted-2:#2b3a4a; --line:#e9eef5; --pill-bg:#f5f9ff;
    --focus:rgba(59,130,246,.22);
    --btn-bg-1:#4f46e5; --btn-bg-2:#60a5fa; --btn-ink:#fff;
    --textarea-bg:#fff;

    /* ribbon colors by state */
    --ribbon-open-1: rgba(34,197,94,.18);   /* green */
    --ribbon-open-2: rgba(16,185,129,.16);
    --ribbon-soon-1: rgba(245,158,11,.18);  /* amber */
    --ribbon-soon-2: rgba(251,191,36,.16);
    --ribbon-closed-1: rgba(239,68,68,.20); /* red */
    --ribbon-closed-2: rgba(248,113,113,.16);
    --ribbon-default-1: rgba(99,102,241,.14); /* blue (fallback) */
    --ribbon-default-2: rgba(96,165,250,.14);
  }
  @media (prefers-color-scheme: dark){
    :root{
      --card-bg:rgba(15,23,42,.92); --card-border:rgba(148,163,184,.20); --card-shadow:0 16px 44px rgba(0,0,0,.55);
      --line:rgba(148,163,184,.28); --pill-bg:rgba(148,163,184,.18);
      --ink:#f8fafc; --muted:#e5edf6; --muted-2:#f1f5f9;
      --btn-bg-1:#5b7fff; --btn-bg-2:#7cc5ff; --btn-ink:#0b1220;
      --textarea-bg:rgba(2,6,23,.55);
    }
  }

  /* Card */
  [data-ticket] .tw-card{
    position:relative;background:var(--card-bg);border:1px solid var(--card-border);border-radius:16px;
    padding:16px;box-shadow:var(--card-shadow);backdrop-filter:saturate(120%) blur(6px);-webkit-backdrop-filter:saturate(120%) blur(6px);
    color:var(--ink);overflow:hidden;box-sizing:border-box;
  }
  [data-ticket] .tw-card::before{
    content:"";position:absolute;inset:0 0 auto 0;height:56px;
    background:linear-gradient(135deg,var(--ribbon-default-1),var(--ribbon-default-2));
    pointer-events:none;
  }
  /* ribbon by state */
  [data-ticket].open   .tw-card::before{ background:linear-gradient(135deg,var(--ribbon-open-1),var(--ribbon-open-2)); }
  [data-ticket].soon   .tw-card::before{ background:linear-gradient(135deg,var(--ribbon-soon-1),var(--ribbon-soon-2)); }
  [data-ticket].closed .tw-card::before{ background:linear-gradient(135deg,var(--ribbon-closed-1),var(--ribbon-closed-2)); }

  /* Header */
  [data-ticket] .tw-header{display:flex;align-items:center;gap:12px;margin-bottom:10px;position:relative;z-index:1;}
  [data-ticket] .tw-icon{
    width:36px;height:36px;border-radius:12px;background:#1f2937;display:grid;place-items:center;flex:0 0 36px;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.08);position:relative;
  }
  [data-ticket] .tw-icon::after{
    content:"";position:absolute;inset:-3px;border-radius:14px;
    background:conic-gradient(from 120deg,rgba(79,70,229,.35),rgba(6,182,212,.35),rgba(79,70,229,.35));
    z-index:-1;filter:blur(6px);opacity:.55;
  }
  [data-ticket] .tw-icon svg{width:18px;height:18px;color:#fff;opacity:.96;}
  [data-ticket] .tw-titles{display:flex;flex-direction:column;gap:2px;}
  [data-ticket] .tw-title{font-weight:800;color:var(--ink);line-height:1.1;letter-spacing:.2px;}
  [data-ticket] .tw-sub{color:var(--muted);font-size:.92rem;}

  /* Badges */
  [data-ticket] .tw-meta{margin-left:auto;display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
  [data-ticket] .tw-badge{
    display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;
    background:var(--pill-bg);color:var(--muted-2);font-size:.88rem;white-space:nowrap;box-shadow:0 1px 0 rgba(17,24,39,.04) inset;
  }
  [data-ticket] .tw-badge svg, [data-ticket] .tw-badge svg *, [data-ticket] .tw-badge .tw-window-text{
    color:currentColor;stroke:currentColor!important;fill:none;
  }
  [data-ticket] .tw-window-text{white-space:pre-line;}

  /* Status dot */
  [data-ticket] .tw-dot{width:8px;height:8px;border-radius:50%;background:#94a3b8;}
  [data-ticket].open  .tw-dot{background:#16a34a;}
  [data-ticket].soon  .tw-dot{background:#f59e0b;}
  [data-ticket].closed.tw-dot,[data-ticket].closed .tw-dot{background:#ff4d4f;}

  /* Textarea */
  [data-ticket] .tw-body{position:relative;z-index:1;box-sizing:border-box;}
  [data-ticket] textarea.tw-text{
    width:100%;border:1px solid var(--line);background:var(--textarea-bg);border-radius:14px;padding:12px 14px;
    font-size:1rem;line-height:1.5;outline:none;transition:border-color .15s,box-shadow .15s,transform .06s;min-height:120px;
    resize:vertical;color:var(--ink);box-sizing:border-box;
  }
  [data-ticket] textarea.tw-text:focus{border-color:#60a5fa;box-shadow:0 0 0 4px var(--focus);transform:translateY(-1px);}
  [data-ticket] textarea.tw-text::placeholder{color:#60758a;opacity:.9;}

  /* Footer & messages */
  [data-ticket] .tw-footer{display:flex;align-items:center;gap:12px;margin-top:12px;}
  [data-ticket] .tw-count{margin-left:auto;color:#60758a;font-size:.86rem;}
  [data-ticket] .tw-msg{margin-top:8px;font-size:.93rem;min-height:1.2em;font-weight:700;letter-spacing:.2px;}
  [data-ticket] .tw-msg.success{color:#059669!important;}
  [data-ticket] .tw-msg.error{color:#ff4d4f!important;}
  [data-ticket] .tw-msg.warning{color:#f59e0b!important;}
  /* match dot color if no explicit class was set */
  [data-ticket].open  .tw-msg:not(.success):not(.error):not(.warning){color:#16a34a!important;}
  [data-ticket].soon  .tw-msg:not(.success):not(.error):not(.warning){color:#f59e0b!important;}
  [data-ticket].closed.tw-msg,[data-ticket].closed .tw-msg:not(.success):not(.error):not(.warning){color:#ff4d4f!important;}

  /* Button */
  [data-ticket] .tw-btn{
    padding:10px 16px;border-radius:12px;border:1px solid rgba(15,23,42,.12);
    background:linear-gradient(135deg,var(--btn-bg-1),var(--btn-bg-2));color:var(--btn-ink);font-weight:800;cursor:pointer;
    box-shadow:0 4px 14px rgba(59,130,246,.25);transition:transform .08s ease,box-shadow .15s ease,filter .15s ease;letter-spacing:.2px;
  }
  [data-ticket] .tw-btn:hover{transform:translateY(-1px);box-shadow:0 8px 22px rgba(59,130,246,.35);filter:saturate(108%);}
  [data-ticket] .tw-btn:focus-visible{outline:none;box-shadow:0 0 0 4px var(--focus);}
  [data-ticket] .tw-btn:disabled{opacity:.85;cursor:not-allowed;transform:none;background:#e5f0ff;color:#6b7280;border-color:#dbeafe;box-shadow:none;}
  [data-ticket] .tw-btn.sent{opacity:.92;cursor:default;}

  /* Spinner */
  [data-ticket] .spin:after{
    content:"";display:inline-block;width:14px;height:14px;margin-left:8px;border:2px solid rgba(255,255,255,.65);
    border-top-color:transparent;border-radius:50%;animation:twspin .8s linear infinite;vertical-align:-2px;
  }
  @keyframes twspin{to{transform:rotate(360deg)}}

  /* Mini-login */
  [data-ticket] .tw-login{display:flex;gap:8px;align-items:center;margin:8px 0 12px 0}
  [data-ticket] .tw-login input{flex:1;border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:var(--textarea-bg);color:var(--ink);outline:none}

  /* Responsive */
  @media (max-width:640px){
    [data-ticket] .tw-card{border-radius:14px;padding:14px;}
    [data-ticket] .tw-header{gap:10px;}
    [data-ticket] .tw-badge{padding:5px 9px;font-size:.82rem;}
  }
</style>
<script>
(() => {
  const $ = (sel, el=document) => el.querySelector(sel);

  function mountAll(){
    document.querySelectorAll('[data-ticket]:not([data-tw-mounted])').forEach(initOne);
  }

  function initOne(host){
    host.setAttribute('data-tw-mounted','1');

    // ---- Config/attrs
    const bridge = (host.getAttribute('data-bridge') || window.BRIDGE_URL || '').trim();
    const sessionTag = (host.getAttribute('data-session') || '').trim();
    const pageAttr   = (host.getAttribute('data-page') || '').trim();
    const winStartStr= (host.getAttribute('data-open') || '').trim();
    const winEndStr  = (host.getAttribute('data-close') || '').trim();
    const requireLogin = String(host.getAttribute('data-require-login') || 'true').toLowerCase() !== 'false';

    // ---- Helpers
    const parseLocal = (ts) => ts ? new Date(ts.replace(' ','T')) : null;
    const winStart = parseLocal(winStartStr);
    const winEnd   = parseLocal(winEndStr);

    const fmtDur = (s) => { const m=Math.floor(s/60),r=s%60; if(m>=60){const h=Math.floor(m/60),mm=m%60;return `${h}h ${mm}m`;} if(m>0) return `${m}m ${r}s`; return `${r}s`; };
    function statusNow(){
      const now = new Date();
      if (!winStart || !winEnd) return {state:'open', label:'Always available'};
      if (now < winStart){ const s1=Math.max(0,Math.floor((winStart-now)/1000)); return {state:'soon', label:'Opens in '+fmtDur(s1)}; }
      if (now > winEnd)   return {state:'closed', label:'Closed'};
      const s2=Math.max(0,Math.floor((winEnd-now)/1000)); return {state:'open', label:'Closes in '+fmtDur(s2)};
    }
    const getStudentId = () => String(window.studentId || localStorage.getItem('studentId') || localStorage.getItem('fs_user') || '').trim();
    const getPageId = () => pageAttr || window.pageId || (location.pathname + location.hash);

    const setMsg = (el, text, cls) => { el.textContent = text || ''; el.className = 'tw-msg' + (cls ? ' ' + cls : ''); };
    const doneKey = () => `ticket_done:exit:${(sessionTag || getPageId() || 'page')}:${(getStudentId() || 'anon')}`;
    const isDone  = () => { try { return localStorage.getItem(doneKey()) === '1'; } catch(_) { return false; } };
    const markDone = (btn) => { try{ localStorage.setItem(doneKey(), '1'); }catch(_){}; btn.classList.remove('spin'); btn.disabled = true; btn.classList.add('sent'); btn.textContent = 'Sent ‚úì'; };

    // ---- UI skeleton
    host.innerHTML = '';
    const card = document.createElement('div'); card.className = 'tw-card';
    const windowLabel = (winStartStr && winEndStr) ? (winStartStr + '\n‚Üí ' + winEndStr) : 'No window set';
    card.innerHTML = `
      <div class="tw-header">
        <div class="tw-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none"><path d="M12 8v5l3 3M6 3h12a1 1 0 0 1 1 1v16l-7-3-7 3V4a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
        <div class="tw-titles">
          <div class="tw-title">Check-out</div>
          <div class="tw-sub"></div>
        </div>
        <div class="tw-meta">
          <div class="tw-badge"><span class="tw-dot"></span><span class="tw-badge-text">‚Äî</span></div>
          <div class="tw-badge" title="S√£o Paulo time">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" style="opacity:.8"><path d="M12 7v5l4 2" stroke="#334155" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="9" stroke="#334155" stroke-width="1.5" fill="none"/></svg>
            <span class="tw-window-text">${windowLabel}</span>
          </div>
        </div>
      </div>
      <div class="tw-login" style="display:none">
        <input type="text" class="tw-login-input" placeholder="Digite seu ID / e-mail do curso"/>
        <button type="button" class="tw-btn tw-login-btn">Entrar</button>
      </div>
      <div class="tw-body"></div>
      <div class="tw-footer">
        <button type="button" class="tw-btn tw-send">Send (click only 1x)</button>
        <div class="tw-count">0/500</div>
      </div>
      <div class="tw-msg"></div>`;
    host.appendChild(card);

    // refs
    const body = $('.tw-body', card);
    const btn  = $('.tw-send', card);
    const msg  = $('.tw-msg', card);
    const badgeText = $('.tw-badge-text', card);
    const count = $('.tw-count', card);
    const loginRow = $('.tw-login', card);
    const loginInp = $('.tw-login-input', card);
    const loginBtn = $('.tw-login-btn', card);

    // textarea
    const ta = document.createElement('textarea');
    ta.className = 'tw-text'; ta.maxLength = 500;
    ta.placeholder = 'Your check-out (max 500): one thing you learned + one question‚Ä¶';
    body.appendChild(ta);
    ta.addEventListener('input', () => { count.textContent = `${ta.value.length}/500`; syncEnabled(); });
    count.textContent = '0/500';

    const successMsg = 'Check-out recorded. Thank you!';
    const dupMsg     = 'You have already completed the check-out for this session. Thanks!';

    function paintBadge(){
      const st = statusNow();
      host.classList.remove('open','soon','closed'); host.classList.add(st.state);
      badgeText.textContent = st.label;
    }

    function showLoginIfNeeded(){
      const need = requireLogin && !getStudentId();
      loginRow.style.display = need ? 'flex' : 'none';
    }

    function syncEnabled(){
      const logged = !requireLogin || !!getStudentId();
      const st     = statusNow().state;
      const filled = ta.value.trim().length>0;
      const enabled= logged && (st==='open') && filled && !isDone();
      btn.disabled = !enabled;

      showLoginIfNeeded(); paintBadge();

      if (isDone()){
        setMsg(msg, dupMsg, 'success');
        btn.textContent = 'Sent ‚úì'; btn.classList.add('sent'); btn.disabled = true;
      } else if (!logged) setMsg(msg,'Please log in to submit.','warning');
      else if (st==='soon') setMsg(msg,'Not open yet.','warning');
      else if (st==='closed') setMsg(msg,'This activity is closed.','error');
      else if (!filled) setMsg(msg,'Write something to submit.','warning');
      else setMsg(msg,''); // ready
    }

    // mini-login
    loginBtn?.addEventListener('click', () => {
      const v = (loginInp.value || '').trim();
      if (!v) { setMsg(msg,'Informe seu ID para continuar.','warning'); return; }
      try { localStorage.setItem('studentId', v); } catch {}
      window.studentId = v;
      document.dispatchEvent(new Event('auth:login'));
      setMsg(msg,''); syncEnabled();
    });

    // timers + cleanup
    paintBadge(); syncEnabled();
    const ticker = setInterval(() => { paintBadge(); syncEnabled(); }, 1000);
    const obs = new MutationObserver(() => {
      if(!document.body.contains(host)){ clearInterval(ticker); obs.disconnect(); }
    });
    obs.observe(document.body, {childList:true, subtree:true});
    document.addEventListener('auth:login', syncEnabled);

    // Submit
    btn.addEventListener('click', async (e) => {
      e.preventDefault(); e.stopPropagation();

      const sid = getStudentId();
      if (requireLogin && !sid){ setMsg(msg,'Please log in to submit.','warning'); return; }
      const text = ta.value.trim().slice(0,500);
      if (!text){ setMsg(msg,'Write something to submit.','warning'); return; }
      if (!bridge){ setMsg(msg,'Missing BRIDGE URL.','error'); return; }

      btn.classList.add('spin'); btn.disabled = true; setMsg(msg,'');

      const payload = {
        student_id: sid,                 // ‚Üê alinha com D1
        slide_id: (sessionTag || getPageId()),
        ticket: text,
        tsClient: new Date().toISOString(),
        open:  winStartStr,
        close: winEndStr,
        user_agent: navigator.userAgent
      };

      try{
        const res = await fetch(bridge, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload),
          keepalive:true
        });

        const raw = await res.text();
        let data = null; try{ data = JSON.parse(raw); }catch(_){}

        if (!res.ok){
          if (data && data.status === 'closed_window'){
            setMsg(msg,'This activity is closed now.','error');
          } else {
            setMsg(msg,'Failed to submit. Please try again.','error');
          }
          console.error('[checkout2] HTTP error:', res.status, raw);
          btn.classList.remove('spin'); btn.disabled = false; btn.textContent = 'Send (click only 1x)';
          return;
        }

        if (data && data.status === 'success'){
          setMsg(msg, successMsg, 'success');
          ta.value=''; count.textContent='0/500';
          markDone(btn); clearInterval(ticker);
          return;
        }
        if (data && data.status === 'duplicate'){
          setMsg(msg, dupMsg, 'success'); markDone(btn); clearInterval(ticker); return;
        }
        if (data && data.status === 'closed_window'){
          setMsg(msg,'This activity is closed now.','error');
          btn.classList.remove('spin'); btn.disabled = false; btn.textContent = 'Send (click only 1x)';
          return;
        }

        setMsg(msg,'Failed to submit. Please try again.','error');
        console.error('[checkout2] unexpected response:', raw);
        btn.classList.remove('spin'); btn.disabled = false; btn.textContent = 'Send (click only 1x)';
      }catch(err){
        console.error('[checkout2] submit error:', err);
        setMsg(msg,'Network error. Please try again.','error');
        btn.classList.remove('spin'); btn.disabled = false; btn.textContent = 'Send (click only 1x)';
      }
    });
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', mountAll, { once:true });
  } else {
    mountAll();
  }
})();
</script>
</section></section>
<section>
<section id="now-it-is-your-turn" class="title-slide slide level1 smaller center" data-background="#191f36">
<h1>Now it is your turn‚Ä¶</h1>
<div class="footer">

</div>
</section>
<section id="any-questions" class="slide level2" data-background="#fdf6e3">
<h2>üôã‚Äç‚ôÇÔ∏è <strong>Any Questions?</strong></h2>
<div class="columns">
<div class="column" style="width:50%;">
<h3 id="thank-you">Thank You!</h3>
<p><img data-src="../figs/qa2.png" style="box-shadow: none;;width:110.0%"></p>
</div><div class="column" style="width:50%;">
<div style="text-align:right;">
<p><img src="../figs/avatar.jpg" width="120px" style="border-radius:50%; box-shadow:0 4px 12px rgba(0,0,0,.25);"></p>
</div>
<h3 id="henrique-c.-martins"><strong>Henrique C. Martins</strong></h3>
<ul>
<li>üåê <a href="https://eaesp.fgv.br/en/people/henrique-castro-martins">FGV/EAESP</a><br>
</li>
<li>üíº <a href="https://www.linkedin.com/in/henriquecastror/">LinkedIn</a><br>
</li>
<li>üß† <a href="https://scholar.google.com.br/citations?user=7gIfkRMAAAAJ&amp;hl=pt-BR&amp;oi=ao">Google Scholar</a><br>
</li>
<li>üìÑ <a href="http://lattes.cnpq.br/6076997472159785">Lattes CV</a><br>
</li>
<li>üè† <a href="https://henriquemartins.net/">Personal Website</a><br>
</li>
</ul>
</div>
</div>

<div class="quarto-auto-generated-content">
<p><img src="../figs/background8.png" class="slide-logo"></p>
<div class="footer footer-default">
<p><span style="font-size:10px"> [<a href="mailto:henrique.martins@fgv.br">Henrique C. Martins</a>] [<a href="https://henriquemartins.net/teaching/financial_strategy/">Teaching Resources</a>]<strong>[Do not use without permission]</strong></span></p>
</div>
</div>
</section></section>
    </div>
  </div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="../../../site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="../../../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="../../../site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="../../../site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="../../../site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="../../../site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="../../../site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="../../../site_libs/revealjs/plugin/search/search.js"></script>
  <script src="../../../site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="../../../site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': false,
'previewLinksAuto': true,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":false},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: true,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <!-- chat-widget-deluxe.html : Floating chat for all slides (Quarto + revealjs) -->
    <style>
      :root{
        /* Fundo geral claro e elegante */
        --bg: rgba(255,255,255,.88);
        --border: rgba(15,23,42,.12);
        --shadow: 0 12px 40px rgba(20,20,40,.18);

        --brand1: #4f46e5; /* indigo */
        --brand2: #06b6d4; /* cyan */
        --brand-weak: rgba(79,70,229,.10);

        --text: #0f172a;
        --muted: #475569;
        --danger: #b91c1c;

        --bubble-user: #ffffff;
        --bubble-ai:   #fbfdff;
      }
      @media (prefers-color-scheme: dark){
        :root{
          --bg: rgba(19,26,42,.72);
          --border: rgba(255,255,255,.10);
          --shadow: 0 18px 50px rgba(0,0,0,.55);
          --text: #e6e9ef;
          --muted: #b6bfca;
          --brand-weak: rgba(79,70,229,.20);

          --bubble-user: rgba(255,255,255,.08);
          --bubble-ai:   rgba(255,255,255,.06);
        }
      }

      .vhcm-panel, .vhcm-input textarea, .vhcm-bubble {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        font-feature-settings: "liga" 1, "kern" 1;
      }

      /* FAB button */
      .vhcm-fab{position:fixed; right:18px; bottom:18px; z-index:9999; display:flex; align-items:center; gap:10px}
      .vhcm-fab button{border:none; border-radius:16px; padding:12px 14px; cursor:pointer; background:linear-gradient(135deg,var(--brand1),var(--brand2)); color:#fff; box-shadow:var(--shadow); display:flex; align-items:center; gap:10px; font-weight:600}
      .vhcm-fab svg{width:20px; height:20px}

      /* Panel (redimension√°vel) */
      .vhcm-panel{
        position:fixed; right:18px; bottom:78px;
        width:325px; height:600px;
        min-width:280px; min-height:360px;
        max-width:94vw; max-height:84vh;

        display:none; flex-direction:column; border:1px solid var(--border);
        border-radius:18px; box-shadow:var(--shadow); overflow:hidden; z-index:9999;
        backdrop-filter: blur(16px) saturate(140%); -webkit-backdrop-filter: blur(16px) saturate(140%);
        background: var(--bg); animation:vslide .25s ease-out;

        /* permite redimensionar pelo canto inferior direito */
        resize: both;
      }
      @keyframes vslide{from{transform: translateY(8px); opacity:0} to{transform:none; opacity:1}}

      .vhcm-header{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border); background:linear-gradient(135deg, rgba(79,70,229,.10), rgba(6,182,212,.08));}
      .vhcm-brand{display:flex; align-items:center; gap:10px}
      .vhcm-logo{width:28px; height:28px; border-radius:10px; background:linear-gradient(135deg,var(--brand1),var(--brand2)); color:#fff; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; box-shadow:0 4px 16px var(--brand-weak)}
      .vhcm-title{font-weight:700; letter-spacing:.2px; color:var(--text)}
      .vhcm-status{display:flex; align-items:center; gap:6px; color:var(--muted); font-size:12px}
      .vhcm-dot{width:8px; height:8px; border-radius:50%; background:#22c55e; box-shadow:0 0 0 2px rgba(34,197,94,.25)}
      .vhcm-close{border:none; background:transparent; font-size:18px; cursor:pointer; color:var(--muted)}

      /* Bot√£o meia tela */
      .vhcm-half{
        border:none; background:transparent; cursor:pointer;
        font-size:16px; color:var(--muted); margin-right:6px;
      }
      .vhcm-half:hover{ color: var(--text); }

      /* Painel em meia tela (50vw x 50vh) */
      .vhcm-panel.vhcm--half{
        width: 50vw !important;
        height: 50vh !important;
        max-width: 95vw;
        max-height: 95vh;
        border-radius: 12px;
      }

      .vhcm-body{flex:1; overflow:auto; padding:14px; background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,0));}
      .vhcm-typing{font-size:12px; color:var(--muted); display:none; padding:6px 2px}
      .vhcm-dots{display:inline-flex; gap:3px; margin-left:4px}
      .vhcm-dots span{width:6px; height:6px; border-radius:50%; background:var(--muted); opacity:.6; animation:blink 1.2s infinite}
      .vhcm-dots span:nth-child(2){animation-delay:.2s}
      .vhcm-dots span:nth-child(3){animation-delay:.4s}
      @keyframes blink{0%,80%,100%{opacity:.2; transform:translateY(0)} 40%{opacity:.9; transform:translateY(-2px)}}

      .vhcm-input{
        display:flex; align-items:flex-end; gap:8px; padding:12px;
        border-top:1px solid var(--border);
        background:linear-gradient(180deg, rgba(255,255,255,.40), rgba(255,255,255,.20));
      }
      .vhcm-input textarea{
        flex:1;
        resize:none;
        min-height:44px;
        max-height:140px;
        padding:12px 14px;
        border:1px solid var(--border);
        border-radius:14px;
        background:#ffffff;
        color:#0f172a;
        font: 500 14px/1.45 system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        caret-color: var(--brand1);
        box-shadow: 0 1px 0 rgba(0,0,0,.02) inset;
      }
      .vhcm-input textarea::placeholder{ color:#475569; }

      .vhcm-send{background:linear-gradient(135deg,var(--brand1),var(--brand2)); color:#fff; border:none; border-radius:12px; padding:10px 14px; cursor:pointer; display:flex; align-items:center; gap:8px; font-weight:600}
      .vhcm-send svg{width:18px; height:18px}

      .vhcm-msg{display:flex; gap:10px; margin-bottom:12px; align-items:flex-end}
      .vhcm-avatar{width:28px; height:28px; border-radius:10px; background:var(--brand-weak); display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; color:var(--text)}
      .vhcm-bubble{
        max-width:78%; padding:12px 14px; border-radius:14px; border:1px solid var(--border);
        box-shadow: 0 6px 18px rgba(0,0,0,.06);
        line-height:1.48; font-weight:500;
      }
      .vhcm-msg.user{justify-content:flex-end}
      .vhcm-msg.user .vhcm-bubble{
        background: var(--bubble-user);
        color: var(--text);
        border-color: rgba(15,23,42,.10);
      }
      .vhcm-msg.user .vhcm-avatar{display:none}
      .vhcm-msg.ai .vhcm-bubble{
        background: var(--bubble-ai);
        color: var(--text);
        border-color: rgba(15,23,42,.10);
      }

      .vhcm-error{color:var(--danger); font-size:12px; margin:6px 2px}
    </style>

    <div class="vhcm-fab">
      <button id="vhcm-open" title="Virtual HCM">
        <svg viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22c4.97 0 9-3.582 9-8 0-1.93-.71-3.706-1.92-5.126l.86-3.006-3.01.847C15.87 5.6 14 5 12 5 7.03 5 3 8.582 3 13s4.03 9 9 9Z" stroke="currentColor" stroke-width="1.2"></path></svg>
        Virtual HCM
      </button>
    </div>

    <div class="vhcm-panel" id="vhcm-panel" role="dialog" aria-label="Virtual HCM chat">
      <div class="vhcm-header">
        <div class="vhcm-brand">
          <div class="vhcm-logo">VH</div>
          <div>
            <div class="vhcm-title">Virtual HCM</div>
            <div class="vhcm-status"><span class="vhcm-dot"></span><span id="vhcm-module-label">module1</span></div>
          </div>
        </div>
        <div>
          <button id="vhcm-half" class="vhcm-half" aria-label="Half screen" title="Half screen">‚§¢</button>
          <button id="vhcm-close" class="vhcm-close" aria-label="Close">‚úï</button>
        </div>
      </div>
      <div class="vhcm-body" id="vhcm-body"></div>
      <div class="vhcm-typing" id="vhcm-typing">Virtual HCM is typing <span class="vhcm-dots"><span></span><span></span><span></span></span></div>
      <div class="vhcm-input">
        <textarea id="vhcm-text" placeholder="Ask anything about this module‚Ä¶"></textarea>
        <button class="vhcm-send" id="vhcm-send" title="Send">
          <svg viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 11l17-8-8 17-1-7-8-2Z" stroke="#fff" stroke-width="1.6"></path></svg>
          Send
        </button>
      </div>
    </div>

    <script>
    (function(){
      // ====== CONFIG ======
      const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbza4kInsudyRFK_62VL8eULh3TiF_zMdleq4N0OpX4QunuU2rEryBnbE4S9zDHQkvB_/exec"; // troque se necess√°rio
      const DEFAULT_MODULE = "module1";
      const STORAGE_OPEN   = "vhcm_open";
      const STORAGE_SIZE   = "vhcm_size";
      const STORAGE_HALF   = "vhcm_half_mode";
      const STORAGE_SIZE_PREV = "vhcm_size_prev";

      // ====== Elements ======
      const btnOpen = document.getElementById('vhcm-open');
      const btnClose = document.getElementById('vhcm-close');
      const btnHalf = document.getElementById('vhcm-half');
      const panel = document.getElementById('vhcm-panel');
      const body = document.getElementById('vhcm-body');
      const typing = document.getElementById('vhcm-typing');
      const text = document.getElementById('vhcm-text');
      const send = document.getElementById('vhcm-send');
      const moduleLabel = document.getElementById('vhcm-module-label');

      // ====== Module detection (robusta, sem quebrar compatibilidade) ======
      function detectModule(){
        try {
          // 1) Override expl√≠cito via window.VHCM.module
          if (window.VHCM && window.VHCM.module) {
            const v = String(window.VHCM.module).trim();
            if (v) return v;
          }
          // 2) Reveal slide atual com data-module
          if (window.Reveal && typeof Reveal.getCurrentSlide === 'function') {
            const s = Reveal.getCurrentSlide && Reveal.getCurrentSlide();
            const v = (s && (s.dataset.module || s.getAttribute('data-module'))) || '';
            if (v && String(v).trim()) return String(v).trim();
          }
          // 3) <meta name="vhcm-module" content="moduleX">
          const meta = document.querySelector('meta[name="vhcm-module"]');
          if (meta && meta.content && meta.content.trim()) return meta.content.trim();
          // 4) atributo data-module no <body>
          const dm = document.body && document.body.getAttribute && document.body.getAttribute('data-module');
          if (dm && dm.trim()) return dm.trim();
          // 5) querystring ?module=moduleX
          const qs = new URLSearchParams(location.search).get('module');
          if (qs && qs.trim()) return qs.trim();
          // 6) regex no caminho (module2, m2, p2.html)
          const path = (location.pathname || '').toLowerCase();
          let m = path.match(/module(\d+)/); if (m) return `module${m[1]}`;
          m = path.match(/\/m(\d+)\b/);     if (m) return `module${m[1]}`;
          m = path.match(/\/p(\d+)\.html/); if (m) return `module${m[1]}`;
          // 7) compat: window.CURRENT_MODULE (caso voc√™ j√° defina em algum lugar)
          if (window.CURRENT_MODULE) return String(window.CURRENT_MODULE).trim();
        } catch(_){}
        // 8) fallback
        return DEFAULT_MODULE;
      }

      // ====== Helpers ======
      // (√öNICA MUDAN√áA) ‚Üí pega o aluno logado do localStorage, priorizando o ID salvo no login
      function getStudent(){
        try{
          const u = (localStorage.getItem('fs_user')
                  || localStorage.getItem('studentId')
                  || localStorage.getItem('studentName')
                  || 'Anonimo').trim();
          return u || 'Anonimo';
        }catch(_){
          return 'Anonimo';
        }
      }
      function currentModule(){ return detectModule(); }

      function bubble(author, textHtml, isUser=false){
        const wrap = document.createElement('div');
        wrap.className = 'vhcm-msg' + (isUser ? ' user' : ' ai');
        const avatar = document.createElement('div');
        avatar.className = 'vhcm-avatar';
        avatar.textContent = isUser ? 'You' : 'VH';
        const bub = document.createElement('div');
        bub.className = 'vhcm-bubble';
        bub.innerHTML = String(textHtml || '').replace(/\n/g,'<br>');
        if (isUser){ wrap.appendChild(bub); wrap.appendChild(avatar); }
        else { wrap.appendChild(avatar); wrap.appendChild(bub); }
        body.appendChild(wrap); body.scrollTop = body.scrollHeight;
      }
      function setOpen(open){ panel.style.display = open ? 'flex' : 'none'; localStorage.setItem(STORAGE_OPEN, open ? '1' : '0'); }

      // ====== Restaurar tamanho salvo ======
      (function restoreSize(){
        try{
          const saved = JSON.parse(localStorage.getItem(STORAGE_SIZE) || 'null');
          if (saved?.w && saved?.h) {
            panel.style.width = saved.w;
            panel.style.height = saved.h;
          }
        }catch(_){}
      })();

      // ====== Observar e salvar mudan√ßas de tamanho ======
      (function watchSize(){
        if (!('ResizeObserver' in window)) return;
        const ro = new ResizeObserver(entries => {
          for (const e of entries) {
            const { width, height } = e.contentRect || {};
            if (!width || !height) continue;
            localStorage.setItem(STORAGE_SIZE, JSON.stringify({
              w: Math.round(width) + 'px',
              h: Math.round(height) + 'px'
            }));
          }
        });
        ro.observe(panel);
      })();

      // ====== Open/Close & persist state ======
      btnOpen.addEventListener('click', ()=> setOpen(panel.style.display !== 'flex'));
      btnClose.addEventListener('click', ()=> setOpen(false));
      if (localStorage.getItem(STORAGE_OPEN) === '1') setOpen(true);

      // ====== Module label sync ======
      function updateModuleLabel(){ moduleLabel.textContent = currentModule(); }
      updateModuleLabel();
      if (window.Reveal && typeof Reveal.on === 'function'){ Reveal.on('slidechanged', updateModuleLabel); }
      window.addEventListener('hashchange', updateModuleLabel); // caso mude via URL/anchor

      // ====== Meia tela (toggle) ======
      function readSize(){ try { return JSON.parse(localStorage.getItem(STORAGE_SIZE) || 'null'); } catch(_){ return null; } }
      function savePrevSize(){
        const rect = panel.getBoundingClientRect();
        localStorage.setItem(STORAGE_SIZE_PREV, JSON.stringify({
          w: Math.round(rect.width) + 'px',
          h: Math.round(rect.height) + 'px'
        }));
      }
      function readPrevSize(){ try { return JSON.parse(localStorage.getItem(STORAGE_SIZE_PREV) || 'null'); } catch(_){ return null; } }

      function setHalfMode(on){
        if (on){
          // guarda tamanho atual antes de mudar
          savePrevSize();
          panel.classList.add('vhcm--half');
          panel.style.width  = '50vw';
          panel.style.height = '50vh';
          localStorage.setItem(STORAGE_HALF, '1');
          btnHalf.title = 'Exit half screen';
        } else {
          panel.classList.remove('vhcm--half');
          localStorage.setItem(STORAGE_HALF, '0');
          btnHalf.title = 'Half screen';
          const prev = readPrevSize() || readSize();
          if (prev?.w && prev?.h){
            panel.style.width  = prev.w;
            panel.style.height = prev.h;
          } else {
            panel.style.width  = '';
            panel.style.height = '';
          }
        }
      }

      btnHalf.addEventListener('click', ()=>{
        const isOn = panel.classList.contains('vhcm--half');
        setHalfMode(!isOn);
      });

      // Restaurar modo meia tela se estava ativo
      if (localStorage.getItem(STORAGE_HALF) === '1') {
        setHalfMode(true);
      }

      // ====== Send logic ======
      async function sendQuestion(){
        const q = text.value.trim(); if (!q) return;
        const mod = currentModule(); updateModuleLabel();
        bubble('You', q, true); text.value=''; typing.style.display='block';
        try{
          const resp = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            // sem headers pra evitar preflight; servidor j√° aceita JSON puro
            body: JSON.stringify({ question: q, student: getStudent(), module: mod })
          });
          const raw = await resp.text();
          let data = {}; try { data = JSON.parse(raw); } catch(_){ data = { answer: 'Server returned an invalid response.' }; }
          typing.style.display='none';
          bubble('Virtual HCM', data.answer || 'No answer received.', false);
        } catch(e){
          typing.style.display='none';
          bubble('Error', 'Could not contact the server.', false);
        }
      }

      send.addEventListener('click', sendQuestion);
      text.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendQuestion(); }
      });
    })();
    </script>
    <!-- threads-gate.html -->
    <!-- Gate + conte√∫do inline do threads, injetado somente para logins permitidos -->

    <script>
      // ===== Allowlist (inclui professor) =====
    //  const CHAT_ALLOWLIST = new Set([
    //    'hcm','aula','aluno5','bruno_pereira','jos√©_allocca','ana_santos','eduardo_senedese','vanessa_meieler', 'leonardo_derviche','jo√£o_coghi','luisa_fernandes','laura_nakama','ludmilla_moraes','jose_allocca', 'joao_coghi'
    //  ]);

      const stripDiacritics = s => (s || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      const normalizeLogin  = s => {
        const raw = String(s || '').trim().toLowerCase();
        if (!raw) return '';
        return raw.includes('@') ? raw.split('@')[0] : raw;
      };

      function getCurrentUser(){
        try{
          const seq = [
            () => localStorage.getItem('studentId'),
            () => localStorage.getItem('login'),
            () => (window.VHCM && window.VHCM.user) ? String(window.VHCM.user) : '',
          ];
          for (const f of seq){
            const out = normalizeLogin(f());
            if (out) return out;
          }
          const m = document.cookie.match(/(?:^|;\s*)(studentId|login|vhcm_user|vhcm_login|user)=([^;]+)/i);
          if (m) return normalizeLogin(decodeURIComponent(m[2]));
        }catch(_){}
        return '';
      }

    //  function isAllowed(){
    //    const user  = getCurrentUser();
    //    const ascii = stripDiacritics(user);
    //    return CHAT_ALLOWLIST.has(user) || CHAT_ALLOWLIST.has(ascii);}


    // threads-gate.html
    function isAllowed(){ return true } // libera para todos


      // Injeta o conte√∫do do template apenas se permitido

      async function injectIfAllowed(){
        if (!isAllowed()){
          console.debug('[threads-gate] user not allowed, chat hidden');
          return;
        }
        if (document.querySelector('[data-vhcm-chat="threads"]')) return;

        const tpl = document.getElementById('vhcm-threads-tpl');
        if (!tpl){ console.warn('[threads-gate] template n√£o encontrado'); return; }

        // 1) injeta o HTML
        const holder = document.createElement('div');
        holder.setAttribute('data-vhcm-chat','threads');
        holder.innerHTML = tpl.innerHTML;
        document.body.appendChild(holder);

        // 2) for√ßa execu√ß√£o de TODOS os <script> rec√©m-inseridos (na ordem)
        const scripts = holder.querySelectorAll('script');
        for (const old of scripts) {
          const s = document.createElement('script');
          // copia atributos (type, etc.)
          for (const {name, value} of Array.from(old.attributes)) s.setAttribute(name, value);
          if (old.src) {
            s.src = old.src;              // se um dia voc√™ usar scripts externos
            s.async = false;
          } else {
            s.textContent = old.textContent; // inline JS
          }
          old.replaceWith(s);             // substitui para preservar a ordem de execu√ß√£o
        }

        console.debug('[threads-gate] chat injected & scripts executed');
      }





      document.addEventListener('DOMContentLoaded', () => {
        injectIfAllowed();
        // se o login for setado um pouco depois:
        setTimeout(injectIfAllowed, 400);
        setTimeout(injectIfAllowed, 1000);
        // se disparar evento de login
        document.addEventListener('auth:login', () => setTimeout(injectIfAllowed, 50));
        // se outra aba/setter atualizar credenciais
        window.addEventListener('storage', (e)=>{
          if (['studentId','login','vhcm_user','vhcm_login','user'].includes(e.key||'')){
            setTimeout(injectIfAllowed, 50);
          }
        });
      });
    </script>

    <!-- ============== CONTE√öDO ORIGINAL DO threads.html, INATIVO EM TEMPLATE ============== -->
    <template id="vhcm-threads-tpl">
      <!-- ===================== CLASS CHAT (Widget) ===================== -->
      <script>
      function onLoginSuccess(studentId) {
        window.studentId = String(studentId || '').trim();
        localStorage.setItem('studentId', window.studentId);
        document.dispatchEvent(new CustomEvent('auth:login', { detail: { studentId: window.studentId }}));
        console.debug('[Login] onLoginSuccess ‚Üí', window.studentId);
      }
      </script>

      <div id="cmt-root">
        <button id="cmt-bubble" aria-label="Open class chat">
          <span class="cmt-icon">üí¨</span><span class="cmt-badge" id="cmt-count">0</span>
        </button>

        <aside id="cmt-panel" aria-hidden="true" aria-label="Class chat panel">
          <header class="cmt-header">
            <div class="cmt-title"><span class="cmt-dot"></span><span>Class chat</span></div>
            <div class="cmt-actions">
              <select id="cmt-target" class="cmt-filter" style="display:none"></select>
              <button id="cmt-find" class="cmt-ghost" title="Buscar/abrir login (Ctrl+K)" aria-label="Find student" style="display:none">üîé</button>
              <button id="cmt-key" class="cmt-ghost" title="Set admin token" aria-label="Set admin token" style="display:none">üîë</button>
              <button id="cmt-close" class="cmt-ghost" title="Close" aria-label="Close">‚úï</button>
            </div>
          </header>

          <div id="cmt-list" class="cmt-body" role="list"></div>

          <footer class="cmt-input">
            <textarea id="cmt-text" placeholder="Write anything to your instructor‚Ä¶"></textarea>
            <div class="cmt-row cmt-end">
              <button id="cmt-send" class="cmt-primary" aria-label="Send">Send</button>
            </div>
          </footer>
        </aside>
      </div>

      <style>
      /* === seu CSS original === */
      #cmt-root { all: initial; }
      #cmt-root * { box-sizing: border-box; font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; }
      #cmt-root button { display:inline-flex; align-items:center; justify-content:center; cursor:pointer; }
      #cmt-root input, #cmt-root textarea, #cmt-root select { display:block; }

      /* Bubble */
      #cmt-root #cmt-bubble{
        position: fixed; left:max(20px,env(safe-area-inset-left)); bottom:max(20px,env(safe-area-inset-bottom));
        display:inline-flex; gap:8px; background:linear-gradient(135deg,#7c3aed 0%,#06b6d4 100%); color:#fff;
        border:1px solid rgba(255,255,255,.18); border-radius:16px; padding:10px 12px; box-shadow:0 18px 40px rgba(0,0,0,.28);
        z-index:11000; transition:transform .18s ease, box-shadow .18s ease, opacity .18s ease;
      }
      #cmt-root #cmt-bubble:hover{ transform: translateY(-2px) }
      #cmt-root .cmt-icon{ font-size:18px; line-height:1; }
      #cmt-root .cmt-badge{ min-width:20px; height:20px; padding:0 6px; display:inline-flex; align-items:center; justify-content:center;
        background:rgba(255,255,255,.95); color:#1f2937; font-size:12px; font-weight:800; border-radius:999px; box-shadow:0 2px 6px rgba(0,0,0,.18); }
      #cmt-root .cmt-badge.alert{ background:#dc2626 !important; color:#fff !important; }

      /* Panel */
      #cmt-root #cmt-panel{
        position: fixed; left:max(20px,env(safe-area-inset-left));
        bottom: calc(max(20px,env(safe-area-inset-bottom)) + 56px);
        width: 360px; height: 600px; min-width:300px; min-height:360px; max-width:94vw; max-height:84vh;
        display:grid; grid-template-rows:auto 1fr auto; background:rgba(248,250,252,.85); color:#0f172a;
        -webkit-backdrop-filter:saturate(140%) blur(10px); backdrop-filter:saturate(140%) blur(10px);
        border:1px solid rgba(30,41,59,.12); box-shadow:0 16px 50px rgba(0,0,0,.35); border-radius:18px; overflow:hidden; z-index:12000;
        opacity:0; transform:translateY(8px) scale(.98); pointer-events:none; transition:opacity .22s ease, transform .22s ease; resize:both;
      }
      #cmt-root #cmt-panel.open{ opacity:1; transform:translateY(0) scale(1); pointer-events:auto; }

      /* Header */
      #cmt-root .cmt-header{ display:flex; align-items:center; gap:10px; padding:12px 14px; background:linear-gradient(180deg,#334155 0%,#475569 100%); color:#fff; }
      #cmt-root .cmt-title{ display:flex; align-items:center; gap:8px; font-weight:700; letter-spacing:.2px;}
      #cmt-root .cmt-dot{ width:10px; height:10px; border-radius:50%; background:#22c55e; box-shadow:0 0 0 3px rgba(34,197,94,.22); }
      #cmt-root .cmt-dot.alert{ background:#f97316; }
      #cmt-root .cmt-dot.pulse{ animation:cmtPing 1.5s ease-out infinite; }
      @keyframes cmtPing{
        0%{box-shadow:0 0 0 0 rgba(249,115,22,.45);}
        70%{box-shadow:0 0 0 12px rgba(249,115,22,0);}
        100%{box-shadow:0 0 0 0 rgba(249,115,22,0);}
      }
      #cmt-root .cmt-actions{ margin-left:auto; display:flex; gap:8px; align-items:center; flex-wrap:nowrap; }
      #cmt-root .cmt-ghost{ padding:6px 10px; border-radius:10px; background:rgba(255,255,255,.18); border:1px solid rgba(255,255,255,.25); }
      #cmt-root .cmt-ghost:hover{ background:rgba(255,255,255,.28); }

      /* Select */
      #cmt-root .cmt-filter{
        max-width:260px; padding:6px 8px; border-radius:8px; font-size:12px;
        background:#fff; color:#0f172a; border:1px solid rgba(30,41,59,.25);
        appearance:auto;
      }
      #cmt-root .cmt-filter option{ color:#0f172a; background:#fff; }

      /* Body */
      #cmt-root .cmt-body{ padding:12px 10px 16px 10px; overflow:auto; }

      /* Mensagens */
      #cmt-root .cmt-msg{
        position:relative; display:flex; align-items:flex-end; gap:8px; margin:12px 6px;
        width:auto; max-width:calc(100% - 20px);
      }
      #cmt-root .cmt-msg.other{ flex-direction:row; justify-content:flex-start; margin-right:auto; margin-left:0; }
      #cmt-root .cmt-msg.me   { flex-direction:row-reverse; justify-content:flex-end; margin-left:auto; margin-right:0 !important; }

      #cmt-root .cmt-avatar{
        width:28px; height:28px; min-width:28px; min-height:28px; border-radius:50%; color:#fff; font-weight:700;
        display:flex; align-items:center; justify-content:center; box-shadow:0 4px 12px rgba(0,0,0,.12);
        font-size:12px;
      }
      #cmt-root .cmt-avatar.instr{ background:#7c3aed; font-size:10.5px; } /* 'hcm' */

      #cmt-root .cmt-meta-wrap{ position:relative; display:flex; flex-direction:column; align-items:flex-start; max-width:78%; }
      #cmt-root .cmt-msg.me .cmt-meta-wrap{ align-items:flex-end; }
      #cmt-root .cmt-msg.me .cmt-meta{ text-align:right; justify-content:flex-end; width:100%; }
      #cmt-root .cmt-meta{ display:flex; align-items:center; gap:8px; font-size:11px; color:#64748b; margin:0 4px 6px 4px; line-height:1.2; word-break:break-word; overflow-wrap:anywhere; }
      #cmt-root .cmt-url{ font-size:11px; margin:0 4px 6px 4px; word-break:break-all; }
      #cmt-root .cmt-url a{ color:#0ea5e9; }

      #cmt-root .cmt-bubble{ display:inline-block; max-width:100%; padding:10px 12px; border-radius:14px; border:1px solid rgba(30,41,59,.12);
        background:rgba(255,255,255,.92); box-shadow:0 6px 14px rgba(0,0,0,.06); line-height:1.45; white-space:pre-wrap; word-break:break-word; overflow-wrap:anywhere; font-size:12px; }
      #cmt-root .cmt-msg.me .cmt-bubble{ background:#eef2ff; border-color:rgba(79,70,229,.20); margin-left:auto; }

      /* Delete */
      #cmt-root .cmt-del{
        position:absolute; top:-2px; opacity:0; transform:translateY(-2px);
        padding:4px 6px; font-size:11px; border-radius:8px; line-height:1;
        background:rgba(244,63,94,.12); color:#ef4444; border:1px solid rgba(239,68,68,.25);
        transition:opacity .15s ease, transform .15s ease;
      }
      #cmt-root .cmt-msg.other .cmt-del{ left:-26px; }
      #cmt-root .cmt-msg.me .cmt-del{ right:-26px; }
      #cmt-root .cmt-msg:hover .cmt-del{ opacity:1; transform:translateY(0); }

      /* Input */
      #cmt-root .cmt-input{ border-top:1px solid rgba(30,41,59,.12); padding:12px; display:flex; flex-direction:column; gap:8px; background:rgba(255,255,255,.6); }
      #cmt-root .cmt-row{ display:flex; gap:8px; }
      #cmt-root .cmt-end{ justify-content:flex-end; }
      #cmt-root .cmt-input textarea{ width:100%; font-size:14px; padding:10px 12px; border-radius:12px; border:1px solid rgba(30,41,59,.15);
        color:#0f172a; background:rgba(255,255,255,.9); outline:none; min-height:100px; max-height:160px; resize:vertical; }
      #cmt-root .cmt-primary{ background:#6366f1; color:#fff; border:none; padding:10px 14px; border-radius:12px; font-weight:600;
        box-shadow:0 6px 18px rgba(99,102,241,.35); transition:transform .15s ease, box-shadow .2s ease, opacity .2s ease; }
      #cmt-root .cmt-primary:hover{ transform:translateY(-1px); box-shadow:0 10px 24px rgba(99,102,241,.42); }
      </style>

      <script>
      /* Slide id helper */
      window.__getSlideId = window.__getSlideId || function(){
        if (window.Reveal?.getCurrentSlide) {
          const s = Reveal.getCurrentSlide();
          if (s?.getAttribute('id')) return s.getAttribute('id');
          if (Reveal.getIndices) { const idx = Reveal.getIndices(); return `h${idx.h}_v${idx.v||0}`; }
        }
        const hash = (location.hash||'').replace(/^#\/?/, '');
        return hash || 'slide-unknown';
      };
      </script>

      <script>
      (function(){
        const COMMENTS_SCOPE = 'presentation';
        const scriptURL = 'https://course-chat.hcmrtns.workers.dev';
        const INSTRUCTOR_KEY = (document.querySelector('meta[name="cmt-instructor-login"]')?.content || 'hcm').toLowerCase();

        const root=document.getElementById('cmt-root'),
              bubble=root.querySelector('#cmt-bubble'),
              bubbleCt=root.querySelector('#cmt-count'),
              panel=root.querySelector('#cmt-panel'),
              closeBtn=root.querySelector('#cmt-close'),
              listEl=root.querySelector('#cmt-list'),
              textIn=root.querySelector('#cmt-text'),
              sendBtn=root.querySelector('#cmt-send'),
              targetSel=root.querySelector('#cmt-target'),
              keyBtn=root.querySelector('#cmt-key'),
              findBtn=root.querySelector('#cmt-find'),
              dot=root.querySelector('.cmt-dot');

        let __lastTsMs=0, __haveInitial=false, __posting=false, __lastSent={sig:'',at:0}, pollTimer=null;
        let inboxTimer=null, __inboxMs=0;

        const loadJSON = (k, def)=> { try{ return JSON.parse(localStorage.getItem(k) || 'null') ?? def; }catch{ return def; } };
        const saveJSON = (k, v)=> localStorage.setItem(k, JSON.stringify(v));
        let unread = loadJSON('cmt_unread', {});
        let newUntil = loadJSON('cmt_new_until', {});
        let selfUnread = Number(localStorage.getItem('cmt_unread_self')||'0') || 0;

        const forceInstructor = localStorage.getItem('cmt_force_instructor') === '1';
        function setForceInstructor(on){ localStorage.setItem('cmt_force_instructor', on ? '1' : '0'); }

        const loggedLogin = ()=>{
          const seq=[
            ()=> (window.studentId||'').toString().trim(),
            ()=> (localStorage.getItem('studentId')||'').toString().trim(),
            ()=> (window.__auth?.student?.login||'').toString().trim(),
            ()=> (document.getElementById('student-id')?.value||'').toString().trim(),
            ()=> (localStorage.getItem('login')||'').toString().trim(),
          ];
          for (const f of seq){ const v=f(); if (v) return v; }
          return '';
        };

        const adminToken = ()=> (localStorage.getItem('cmt_admin_token')||'').trim();
        const isInstructorMode = ()=> forceInstructor || (loggedLogin()||'').toLowerCase().includes(INSTRUCTOR_KEY);

        const scopeId = ()=> COMMENTS_SCOPE==='slide'
          ? (window.__getSlideId ? window.__getSlideId() : 'slide-unknown')
          : (location.origin + location.pathname + location.search);

        function detectModuleId(){
          const meta = document.querySelector('meta[name="module-id"]');
          if (meta?.content) return String(meta.content).trim();
          const d = document.body?.dataset?.moduleId; if (d) return String(d).trim();
          const m = (location.pathname||'').match(/mod(?:ulo)?[-_]?(\d+)/i) || (location.pathname||'').match(/(mod\d+)/i);
          return m ? (m[1] ? `mod${m[1]}` : m[0]) : '';
        }
        function hashColor(s){ let h=0; for(let i=0;i<s.length;i++) h=((h<<5)-h)+s.charCodeAt(i)|0; return `hsl(${Math.abs(h)%360},70%,50%)`; }
        function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;', '"':'&quot;', "'":'&#39;' }[m])); }
        function stripUrls(text){ return String(text||'').replace(/https?:\/\/[^\s)]+/g,'').trim(); }
        const looksLikeUrl = (s)=> /^https?:\/\//i.test(String(s||'').trim());
        function itemKey(c){ const id=(c.id||'').trim(); if (id) return id; const who=(c.student||'').trim(), ts=(String(c.ts||c.timestamp)||'').trim(), txt=(c.comment||'').slice(0,24); return `k_${who}__${ts}__${txt}`; }

        const unreadTotal = ()=> Object.values(unread).reduce((a,b)=> a + (Number(b)||0), 0);
        function clearAlerts(){ bubbleCt.classList.remove('alert'); if (dot) dot.classList.remove('alert','pulse'); }
        function updateBubbleCount(){ bubbleCt.textContent = String(isInstructorMode() ? unreadTotal() : selfUnread); }
        function maybeAlert(){
          const count = isInstructorMode() ? unreadTotal() : selfUnread;
          if (!panel.classList.contains('open') && count>0){
            bubbleCt.classList.add('alert'); if (dot) dot.classList.add('alert','pulse');
          } else { clearAlerts(); }
        }

        function optionLabel(login){
          const n = unread[login] || 0;
          const isNew = (newUntil[login]||0) > Date.now();
          return `${isNew ? 'NEW ‚Äì ' : ''}${login}${n>0 ? ' ['+n+']' : ''}`;
        }
        function renderSelect(){
          if (!isInstructorMode()) { targetSel.style.display='none'; findBtn.style.display='none'; return; }
          const current = localStorage.getItem('cmt_last_target') || '';
          const base = Object.keys(unread).filter(Boolean);
          if (current && !base.includes(current)) base.unshift(current);
          const ordered = [...new Set(base)].sort((a,b)=> ((unread[b]||0)-(unread[a]||0)) || a.localeCompare(b));
          if (!ordered.length){
            targetSel.innerHTML = `<option disabled>‚Äî sem novas ‚Äî</option>`;
            targetSel.style.display=''; findBtn.style.display=''; return;
          }
          targetSel.innerHTML = ordered.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(optionLabel(s))}</option>`).join('');
          const hasCurrent = ordered.includes(current);
          if (hasCurrent) targetSel.value=current; else targetSel.selectedIndex=0;
          targetSel.style.display=''; findBtn.style.display='';
        }

        targetSel.addEventListener('change', ()=>{
          const sel = targetSel.value || '';
          localStorage.setItem('cmt_last_target', sel);
          if (unread[sel]) { delete unread[sel]; saveJSON('cmt_unread', unread); }
          if (newUntil[sel]) { delete newUntil[sel]; saveJSON('cmt_new_until', newUntil); }
          clearAlerts(); renderSelect(); updateBubbleCount(); hardReload();
        });

        function askLogin(){
          const v = prompt('Digite o login do aluno:', localStorage.getItem('cmt_last_target')||'') || '';
          const login = v.trim(); if (!login) return;
          localStorage.setItem('cmt_last_target', login);
          if (unread[login]) { delete unread[login]; saveJSON('cmt_unread', unread); }
          if (newUntil[login]) { delete newUntil[login]; saveJSON('cmt_new_until', newUntil); }
          clearAlerts(); renderSelect(); updateBubbleCount(); hardReload();
        }
        findBtn.addEventListener('click', askLogin);
        window.addEventListener('keydown', (e)=>{ if (e.ctrlKey && (e.key==='k' || e.key==='K')){ e.preventDefault(); askLogin(); } });

        function startInboxWatch(){
          if (!isInstructorMode()) return;
          if (inboxTimer) { clearInterval(inboxTimer); inboxTimer=null; }
          const headers = adminToken()? {'x-admin-token': adminToken()} : {};
          __inboxMs = Date.now() - 60000;

          inboxTimer = setInterval(async ()=>{
            try{
              const url = `${scriptURL}/comments?all=1&since_ms=${__inboxMs}`;
              const r = await fetch(url, { headers });
              if (!r.ok) return;
              const j = await r.json();
              const items = (j.items||[]).map(x=>{ if(!x.ts && x.timestamp){ const ms=Date.parse(x.timestamp); if (isFinite(ms)) x.ts=ms; } return x; });
              if (!items.length) return;

              for (const it of items){ const ms=Number(it.ts||0); if (isFinite(ms) && ms > __inboxMs) __inboxMs=ms; }

              const viewing = (targetSel.value || localStorage.getItem('cmt_last_target') || '').trim();
              const isOpen = panel.classList.contains('open');

              let changed=false, anyAlert=false;
              for (const it of items){
                const isStudent = String(it.author||'').toLowerCase()==='student';
                const who = String(it.student||'').trim();
                if (!who || !isStudent) continue;

                if (isOpen && who === viewing) continue;

                unread[who] = (unread[who]||0) + 1;
                if (!newUntil[who]) newUntil[who] = Date.now() + 10*60*1000;
                changed=true; anyAlert=true;
              }

              if (changed){
                saveJSON('cmt_unread', unread);
                saveJSON('cmt_new_until', newUntil);
                renderSelect();
                updateBubbleCount();
                if (anyAlert) { maybeAlert(); }
              }
            }catch(_){}
          }, 4000);
        }

        function buildMsgHTML(c, viewer){
          const who = String(c.student||'').trim();
          const author = String(c.author||'').toLowerCase();
          const isInstr = author === 'instructor';

          const whenMs=c.ts?Number(c.ts):(c.timestamp?Date.parse(c.timestamp):NaN);
          const when=isFinite(whenMs)? new Date(whenMs).toLocaleString() : (c.timestamp||'');

          const whoLabel = isInstr ? 'hcm' : who;

          const asInstructor = viewer.mode==='instructor';
          const loginLower = (viewer.login||'').toLowerCase();
          const isMe = asInstructor ? isInstr : (!isInstr && who.toLowerCase()===loginLower);

          const metaParts=[when, whoLabel, (c.module_id||''), (c.slide_id||'')].filter(p=>p && !looksLikeUrl(p));
          const meta=metaParts.join(' ‚Ä¢ ');

          const urlHtml = (!isInstr && c.page_url)
            ? `<div class="cmt-url"><a href="${escapeHtml(c.page_url)}" target="_blank" rel="noopener">${escapeHtml(c.page_url)}</a></div>` : '';

          const safe=escapeHtml(stripUrls(String(c.comment||'')));

          const cls=isMe?'me':'other';
          const init = isInstr ? 'hcm' : (who||'Anonymous').slice(0,2).toUpperCase();
          const avatarCls = isInstr ? 'cmt-avatar instr' : 'cmt-avatar';
          const col=isInstr?'#7c3aed':hashColor(who||'Anonymous');
          const key=itemKey(c);

          const canDelete = !!(viewer.canDelete && (c.id||'').trim());
          const delBtn = canDelete ? `<button class="cmt-del" data-del="${escapeHtml(c.id)}" title="Delete">üóëÔ∏è</button>` : '';

          return `<div class="cmt-msg ${cls}" role="listitem" data-id="${key}">
            <div class="${avatarCls}" style="background:${col}">${init}</div>
            <div class="cmt-meta-wrap">
              ${delBtn}
              <div class="cmt-meta"><span>${meta}</span></div>
              ${urlHtml}
              <div class="cmt-bubble">${safe}</div>
            </div>
          </div>`;
        }

        function render(items, viewer){ listEl.innerHTML = items.map(c=> buildMsgHTML(c, viewer)).join(''); }
        const isNearBottom=()=> listEl.scrollHeight - (listEl.scrollTop + listEl.clientHeight) < 120;
        const scrollToBottom=()=>{ listEl.scrollTop = listEl.scrollHeight; };

        const BASE_POLL_MS=3000;
        function scheduleNextPoll(delay){
          if (pollTimer) clearTimeout(pollTimer);
          if (document.hidden) return;
          pollTimer=setTimeout(()=> load({forceScroll:isNearBottom()}), delay ?? BASE_POLL_MS);
        }
        function normalizeItems(arr){ return (arr||[]).map(x=>{ if(!x.ts && x.timestamp){ const ms=Date.parse(x.timestamp); if (isFinite(ms)) x.ts=ms; } return x; }); }

        async function deleteComment(id){
          if (!adminToken()){ alert('Admin token ausente. Clique no üîë para setar.'); return; }
          if (!confirm('Excluir este coment√°rio?')) return;
          const headers = {'x-admin-token': adminToken()};
          let ok=false;
          try{ const r = await fetch(`${scriptURL}/comments/${encodeURIComponent(id)}`, { method:'DELETE', headers }); ok = r.ok; }catch(_){}
          if (!ok){
            try{
              const r2 = await fetch(`${scriptURL}/comments/delete`, { method:'POST', headers:{...headers,'Content-Type':'application/json'}, body:JSON.stringify({id}) });
              ok = r2.ok || (await r2.json().catch(()=>({}))).status==='success';
            }catch(_){}
          }
          if (!ok){ alert('Falha ao excluir. Verifique o token e as permiss√µes.'); return; }
          const msg = listEl.querySelector(`[data-id="${CSS.escape(id)}"]`) || listEl.querySelector(`[data-del="${CSS.escape(id)}"]`)?.closest('.cmt-msg');
          if (msg) msg.remove();
        }
        listEl.addEventListener('click', (e)=>{
          const btn = e.target.closest('button.cmt-del');
          if (!btn) return;
          const id = btn.getAttribute('data-del');
          if (id) deleteComment(id);
        });

        function load({forceScroll=false}={}){
          const shouldStick = forceScroll || isNearBottom();
          const meLogin=(loggedLogin()||'').trim();

          const viewer = {
            mode: isInstructorMode() ? 'instructor' : 'student',
            login: meLogin,
            canDelete: isInstructorMode() && !!adminToken()
          };

          let viewing = meLogin;
          if (isInstructorMode()){
            viewing = targetSel.value || localStorage.getItem('cmt_last_target') || meLogin;
          }
          if (!viewing){ scheduleNextPoll(); return; }

          const base=`${scriptURL}/comments?student=${encodeURIComponent(viewing)}&limit=1000`;
          const url=(__haveInitial && __lastTsMs) ? `${base}&since_ms=${__lastTsMs}` : base;

          fetch(url).then(r=>r.json()).then(d=>{
            const incoming=normalizeItems(Array.isArray(d.items)? d.items.slice() : []);
            incoming.sort((a,b)=> (Number(a.ts||0)-Number(b.ts||0)));
            for (const it of incoming){ const ms=Number(it.ts||0); if (ms > __lastTsMs) __lastTsMs=ms; }

            if (!__haveInitial){
              render(incoming, viewer);
              __haveInitial=true; if (shouldStick) scrollToBottom();
            } else if (incoming.length){
              const fresh=incoming.filter(c=> !listEl.querySelector(`[data-id="${itemKey(c)}"]`));
              if (fresh.length){
                const frag=fresh.map(c=> buildMsgHTML(c, viewer)).join('');
                const keepBottom=isNearBottom();
                listEl.insertAdjacentHTML('beforeend', frag);
                if (keepBottom) scrollToBottom();

                const instrFreshCount = fresh.filter(c => String(c.author||'').toLowerCase() === 'instructor').length;
                if (viewer.mode==='student' && instrFreshCount>0 && !panel.classList.contains('open')){
                  selfUnread += instrFreshCount;
                  localStorage.setItem('cmt_unread_self', String(selfUnread));
                  updateBubbleCount();
                  maybeAlert();
                }
              }
            }
          }).catch(()=>{}).finally(()=> scheduleNextPoll());
        }

        function updateKeyBtnLabel(){
          const tok = adminToken();
          if (tok) { keyBtn.title = `Admin token set (‚Ä¶${tok.slice(-4)})`; keyBtn.textContent='üîë‚úì'; }
          else     { keyBtn.title='Set admin token'; keyBtn.textContent='üîë'; }
        }

        function setInstructorUI(){
          const on = isInstructorMode();
          keyBtn.style.display  = (on || !!adminToken()) ? '' : 'none';
          findBtn.style.display = on ? '' : 'none';
          if (on){ updateKeyBtnLabel(); renderSelect(); startInboxWatch(); }
          updateBubbleCount();
        }

        keyBtn.addEventListener('click', ()=>{
          const current = adminToken();
          const next = prompt(current ? 'Replace admin token (vazio para limpar):' : 'Cole o admin token:', current || '');
          if (next === null) return;
          const v = String(next||'').trim();
          if (v) localStorage.setItem('cmt_admin_token', v);
          else   localStorage.removeItem('cmt_admin_token');
          updateKeyBtnLabel(); clearAlerts(); renderSelect(); updateBubbleCount(); startInboxWatch();
        });

        function hardReload(){ __haveInitial=false; __lastTsMs=0; load({forceScroll:true}); }

        const openPanel=()=>{ 
          panel.classList.add('open'); 
          panel.setAttribute('aria-hidden','false'); 
          clearAlerts();

          if (isInstructorMode()){
            unread = {}; newUntil = {};
            saveJSON('cmt_unread', unread);
            saveJSON('cmt_new_until', newUntil);
          } else {
            selfUnread = 0;
            localStorage.setItem('cmt_unread_self', '0');
          }

          renderSelect(); 
          updateBubbleCount(); 
          startInboxWatch(); 
          hardReload(); 
          setTimeout(scrollToBottom,80); 
        };

        const closePanel=()=>{ 
          panel.classList.remove('open'); 
          panel.setAttribute('aria-hidden','true'); 
          maybeAlert(); 
        };

        bubble.addEventListener('click', ()=> panel.classList.contains('open') ? closePanel() : openPanel());
        closeBtn.addEventListener('click', closePanel);
        sendBtn.addEventListener('click', post);
        textIn.addEventListener('keydown', e=>{ if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); post(); } });

        window.addEventListener('keydown', (e)=>{
          if (e.ctrlKey && e.altKey && (e.key==='i' || e.key==='I')){
            const now = !(localStorage.getItem('cmt_force_instructor')==='1');
            setForceInstructor(now);
            alert(`Instructor UI: ${now ? 'ON' : 'OFF'}`);
            setInstructorUI();
            if (now) startInboxWatch();
          }
          if (e.ctrlKey && (e.key==='k' || e.key==='K')){ e.preventDefault(); askLogin(); }
        });

        document.addEventListener('visibilitychange', ()=>{
          if (document.hidden){
            if (pollTimer){ clearTimeout(pollTimer); pollTimer=null; }
          } else {
            renderSelect(); startInboxWatch(); updateBubbleCount(); scheduleNextPoll(100);
          }
        });

        function post(){
          if (__posting) return;
          const s=loggedLogin(); const t=(textIn.value||'').trim();
          if (!t){ alert('Please write a comment.'); return; }

          const asInstructor=isInstructorMode();
          const targetStudent= asInstructor ? (targetSel.value||localStorage.getItem('cmt_last_target')||s) : s;
          if (asInstructor && !targetStudent){ alert("Selecione ou busque o login do aluno (üîé)."); return; }
          if (!asInstructor && !s){ alert('Fa√ßa login para comentar.'); return; }

          const now=Date.now(); const sig=`${targetStudent}__${scopeId()}__${t}`;
          if (__lastSent.sig===sig && (now-__lastSent.at)<12000){ textIn.focus(); return; }
          __lastSent={sig,at:now};

          __posting=true; sendBtn.disabled=true; sendBtn.setAttribute('aria-busy','true'); sendBtn.style.opacity='.7';

          const tempId='temp-'+now, temp={ id:tempId, ts:now, student:targetStudent, author: asInstructor?'instructor':'student',
            slide_id:scopeId(), module_id:detectModuleId(), page_url:location.href, comment:t };

          if (panel.classList.contains('open')){
            const viewer = asInstructor ? {mode:'instructor', canDelete:isInstructorMode()&&!!adminToken()} : {mode:'student', login:s, canDelete:false};
            const html=buildMsgHTML(temp, viewer);
            const keepBottom=isNearBottom(); listEl.insertAdjacentHTML('beforeend', html); if (keepBottom) scrollToBottom();
          }

          fetch(`${scriptURL}/comments`,{
            method:'POST',
            headers:{ 'Content-Type':'application/json', ...(asInstructor? {'x-admin-token': adminToken()} : {}) },
            body:JSON.stringify({ student:targetStudent, author:temp.author, slide_id:scopeId(), page_url:temp.page_url, module_id:temp.module_id, comment:t, user_agent:navigator.userAgent })
          }).then(r=>r.json()).then(d=>{
            if (d.status==='success'){
              textIn.value='';
              const tempEl=listEl.querySelector(`[data-id="${tempId}"]`); if (tempEl) tempEl.setAttribute('data-id', d.id||tempId);
              scheduleNextPoll(200);
            } else {
              const el=listEl.querySelector(`[data-id="${tempId}"]`); if (el) el.remove(); alert('Error: '+(d.message||'Unable to post'));
            }
          }).catch(()=>{
            const el=listEl.querySelector(`[data-id="${tempId}"]`); if (el) el.remove(); alert('Network error: failed to send');
          }).finally(()=>{
            __posting=false; sendBtn.disabled=false; sendBtn.removeAttribute('aria-busy'); sendBtn.style.opacity='';
          });
        }

        setInstructorUI();
        updateBubbleCount();
        load();
      })();
      </script>
    </template>
    <!-- ranking-widgets2.html : Minimal icon button + ranking panel (Cloudflare) -->
    <style>
      html.locked .requires-auth, body.locked .requires-auth { display: none !important; }

      :root{
        --chatbot-gap: 350px;
        --lb-bg: rgba(46, 58, 78, 0.72);
        --lb-border: rgba(255,255,255,0.10);
        --lb-shadow: 0 18px 60px rgba(0,0,0,0.35), 0 2px 8px rgba(0,0,0,0.18);
        --lb-radius: 18px;
        --lb-accent: #a78bfa;
        --lb-accent-weak: rgba(167,139,250,0.18);
        --pill-start: #6d5df5; --pill-end: #2ec5ff;
      }
      .lb-panel{ position:fixed; bottom:20px; right:var(--chatbot-gap); z-index:2147483647; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; }
      .lb-toggle{ width:40px; height:40px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center; border:none;
        background:linear-gradient(135deg,var(--pill-start),var(--pill-end)); color:#fff; box-shadow:0 10px 28px rgba(2,6,23,.30), inset 0 0 0 1px rgba(255,255,255,.14);
        cursor:pointer; user-select:none; transition:transform .12s ease, box-shadow .12s ease, filter .12s ease; }
      .lb-toggle:hover{ transform:translateY(-1px); filter:brightness(1.05); }
      .lb-toggle:active{ transform:translateY(0); filter:brightness(.98); }
      .lb-icon{ font-size:20px; line-height:1; }

      .lb-card{
        margin-top:10px; width:360px; max-height:62vh; overflow:auto; border:1px solid var(--lb-border); background:var(--lb-bg);
        -webkit-backdrop-filter:saturate(160%) blur(10px); backdrop-filter:saturate(160%) blur(10px); border-radius:var(--lb-radius); box-shadow:var(--lb-shadow);
        display:none; position:absolute; bottom:52px; right:0; transform-origin:bottom right; color:#e5e7eb;
      }
      .lb-card.open{ display:block; animation:lbPop .18s cubic-bezier(.2,.9,.2,1); }
      @keyframes lbPop{ from{ transform:scale(.98); opacity:0 } to{ transform:scale(1); opacity:1 } }

      .lb-header{ padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.06); display:flex; justify-content:space-between; align-items:center;
        background:linear-gradient(180deg, rgba(167,139,250,.12), transparent 60%); border-top-left-radius:var(--lb-radius); border-top-right-radius:var(--lb-radius);
        position:sticky; top:0; backdrop-filter:blur(6px); }
      .lb-title{ font-weight:800; letter-spacing:.2px; color:#f3f4f6; }

      .lb-list{ list-style:none; margin:0; padding:6px 0 8px; }
      .lb-item{ display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px dashed rgba(255,255,255,.06); }
      .lb-item:last-child{ border-bottom:0; }

      .lb-left{ display:flex; align-items:center; gap:10px; min-width:0; }
      .lb-rank{ width:28px; text-align:right; font-variant-numeric:tabular-nums; color:#fde68a; font-weight:700; }
      .lb-item.top-2 .lb-rank{ color:#cbd5e1; } .lb-item.top-3 .lb-rank{ color:#d8b4fe; }

      .lb-name{ flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color:#e5e7eb; }
      .lb-points{ font-variant-numeric:tabular-nums; font-weight:600; color:#f3f4f6; }

      .lb-footer{ padding:10px 14px; display:flex; justify-content:space-between; align-items:center; gap:8px; border-top:1px solid rgba(255,255,255,.06);
        background:linear-gradient(0deg, rgba(167,139,250,.10), transparent 60%); border-bottom-left-radius:var(--lb-radius); border-bottom-right-radius:var(--lb-radius);
        position:sticky; bottom:0; backdrop-filter:blur(6px); }
      .lb-badge-me{ background:var(--lb-accent-weak); padding:4px 8px; border-radius:999px; font-size:12px; font-weight:600; color:#f5f3ff; }

      @media (max-width:820px){ .lb-panel{ right:12px; bottom:88px; } .lb-card{ position:fixed; left:12px; right:12px; bottom:88px; width:auto; height:58vh; max-height:none; transform-origin:bottom center; } }
      @media (max-width:380px){ .lb-card{ height:62vh; } }
    </style>

    <div class="requires-auth">
      <div class="lb-panel" id="lbPanel2">
        <button class="lb-toggle" id="lbToggle2" title="Ranking" aria-label="Open ranking">
          <span class="lb-icon">üèÜ</span>
        </button>
        <div class="lb-card" id="lbCard2" role="dialog" aria-modal="false" aria-label="Ranking">
          <div class="lb-header">
            <div class="lb-title">Top <span id="lbTopN2">10</span></div>
          </div>
          <ul class="lb-list" id="lbList2"></ul>
          <div class="lb-footer"><span id="lbMe2"></span></div>
        </div>
      </div>
    </div>

    <script>
      const LB_ENDPOINT = 'https://course-chat.hcmrtns.workers.dev/ranking';
      const LB_TOP = 10;
      const LB_POLL_MS = 3000;

      let LB_STUDENT = (window.studentId || localStorage.getItem('studentId') || localStorage.getItem('fs_user') || '').toString();

      const $ = (id) => document.getElementById(id);
      const lbToggle  = $('lbToggle2');
      const lbCard    = $('lbCard2');
      const lbList    = $('lbList2');
      const lbTopNEl  = $('lbTopN2');
      const lbMeEl    = $('lbMe2');
      lbTopNEl.textContent = LB_TOP;

      document.addEventListener('auth:login', (ev) => {
        const sid = (ev && ev.detail && ev.detail.studentId) ? ev.detail.studentId :
          (window.studentId || localStorage.getItem('studentId') || localStorage.getItem('fs_user') || '');
        if (sid) { LB_STUDENT = String(sid); if (lbCard.classList.contains('open')) fetchRanking(); }
      });

      lbToggle.addEventListener('click', () => {
        const open = lbCard.classList.contains('open');
        if (open) lbCard.classList.remove('open'); else { lbCard.classList.add('open'); fetchRanking(); }
      });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') lbCard.classList.remove('open'); });

      async function fetchRanking() {
        try {
          const who = LB_STUDENT || 'anonymous';
          const url = `${LB_ENDPOINT}?top=${LB_TOP}&who=${encodeURIComponent(who)}`;
          const res = await fetch(url, { method: 'GET' });
          const data = await res.json();
          if (!data.ok && data.status !== 'success') throw new Error(data.error || 'Failed');
          renderTop(data.top, data.me);
        } catch (e) {
          console.error('Ranking error:', e);
          lbList.innerHTML = '<li class="lb-item"><div class="lb-name">Refreshing...</div></li>';
        }
      }

      function renderTop(top, me) {
        lbList.innerHTML = '';
        if (!top || !top.length){
          lbList.innerHTML = '<li class="lb-item"><div class="lb-name" style="opacity:.8">No points yet.</div></li>';
        } else {
          for (const row of top) {
            const li = document.createElement('li'); li.className = 'lb-item';
            if (row.rank <= 3) li.classList.add(`top-${row.rank}`);
            const left = document.createElement('div'); left.className='lb-left';
            const rk = document.createElement('div'); rk.className='lb-rank'; rk.textContent = row.rank;
            const nm = document.createElement('div'); nm.className='lb-name'; nm.textContent = row.name || row.studentId || row.student;
            left.appendChild(rk); left.appendChild(nm);
            const pts = document.createElement('div'); pts.className='lb-points'; pts.textContent = (row.total_points ?? row.points) + ' pts';
            li.appendChild(left); li.appendChild(pts);
            lbList.appendChild(li);
          }
        }
        lbMeEl.innerHTML = me ? `<span class="lb-badge-me">You: #${me.rank} ¬∑ ${me.total_points} pts</span>` : '';
      }
      if (LB_POLL_MS && Number(LB_POLL_MS) > 0) setInterval(fetchRanking, LB_POLL_MS);
    </script>
    <!-- notices-on-login.html -->
    <style>
      .notice-modal-backdrop{
        position:fixed; inset:0; background:rgba(15,23,42,.35);
        display:none; align-items:center; justify-content:center;
        z-index:2147483647; /* topo de tudo */
      }
      .notice-modal{
        width:min(92vw, 680px); background:#fff; border-radius:16px;
        box-shadow:0 18px 50px rgba(0,0,0,.25);
        padding:18px 18px 12px; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
        border:1px solid rgba(0,0,0,.08);
      }
      .notice-title{ font-size:1.1rem; font-weight:700; margin:0 0 6px; color:#0f172a; }
      .notice-body{ color:#334155; line-height:1.5; }
      .notice-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:14px; }

      .notice-btn{
        padding:10px 14px; border-radius:10px;
        border:1px solid rgba(0,0,0,.1); background:#0ea5e9; color:#fff; cursor:pointer;
      }

      /* Bot√µes das op√ß√µes */
      .notice-choice{
        padding:10px 14px; border-radius:999px;
        border:1px solid rgba(15,23,42,.08);
        background: linear-gradient(180deg,#3b82f6,#2563eb);
        color:#fff; cursor:pointer; box-shadow: 0 2px 0 rgba(0,0,0,.06);
        transition: transform .12s ease, filter .12s ease, opacity .12s ease;
      }
      .notice-choice:hover{ transform: translateY(-1px); filter: brightness(1.05); }
      .notice-choice:disabled{ opacity:.7; cursor:default; transform:none; }

      /* Estado visual ap√≥s clique */
      .notice-choice.is-selected{
        background: linear-gradient(180deg,#2563eb,#1d4ed8);
        border-color: rgba(37,99,235,.35);
      }
      .notice-choice.is-correct{
        background: linear-gradient(180deg,#16a34a,#15803d);
        border-color: rgba(22,163,74,.35);
      }
      .notice-choice.is-wrong{
        background: linear-gradient(180deg,#dc2626,#b91c1c);
        border-color: rgba(220,38,38,.35);
      }

      /* Placar */
      .notice-score{
        margin-top:10px;
        font-weight:600;
        color:#0f766e; /* teal-700 */
        font-size:.95rem;
      }
      .notice-accuracy{
        display:flex; align-items:center; gap:8px;
        margin-top:6px; font-size:.92rem; color:#334155;
      }
      .stars{
        display:inline-flex; gap:2px; line-height:1;
      }
      .star{
        font-size:1.05rem; user-select:none;
        color:#e5e7eb; /* base (cinza claro para ‚Äúvazio‚Äù) */
        text-shadow: 0 1px 0 rgba(0,0,0,.05);
      }
      .star.filled{ color:#F59E0B; }     /* gold  */
      .star.half::after{                  /* meia estrela simples (overlay) */
        content:'‚òÖ'; color:#FDE047; position:absolute; width:50%; overflow:hidden;
      }
      .pct{
        font-weight:700; color:#0ea5e9; /* ciano/teal p/ combinar com seus azuis */
      }
    </style>

    <div class="notice-modal-backdrop" id="noticeBackdrop" aria-hidden="true" style="display:none">
      <div class="notice-modal" role="dialog" aria-modal="true">
        <div class="notice-title" id="noticeTitle">Notice</div>
        <div class="notice-body" id="noticeBody"></div>
        <div class="notice-actions">
          <button class="notice-btn" id="noticeOkBtn" type="button">Ok, got it</button>
        </div>
      </div>
    </div>

    <!-- Confete -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js" defer=""></script>

    <script>
    (function(){
      const ENDPOINT = 'https://script.google.com/macros/s/AKfycbw1stXhHVbcinNcagloc6XNr3MYW9zn8EctaxxLuOJ086ODpCBvNCPwdfzbJxwl1XgDfw/exec';
      const SESSION_FLAG = 'notice_shown_this_load';
      const FEEDBACK_AUTO_CLOSE_MS = 18000;
      const DEBUG = false;

      /* Preconnect + dns-prefetch */
      try {
        const l1=document.createElement('link'); l1.rel='preconnect';   l1.href='https://script.google.com'; document.head.appendChild(l1);
        const l2=document.createElement('link'); l2.rel='dns-prefetch'; l2.href='https://script.google.com'; document.head.appendChild(l2);
      } catch(_) {}

      /* üî• Warm-up imediato do GAS */
      try {
        const warm = new Image();
        warm.referrerPolicy = 'no-referrer';
        warm.src = `${ENDPOINT}?action=ping&t=${Date.now()}`;
      } catch(_) {}

      /* Helpers b√°sicos */
      function ensureModal(){
        let backdrop = document.getElementById('noticeBackdrop');
        if (!backdrop) {
          const tpl = document.createElement('div');
          tpl.innerHTML = `
            <div class="notice-modal-backdrop" id="noticeBackdrop" aria-hidden="true" style="display:none">
              <div class="notice-modal" role="dialog" aria-modal="true">
                <div class="notice-title" id="noticeTitle">Notice</div>
                <div class="notice-body" id="noticeBody"></div>
                <div class="notice-actions">
                  <button class="notice-btn" id="noticeOkBtn" type="button">Ok, got it</button>
                </div>
              </div>
            </div>`;
          document.body.appendChild(tpl.firstElementChild);
          if (DEBUG) console.log('[notice] backdrop injected');
        }
      }

      function getStudentId(){
        try { return (localStorage.getItem('studentId') || sessionStorage.getItem('studentId') || window.__lastLoginStudentId || '').trim(); }
        catch(e){ return ''; }
      }
      function normalizeModule(m){
        if (!m) return '';
        const s = String(m).trim().toLowerCase();
        const m1 = s.match(/^module(\d+)$/); if (m1) return `mod${m1[1]}`;
        return s;
      }
      function getModule(){
        try {
          const el = document.getElementById('current-module'); if (el && el.value) return normalizeModule(el.value);
          const byStorage = localStorage.getItem('module') || sessionStorage.getItem('module'); if (byStorage) return normalizeModule(byStorage);
          const dm = document.body && document.body.getAttribute('data-module'); if (dm) return normalizeModule(dm);
          if (window.VHCM && window.VHCM.module) return normalizeModule(window.VHCM.module);
          return '';
        } catch(e){ return ''; }
      }
      function fetchJSON(url){
        return fetch(url, { credentials:'omit', cache:'no-store' })
          .then(r => { if(!r.ok) throw new Error('HTTP ' + r.status); return r.json(); });
      }
      function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
      function personalize(s, studentId, module){
        return String(s || '')
          .replace(/\{\{\s*studentId\s*\}\}/gi, escapeHtml(studentId || ''))
          .replace(/\{\{\s*module\s*\}\}/gi, escapeHtml(module || ''));
      }
      function fireAndForget(url){
        try { const img = new Image(); img.referrerPolicy='no-referrer'; img.src = url; } catch(_) {}
      }
      function ackAndClose(studentId, notice_id){
        const modal = document.getElementById('noticeBackdrop');
        if (modal) modal.style.display = 'none';
        const qs2 = new URLSearchParams({ action:'ack', studentId, notice_id, t: Date.now().toString() });
        fireAndForget(`${ENDPOINT}?${qs2.toString()}`);
      }
      function normalizeTF(x){
        const s = String(x || '').trim().toLowerCase();
        if (['true','t','verdadeiro','v','yes','y','sim','‚úÖ','‚úîÔ∏è'].includes(s)) return 'true';
        if (['false','f','falso','no','n','nao','n√£o','‚ùå','‚úñÔ∏è'].includes(s)) return 'false';
        if (s.startsWith('true'))  return 'true';
        if (s.startsWith('false')) return 'false';
        return '';
      }

      /* ===== Estrelas ===== */
      function makeStars(rating /* 0..5, pode ser decimal */){
        const full = Math.floor(rating);
        const hasHalf = (rating - full) >= 0.5;
        let html = '';
        for (let i=1;i<=5;i++){
          if (i <= full) html += '<span class="star filled" aria-hidden="true">‚òÖ</span>';
          else if (i === full+1 && hasHalf) html += '<span class="star filled" style="position:relative" aria-hidden="true">‚òÖ<span style="position:absolute;inset:0;clip-path:inset(0 50% 0 0); color:#FDE047;">‚òÖ</span></span>';
          else html += '<span class="star" aria-hidden="true">‚òÖ</span>';
        }
        return html;
      }

      /* ===== Placar do backend + UI ===== */
      async function updateTFScore(studentId, module){
        const box = document.getElementById('pollScore');
        if (!box) return;

        try{
          const qs = new URLSearchParams({ action:'stats_tf', studentId });
          if (module) qs.set('module', module);
          const j = await fetchJSON(`${ENDPOINT}?${qs.toString()}`);
          if (!j?.ok) return;

          const src = j.stats ? j.stats : j;
          const correct = Number(src.correct ?? 0);
          const total   = Number(src.total   ?? 0);
          const pct = total ? Math.round((correct/total)*100) : 0;

          // converte % em nota 0..5 (ex.: 70% => 3.5 estrelas)
          const starsValue = Math.max(0, Math.min(5, (pct/20)));

          box.innerHTML = `
            <div>Congrats, you have answered ${correct} of ${total} correctly.</div>
            <div class="notice-accuracy" aria-label="Your accuracy">
              <div class="stars" aria-hidden="true">${makeStars(starsValue)}</div>
              <div class="pct">${pct}%</div>
            </div>
          `;
          box.style.display = '';
        }catch(_){ /* silencioso */ }
      }

      /* Render de poll */
      function renderPoll(notice, studentId, module){
        const body = document.getElementById('noticeBody');
        const okBtn = document.getElementById('noticeOkBtn');
        const opts = Array.isArray(notice.poll_options) ? notice.poll_options : [];
        const q    = notice.poll_question || 'Vote:';

        const correctKey = normalizeTF(notice.poll_correct);
        const isQuizTF   = (correctKey === 'true' || correctKey === 'false');
        let autoTimer = null;

        const pollWrap = document.createElement('div');
        pollWrap.innerHTML = `
          <div style="margin:8px 0 12px 0;"><strong>${escapeHtml(q)}</strong></div>
          <div id="pollBtns" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
          <div id="pollFeedback" style="margin-top:10px;"></div>
          <div id="pollScore" class="notice-score" style="display:none"></div>
        `;
        body.appendChild(pollWrap);

        const btns = pollWrap.querySelector('#pollBtns');
        const fb   = pollWrap.querySelector('#pollFeedback');

        if (isQuizTF && okBtn) {
          okBtn.style.display = '';
          okBtn.onclick = (ev) => {
            ev.preventDefault(); ev.stopPropagation();
            if (autoTimer) { clearTimeout(autoTimer); autoTimer = null; }
            ackAndClose(studentId, notice.notice_id);
          };
        }

        opts.forEach((label) => {
          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'notice-choice';
          b.textContent = label;

          b.addEventListener('click', () => {
            // desabilita todos imediatamente
            const all = [...btns.querySelectorAll('button')];
            all.forEach(x => x.disabled = true);

            // envia voto (fire-and-forget)
            const qs = new URLSearchParams({
              action: 'poll_vote',
              studentId,
              module: module || '',
              poll_id: notice.poll_id || '',
              choice: label,
              t: Date.now().toString()
            });
            fireAndForget(`${ENDPOINT}?${qs.toString()}`);

            if (!isQuizTF) {
              b.classList.add('is-selected');
              ackAndClose(studentId, notice.notice_id);
              return;
            }

            // T/F: decide correto/errado
            const choiceKey = normalizeTF(label);
            const isCorrect = (choiceKey && choiceKey === correctKey);

            b.classList.add(isCorrect ? 'is-correct' : 'is-wrong');
            if (isCorrect) celebrate();

            // feedback
            fb.style.color = isCorrect ? '#065f46' : '#b91c1c';
            fb.innerHTML = isCorrect
              ? (notice.feedback_correct_html || '<p><strong>‚úÖ Correct.</strong></p>')
              : (notice.feedback_wrong_html  || '<p><strong>‚ùå Not quite.</strong></p>');

            // üëâ s√≥ agora buscamos e revelamos o placar completo
            updateTFScore(studentId, module);

            if (FEEDBACK_AUTO_CLOSE_MS > 0) {
              autoTimer = setTimeout(() => {
                autoTimer = null;
                ackAndClose(studentId, notice.notice_id);
              }, FEEDBACK_AUTO_CLOSE_MS);
            }
          });

          btns.appendChild(b);
        });
      }

      /* Mostra aviso/poll */
      async function showNotice(studentId){
        try { if (sessionStorage.getItem(SESSION_FLAG)) return false; } catch(e){}

        const module = getModule();
        const qs = new URLSearchParams({ action:'get', studentId });
        if (module) qs.set('module', module);

        const data = await fetchJSON(`${ENDPOINT}?${qs.toString()}`);
        if (!data.ok || !data.hasNotice || !data.notice) return false;

        ensureModal();

        const notice = data.notice;
        const titleEl = document.getElementById('noticeTitle');
        const bodyEl  = document.getElementById('noticeBody');
        const okBtn   = document.getElementById('noticeOkBtn');
        const modal   = document.getElementById('noticeBackdrop');
        if (!titleEl || !bodyEl || !okBtn || !modal) return false;

        titleEl.textContent = personalize(notice.title || (notice.type === 'poll' ? 'Quick poll' : 'Notice'), studentId, module);
        bodyEl.innerHTML = personalize(notice.message_html || '', studentId, module);
        modal.style.display = 'flex';

        if (notice.type === 'poll' && !notice.already_voted) {
          const correctKey = normalizeTF(notice.poll_correct);
          const isQuizTF   = (correctKey === 'true' || correctKey === 'false');

          okBtn.style.display = isQuizTF ? '' : 'none';
          if (!isQuizTF) {
            okBtn.onclick = (ev) => { ev.preventDefault(); ev.stopPropagation(); ackAndClose(studentId, notice.notice_id); };
          }

          renderPoll(notice, studentId, module);
        } else {
          okBtn.style.display = '';
          okBtn.onclick = (ev) => { ev.preventDefault(); ev.stopPropagation(); ackAndClose(studentId, notice.notice_id); };
        }

        try { sessionStorage.setItem(SESSION_FLAG, notice.notice_id); } catch(e){}
        return true;
      }

      /* API global opcional */
      window.noticeCenter = {
        onLogin: (studentId) => { try { window.__lastLoginStudentId = studentId; } catch(e){}; showNotice(String(studentId || '').trim()); },
        showNow: () => { try{ sessionStorage.removeItem(SESSION_FLAG); }catch(_){};
          const sid = getStudentId(); if (sid) showNotice(sid);
        }
      };

      /* Espera login e mostra (fallback) */
      async function waitForLoginAndShow(maxMs=20000){
        const start = Date.now();
        while (Date.now() - start < maxMs) {
          const sid = getStudentId();
          if (sid) { await showNotice(sid); return; }
          await new Promise(r => setTimeout(r, 150));
        }
      }

      /* Gatilhos */
      document.addEventListener('auth:login', (ev) => {
        const sid = (ev && ev.detail && ev.detail.studentId) ? String(ev.detail.studentId).trim() : getStudentId();
        if (sid) window.noticeCenter.onLogin(sid);
      });
      window.addEventListener('login:success', (ev) => {
        const sid = (ev && ev.detail && ev.detail.studentId) ? String(ev.detail.studentId).trim() : getStudentId();
        if (sid) window.noticeCenter.onLogin(sid);
      });

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => { waitForLoginAndShow(); });
      } else {
        waitForLoginAndShow();
      }

      /* üéä Confete em estrelas */
      function celebrate(){
        const defaults = {
          spread: 360, ticks: 55, gravity: 0.9, decay: 0.92, startVelocity: 35,
          colors: ['#F59E0B','#FDE047','#22D3EE','#60A5FA','#A78BFA']
        };
        function shoot(scale, countStar=40, countCircle=12){
          confetti({ ...defaults, particleCount: countStar, scalar: scale, shapes: ['star'] });
          confetti({ ...defaults, particleCount: countCircle, scalar: scale*0.7, shapes: ['circle'] });
        }
        shoot(1.1); setTimeout(()=>shoot(1.0), 180); setTimeout(()=>shoot(0.9), 320);
      }
    })();
    </script>
    <script id="quarto-html-after-body" type="application/javascript">
    window.document.addEventListener("DOMContentLoaded", function (event) {
      const toggleBodyColorMode = (bsSheetEl) => {
        const mode = bsSheetEl.getAttribute("data-mode");
        const bodyEl = window.document.querySelector("body");
        if (mode === "dark") {
          bodyEl.classList.add("quarto-dark");
          bodyEl.classList.remove("quarto-light");
        } else {
          bodyEl.classList.add("quarto-light");
          bodyEl.classList.remove("quarto-dark");
        }
      }
      const toggleBodyColorPrimary = () => {
        const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
        if (bsSheetEl) {
          toggleBodyColorMode(bsSheetEl);
        }
      }
      toggleBodyColorPrimary();  
      const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
      tabsets.forEach(function(tabset) {
        const tabby = new Tabby('#' + tabset.id);
      });
      const isCodeAnnotation = (el) => {
        for (const clz of el.classList) {
          if (clz.startsWith('code-annotation-')) {                     
            return true;
          }
        }
        return false;
      }
      const clipboard = new window.ClipboardJS('.code-copy-button', {
        text: function(trigger) {
          const codeEl = trigger.previousElementSibling.cloneNode(true);
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
        }
      });
      clipboard.on('success', function(e) {
        // button target
        const button = e.trigger;
        // don't keep focus
        button.blur();
        // flash "checked"
        button.classList.add('code-copy-button-checked');
        var currentTitle = button.getAttribute("title");
        button.setAttribute("title", "Copied!");
        let tooltip;
        if (window.bootstrap) {
          button.setAttribute("data-bs-toggle", "tooltip");
          button.setAttribute("data-bs-placement", "left");
          button.setAttribute("data-bs-title", "Copied!");
          tooltip = new bootstrap.Tooltip(button, 
            { trigger: "manual", 
              customClass: "code-copy-button-tooltip",
              offset: [0, -8]});
          tooltip.show();    
        }
        setTimeout(function() {
          if (tooltip) {
            tooltip.hide();
            button.removeAttribute("data-bs-title");
            button.removeAttribute("data-bs-toggle");
            button.removeAttribute("data-bs-placement");
          }
          button.setAttribute("title", currentTitle);
          button.classList.remove('code-copy-button-checked');
        }, 1000);
        // clear code selection
        e.clearSelection();
      });
      function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
        const config = {
          allowHTML: true,
          maxWidth: 500,
          delay: 100,
          arrow: false,
          appendTo: function(el) {
              return el.closest('section.slide') || el.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start',
        };
        if (contentFn) {
          config.content = contentFn;
        }
        if (onTriggerFn) {
          config.onTrigger = onTriggerFn;
        }
        if (onUntriggerFn) {
          config.onUntrigger = onUntriggerFn;
        }
          config['offset'] = [0,0];
          config['maxWidth'] = 700;
        window.tippy(el, config); 
      }
      const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
      for (var i=0; i<noterefs.length; i++) {
        const ref = noterefs[i];
        tippyHover(ref, function() {
          // use id or data attribute instead here
          let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
          try { href = new URL(href).hash; } catch {}
          const id = href.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          return note.innerHTML;
        });
      }
      const findCites = (el) => {
        const parentEl = el.parentElement;
        if (parentEl) {
          const cites = parentEl.dataset.cites;
          if (cites) {
            return {
              el,
              cites: cites.split(' ')
            };
          } else {
            return findCites(el.parentElement)
          }
        } else {
          return undefined;
        }
      };
      var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
      for (var i=0; i<bibliorefs.length; i++) {
        const ref = bibliorefs[i];
        const citeInfo = findCites(ref);
        if (citeInfo) {
          tippyHover(citeInfo.el, function() {
            var popup = window.document.createElement('div');
            citeInfo.cites.forEach(function(cite) {
              var citeDiv = window.document.createElement('div');
              citeDiv.classList.add('hanging-indent');
              citeDiv.classList.add('csl-entry');
              var biblioDiv = window.document.getElementById('ref-' + cite);
              if (biblioDiv) {
                citeDiv.innerHTML = biblioDiv.innerHTML;
              }
              popup.appendChild(citeDiv);
            });
            return popup.innerHTML;
          });
        }
      }
    });
    </script>
    <script>
      // Redund√¢ncia leve: tamb√©m define o m√≥dulo via JS neste deck
      // (o notices-on-login reconhece body[data-module], localStorage e window.VHCM.module)
      window.VHCM = window.VHCM || {};
      window.VHCM.module = "mod10";

      document.addEventListener('DOMContentLoaded', () => {
        try { localStorage.setItem('mod2','mod2'); } catch(_) {}
      });

      Reveal.on('ready', event => {
        if (event.indexh === 0) {
          document.querySelector("div.has-logo > img.slide-logo").style.display = "none";
        }
      });
      Reveal.addEventListener('slidechanged', (event) => {
        if (event.indexh === 0) {
          Reveal.configure({ slideNumber: null });
          document.querySelector("div.has-logo > img.slide-logo").style.display = "none";
        }
        if (event.indexh === 1) {
          Reveal.configure({ slideNumber: 'c' });
          document.querySelector("div.has-logo > img.slide-logo").style.display = null;
        }
      });
    </script>
    

</body></html>